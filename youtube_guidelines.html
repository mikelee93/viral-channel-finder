<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YouTube ê°€ì´ë“œë¼ì¸ ì²´í¬ | Viral Shorts Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            min-height: 100vh;
        }

        .glass-panel {
            background: rgba(30, 41, 59, 0.5);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .upload-zone {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(168, 85, 247, 0.1) 100%);
            border: 2px dashed rgba(99, 102, 241, 0.5);
            cursor: pointer;
            transition: all 0.3s;
        }

        .upload-zone:hover {
            border-color: rgba(99, 102, 241, 0.8);
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.2) 0%, rgba(168, 85, 247, 0.2) 100%);
        }

        .glass {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
        }

        /* Loader animation */
        .loader {
            border-radius: 50%;
            border-top-color: currentColor;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .upload-zone.dragover {
            border-color: #10b981;
            background: rgba(16, 185, 129, 0.1);
        }
    </style>
</head>

<body class="p-8">
    <div class="max-w-6xl mx-auto">
        <!-- Navigation -->
        <div class="flex justify-end mb-6">
            <a href="viral_style_trainer.html"
                class="flex items-center gap-2 bg-blue-600/20 text-blue-400 border border-blue-500/30 px-4 py-2 rounded-lg hover:bg-blue-600/30 transition-colors font-bold">
                <span class="text-xl">ğŸ§ª</span>
                <span>ìŠ¤íƒ€ì¼ ì—°êµ¬ì†Œë¡œ ì´ë™</span>
                <span>â†’</span>
            </a>
        </div>

        <!-- Header -->
        <div class="text-center mb-12">
            <h1 class="text-5xl font-black text-white mb-4">
                ğŸ“‹ YouTube ê°€ì´ë“œë¼ì¸ ì²´í¬
            </h1>
            <p class="text-slate-400 text-lg">
                ì—…ë¡œë“œ ì „ ê°€ì´ë“œë¼ì¸ ìœ„ë°˜ ì—¬ë¶€ë¥¼ AIë¡œ ì‚¬ì „ ì²´í¬í•˜ì„¸ìš”
            </p>
        </div>

        <!-- Upload Section -->
        <div class="glass-panel rounded-2xl p-8 mb-8">
            <h2 class="text-2xl font-bold text-white mb-6">ğŸ“¤ ë¹„ë””ì˜¤ ì—…ë¡œë“œ</h2>

            <form id="uploadForm" enctype="multipart/form-data">
                <!-- File Upload Zone -->
                <div class="upload-zone rounded-xl p-12 text-center mb-6" id="uploadZone">
                    <div id="uploadPlaceholder">
                        <div class="text-6xl mb-4">ğŸ¬</div>
                        <p class="text-slate-300 font-bold text-lg mb-2">ë¹„ë””ì˜¤ íŒŒì¼ì„ ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­í•˜ì„¸ìš”</p>
                        <p class="text-slate-500 text-sm">MP4, MOV, AVI (ìµœëŒ€ 100MB)</p>
                        <input type="file" id="videoFile" accept="video/*" class="hidden" />
                    </div>
                    <div id="uploadInfo" class="hidden">
                        <div class="text-4xl mb-2">âœ…</div>
                        <p class="text-green-400 font-bold" id="fileName"></p>
                        <p class="text-slate-500 text-sm" id="fileSize"></p>
                    </div>
                </div>

                <!-- Title -->
                <div class="mb-4">
                    <label class="block text-slate-300 font-bold mb-2">ì œëª© (ì„ íƒì‚¬í•­)</label>
                    <input type="text" id="videoTitle"
                        class="w-full px-4 py-3 bg-slate-800 text-white rounded-lg border border-slate-700 focus:border-blue-500 focus:outline-none"
                        placeholder="ì˜ìƒ ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš” (ìƒëµ ê°€ëŠ¥)">
                </div>

                <!-- Description -->
                <div class="mb-6">
                    <label class="block text-slate-300 font-bold mb-2">ì„¤ëª…</label>
                    <textarea id="videoDescription" rows="3"
                        class="w-full px-4 py-3 bg-slate-800 text-white rounded-lg border border-slate-700 focus:border-blue-500 focus:outline-none"
                        placeholder="ì˜ìƒ ì„¤ëª…ì„ ì…ë ¥í•˜ì„¸ìš” (ì„ íƒì‚¬í•­)"></textarea>
                </div>

                <!-- Submit Button -->
                <button type="submit" id="analyzeBtn"
                    class="w-full bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-500 hover:to-purple-500 text-white font-bold py-4 rounded-xl transition-all transform hover:scale-[1.02]">
                    ğŸ” ê°€ì´ë“œë¼ì¸ ë¶„ì„ ì‹œì‘
                </button>
            </form>
        </div>

        <!-- Loading Section -->
        <div id="loadingSection" class="glass-panel rounded-2xl p-12 text-center hidden">
            <div class="loader w-16 h-16 border-4 border-t-blue-500 mx-auto mb-4"></div>
            <p class="text-white font-bold text-xl mb-2">AIë¡œ ê°€ì´ë“œë¼ì¸ ë¶„ì„ ì¤‘...</p>
            <p class="text-slate-400">ì˜ìƒ ë‚´ìš©, ìŒì„±, í…ìŠ¤íŠ¸ë¥¼ ê²€í† í•˜ê³  ìˆìŠµë‹ˆë‹¤</p>
        </div>

        <!-- Result Section -->
        <div id="resultSection" class="hidden">
            <div class="glass-panel rounded-2xl p-8 mb-6">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-2xl font-bold text-white">ë¶„ì„ ê²°ê³¼</h2>
                    <div id="statusBadge"></div>
                </div>

                <!-- Score -->
                <div class="bg-slate-800/50 rounded-xl p-6 mb-6 text-center">
                    <p class="text-slate-400 text-sm mb-2">ì•ˆì „ ì ìˆ˜</p>
                    <p class="text-5xl font-black text-white" id="score">--</p>
                    <p class="text-slate-500 text-sm mt-2">100ì  ë§Œì </p>
                </div>

                <!-- Summary -->
                <div class="bg-slate-800/50 rounded-xl p-6 mb-6">
                    <p class="text-slate-400 text-sm mb-2">ì¢…í•© í‰ê°€</p>
                    <p class="text-white" id="summary">--</p>
                </div>

                <!-- BGM Analysis -->
                <div class="bg-slate-800/50 rounded-xl p-6 mb-6" id="bgmSection"></div>

                <!-- Violations -->
                <div id="violationsContainer"></div>

                <!-- Action Buttons -->
                <div class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-4">
                    <button id="generateTitlesBtn"
                        class="bg-gradient-to-r from-green-600 to-blue-600 hover:from-green-500 hover:to-blue-500 text-white font-bold py-4 rounded-xl transition-all transform hover:scale-[1.02]">
                        âœ¨ Shorts ì œëª© ìƒì„± (í•œ/ì¼/ë°œìŒ)
                    </button>
                    <button id="extractTranscriptBtn"
                        class="bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-500 hover:to-pink-500 text-white font-bold py-4 rounded-xl transition-all transform hover:scale-[1.02]">
                        ğŸ“ ì˜ìƒ ëŒ€ë³¸ ì¶”ì¶œ
                    </button>
                    <!-- Whisper Provider Toggle -->
                    <div class="col-span-1 md:col-span-2 bg-slate-800/50 rounded-xl p-4 border border-slate-700">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-white font-bold mb-1">ğŸ™ï¸ Whisper ASR ì—”ì§„ ì„ íƒ</p>
                                <p class="text-slate-400 text-xs">ìœ ë£ŒëŠ” ì •í™•í•œ íƒ€ì„ìŠ¤íƒ¬í”„, ë¬´ë£ŒëŠ” ì˜ˆìƒ íƒ€ì„ìŠ¤íƒ¬í”„</p>
                            </div>
                            <div class="flex items-center gap-3 bg-slate-900 rounded-full p-1">
                                <button id="whisperOpenAI" onclick="selectWhisperProvider('openai')"
                                    class="px-4 py-2 rounded-full font-bold text-sm transition-all bg-gradient-to-r from-green-600 to-blue-600 text-white shadow-lg">
                                    ğŸ’³ OpenAI (ìœ ë£Œ)
                                </button>
                                <button id="whisperHF" onclick="selectWhisperProvider('huggingface')"
                                    class="px-4 py-2 rounded-full font-bold text-sm transition-all text-slate-400 hover:text-white">
                                    ğŸ†“ HuggingFace (ë¬´ë£Œ)
                                </button>
                            </div>
                        </div>
                    </div>
                    <button id="openAiProductionBtn"
                        class="col-span-1 md:col-span-2 bg-gradient-to-r from-amber-500 to-orange-600 hover:from-amber-400 hover:to-orange-500 text-white font-black py-4 rounded-xl transition-all transform hover:scale-[1.02] shadow-lg shadow-orange-500/20 flex items-center justify-center gap-3">
                        ğŸ§ª AI ìë™ í”„ë¡œë•ì…˜ (ìŠ¤íƒ€ì¼ ì ìš©)
                    </button>
                </div>
            </div>

            <!-- AI Production Result Section -->
            <div id="aiProductionSection" class="glass-panel rounded-2xl p-8 mb-6 hidden">
                <div class="flex items-center justify-between mb-8">
                    <h2 class="text-3xl font-black text-white flex items-center gap-3">
                        <span class="text-4xl">ğŸ¬</span> AI í”„ë¡œë•ì…˜ ê²°ê³¼
                    </h2>
                    <span class="px-4 py-2 bg-slate-800 rounded-lg text-slate-400 font-mono text-sm"
                        id="prodStyleLabel">ìŠ¤íƒ€ì¼: -</span>
                </div>

                <!-- 3 Script Tabs -->
                <div class="mb-6">
                    <div class="flex gap-2 bg-slate-800/50 p-1 rounded-xl mb-4">
                        <button class="flex-1 py-3 rounded-lg font-bold text-white bg-slate-700 shadow-lg tab-btn"
                            onclick="switchScriptTab('jp')">ğŸ‡¯ğŸ‡µ ì¼ë³¸ì–´</button>
                        <button class="flex-1 py-3 rounded-lg font-bold text-slate-400 hover:text-white tab-btn"
                            onclick="switchScriptTab('pron')">ğŸ—£ï¸ í•œê¸€ë°œìŒ</button>
                        <button class="flex-1 py-3 rounded-lg font-bold text-slate-400 hover:text-white tab-btn"
                            onclick="switchScriptTab('kr')">ğŸ‡°ğŸ‡· í•œêµ­ì–´</button>
                    </div>

                    <div class="bg-slate-900/50 rounded-xl p-6 h-[400px] overflow-y-auto border border-slate-700 relative font-mono leading-relaxed"
                        id="prodScriptDisplay">
                        <!-- Script Content -->
                    </div>
                </div>

                <!-- Audio / Voicevox -->
                <div class="bg-indigo-900/20 border border-indigo-500/30 rounded-xl p-6">
                    <h3 class="text-xl font-bold text-white mb-4 flex items-center gap-2">
                        ğŸ™ï¸ Voicevox ì˜¤ë””ì˜¤
                    </h3>
                    <div id="prodAudioPlayer" class="hidden mb-4">
                        <audio id="prodAudio" controls class="w-full"></audio>
                    </div>
                    <div class="flex gap-3">
                        <button id="prodGenerateAudioBtn"
                            class="flex-1 bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-3 rounded-lg transition-all">
                            ğŸ”Š ì˜¤ë””ì˜¤ ìƒì„±í•˜ê¸°
                        </button>
                        <button id="prodDownloadSrtBtn"
                            class="bg-slate-700 hover:bg-slate-600 text-white font-bold py-3 px-6 rounded-lg transition-all">
                            ğŸ“„ SRT ìë§‰
                        </button>
                    </div>
                </div>
            </div>

            <!-- Style Selection Modal -->
            <div id="styleModal"
                class="fixed inset-0 bg-black/90 backdrop-blur-md z-50 hidden flex items-center justify-center p-4">
                <div
                    class="bg-slate-900 border border-slate-700 rounded-2xl w-full max-w-6xl h-[85vh] flex flex-col shadow-2xl overflow-hidden relative">
                    <!-- Header -->
                    <div class="p-6 border-b border-slate-700 flex justify-between items-center bg-slate-900 z-10">
                        <div>
                            <h2 class="text-2xl font-bold text-white flex items-center gap-2">ğŸ¨ ìŠ¤íƒ€ì¼ ì„ íƒ <span
                                    class="text-orange-500 text-sm bg-orange-500/10 px-2 py-0.5 rounded">Style
                                    Lab</span></h2>
                            <p class="text-slate-400 text-sm mt-1">ë²¤ì¹˜ë§ˆí‚¹í•  ì±„ë„(í˜ë¥´ì†Œë‚˜)ì„ ì„ íƒí•˜ì„¸ìš”.</p>
                        </div>
                        <button onclick="document.getElementById('styleModal').classList.add('hidden')"
                            class="w-10 h-10 rounded-full bg-slate-800 text-slate-400 hover:bg-slate-700 hover:text-white transition-all flex items-center justify-center text-xl">Ã—</button>
                    </div>

                    <!-- Content -->
                    <div class="flex-1 overflow-hidden flex">
                        <!-- Left: Categories -->
                        <div class="w-64 bg-slate-800/30 overflow-y-auto p-4 border-r border-slate-700 space-y-2"
                            id="styleCategories">
                            <!-- Categories injected here -->
                        </div>

                        <!-- Right: Channels -->
                        <div class="flex-1 overflow-y-auto p-8 bg-slate-900/50" id="styleChannelsContainer">
                            <div id="styleChannelsGrid"
                                class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-3 gap-6">
                                <!-- Channels injected here -->
                            </div>
                        </div>
                    </div>

                    <!-- Footer -->
                    <div class="p-6 border-t border-slate-700 bg-slate-800 flex justify-between items-center">
                        <div class="flex items-center gap-4">
                            <div id="selectedStylePreview"
                                class="w-12 h-12 rounded-full bg-slate-700 flex-shrink-0 bg-cover bg-center"></div>
                            <div>
                                <p class="text-slate-400 text-xs">ì„ íƒëœ ìŠ¤íƒ€ì¼</p>
                                <p id="selectedStyleName" class="font-bold text-white text-lg">ì„ íƒí•´ì£¼ì„¸ìš”</p>
                            </div>
                        </div>
                        <button id="startProductionBtn" disabled
                            class="bg-gradient-to-r from-orange-500 to-pink-600 hover:from-orange-400 hover:to-pink-500 text-white font-bold py-3 px-10 rounded-xl disabled:opacity-50 disabled:cursor-not-allowed transition-all shadow-lg transform hover:scale-[1.02]">
                            ğŸš€ ëŒ€ë³¸ ë° ì˜¤ë””ì˜¤ ìƒì„± ì‹œì‘
                        </button>
                    </div>
                </div>
            </div>

            <!-- Transcript Extraction Section (Step 1) -->
            <div id="transcriptStepSection" class="glass-panel rounded-2xl p-8 mb-6 hidden">
                <h2 class="text-2xl font-bold text-white mb-6">ğŸ“ Step 1: ì˜ìƒ ëŒ€ë³¸ ì¶”ì¶œ ê²°ê³¼</h2>

                <!-- Language Info -->
                <div class="bg-slate-800/50 rounded-xl p-4 mb-6">
                    <div class="flex items-center gap-4">
                        <span id="detectedLanguageFlag" class="text-4xl">ğŸŒ</span>
                        <div class="flex-1">
                            <div class="flex items-center gap-3 mb-1">
                                <p class="text-white font-bold text-xl" id="languageName">-</p>
                                <span id="translationBadge"
                                    class="px-3 py-1 bg-green-500/20 text-green-400 rounded-full text-sm font-bold hidden">
                                    ğŸŒ í•œêµ­ì–´ ë²ˆì—­ í¬í•¨
                                </span>
                            </div>
                            <div class="flex gap-3 text-sm">
                                <span class="text-slate-400">
                                    <span class="text-purple-400 font-bold" id="transcriptDuration">-</span>ì´ˆ
                                </span>
                                <span class="text-slate-400">â€¢</span>
                                <span class="text-slate-400">
                                    <span class="text-purple-400 font-bold" id="transcriptSegments">-</span>ê°œ ì„¸ê·¸ë¨¼íŠ¸
                                </span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Bilingual Transcript -->
                <div id="bilingualTranscriptContainer" class="mb-6">
                    <h3 class="text-lg font-bold text-white mb-4">ëŒ€ë³¸ ë‚´ìš©</h3>
                    <div class="space-y-3 max-h-[500px] overflow-y-auto" id="bilingualTranscript">
                        <!-- Dynamic segments will be inserted here -->
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="grid grid-cols-2 gap-3">
                    <button id="copyTranscriptBtn"
                        class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 rounded-lg transition-colors">
                        ğŸ“‹ ëŒ€ë³¸ ë³µì‚¬
                    </button>
                    <button id="extractHighlightsBtn"
                        class="bg-purple-600 hover:bg-purple-500 text-white font-bold py-3 rounded-lg transition-colors">
                        âœ‚ï¸ í•˜ì´ë¼ì´íŠ¸ ì¶”ì¶œ â†’
                    </button>
                </div>
            </div>

            <!-- Highlight Selection Section (Step 2) -->
            <div id="highlightsStepSection" class="glass-panel rounded-2xl p-8 mb-6 hidden">
                <h2 class="text-2xl font-bold text-white mb-6">âœ‚ï¸ Step 2: í•˜ì´ë¼ì´íŠ¸ êµ¬ê°„ ì„ íƒ</h2>

                <p class="text-slate-300 mb-6">AIê°€ ë¶„ì„í•œ ê°€ì¥ ë°”ì´ëŸ´í•˜ê¸° ì¢‹ì€ êµ¬ê°„ë“¤ì…ë‹ˆë‹¤. í•˜ë‚˜ë¥¼ ì„ íƒí•´ ë³´ì„¸ìš”.</p>

                <!-- Highlights Grid -->
                <div id="highlightsGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-8">
                    <!-- Dynamic cards -->
                </div>

                <!-- Manual Selection (Optional) -->
                <div class="bg-slate-800/50 rounded-xl p-4 mb-6 hidden">
                    <h3 class="font-bold text-white mb-2">ìˆ˜ë™ êµ¬ê°„ ì„¤ì •</h3>
                    <div class="flex items-center gap-4">
                        <input type="number" id="manualStart" placeholder="0.0"
                            class="bg-slate-900 border border-slate-700 rounded px-3 py-2 text-white w-24">
                        <span class="text-white">~</span>
                        <input type="number" id="manualEnd" placeholder="10.0"
                            class="bg-slate-900 border border-slate-700 rounded px-3 py-2 text-white w-24">
                    </div>
                </div>

                <div class="flex justify-end">
                    <button id="generateFinalScriptBtn" disabled
                        class="bg-gradient-to-r from-pink-600 to-rose-600 hover:from-pink-500 hover:to-rose-500 text-white font-bold py-3 px-8 rounded-xl transition-all transform hover:scale-[1.05] opacity-50 cursor-not-allowed">
                        ğŸ¬ ì„ íƒí•œ êµ¬ê°„ìœ¼ë¡œ ëŒ€ë³¸ ìƒì„± (Step 3)
                    </button>
                </div>
            </div>

            <!-- Titles Section -->
            <div id="titlesSection" class="glass-panel rounded-2xl p-8 hidden">
                <h2 class="text-2xl font-bold text-white mb-6">ğŸ“ ìƒì„±ëœ Shorts ì œëª©</h2>
                <div id="titlesContent"></div>
            </div>

            <!-- VOICEVOX TTS Section -->
            <div id="voicevoxSection" class="glass-panel rounded-2xl p-8 hidden mt-6">
                <h2 class="text-2xl font-bold text-white mb-6">ğŸ™ï¸ ì¼ë³¸ì–´ TTS ìƒì„± (VOICEVOX)</h2>

                <!-- VOICEVOX Connection Status -->
                <div id="voicevoxStatus" class="mb-6 p-4 rounded-lg border">
                    <div class="flex items-center gap-3">
                        <div class="w-3 h-3 rounded-full" id="voicevoxStatusDot"></div>
                        <span id="voicevoxStatusText" class="text-white font-medium"></span>
                    </div>
                </div>

                <!-- Character Selection -->
                <div class="mb-8">
                    <div class="flex items-baseline justify-between mb-4">
                        <h3 class="text-xl font-bold text-white flex items-center gap-2">ğŸ‘¤ ìºë¦­í„° ì„ íƒ</h3>
                        <a href="https://hub.aivis-project.com/" target="_blank"
                            class="text-[10px] bg-slate-800/80 hover:bg-brand-600/20 text-brand-400 px-3 py-1.5 rounded-full border border-brand-500/30 transition-all flex items-center gap-1.5 group">
                            ğŸŒ AIVISS Hubì—ì„œ ë” ë§ì€ ìºë¦­í„° ë°œê²¬í•˜ê¸°
                            <span class="inline-block transition-transform group-hover:translate-x-0.5">â†’</span>
                        </a>
                    </div>
                    <div class="bg-slate-800/50 rounded-xl p-6">
                        <button id="loadCharactersBtn"
                            class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 rounded-lg mb-4">
                            ìºë¦­í„° ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
                        </button>

                        <!-- Category Tabs -->
                        <div id="categoryTabs" class="hidden mb-4">
                            <div class="flex flex-wrap gap-2 mb-4">
                                <button
                                    class="category-tab px-3 py-2 rounded-lg font-medium transition-all text-sm active"
                                    data-category="all">
                                    ì „ì²´
                                </button>
                                <button class="category-tab px-3 py-2 rounded-lg font-medium transition-all text-sm"
                                    data-category="ì—¬ì„± - ë°ê³  ê·€ì—¬ìš´">
                                    ğŸ‘§ ë°ê³  ê·€ì—¬ìš´
                                </button>
                                <button class="category-tab px-3 py-2 rounded-lg font-medium transition-all text-sm"
                                    data-category="ì—¬ì„± - ì°¨ë¶„í•˜ê³  ì„±ìˆ™">
                                    ğŸ‘© ì°¨ë¶„í•˜ê³  ì„±ìˆ™
                                </button>
                                <button class="category-tab px-3 py-2 rounded-lg font-medium transition-all text-sm"
                                    data-category="ë‚¨ì„± - ì²­ë…„">
                                    ğŸ‘¨ ë‚¨ì„± ì²­ë…„
                                </button>
                                <button class="category-tab px-3 py-2 rounded-lg font-medium transition-all text-sm"
                                    data-category="ë‚¨ì„± - ì¤‘ë…„/íŠ¹ì´">
                                    ğŸ‘´ ë‚¨ì„± ì¤‘ë…„
                                </button>
                                <button class="category-tab px-3 py-2 rounded-lg font-medium transition-all text-sm"
                                    data-category="íŠ¹ìˆ˜ - ë¡œë´‡/ê¸°ê³„">
                                    ğŸ¤– ë¡œë´‡/ê¸°ê³„
                                </button>
                                <button class="category-tab px-3 py-2 rounded-lg font-medium transition-all text-sm"
                                    data-category="íŠ¹ìˆ˜ - íŒíƒ€ì§€">
                                    âœ¨ íŒíƒ€ì§€
                                </button>
                            </div>
                        </div>

                        <div id="charactersGrid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 hidden">
                            <!-- Characters will be loaded here -->
                        </div>
                        <div id="selectedCharacterInfo" class="mt-4 hidden">
                            <div class="bg-blue-500/10 border border-blue-500/20 rounded-lg p-4">
                                <p class="text-blue-400 font-bold mb-2">ì„ íƒí•œ ìºë¦­í„°:</p>
                                <div class="flex items-center gap-4">
                                    <div class="flex-1">
                                        <div class="flex items-baseline gap-2">
                                            <p class="text-white font-medium text-lg" id="selectedCharacterName">ìºë¦­í„°ë¥¼
                                                ì„ íƒí•´ì£¼ì„¸ìš”</p>
                                            <span id="selectedCharacterEngine" class="hidden"></span>
                                        </div>
                                        <p class="text-brand-400 text-sm font-bold" id="selectedCharacterStyle"></p>
                                        <p class="text-slate-500 text-xs mt-1" id="selectedCharacterUseCase"></p>
                                    </div>
                                    <div class="flex gap-2">
                                        <button id="previewCharacterBtn"
                                            class="px-4 py-2 bg-blue-600 hover:bg-blue-500 text-white rounded-lg transition-colors flex items-center gap-2">
                                            ğŸ”Š ë¯¸ë¦¬ë“£ê¸°
                                        </button>
                                        <button id="stopPreviewBtn"
                                            class="px-4 py-2 bg-red-600 hover:bg-red-500 text-white rounded-lg hidden transition-colors flex items-center gap-2">
                                            â¹ï¸ ì •ì§€
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Script Generation -->
                <div class="mb-8">
                    <h3 class="text-xl font-bold text-white mb-4">ğŸ“ ì¼ë³¸ì–´ ëŒ€ë³¸</h3>
                    <div class="bg-slate-800/50 rounded-xl p-6">
                        <div class="flex gap-3 mb-4">
                            <button id="autoGenerateScriptBtn"
                                class="flex-1 bg-purple-600 hover:bg-purple-500 text-white font-bold py-3 rounded-lg">
                                ğŸ¤– ìë™ ìƒì„± (Gemini)
                            </button>
                            <button id="manualScriptBtn"
                                class="flex-1 bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-3 rounded-lg">
                                âœï¸ ì§ì ‘ ì…ë ¥
                            </button>
                        </div>

                        <!-- Timeline Editor -->
                        <div id="timelineEditor" class="space-y-4 hidden">
                            <div class="bg-slate-900/50 rounded-lg p-4">
                                <label class="text-slate-300 font-bold mb-2 block">íƒ€ì„ë¼ì¸ ëŒ€ë³¸</label>
                                <textarea id="scriptTextarea" rows="10"
                                    class="w-full px-4 py-3 bg-slate-800 text-white rounded-lg border border-slate-700 focus:border-purple-500 focus:outline-none font-mono"
                                    placeholder="ì˜ˆì‹œ:
[0-3ì´ˆ] çš†ã•ã‚“ã€ã“ã‚“ã«ã¡ã¯ï¼
[3-10ì´ˆ] ä»Šæ—¥ã¯é¢ç™½ã„å‹•ç”»ã‚’ç´¹ä»‹ã—ã¾ã™
[10-15ì´ˆ] ãƒãƒ£ãƒ³ãƒãƒ«ç™»éŒ²ãŠé¡˜ã„ã—ã¾ã™ï¼"></textarea>
                                <p class="text-slate-500 text-sm mt-2">
                                    ğŸ’¡ íƒ€ì„ë¼ì¸ í˜•ì‹ìœ¼ë¡œ ì…ë ¥í•˜ê±°ë‚˜, ì¼ë°˜ í…ìŠ¤íŠ¸ë¡œ ì…ë ¥í•˜ì„¸ìš”
                                </p>
                            </div>
                        </div>

                        <!-- Generated Script Display -->
                        <div id="generatedScriptDisplay" class="hidden">
                            <div class="bg-green-500/10 border border-green-500/20 rounded-lg p-4 mb-4">
                                <p class="text-green-400 font-bold mb-2">âœ… ëŒ€ë³¸ ìƒì„± ì™„ë£Œ</p>
                                <div id="generatedScriptContent"
                                    class="text-white whitespace-pre-wrap font-mono text-sm">
                                </div>
                            </div>
                            <button id="editGeneratedScriptBtn"
                                class="px-4 py-2 bg-slate-600 hover:bg-slate-500 text-white rounded-lg">
                                âœï¸ ìˆ˜ì •í•˜ê¸°
                            </button>
                        </div>
                    </div>
                </div>

                <!-- TTS Generation -->
                <div class="mb-8">
                    <h3 class="text-xl font-bold text-white mb-4">ğŸµ ìŒì„± ìƒì„±</h3>
                    <div class="bg-slate-800/50 rounded-xl p-6">
                        <button id="generateTTSBtn"
                            class="w-full bg-gradient-to-r from-pink-600 to-purple-600 hover:from-pink-500 hover:to-purple-500 text-white font-bold py-4 rounded-xl transition-all transform hover:scale-[1.02]"
                            disabled>
                            ğŸ™ï¸ TTS ìŒì„± íŒŒì¼ ìƒì„±
                        </button>
                        <p class="text-slate-500 text-sm mt-2 text-center">
                            ìºë¦­í„°ì™€ ëŒ€ë³¸ì„ ì„ íƒí•˜ë©´ ìƒì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤
                        </p>
                    </div>
                </div>

                <!-- Generated Audio -->
                <div id="generatedAudioSection" class="hidden">
                    <div
                        class="bg-gradient-to-r from-green-500/10 to-blue-500/10 border border-green-500/20 rounded-xl p-6">
                        <h3 class="text-xl font-bold text-white mb-4">ğŸ‰ ìŒì„± ìƒì„± ì™„ë£Œ!</h3>
                        <audio id="generatedAudio" controls class="w-full mb-4"></audio>
                        <button id="downloadAudioBtn"
                            class="w-full bg-green-600 hover:bg-green-500 text-white font-bold py-3 rounded-lg">
                            â¬‡ï¸ WAV íŒŒì¼ ë‹¤ìš´ë¡œë“œ
                        </button>
                    </div>
                </div>

            </div>

        </div>

        <!-- Enhanced VOICEVOX UI Script -->
        <script src="voicevox-ui-enhanced.js"></script>

        <script>
            const uploadZone = document.getElementById('uploadZone');
            const uploadPlaceholder = document.getElementById('uploadPlaceholder');
            const uploadInfo = document.getElementById('uploadInfo');
            const videoFileInput = document.getElementById('videoFile');
            const fileName = document.getElementById('fileName');
            const fileSize = document.getElementById('fileSize');
            const uploadForm = document.getElementById('uploadForm');
            const loadingSection = document.getElementById('loadingSection');
            const resultSection = document.getElementById('resultSection');

            window.selectedFile = null;
            window.selectedSpeakerId = null;
            window.selectedCharacterName = '';
            window.currentVideoAnalysis = null;

            // Click to upload
            uploadZone.addEventListener('click', () => {
                videoFileInput.click();
            });

            // File selected
            videoFileInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    handleFile(file);
                }
            });

            // Drag and drop
            // Drag and drop
            uploadZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadZone.classList.add('border-pink-500', 'bg-slate-800');
            });

            uploadZone.addEventListener('dragleave', () => {
                uploadZone.classList.remove('border-pink-500', 'bg-slate-800');
            });

            uploadZone.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadZone.classList.remove('border-pink-500', 'bg-slate-800');
                const file = e.dataTransfer.files[0];
                if (file && file.type.startsWith('video/')) {
                    handleFile(file);
                } else {
                    alert('ë¹„ë””ì˜¤ íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
                }
            });

            function handleFile(file) {
                selectedFile = file;
                fileName.textContent = file.name;
                fileSize.textContent = `${(file.size / 1024 / 1024).toFixed(2)} MB`;
                uploadPlaceholder.classList.add('hidden');
                uploadInfo.classList.remove('hidden');
            }

            // Form submit
            uploadForm.addEventListener('submit', async (e) => {
                e.preventDefault();

                if (!selectedFile) {
                    alert('ë¹„ë””ì˜¤ íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                    return;
                }

                const title = document.getElementById('videoTitle').value;
                const description = document.getElementById('videoDescription').value;

                // Show loading
                loadingSection.classList.remove('hidden');
                resultSection.classList.add('hidden');

                // Prepare form data
                const formData = new FormData();
                formData.append('video', selectedFile);
                formData.append('title', title);
                formData.append('description', description);

                try {
                    const response = await fetch('http://localhost:4000/api/guidelines/check-video', {
                        method: 'POST',
                        body: formData
                    });

                    const data = await response.json();

                    if (!response.ok) {
                        throw new Error(data.error || 'ë¶„ì„ ì‹¤íŒ¨');
                    }

                    // Hide loading, show result
                    loadingSection.classList.add('hidden');
                    displayResult(data.analysis);

                } catch (error) {
                    console.error('Analysis error:', error);
                    loadingSection.classList.add('hidden');
                    alert('ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
                }
            });

            function displayResult(analysis) {
                // Update global state
                window.currentVideoAnalysis = analysis;

                const { overallStatus, score, violations, summary, bgmAnalysis } = analysis;

                // Status badge
                const statusBadge = document.getElementById('statusBadge');
                if (overallStatus === 'safe') {
                    statusBadge.innerHTML = '<span class="px-4 py-2 bg-green-500 text-white rounded-full font-bold">âœ… ì•ˆì „</span>';
                } else if (overallStatus === 'warning') {
                    statusBadge.innerHTML = '<span class="px-4 py-2 bg-yellow-500 text-white rounded-full font-bold">âš ï¸ ì£¼ì˜</span>';
                } else {
                    statusBadge.innerHTML = '<span class="px-4 py-2 bg-red-500 text-white rounded-full font-bold">âŒ ìœ„í—˜</span>';
                }

                // Score
                document.getElementById('score').textContent = score;

                // Summary
                document.getElementById('summary').textContent = summary || 'ë¶„ì„ ì™„ë£Œ';

                // BGM Analysis
                if (bgmAnalysis) {
                    displayBgmAnalysis(bgmAnalysis);
                }

                // Violations
                const violationsContainer = document.getElementById('violationsContainer');
                if (violations && violations.length > 0) {
                    violationsContainer.innerHTML = `
                    <h3 class="text-xl font-bold text-white mb-4">ë°œê²¬ëœ ë¬¸ì œì </h3>
                    ${violations.map(v => `
                        <div class="bg-slate-800/50 rounded-xl p-6 mb-4">
                            <div class="flex items-start gap-4">
                                <div class="flex-shrink-0">
                                    ${v.severity === 'critical' ? 'ğŸ”´' : v.severity === 'high' ? 'ğŸŸ ' : v.severity === 'medium' ? 'ğŸŸ¡' : 'ğŸŸ¢'}
                                </div>
                                <div class="flex-1">
                                    <div class="flex items-center gap-2 mb-2">
                                        <span class="px-2 py-1 bg-slate-700 text-slate-300 rounded text-xs">${v.timestamp || 'ì „ì²´'}</span>
                                        <span class="px-2 py-1 bg-blue-600/20 text-blue-400 rounded text-xs">${v.category}</span>
                                    </div>
                                    <p class="text-white font-bold mb-2">${v.issue}</p>
                                    <p class="text-green-400 text-sm">ğŸ’¡ ê°œì„  ë°©ë²•: ${v.recommendation}</p>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                `;
                } else {
                    violationsContainer.innerHTML = `
                    <div class="bg-green-500/10 rounded-xl p-6 text-center">
                        <div class="text-4xl mb-2">ğŸ‰</div>
                        <p class="text-green-400 font-bold">ë¬¸ì œì ì´ ë°œê²¬ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤!</p>
                    </div>
                `;
                }

                resultSection.classList.remove('hidden');

                // Show VOICEVOX section and check connection
                document.getElementById('voicevoxSection').classList.remove('hidden');
                checkVoicevoxConnection();
            }

            function displayBgmAnalysis(bgm) {
                const bgmSection = document.getElementById('bgmSection');

                // Risk level colors
                const riskColors = {
                    'low': 'text-green-400',
                    'medium': 'text-yellow-400',
                    'high': 'text-red-400'
                };

                const riskIcons = {
                    'low': 'ğŸŸ¢',
                    'medium': 'ğŸŸ¡',
                    'high': 'ğŸ”´'
                };

                bgmSection.innerHTML = `
                <p class="text-slate-400 text-sm mb-4">ğŸµ ë°°ê²½ìŒì•…(BGM) ë¶„ì„</p>
                <div class="space-y-3">
                    <div class="flex items-center justify-between">
                        <span class="text-slate-300">ì €ì‘ê¶Œ ìœ„í—˜ë„</span>
                        <span class="${riskColors[bgm.copyrightRiskLevel] || 'text-gray-400'} font-bold">
                            ${riskIcons[bgm.copyrightRiskLevel] || 'âšª'} ${bgm.copyrightRiskLevel?.toUpperCase() || 'UNKNOWN'}
                        </span>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="text-slate-300">ë¶„ìœ„ê¸° ì í•©ì„±</span>
                        <span class="text-blue-400 font-bold">${bgm.atmosphereMatch || '-'}</span>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="text-slate-300">ìŒëŸ‰/í’ˆì§ˆ</span>
                        <span class="text-purple-400 font-bold">${bgm.volumeQuality || '-'}</span>
                    </div>
                    ${bgm.recommendation ? `
                        <div class="mt-4 pt-4 border-t border-slate-700">
                            <p class="text-emerald-400 text-sm">ğŸ’¡ ${bgm.recommendation}</p>
                        </div>
                    ` : ''}
                </div>
            `;
            }

            // Title generation handler
            document.getElementById('generateTitlesBtn').addEventListener('click', async () => {
                if (!selectedFile) {
                    alert('ë¨¼ì € ë¹„ë””ì˜¤ íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                    return;
                }

                const title = document.getElementById('videoTitle').value;
                const description = document.getElementById('videoDescription').value;

                // Show loading
                const btn = document.getElementById('generateTitlesBtn');
                const originalText = btn.textContent;
                btn.textContent = 'â³ ì œëª© ìƒì„± ì¤‘...';
                btn.disabled = true;

                // Prepare form data
                const formData = new FormData();
                formData.append('video', selectedFile);
                formData.append('title', title);
                formData.append('description', description);

                try {
                    const response = await fetch('http://localhost:4000/api/guidelines/generate-titles', {
                        method: 'POST',
                        body: formData
                    });

                    const data = await response.json();

                    if (!response.ok) {
                        throw new Error(data.error || 'ì œëª© ìƒì„± ì‹¤íŒ¨');
                    }

                    displayTitles(data.titles);

                } catch (error) {
                    console.error('Title generation error:', error);
                    alert('ì œëª© ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
                } finally {
                    btn.textContent = originalText;
                    btn.disabled = false;
                }
            });

            function displayTitles(titles) {
                const titlesSection = document.getElementById('titlesSection');
                const titlesContent = document.getElementById('titlesContent');

                titlesContent.innerHTML = `
                <!-- Video Interpretation -->
                ${titles.videoInterpretation ? `
                    <div class="bg-blue-500/10 border border-blue-500/20 rounded-xl p-6 mb-6">
                        <div class="flex items-start gap-3">
                            <div class="text-2xl">ğŸ¬</div>
                            <div>
                                <h3 class="text-blue-400 font-bold mb-2">ì˜ìƒ í•´ì„</h3>
                                <p class="text-slate-300 leading-relaxed">${titles.videoInterpretation}</p>
                            </div>
                        </div>
                    </div>
                ` : ''}

                <!-- Korean Titles -->
                <div class="mb-6">
                    <h3 class="text-xl font-bold text-white mb-4 flex items-center gap-2">
                        ğŸ‡°ğŸ‡· í•œêµ­ì–´ ì œëª©
                    </h3>
                    <div class="space-y-2">
                        ${titles.korean?.map((t, i) => `
                            <div class="bg-slate-800/50 rounded-lg p-4 hover:bg-slate-700/50 cursor-pointer transition-colors"
                                 onclick="copyToClipboard('${t.replace(/'/g, "\\'")}', 'í•œêµ­ì–´ ì œëª© ${i + 1}')">
                                <div class="flex items-center justify-between">
                                    <span class="text-white font-medium">${i + 1}. ${t}</span>
                                    <span class="text-slate-500 text-sm">ğŸ“‹ ë³µì‚¬</span>
                                </div>
                            </div>
                        `).join('') || '<p class="text-slate-500">ìƒì„±ëœ ì œëª©ì´ ì—†ìŠµë‹ˆë‹¤</p>'}
                    </div>
                </div>

                <!-- Japanese Titles -->
                <div class="mb-6">
                    <h3 class="text-xl font-bold text-white mb-4 flex items-center gap-2">
                        ğŸ‡¯ğŸ‡µ ì¼ë³¸ì–´ ì œëª©
                    </h3>
                    <div class="space-y-2">
                        ${titles.japanese?.map((t, i) => `
                            <div class="bg-slate-800/50 rounded-lg p-4 hover:bg-slate-700/50 cursor-pointer transition-colors"
                                 onclick="copyToClipboard('${t.replace(/'/g, "\\'")}', 'ì¼ë³¸ì–´ ì œëª© ${i + 1}')">
                                <div class="flex items-center justify-between">
                                    <span class="text-white font-medium">${i + 1}. ${t}</span>
                                    <span class="text-slate-500 text-sm">ğŸ“‹ ë³µì‚¬</span>
                                </div>
                            </div>
                        `).join('') || '<p class="text-slate-500">ìƒì„±ëœ ì œëª©ì´ ì—†ìŠµë‹ˆë‹¤</p>'}
                    </div>
                </div>

                <!-- Japanese Pronunciation -->
                <div class="mb-6">
                    <h3 class="text-xl font-bold text-white mb-4 flex items-center gap-2">
                        ğŸ—£ï¸ ì¼ë³¸ì–´ ë°œìŒ (í•œê¸€)
                    </h3>
                    <div class="space-y-2">
                        ${titles.japanesePronunciation?.map((t, i) => `
                            <div class="bg-slate-800/50 rounded-lg p-4 hover:bg-slate-700/50 cursor-pointer transition-colors"
                                 onclick="copyToClipboard('${t.replace(/'/g, "\\'")}', 'ì¼ë³¸ì–´ ë°œìŒ ${i + 1}')">
                                <div class="flex items-center justify-between">
                                    <span class="text-white font-medium">${i + 1}. ${t}</span>
                                    <span class="text-slate-500 text-sm">ğŸ“‹ ë³µì‚¬</span>
                                </div>
                            </div>
                        `).join('') || '<p class="text-slate-500">ìƒì„±ëœ ì œëª©ì´ ì—†ìŠµë‹ˆë‹¤</p>'}
                    </div>
                </div>
            `;

                titlesSection.classList.remove('hidden');
                titlesSection.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }

            function copyToClipboard(text, label) {
                navigator.clipboard.writeText(text).then(() => {
                    // Show toast notification
                    const toast = document.createElement('div');
                    toast.className = 'fixed bottom-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50';
                    toast.textContent = `âœ… ${label} ë³µì‚¬ë¨!`;
                    document.body.appendChild(toast);

                    setTimeout(() => {
                        toast.remove();
                    }, 2000);
                }).catch(err => {
                    console.error('Copy failed:', err);
                    alert('ë³µì‚¬ ì‹¤íŒ¨: ' + err.message);
                });
            }

            // ========================================
            // VOICEVOX TTS Functions
            // ========================================

            // Check VOICEVOX connection status
            async function checkVoicevoxConnection() {
                try {
                    const response = await fetch('http://localhost:4000/api/voicevox/speakers');
                    const data = await response.json();

                    if (response.ok && data.success) {
                        updateVoicevoxStatus(true, `ì—°ê²°ë¨ (${data.count}ê°œ ìºë¦­í„°)`);
                        return true;
                    } else {
                        updateVoicevoxStatus(false, 'VOICEVOX ì„œë²„ì— ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                        return false;
                    }
                } catch (error) {
                    updateVoicevoxStatus(false, 'VOICEVOXê°€ ì‹¤í–‰ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤');
                    return false;
                }
            }

            function updateVoicevoxStatus(isConnected, message) {
                const dot = document.getElementById('voicevoxStatusDot');
                const text = document.getElementById('voicevoxStatusText');
                const statusDiv = document.getElementById('voicevoxStatus');

                if (isConnected) {
                    dot.className = 'w-3 h-3 rounded-full bg-green-500 animate-pulse';
                    text.textContent = message;
                    statusDiv.className = 'mb-6 p-4 rounded-lg border border-green-500/20 bg-green-500/10';
                } else {
                    dot.className = 'w-3 h-3 rounded-full bg-red-500';
                    text.textContent = message;
                    statusDiv.className = 'mb-6 p-4 rounded-lg border border-red-500/20 bg-red-500/10';
                }
            }

            // Load VOICEVOX characters
            document.getElementById('loadCharactersBtn').addEventListener('click', async () => {
                const btn = document.getElementById('loadCharactersBtn');
                const originalText = btn.textContent;
                btn.textContent = 'â³ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...';
                btn.disabled = true;

                try {
                    const response = await fetch('http://localhost:4000/api/voicevox/speakers');
                    const data = await response.json();

                    if (!response.ok) {
                        throw new Error(data.message || 'ìºë¦­í„° ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                    }

                    displayCharacters(data.speakers);
                    document.getElementById('charactersGrid').classList.remove('hidden');

                } catch (error) {
                    alert('ì˜¤ë¥˜: ' + error.message + '\n\nVOICEVOX ì•±ì„ ì‹¤í–‰í•´ì£¼ì„¸ìš”');
                } finally {
                    btn.textContent = originalText;
                    btn.disabled = false;
                }
            });

            function displayCharacters(speakers) {
                const grid = document.getElementById('charactersGrid');
                grid.innerHTML = '';

                speakers.forEach(speaker => {
                    speaker.styles.forEach(style => {
                        const card = document.createElement('div');
                        card.className = 'bg-slate-700/50 hover:bg-slate-600/50 rounded-lg p-4 cursor-pointer transition-all border-2 border-transparent hover:border-blue-500';
                        card.onclick = () => selectCharacter(style.id, speaker.nameKr || speaker.name, style.nameKr || style.name, speaker.useCase || '');

                        // Use character image if available, otherwise fallback to emoji
                        const imageHtml = speaker.imageUrl
                            ? `<img src="${speaker.imageUrl}" alt="${speaker.name}" class="w-16 h-16 mx-auto mb-2 rounded-full object-cover" onerror="this.onerror=null; this.outerHTML='<div class=\\'text-4xl mb-2\\'>ğŸ¤</div>';">`
                            : '<div class="text-4xl mb-2">ğŸ¤</div>';

                        card.innerHTML = `
                        <div class="text-center">
                            ${imageHtml}
                            <p class="text-white font-bold text-sm mb-1">${speaker.nameKr || speaker.name}</p>
                            <p class="text-slate-400 text-xs">${style.nameKr || style.name}</p>
                            ${speaker.gender ? `<p class="text-slate-500 text-xs mt-1">${speaker.gender === 'female' ? 'ğŸ‘§' : speaker.gender === 'male' ? 'ğŸ‘¦' : 'ğŸ¤–'}</p>` : ''}
                        </div>
                    `;

                        grid.appendChild(card);
                    });
                });
            }

            function selectCharacter(speakerId, characterName, styleName, useCase = '') {
                window.selectedSpeakerId = speakerId;
                window.selectedCharacterName = `${characterName} (${styleName})`;

                // Update selected character info
                document.getElementById('selectedCharacterIcon').textContent = 'ğŸ¤';
                document.getElementById('selectedCharacterName').textContent = characterName;
                document.getElementById('selectedCharacterStyle').textContent = styleName;
                document.getElementById('selectedCharacterUseCase').textContent = useCase ? `ìš©ë„: ${useCase}` : '';
                document.getElementById('selectedCharacterInfo').classList.remove('hidden');

                // Enable TTS generation if script is ready
                checkTTSButtonState();

                console.log(`Selected character: ${selectedCharacterName}, ID: ${speakerId}`);
            }

            // Preview character voice
            document.getElementById('previewCharacterBtn').addEventListener('click', async () => {
                if (!window.selectedSpeakerId) {
                    alert('ìºë¦­í„°ë¥¼ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”');
                    return;
                }

                const btn = document.getElementById('previewCharacterBtn');
                const originalText = btn.textContent;
                btn.textContent = 'â³ ìƒì„± ì¤‘...';
                btn.disabled = true;

                try {
                    const response = await fetch('http://localhost:4000/api/voicevox/preview', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            speakerId: window.selectedSpeakerId,
                            sampleText: 'ã“ã‚“ã«ã¡ã¯ã€ã‚ˆã‚ã—ããŠé¡˜ã„ã—ã¾ã™ã€‚'
                        })
                    });

                    if (!response.ok) {
                        throw new Error('ìƒ˜í”Œ ìŒì„± ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
                    }

                    const audioBlob = await response.blob();
                    const audioUrl = URL.createObjectURL(audioBlob);
                    const audio = new Audio(audioUrl);
                    audio.play();

                } catch (error) {
                    alert('ì˜¤ë¥˜: ' + error.message);
                } finally {
                    btn.textContent = originalText;
                    btn.disabled = false;
                }
            });

            // Manual script input (Always allowed)
            document.getElementById('manualScriptBtn').addEventListener('click', () => {
                document.getElementById('timelineEditor').classList.remove('hidden');
                document.getElementById('generatedScriptDisplay').classList.add('hidden');
                checkTTSButtonState();

                // Ensure section is visible if opened manually (e.g. future standalone mode)
                // In current layout, buttons are inside the section, so section must be visible first.
                // But just in case we add a global entry point:
                document.getElementById('voicevoxSection').classList.remove('hidden');
                checkVoicevoxConnection();
            });

            // Auto generate script with Gemini
            document.getElementById('autoGenerateScriptBtn').addEventListener('click', async () => {
                if (!window.currentVideoAnalysis) {
                    alert('âš ï¸ ìë™ ëŒ€ë³¸ ìƒì„±ì€ ì˜ìƒ ë¶„ì„ ë°ì´í„°ê°€ í•„ìš”í•©ë‹ˆë‹¤.\në¨¼ì € ìƒë‹¨ì˜ "ê°€ì´ë“œë¼ì¸ ë¶„ì„ ì‹œì‘"ì„ ì§„í–‰í•´ì£¼ì„¸ìš”.\n\n(ì§ì ‘ ì…ë ¥ì€ ì–¸ì œë“ ì§€ ê°€ëŠ¥í•©ë‹ˆë‹¤!)');
                    return;
                }

                const btn = document.getElementById('autoGenerateScriptBtn');
                const originalText = btn.textContent;
                btn.textContent = 'â³ Geminië¡œ ìƒì„± ì¤‘...';
                btn.disabled = true;

                try {
                    const response = await fetch('http://localhost:4000/api/voicevox/generate-script', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            videoAnalysis: window.currentVideoAnalysis,
                            duration: 15
                        })
                    });

                    const data = await response.json();

                    if (!response.ok) {
                        throw new Error(data.message || 'ëŒ€ë³¸ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
                    }

                    displayGeneratedScript(data.script);

                } catch (error) {
                    alert('ì˜¤ë¥˜: ' + error.message);
                } finally {
                    btn.textContent = originalText;
                    btn.disabled = false;
                }
            });

            function displayGeneratedScript(script) {
                let scriptSummary = script.scriptSummary || 'ì¼ë³¸ì–´ ì‡¼ì¸  ëŒ€ë³¸ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.';
                let scriptText = '';

                if (script.timeline) {
                    script.timeline.forEach(segment => {
                        // Display Format: [0-3ì´ˆ] JP: ... / KR: ... / ë°œìŒ: ...
                        scriptText += `[${segment.start}-${segment.end}ì´ˆ]\n`;
                        scriptText += `ğŸ‡¯ğŸ‡µ ì¼ë³¸ì–´: ${segment.text_jp}\n`;
                        scriptText += `ğŸ‡°ğŸ‡· í•œêµ­ì–´: ${segment.text_kr}\n`;
                        scriptText += `ğŸ—£ï¸ ë°œìŒ: ${segment.text_pron}\n\n`;
                    });
                }

                document.getElementById('generatedScriptContent').innerHTML = `
                    <div class="mb-4 text-brand-400 font-bold">${scriptSummary}</div>
                    <div class="whitespace-pre-wrap font-medium">${scriptText}</div>
                `;
                document.getElementById('generatedScriptDisplay').classList.remove('hidden');
                document.getElementById('timelineEditor').classList.add('hidden');

                // Copy to textarea for potential editing
                document.getElementById('scriptTextarea').value = scriptText;

                checkTTSButtonState();
            }

            // Edit generated script
            document.getElementById('editGeneratedScriptBtn').addEventListener('click', () => {
                document.getElementById('timelineEditor').classList.remove('hidden');
                document.getElementById('generatedScriptDisplay').classList.add('hidden');
            });

            // Generate TTS
            document.getElementById('generateTTSBtn').addEventListener('click', async () => {
                if (!window.selectedSpeakerId) {
                    alert('ìºë¦­í„°ë¥¼ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”');
                    return;
                }

                const scriptText = document.getElementById('scriptTextarea').value.trim();
                if (!scriptText) {
                    alert('ëŒ€ë³¸ì„ ì…ë ¥í•´ì£¼ì„¸ìš”');
                    return;
                }

                // Extract Japanese text for TTS
                // We need to extract the parts after "ğŸ‡¯ğŸ‡µ ì¼ë³¸ì–´: " and before the next line
                const lines = scriptText.split('\n');
                let cleanText = '';

                if (scriptText.includes('ğŸ‡¯ğŸ‡µ ì¼ë³¸ì–´:')) {
                    // Trilingual format
                    cleanText = lines
                        .filter(line => line.includes('ğŸ‡¯ğŸ‡µ ì¼ë³¸ì–´:'))
                        .map(line => line.replace('ğŸ‡¯ğŸ‡µ ì¼ë³¸ì–´:', '').trim())
                        .join('\n');
                } else {
                    // Legacy or direct format
                    cleanText = lines
                        .map(line => line.replace(/^\[.*?\]\s*/, '')) // Remove [0-3ì´ˆ] markers
                        .filter(line => line.trim())
                        .join('\n');
                }

                const btn = document.getElementById('generateTTSBtn');
                const originalText = btn.textContent;
                btn.textContent = 'â³ ìŒì„± ìƒì„± ì¤‘...';
                btn.disabled = true;

                try {
                    const response = await fetch('http://localhost:4000/api/voicevox/generate-tts', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            text: cleanText,
                            speakerId: window.selectedSpeakerId,
                            engineUrl: window.selectedEngineUrl,
                            filename: `tts_${window.selectedSpeakerId}_${Date.now()}.wav`
                        })
                    });

                    if (!response.ok) {
                        throw new Error('TTS ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
                    }

                    const audioBlob = await response.blob();
                    const audioUrl = URL.createObjectURL(audioBlob);

                    // Display generated audio
                    const audio = document.getElementById('generatedAudio');
                    audio.src = audioUrl;
                    document.getElementById('generatedAudioSection').classList.remove('hidden');

                    // Setup download
                    document.getElementById('downloadAudioBtn').onclick = () => {
                        const a = document.createElement('a');
                        a.href = audioUrl;
                        a.download = `voicevox_tts_${Date.now()}.wav`;
                        a.click();
                    };

                    // Scroll to audio section
                    document.getElementById('generatedAudioSection').scrollIntoView({
                        behavior: 'smooth',
                        block: 'center'
                    });

                } catch (error) {
                    alert('ì˜¤ë¥˜: ' + error.message);
                } finally {
                    btn.textContent = originalText;
                    btn.disabled = false;
                }
            });

            function checkTTSButtonState() {
                const scriptText = document.getElementById('scriptTextarea').value.trim();
                const btn = document.getElementById('generateTTSBtn');
                const helpText = btn.nextElementSibling;

                if (window.selectedSpeakerId && scriptText) {
                    btn.disabled = false;
                    btn.classList.remove('opacity-50', 'cursor-not-allowed', 'grayscale');
                    btn.classList.add('hover:scale-[1.02]', 'hover:shadow-lg', 'hover:shadow-purple-500/20');
                    if (helpText) helpText.textContent = 'ğŸ‘† ì´ì œ ìŒì„± íŒŒì¼ì„ ìƒì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤!';
                } else {
                    btn.disabled = true;
                    btn.classList.add('opacity-50', 'cursor-not-allowed', 'grayscale');
                    btn.classList.remove('hover:scale-[1.02]');
                    if (helpText) helpText.textContent = 'ìºë¦­í„°ì™€ ëŒ€ë³¸ì„ ì„ íƒí•˜ë©´ ìƒì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤';
                }
            }

            // Listen for script changes
            document.getElementById('scriptTextarea').addEventListener('input', checkTTSButtonState);

            // ========================================
            // TRANSCRIPT EXTRACTION (Step 1)
            // ========================================

            // Whisper Provider Selection
            let selectedWhisperProvider = 'openai'; // Default to OpenAI

            window.selectWhisperProvider = function (provider) {
                selectedWhisperProvider = provider;

                const openAIBtn = document.getElementById('whisperOpenAI');
                const hfBtn = document.getElementById('whisperHF');

                if (provider === 'openai') {
                    // Highlight OpenAI button
                    openAIBtn.className = 'px-4 py-2 rounded-full font-bold text-sm transition-all bg-gradient-to-r from-green-600 to-blue-600 text-white shadow-lg';
                    hfBtn.className = 'px-4 py-2 rounded-full font-bold text-sm transition-all text-slate-400 hover:text-white';
                } else {
                    // Highlight HuggingFace button
                    openAIBtn.className = 'px-4 py-2 rounded-full font-bold text-sm transition-all text-slate-400 hover:text-white';
                    hfBtn.className = 'px-4 py-2 rounded-full font-bold text-sm transition-all bg-gradient-to-r from-purple-600 to-pink-600 text-white shadow-lg';
                }

                console.log('[Whisper Provider] Selected:', provider);
            }

            // Extract transcript button handler
            document.getElementById('extractTranscriptBtn').addEventListener('click', async () => {
                if (!selectedFile) {
                    alert('ë¨¼ì € ë¹„ë””ì˜¤ íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                    return;
                }

                const transcriptSection = document.getElementById('transcriptStepSection');

                // Generate cache key (filename + size)
                const cacheKey = `transcript_${selectedFile.name}_${selectedFile.size}`;

                // Check localStorage cache first
                const cachedTranscript = localStorage.getItem(cacheKey);
                if (cachedTranscript) {
                    try {
                        const transcript = JSON.parse(cachedTranscript);
                        console.log('[Cache] ğŸ’¾ Using cached transcript');

                        // Show cached indicator
                        transcriptSection.classList.remove('hidden');
                        document.getElementById('bilingualTranscript').innerHTML = `
                            <div class="flex items-center justify-center p-8 bg-green-500/10 border border-green-500/20 rounded-xl mb-4">
                                <div class="text-center">
                                    <div class="text-4xl mb-2">ğŸ’¾</div>
                                    <p class="text-green-400 font-bold text-lg">ìºì‹œëœ ëŒ€ë³¸ ì‚¬ìš© ì¤‘</p>
                                    <p class="text-slate-400 text-sm mt-1">ì´ì „ì— ì¶”ì¶œí•œ ëŒ€ë³¸ì„ ì¬ì‚¬ìš©í•©ë‹ˆë‹¤ (ë¬´ë£Œ!)</p>
                                    <button onclick="document.getElementById('extractTranscriptBtn').dataset.forceRefresh='true'; document.getElementById('extractTranscriptBtn').click();"
                                        class="mt-3 text-xs bg-slate-700 hover:bg-slate-600 text-white px-3 py-1.5 rounded transition-colors">
                                        ğŸ”„ ëŒ€ë³¸ ì¬ì¶”ì¶œ (API ì¬í˜¸ì¶œ)
                                    </button>
                                </div>
                            </div>
                        `;

                        // Display immediately
                        setTimeout(() => {
                            currentTranscriptData = transcript;
                            displayBilingualTranscript(transcript);
                            transcriptSection.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                        }, 100);

                        return; // Exit early, don't call API
                    } catch (e) {
                        console.error('[Cache] Error parsing cached data:', e);
                        localStorage.removeItem(cacheKey); // Remove corrupted cache
                    }
                }

                // Check if force refresh
                const extractBtn = document.getElementById('extractTranscriptBtn');
                const forceRefresh = extractBtn.dataset.forceRefresh === 'true';
                if (forceRefresh) {
                    delete extractBtn.dataset.forceRefresh;
                    localStorage.removeItem(cacheKey); // Clear cache for force refresh
                }

                // Show section & reset
                transcriptSection.classList.remove('hidden');

                const providerName = selectedWhisperProvider === 'openai' ? 'OpenAI (ìœ ë£Œ)' : 'HuggingFace (ë¬´ë£Œ)';
                document.getElementById('bilingualTranscript').innerHTML = `
                    <div class="flex items-center justify-center p-12">
                        <div class="text-center">
                            <div class="loader w-12 h-12 border-4 border-t-purple-500 mx-auto mb-4"></div>
                            <p class="text-white font-bold text-lg">ëŒ€ë³¸ ì¶”ì¶œ ì¤‘...</p>
                            <p class="text-slate-400 text-sm mt-2">${providerName} Whisper ASR</p>
                        </div>
                    </div>
                `;

                // Prepare form data with provider selection
                const formData = new FormData();
                formData.append('video', selectedFile);
                formData.append('provider', selectedWhisperProvider); // Send provider choice

                try {
                    const response = await fetch('http://localhost:4000/api/guidelines/extract-transcript', {
                        method: 'POST',
                        body: formData
                    });

                    const data = await response.json();

                    if (!response.ok) {
                        throw new Error(data.error || 'ëŒ€ë³¸ ì¶”ì¶œ ì‹¤íŒ¨');
                    }

                    // Store for next step
                    currentTranscriptData = data.transcript;

                    // Save to localStorage cache
                    try {
                        localStorage.setItem(cacheKey, JSON.stringify(data.transcript));
                        console.log('[Cache] ğŸ’¾ Transcript cached successfully');
                    } catch (e) {
                        console.warn('[Cache] Failed to cache transcript:', e);
                    }

                    // Display transcript
                    displayBilingualTranscript(data.transcript);

                    // Scroll to results
                    transcriptSection.scrollIntoView({ behavior: 'smooth', block: 'nearest' });

                } catch (error) {
                    console.error('Transcript extraction error:', error);
                    document.getElementById('bilingualTranscript').innerHTML = `
                        <div class="p-6 bg-red-500/10 border border-red-500/20 rounded-lg text-center">
                            <p class="text-red-400 font-bold mb-2">âŒ ì˜¤ë¥˜ ë°œìƒ</p>
                            <p class="text-slate-300 text-sm">${error.message}</p>
                        </div>
                    `;
                }
            });

            function displayBilingualTranscript(transcript) {
                // Update language info
                const languageFlags = {
                    'English': 'ğŸ‡ºğŸ‡¸',
                    'english': 'ğŸ‡ºğŸ‡¸',
                    'í•œêµ­ì–´': 'ğŸ‡°ğŸ‡·',
                    'korean': 'ğŸ‡°ğŸ‡·',
                    'æ—¥æœ¬èª': 'ğŸ‡¯ğŸ‡µ',
                    'japanese': 'ğŸ‡¯ğŸ‡µ',
                    'ä¸­æ–‡': 'ğŸ‡¨ğŸ‡³',
                    'chinese': 'ğŸ‡¨ğŸ‡³'
                };

                document.getElementById('detectedLanguageFlag').textContent = languageFlags[transcript.languageName] || 'ğŸŒ';
                document.getElementById('languageName').textContent = transcript.languageName;
                document.getElementById('transcriptDuration').textContent = transcript.duration.toFixed(1);
                document.getElementById('transcriptSegments').textContent = transcript.segments.length;

                // Show translation badge if has translation
                if (transcript.hasTranslation) {
                    document.getElementById('translationBadge').classList.remove('hidden');
                }

                // Build bilingual segments
                const segmentsHTML = transcript.segments.map((seg, i) => {
                    const emotionColor = seg.emotion === 'excitement' ? 'border-yellow-400' :
                        seg.emotion === 'tension' ? 'border-red-400' :
                            seg.emotion === 'surprise' ? 'border-orange-400' :
                                'border-blue-400';

                    const showBilingual = transcript.hasTranslation;

                    return `
                        <div class="bg-slate-800/50 rounded-xl p-4 border-l-4 ${emotionColor}">
                            <div class="flex items-center gap-2 mb-3">
                                <span class="text-xs font-mono text-purple-300">${formatTime(seg.start)} â†’ ${formatTime(seg.end)}</span>
                                ${seg.emotion ? `<span class="text-xs bg-pink-500/30 px-2 py-0.5 rounded">${seg.emotion}</span>` : ''}
                            </div>
                            ${showBilingual ? `
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <p class="text-xs text-slate-400 mb-1">${languageFlags[transcript.languageName] || 'ğŸŒ'} Original</p>
                                        <p class="text-white">${seg.text}</p>
                                    </div>
                                    <div>
                                        <p class="text-xs text-slate-400 mb-1">ğŸ‡°ğŸ‡· í•œêµ­ì–´</p>
                                        <p class="text-white">${seg.textKo}</p>
                                    </div>
                                </div>
                            ` : `
                                <p class="text-white">${seg.text}</p>
                            `}
                        </div>
                    `;
                }).join('');

                document.getElementById('bilingualTranscript').innerHTML = segmentsHTML;
            }

            // Copy transcript button
            document.getElementById('copyTranscriptBtn').addEventListener('click', () => {
                const transcriptDiv = document.getElementById('bilingualTranscript');
                const segments = transcriptDiv.querySelectorAll('.bg-slate-800\\/50');

                let textToCopy = '';
                segments.forEach((seg) => {
                    const text = seg.textContent.trim();
                    textToCopy += text + '\n\n';
                });

                navigator.clipboard.writeText(textToCopy).then(() => {
                    const btn = document.getElementById('copyTranscriptBtn');
                    const originalText = btn.textContent;
                    btn.textContent = 'âœ… ë³µì‚¬ ì™„ë£Œ!';
                    setTimeout(() => {
                        btn.textContent = originalText;
                    }, 2000);
                }).catch(err => {
                    alert('ë³µì‚¬ ì‹¤íŒ¨: ' + err.message);
                });
            });

            // Current transcript data buffer
            let currentTranscriptData = null;
            let selectedHighlight = null;

            // Extract highlights button
            document.getElementById('extractHighlightsBtn').addEventListener('click', async () => {
                if (!currentTranscriptData) {
                    alert('ë¨¼ì € ëŒ€ë³¸ì„ ì¶”ì¶œí•´ì£¼ì„¸ìš”.');
                    return;
                }

                const highlightsSection = document.getElementById('highlightsStepSection');
                const highlightsGrid = document.getElementById('highlightsGrid');

                // Show section & loading
                highlightsSection.classList.remove('hidden');
                highlightsGrid.innerHTML = `
                    <div class="col-span-full flex items-center justify-center p-12">
                        <div class="text-center">
                            <div class="loader w-12 h-12 border-4 border-t-pink-500 mx-auto mb-4"></div>
                            <p class="text-white font-bold text-xl">AIê°€ ë°”ì´ëŸ´ êµ¬ê°„ ë¶„ì„ ì¤‘...</p>
                            <p class="text-slate-400 text-sm mt-2">Hook, ê°ì •ì„ , ê¸°ìŠ¹ì „ê²° ë¶„ì„</p>
                        </div>
                    </div>
                `;

                highlightsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });

                try {
                    const response = await fetch('http://localhost:4000/api/guidelines/extract-highlights', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            transcript: currentTranscriptData
                        })
                    });

                    const data = await response.json();

                    if (!response.ok) {
                        throw new Error(data.error || 'í•˜ì´ë¼ì´íŠ¸ ì¶”ì¶œ ì‹¤íŒ¨');
                    }

                    // Display Director Plan
                    if (data.directorPlan) {
                        displayDirectorPlan(
                            data.directorPlan,
                            data.viralTitle,
                            data.loopStrategy,
                            data.thumbnailText,
                            data.sourceInfo
                        );
                    } else if (data.highlights) {
                        // Fallback for old version
                        displayHighlights(data.highlights);
                    }

                } catch (error) {
                    console.error('Highlight extraction error:', error);
                    highlightsGrid.innerHTML = `
                        <div class="col-span-full p-6 bg-red-500/10 border border-red-500/20 rounded-lg text-center">
                            <p class="text-red-400 font-bold mb-2">âŒ ì˜¤ë¥˜ ë°œìƒ</p>
                            <p class="text-slate-300 text-sm">${error.message}</p>
                        </div>
                    `;
                }
            });

            function displayDirectorPlan(plan, viralTitle, loopStrategy, thumbnailText, sourceInfo) {
                const grid = document.getElementById('highlightsGrid');
                grid.innerHTML = ''; // Clear existing

                // Title Card with Loop Strategy, Thumbnail, Source
                const titleCard = document.createElement('div');
                titleCard.className = 'col-span-full bg-gradient-to-r from-purple-900/50 to-blue-900/50 p-6 rounded-xl border border-purple-500/30 mb-4';
                titleCard.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <h3 class="text-xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-pink-400 mb-2">
                                ğŸ¬ AI Director's Cut ì„¤ê³„ë„
                            </h3>
                            <p class="text-white text-lg font-bold">ì œëª©ì•ˆ: ${viralTitle || 'ì œëª© ë¯¸ì •'}</p>
                            <p class="text-slate-400 text-sm mt-1">ì´ ì„¤ê³„ë„ë¥¼ ë”°ë¼ CapCutì—ì„œ í¸ì§‘í•˜ì„¸ìš”.</p>
                            
                            ${thumbnailText ? `
                            <div class="mt-4 bg-slate-800/50 border border-slate-700 rounded-lg p-3 max-w-md">
                                <span class="text-yellow-400 font-bold text-xs block mb-2">ğŸ¨ ì¸ë„¤ì¼ ë¬¸êµ¬ (CapCutìš©)</span>
                                <div class="text-white font-black text-xl leading-tight mb-1">${thumbnailText.line1}</div>
                                <div class="text-slate-300 font-bold text-base">${thumbnailText.line2}</div>
                            </div>` : ''}
                            
                            ${sourceInfo && sourceInfo !== 'Unknown' ? `
                            <div class="mt-2 inline-block bg-blue-500/20 border border-blue-500/30 rounded px-2 py-1">
                                <span class="text-blue-300 text-xs">ğŸ“º ì¶œì²˜: ${sourceInfo}</span>
                            </div>` : ''}
                        </div>
                        ${loopStrategy ? `
                        <div class="bg-indigo-500/20 border border-indigo-500/50 rounded-lg p-3 max-w-sm ml-4">
                            <span class="text-indigo-300 font-bold text-xs block mb-1">ğŸ”„ Infinite Loop Strategy</span>
                            <p class="text-indigo-100 text-xs leading-tight">${loopStrategy}</p>
                        </div>` : ''}
                    </div>
                `;
                grid.appendChild(titleCard);

                // Add Download Buttons
                grid.parentElement.insertAdjacentHTML('afterbegin', `
                    <div class="flex gap-2 mb-4 justify-end">
                        <button onclick="downloadFullTranscript()" class="bg-indigo-600 hover:bg-indigo-500 text-white px-3 py-1.5 rounded-lg text-sm font-bold flex items-center gap-2 transition-colors">
                            ğŸ“„ ì „ì²´ ëŒ€ë³¸ ë‹¤ìš´ë¡œë“œ (.txt)
                        </button>
                        <button onclick="downloadDirectorScript()" class="bg-purple-600 hover:bg-purple-500 text-white px-3 py-1.5 rounded-lg text-sm font-bold flex items-center gap-2 transition-colors">
                            ğŸ¬ í•˜ì´ë¼ì´íŠ¸ ëŒ€ë³¸ ë‹¤ìš´ë¡œë“œ (.txt)
                        </button>
                    </div>
                `);

                // Render Plan Items
                plan.forEach((scene, index) => {
                    const duration = (scene.end - scene.start).toFixed(1);
                    const sceneCard = document.createElement('div');
                    sceneCard.className = `col-span-full bg-slate-800/50 border border-slate-700 p-5 rounded-xl hover:border-purple-500 transition-colors group`;

                    const badgeColor = scene.stage.includes('Intro') ? 'bg-pink-600' :
                        scene.stage.includes('Body') ? 'bg-blue-600' :
                            scene.stage.includes('Climax') ? 'bg-orange-600' : 'bg-gray-600';

                    // Prepare Narration & SFX HTML
                    const narrationHtml = (scene.narration_kr || scene.narration_jp) ? `
                        <div class="mt-3 bg-gradient-to-r from-green-900/30 to-blue-900/30 p-4 rounded-lg border border-green-500/30">
                            <span class="text-[11px] text-green-400 font-bold tracking-wider uppercase block mb-2">ğŸ—£ï¸ Narration (CapCut ìë§‰ìš©)</span>
                            <div class="space-y-2">
                                ${scene.narration_kr ? `
                                <div>
                                    <span class="text-[10px] text-slate-500 block">ğŸ‡°ğŸ‡· í•œêµ­ì–´</span>
                                    <p class="text-white text-base font-bold">"${scene.narration_kr}"</p>
                                </div>` : ''}
                                ${scene.narration_jp ? `
                                <div>
                                    <span class="text-[10px] text-slate-500 block">ğŸ‡¯ğŸ‡µ ì¼ë³¸ì–´</span>
                                    <p class="text-blue-300 text-base font-bold">"${scene.narration_jp}"</p>
                                </div>` : ''}
                                ${scene.narration_pron ? `
                                <div>
                                    <span class="text-[10px] text-slate-500 block">ğŸ—£ï¸ ë°œìŒ</span>
                                    <p class="text-orange-300 text-sm font-mono">"${scene.naration_pron}"</p>
                                </div>` : ''}
                            </div>
                        </div>` : '';

                    const sfxHtml = scene.sfx_suggestion ? `
                        <div class="mt-2 flex items-center gap-2">
                            <span class="text-[10px] text-yellow-500/70 border border-yellow-500/30 px-1.5 py-0.5 rounded uppercase font-bold">ğŸµ SFX</span>
                            <span class="text-xs text-yellow-100/80">${scene.sfx_suggestion}</span>
                        </div>` : '';

                    // Enhanced Transcript HTML with 4 Languages (Ordered: Original â†’ Korean â†’ Japanese â†’ Pronunciation)
                    const transcriptHtml = (scene.original_transcript || scene.text_jp) ? `
                        <details class="mt-3 group/details" open>
                            <summary class="text-xs text-slate-500 cursor-pointer hover:text-slate-300 select-none flex items-center gap-1 mb-2">
                                <span class="group-open/details:rotate-90 transition-transform">â–¼</span> ğŸ—£ï¸ 4ê°œ êµ­ì–´ ëŒ€ì‚¬ (í¸ì§‘ìš©)
                            </summary>
                            <div class="space-y-2 pl-2 border-l-2 border-slate-700">
                                ${scene.original_transcript ? `
                                <div>
                                    <span class="text-[10px] text-slate-500 block">ğŸ‡ºğŸ‡¸ ì›ë¬¸ (Original)</span>
                                    <p class="text-slate-300 text-xs font-mono">"${scene.original_transcript}"</p>
                                </div>` : ''}
                                ${scene.text_kr ? `
                                <div>
                                    <span class="text-[10px] text-slate-500 block">ğŸ‡°ğŸ‡· í•œêµ­ì–´ (ìë§‰)</span>
                                    <p class="text-white text-sm font-bold">"${scene.text_kr}"</p>
                                </div>` : ''}
                                ${scene.text_jp ? `
                                <div>
                                    <span class="text-[10px] text-slate-500 block">ğŸ‡¯ğŸ‡µ ì¼ë³¸ì–´ (ë²ˆì—­)</span>
                                    <p class="text-blue-300 text-sm font-bold">"${scene.text_jp}"</p>
                                </div>` : ''}
                                ${scene.text_pron ? `
                                <div>
                                    <span class="text-[10px] text-slate-500 block">ğŸ—£ï¸ ì¼ë³¸ì–´ ë°œìŒ</span>
                                    <p class="text-orange-300 text-xs font-mono">"${scene.text_pron}"</p>
                                </div>` : ''}
                            </div>
                        </details>` : '';

                    sceneCard.innerHTML = `
                        <!-- Timeline at Top (like image) -->
                        <div class="flex items-center justify-between bg-slate-900/50 -m-5 mb-4 p-3 rounded-t-xl border-b border-slate-700">
                            <span class="${badgeColor} text-white text-xs font-bold px-3 py-1 rounded-full">${scene.stage}</span>
                            <div class="flex items-center gap-2">
                                <span class="text-purple-300 font-mono font-bold text-sm">${formatTime(scene.start)}</span>
                                <div class="w-[1px] h-4 bg-slate-600"></div>
                                <span class="text-purple-300 font-mono font-bold text-sm">${formatTime(scene.end)}</span>
                                <span class="text-slate-500 text-xs">(${duration}s)</span>
                            </div>
                        </div>

                        <!-- Content -->
                        <div>
                            <h4 class="text-white font-bold text-lg mb-1">${scene.description}</h4>
                            <p class="text-slate-400 text-sm mb-2">ğŸ’¡ ${scene.reason}</p>
                            
                            ${narrationHtml}
                            ${sfxHtml}
                            ${transcriptHtml}
                            
                            <div class="mt-3 flex gap-2">
                                <button onclick="navigator.clipboard.writeText('${scene.start.toFixed(2)}-${scene.end.toFixed(2)}')" 
                                    class="text-xs bg-slate-700 hover:bg-slate-600 text-white px-2 py-1 rounded transition-colors">
                                    â±ï¸ ì •ë°€ íƒ€ì„ì½”ë“œ ë³µì‚¬
                                </button>
                            </div>
                        </div>
                    `;
                    grid.appendChild(sceneCard);
                });

                // Store plan for Step 3
                window.currentDirectorPlan = plan;

                // Enable Step 3 Button
                if (plan.length > 0) {
                    const btn = document.getElementById('generateFinalScriptBtn');
                    btn.disabled = false;
                    btn.classList.remove('opacity-50', 'cursor-not-allowed');
                    btn.onclick = generateFinalScript; // Bind the function
                    // Scroll to button
                    setTimeout(() => btn.scrollIntoView({ behavior: 'smooth', block: 'center' }), 500);
                }
            }

            // Download Functions
            window.downloadFullTranscript = function () {
                if (!currentTranscriptData) { alert('ëŒ€ë³¸ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.'); return; }

                let content = `ğŸ¥ ì „ì²´ ì˜ìƒ ëŒ€ë³¸ (ì–¸ì–´: ${currentTranscriptData.languageName})\n`;
                content += `ì´ ê¸¸ì´: ${currentTranscriptData.duration}ì´ˆ\n\n`;

                currentTranscriptData.segments.forEach(seg => {
                    content += `[${formatTime(seg.start)} - ${formatTime(seg.end)}] (${seg.emotion})\n`;
                    content += `${seg.text}\n\n`;
                });

                downloadTextFile(content, `full_transcript_${Date.now()}.txt`);
            }

            window.downloadDirectorScript = function () {
                if (!window.currentDirectorPlan) { alert('í•˜ì´ë¼ì´íŠ¸ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.'); return; }

                let content = `ğŸ¬ AI Director's Cut í•˜ì´ë¼ì´íŠ¸ ëŒ€ë³¸\n`;
                content += `====================================\n\n`;

                window.currentDirectorPlan.forEach((scene, i) => {
                    content += `Scene ${i + 1}: ${scene.stage} (${formatTime(scene.start)} - ${formatTime(scene.end)})\n`;
                    content += `------------------------------------\n`;
                    content += `ë‚´ìš©: ${scene.description}\n`;
                    if (scene.narration_draft) content += `ë‚´ë ˆì´ì…˜: ${scene.narration_draft}\n`;
                    if (scene.sfx_suggestion) content += `SFX: ${scene.sfx_suggestion}\n`;
                    content += `\n[ëŒ€ì‚¬]\n`;
                    content += `KR: ${scene.description}\n`; // Using description as KR summary for now or add specific KR text field back if needed
                    if (scene.original_transcript) content += `ORI: ${scene.original_transcript}\n`;
                    if (scene.text_jp) content += `JP: ${scene.text_jp}\n`;
                    if (scene.text_pron) content += `PRON: ${scene.text_pron}\n`;
                    content += `\n\n`;
                });

                downloadTextFile(content, `director_highlights_${Date.now()}.txt`);
            }

            function downloadTextFile(content, filename) {
                const blob = new Blob([content], { type: 'text/plain' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                a.click();
                window.URL.revokeObjectURL(url);
            }

            async function generateFinalScript() {
                if (!window.currentDirectorPlan || !currentTranscriptData) {
                    alert('í•„ìš”í•œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                    return;
                }

                const btn = document.getElementById('generateFinalScriptBtn');
                const originalText = btn.innerHTML;
                btn.innerHTML = 'â³ AIê°€ ëŒ€ë³¸ ìƒì„± ì¤‘... (ì•½ 15ì´ˆ)';
                btn.disabled = true;

                try {
                    const response = await fetch('http://localhost:4000/api/guidelines/generate-final-script', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            directorPlan: window.currentDirectorPlan,
                            transcript: currentTranscriptData
                        })
                    });

                    const data = await response.json();

                    if (!response.ok) throw new Error(data.error || 'ëŒ€ë³¸ ìƒì„± ì‹¤íŒ¨');

                    // Render Step 3
                    displayFinalScript(data.finalScript);

                } catch (error) {
                    alert('ì˜¤ë¥˜ ë°œìƒ: ' + error.message);
                } finally {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }
            }

            // Fixed Syntax Error
            function displayFinalScript(script) {
                // Show Titles Section
                const section = document.getElementById('titlesSection');
                const content = document.getElementById('titlesContent');

                section.classList.remove('hidden');
                section.scrollIntoView({ behavior: 'smooth' });

                let html = '';
                html += '<div class="flex justify-between items-center mb-6">';
                html += '<h2 class="text-2xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-green-400 to-blue-500">ğŸ“ ìµœì¢… 1ë¶„ ë¯¸ë§Œ ì••ì¶• ëŒ€ë³¸</h2>';
                html += '<button onclick="copyFinalScript()" class="bg-slate-700 hover:bg-slate-600 text-white font-bold px-4 py-2 rounded-lg transition-colors">ğŸ“‹ ì „ì²´ ëŒ€ë³¸ ë³µì‚¬</button>';
                html += '</div>';

                let clipboardText = '';

                script.forEach(function (line) {
                    // Manual string concatenation for blockText - REMOVED BACKTICKS
                    let blockText = '[' + line.time + '] ' + line.stage + '\n';
                    blockText += 'KR: ' + line.textKO + '\n';
                    blockText += 'JP: ' + line.textJP + '\n';
                    blockText += 'ë°œìŒ: ' + line.textPron + '\n\n';

                    clipboardText += blockText;

                    // Manual string concatenation for HTML - REMOVED BACKTICKS
                    html += '<div class="bg-slate-800/50 border border-slate-700 rounded-xl p-6 mb-4 hover:border-green-500 transition-colors">';

                    html += '<div class="flex justify-between items-start mb-2">';
                    html += '<span class="text-green-400 font-mono font-bold text-sm">' + line.time + '</span>';
                    html += '<span class="bg-slate-700 text-white text-xs px-2 py-1 rounded">' + line.stage + '</span>';
                    html += '</div>';

                    html += '<div class="space-y-3">';

                    html += '<div>';
                    html += '<span class="text-xs text-slate-500 block mb-1">ğŸ‡°ğŸ‡· í•œêµ­ì–´ (ìë§‰ìš©)</span>';
                    html += '<p class="text-white font-bold text-lg">' + line.textKO + '</p>';
                    html += '</div>';

                    html += '<div class="grid grid-cols-1 md:grid-cols-2 gap-4">';
                    html += '<div class="bg-slate-900/50 p-3 rounded-lg">';
                    html += '<span class="text-xs text-slate-500 block mb-1">ğŸ‡¯ğŸ‡µ ì¼ë³¸ì–´</span>';
                    html += '<p class="text-slate-300">' + line.textJP + '</p>';
                    html += '</div>';

                    html += '<div class="bg-slate-900/50 p-3 rounded-lg">';
                    html += '<span class="text-xs text-slate-500 block mb-1">ğŸ—£ï¸ ë°œìŒ</span>';
                    html += '<p class="text-orange-300 font-mono">' + line.textPron + '</p>';
                    html += '</div>';

                    html += '</div>'; // End grid
                    html += '</div>'; // End space-y-3
                    html += '</div>'; // End card container
                });

                content.innerHTML = html;
                window.finalScriptText = clipboardText;
            }

            function copyFinalScript() {
                if (window.finalScriptText) {
                    navigator.clipboard.writeText(window.finalScriptText).then(() => {
                        alert('ëŒ€ë³¸ì´ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤! CapCutì— ë¶™ì—¬ë„£ìœ¼ì„¸ìš”.');
                    });
                }
            }

            function displayHighlights(highlights) {
                // Legacy support (Keep existing code structure if needed, or remove)
                const grid = document.getElementById('highlightsGrid');
                grid.innerHTML = '<p class="text-red-500 text-center col-span-full">âš ï¸ êµ¬ë²„ì „ API ì‘ë‹µì…ë‹ˆë‹¤.</p>';
            }


            // Also store transcript data when extracted
            /* In extractTranscriptBtn handler:
               currentTranscriptData = data.transcript;
            */

            function formatTime(seconds) {
                const mins = Math.floor(seconds / 60);
                const secs = Math.floor(seconds % 60);
                return `${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
            }

        </script>
        <script>
            // ========================================
            // AI PRODUCTION PIPELINE LOGIC
            // ========================================

            let availableStyles = null;
            let currentProductionScript = null; // Stores generated script

            // 1. Open Production Modal
            document.getElementById('openAiProductionBtn').addEventListener('click', async () => {
                if (!currentTranscriptData) {
                    alert('âš ï¸ ëŒ€ë³¸ì´ ì¶”ì¶œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.\në¨¼ì € ì™¼ìª½ì˜ "ğŸ“ ì˜ìƒ ëŒ€ë³¸ ì¶”ì¶œ" ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.');
                    return;
                }

                document.getElementById('styleModal').classList.remove('hidden');

                if (!availableStyles) {
                    await loadStyles();
                }
            });

            // 2. Load Styles from Backend
            async function loadStyles() {
                const container = document.getElementById('styleChannelsGrid');
                container.innerHTML = '<div class="col-span-full text-center text-white"><div class="loader w-10 h-10 border-4 border-t-orange-500 mx-auto mb-4"></div>ìŠ¤íƒ€ì¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';

                try {
                    const response = await fetch('http://localhost:4000/api/production/styles');
                    const data = await response.json();

                    if (data.success) {
                        availableStyles = data.styles;
                        renderStyleCategories(data.styles);
                        renderStyleChannels(getAllChannels(data.styles));
                    }
                } catch (error) {
                    console.error('Failed to load styles:', error);
                    container.innerHTML = '<div class="col-span-full text-center text-red-400">ìŠ¤íƒ€ì¼ ë¡œë“œ ì‹¤íŒ¨</div>';
                }
            }

            // Helper: Flatten styles
            function getAllChannels(stylesMap) {
                let all = [];
                Object.values(stylesMap).forEach(list => all = all.concat(list));
                return all;
            }

            // 3. Render Categories
            function renderStyleCategories(stylesMap) {
                const catContainer = document.getElementById('styleCategories');
                catContainer.innerHTML = '';

                // Define 15 Fixed Categories (Same as HotChannel Style Lab)
                const CATEGORIES = [
                    'ì˜í™”/ì• ë‹ˆë©”ì´ì…˜', 'ìë™ì°¨', 'ìŒì•…', 'ë°˜ë ¤ë™ë¬¼/ë™ë¬¼', 'ìŠ¤í¬ì¸ ',
                    'ì—¬í–‰/ì´ë²¤íŠ¸', 'ê²Œì„', 'ì¸ë¬¼/ë¸”ë¡œê·¸', 'ì½”ë¯¸ë””', 'ì—”í„°í…Œì¸ë¨¼íŠ¸',
                    'ë‰´ìŠ¤/ì •ì¹˜', 'ë…¸í•˜ìš°/ìŠ¤íƒ€ì¼', 'êµìœ¡', 'ê³¼í•™ê¸°ìˆ ', 'ë¹„ì˜ë¦¬/ì‚¬íšŒìš´ë™', 'ì¼ë°˜'
                ];

                // 'All' button
                const allChannels = getAllChannels(stylesMap);
                const allBtn = document.createElement('button');
                allBtn.className = 'w-full text-left px-4 py-3 rounded-lg bg-orange-500/20 text-orange-400 font-bold mb-2 border border-orange-500/30';
                allBtn.textContent = `ğŸ“‚ ì „ì²´ ë³´ê¸°(${allChannels.length})`;
                allBtn.onclick = () => renderStyleChannels(allChannels);
                catContainer.appendChild(allBtn);

                // Render all 15 categories (plus 'General' if used)
                CATEGORIES.forEach(cat => {
                    const count = stylesMap[cat] ? stylesMap[cat].length : 0;

                    const btn = document.createElement('button');
                    btn.className = 'w-full text-left px-4 py-2 rounded-lg hover:bg-slate-700 text-slate-300 transition-colors text-sm flex justify-between items-center';
                    // Highlight if active logic could be added here

                    btn.innerHTML = `
                        <span > ${cat}</span>
                            <span class="text-xs text-slate-500 bg-slate-800 px-2 py-0.5 rounded-full">${count}</span>
                    `;

                    btn.onclick = () => {
                        if (count > 0) {
                            renderStyleChannels(stylesMap[cat]);
                        } else {
                            // Optional: Show empty state or still clear grid
                            renderStyleChannels([]);
                            document.getElementById('styleChannelsGrid').innerHTML = `
                        <div class="col-span-full py-10 text-center text-slate-500 flex flex-col items-center justify-center" >
                                    <div class="text-4xl mb-2 opacity-50">ğŸ“‚</div>
                                    <p class="font-bold">ì´ ì¹´í…Œê³ ë¦¬ì— ë“±ë¡ëœ ìŠ¤íƒ€ì¼ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                                    <p class="text-xs mt-1">ìŠ¤íƒ€ì¼ ì—°êµ¬ì†Œì—ì„œ ì´ ì¹´í…Œê³ ë¦¬ì˜ ì±„ë„ì„ ì €ì¥í•´ë³´ì„¸ìš”!</p>
                                </div>
                        `;
                        }
                    };
                    catContainer.appendChild(btn);
                });
            }

            // 4. Render Channels (Cards)
            function renderStyleChannels(channels) {
                const grid = document.getElementById('styleChannelsGrid');
                grid.innerHTML = '';

                if (channels.length === 0) {
                    grid.innerHTML = '<div class="col-span-full text-center text-slate-500">ì±„ë„ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
                    return;
                }

                channels.forEach(ch => {
                    const card = document.createElement('div');
                    card.className = 'bg-slate-800 rounded-xl overflow-hidden cursor-pointer hover:ring-2 hover:ring-orange-500 transition-all group style-card flex flex-col h-full'; // Added flex/h-full
                    card.onclick = (e) => selectStyle(ch, e.currentTarget);

                    const hasDna = ch.strategy?.structure_template && ch.strategy.structure_template.length > 0;

                    card.innerHTML = `
                        <div class="h-24 bg-slate-700 relative overflow-hidden flex-shrink-0" >
                            ${ch.thumbnail ? `<img src="${ch.thumbnail}" class="w-full h-full object-cover opacity-60 group-hover:opacity-100 transition-opacity">` : ''}
                             <div class="absolute inset-0 bg-gradient-to-t from-slate-900 to-transparent"></div>
                             <div class="absolute bottom-2 left-3 font-bold text-white text-lg shadow-black drop-shadow-md">${ch.name}</div>
                        </div>
                        <div class="p-4 flex flex-col flex-1">
                            <div class="text-xs text-orange-400 mb-2 font-bold uppercase tracking-wider">${ch.strategy?.tone || 'Style'}</div>
                            <p class="text-slate-400 text-sm line-clamp-2 leading-relaxed mb-4 flex-1">${ch.summary || 'AI ë¶„ì„ ë°ì´í„° ì—†ìŒ'}</p>

                            <!-- DNA Button -->
                            ${hasDna ? `
                            <button onclick="event.stopPropagation(); openDnaModal('${ch.id}')" 
                                class="w-full bg-slate-700 hover:bg-indigo-600 hover:text-white text-slate-300 text-xs font-bold py-2 rounded-lg transition-colors flex items-center justify-center gap-1 border border-slate-600 hover:border-indigo-500">
                                <span>ğŸ§¬</span> DNA ë¶„ì„ (êµ¬ì¡° ë³´ê¸°)
                            </button>
                            ` : ''}
                        </div>
                    `;
                    grid.appendChild(card);
                });
            }

            // DNA Modal Logic
            window.openDnaModal = function (id) {
                const allChannels = getAllChannels(availableStyles);
                // Use loose equality to handle string/number ID mismatch
                const ch = allChannels.find(c => c.id == id);
                if (!ch) {
                    console.warn('Channel not found for DNA modal:', id);
                    return;
                }
                if (!ch.strategy?.structure_template) {
                    alert('ì´ ìŠ¤íƒ€ì¼ì—ëŠ” DNA êµ¬ì¡° ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                    return;
                }

                const container = document.getElementById('dnaTimelineContainer');
                container.innerHTML = ch.strategy.structure_template.map((step, idx) => {
                    const colors = ['border-blue-500', 'border-purple-500', 'border-pink-500', 'border-orange-500'];
                    const color = colors[idx % colors.length];
                    const badgeColor = step.type === 'Hook' ? 'bg-red-500' : 'bg-slate-600';

                    return `
                        <div class="flex gap-4 relative" >
                        <!--Left: Time-->
                        <div class="w-16 text-right pt-2">
                             <span class="text-xs font-mono text-slate-500 block">${step.time}</span>
                        </div>
                        
                        <!--Timeline Line-->
                        <div class="absolute left-[4.5rem] top-3 bottom-0 w-0.5 bg-slate-800"></div>
                        <div class="absolute left-[4.35rem] top-3 w-3 h-3 rounded-full bg-slate-700 border-2 border-slate-900 z-10"></div>

                        <!--Right: Card-->
                        <div class="flex-1 bg-slate-800/80 p-4 rounded-xl border-l-4 ${color} mb-3 ml-4">
                            <div class="flex justify-between items-start mb-2">
                                <span class="${badgeColor} text-white text-[10px] font-bold px-2 py-0.5 rounded uppercase tracking-wider">${step.type}</span>
                                <span class="text-slate-500 text-[10px]">â±ï¸ ${step.time}</span>
                            </div>
                            <p class="text-slate-300 text-sm font-medium leading-relaxed">${step.description}</p>
                        </div>
                    </div>
                        `;
                }).join('');

                document.getElementById('dnaViewModal').classList.remove('hidden');
            };

            // 5. Select Style Logic
            let selectedStyleId = null;

            function selectStyle(channel, element) {
                selectedStyleId = channel.id;

                // Visual Update
                document.querySelectorAll('.style-card').forEach(c => c.classList.remove('ring-2', 'ring-orange-500'));
                if (element) element.classList.add('ring-2', 'ring-orange-500');

                document.getElementById('selectedStyleName').textContent = channel.name;
                document.getElementById('selectedStylePreview').style.backgroundImage = `url(${channel.thumbnail})`;

                const btn = document.getElementById('startProductionBtn');
                btn.disabled = false;
                btn.classList.remove('opacity-50', 'cursor-not-allowed');
            }

            // 6. Start Production (Generate Script)
            document.getElementById('startProductionBtn').addEventListener('click', async () => {
                if (!selectedStyleId || !currentTranscriptData) return;

                const btn = document.getElementById('startProductionBtn');
                btn.textContent = 'â³ AIê°€ ëŒ€ë³¸ì„ ì¬êµ¬ì„±í•˜ëŠ” ì¤‘...';
                btn.disabled = true;

                // Prepare Text
                const transcriptText = currentTranscriptData.segments.map(s => s.text).join(' ');

                try {
                    const response = await fetch('http://localhost:4000/api/production/generate', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            transcriptText: transcriptText,
                            styleId: selectedStyleId
                        })
                    });

                    const result = await response.json();

                    if (!response.ok) throw new Error(result.error || 'ìƒì„± ì‹¤íŒ¨');

                    // Success!
                    document.getElementById('styleModal').classList.add('hidden');
                    renderProductionResult(result);

                } catch (error) {
                    alert('ì˜¤ë¥˜: ' + error.message);
                } finally {
                    btn.textContent = 'ğŸš€ ëŒ€ë³¸ ë° ì˜¤ë””ì˜¤ ìƒì„± ì‹œì‘';
                    btn.disabled = false;
                }
            });

            // 7. Render Result
            function renderProductionResult(result) {
                const section = document.getElementById('aiProductionSection');
                section.classList.remove('hidden');
                section.scrollIntoView({ behavior: 'smooth' });

                const styleName = result.styleMetadata?.name || 'Unknown Style';
                const scriptData = result.data.script || [];

                // Unified Display HTML for Full Shorts Processing
                let scriptHTML = scriptData.map((s, idx) => {
                    // Segment Badge Color
                    let segColor = 'bg-slate-700';
                    if (s.section?.includes('Hook')) segColor = 'bg-red-600';
                    if (s.section?.includes('Twist') || s.section?.includes('Climax')) segColor = 'bg-purple-600';
                    if (s.section?.includes('Conclusion')) segColor = 'bg-green-600';

                    // Type Icon
                    const typeIcon = s.type === 'Dialogue' ? 'ğŸ’¬' : 'ğŸ™ï¸';
                    const typeLabel = s.type || 'Narration';

                    return `
                        <div class="mb-6 bg-slate-800/80 rounded-xl overflow-hidden border border-slate-700/50 hover:border-indigo-500/30 transition-colors" >
                        <!--Header with Segment & Time-->
                        <div class="bg-slate-700/30 px-5 py-3 flex items-center justify-between border-b border-white/5">
                            <div class="flex items-center gap-3">
                                <span class="${segColor} text-white text-[10px] font-bold px-2 py-0.5 rounded uppercase tracking-wider shadow-sm">
                                    ${s.section || 'Segment'}
                                </span>
                                <span class="font-mono text-sm text-indigo-300 font-bold">â±ï¸ ${s.time}</span>
                            </div>
                            <div class="flex gap-2">
                                ${s.visual_cue ? `<span class="text-xs text-slate-400 bg-slate-900/50 px-2 py-1 rounded border border-white/10" title="Visual Cue">ğŸ¥ ${s.visual_cue}</span>` : ''}
                                ${s.sfx ? `<span class="text-xs text-yellow-400/80 bg-yellow-900/20 px-2 py-1 rounded border border-yellow-500/20" title="Sound Effect">ğŸ”Š ${s.sfx}</span>` : ''}
                            </div>
                        </div>
                        
                        <div class="p-6 space-y-5">
                            <!-- Speaker Info (if Dialogue) -->
                            ${s.speaker ? `
                            <div class="flex items-center gap-2 mb-1">
                                <span class="text-xs font-bold text-slate-300 bg-slate-700 px-2 py-0.5 rounded-md">${typeIcon} ${s.speaker}</span>
                            </div>` : ''}

                            <!-- Japanese (Main) -->
                            <div>
                                <p class="text-xl text-white font-medium leading-relaxed font-sans tracking-wide">${s.text_jp}</p>
                            </div>

                            <!-- Pronunciation -->
                            <div class="pl-4 border-l-2 border-slate-700">
                                <p class="text-slate-400 text-sm leading-relaxed font-mono opacity-80">${s.text_pron}</p>
                            </div>

                            <!-- Korean -->
                            <div class="pl-4 border-l-2 border-slate-700">
                                <p class="text-slate-500 text-sm leading-relaxed">${s.text_kr}</p>
                            </div>
                        </div>
                    </div>
                        `;
                }).join('');

                section.innerHTML = `
                        <div class="max-w-4xl mx-auto py-8" >
                        <div class="flex items-center justify-between mb-8">
                            <div class="flex items-center gap-4">
                                <div class="w-12 h-12 bg-indigo-600 rounded-2xl flex items-center justify-center text-2xl shadow-lg shadow-indigo-500/20">ğŸ¬</div>
                                <div>
                                    <h2 class="text-2xl font-bold text-white">Production Result</h2>
                                    <p class="text-slate-400 text-sm flex items-center gap-2">
                                        Applied Style: <span class="text-indigo-400 font-bold bg-indigo-400/10 px-2 py-0.5 rounded">${styleName}</span>
                                    </p>
                                </div>
                            </div>
                            <button onclick="document.getElementById('aiProductionSection').classList.add('hidden')" 
                                class="px-4 py-2 hover:bg-slate-800 text-slate-500 hover:text-white rounded-lg transition-colors">
                                Close
                            </button>
                        </div>

                        <div id="unifiedScriptContainer" class="mb-10">
                            ${scriptHTML}
                        </div>

                        <!--Audio Generation Section-->
                        <div class="bg-gradient-to-br from-slate-800 to-slate-900 rounded-2xl p-8 border border-white/5 shadow-2xl">
                            <div class="flex items-center justify-between mb-6">
                                <div>
                                    <h3 class="text-lg font-bold text-white flex items-center gap-2 mb-1">
                                        <span>ğŸ¤</span> Voicevox Audio
                                    </h3>
                                    <p class="text-sm text-slate-400">Generate high-quality Japanese audio using selected persona.</p>
                                </div>
                            </div>

                            <div class="flex flex-col sm:flex-row gap-4 items-center">
                                <button id="prodGenerateAudioBtn" class="w-full sm:w-auto px-8 py-4 bg-indigo-600 hover:bg-indigo-500 text-white font-bold rounded-xl transition-all shadow-lg hover:shadow-indigo-500/25 flex items-center justify-center gap-3 group">
                                    <span class="text-xl group-hover:scale-110 transition-transform">ğŸ”Š</span>
                                    <span>Generate Audio</span>
                                </button>

                                <div id="prodAudioPlayer" class="hidden flex-1 w-full bg-black/40 rounded-xl p-2 border border-white/5">
                                    <audio id="prodAudio" controls class="w-full h-10"></audio>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                // Re-attach listener
                document.getElementById('prodGenerateAudioBtn').addEventListener('click', () => generateProductionAudio(scriptData));
            }

            // Audio Generation Helper
            async function generateProductionAudio(scriptData) {
                if (!window.selectedSpeakerId) {
                    alert('âš ï¸ Select a Character (Speaker) from the section below first!');
                    document.getElementById('voicevoxSection').scrollIntoView({ behavior: 'smooth' });
                    // Highlight effect
                    const section = document.getElementById('voicevoxSection');
                    section.classList.add('ring-2', 'ring-indigo-500');
                    setTimeout(() => section.classList.remove('ring-2', 'ring-indigo-500'), 2000);
                    return;
                }

                const btn = document.getElementById('prodGenerateAudioBtn');
                const originalText = btn.innerHTML;
                btn.innerHTML = '<span>â³</span> Generating...';
                btn.disabled = true;

                const jpText = scriptData.map(s => s.text_jp).join(' ');

                try {
                    const response = await fetch('http://localhost:4000/api/voicevox/generate-tts', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            text: jpText,
                            speakerId: window.selectedSpeakerId
                        })
                    });

                    if (!response.ok) throw new Error('TTS Generation Failed');

                    const blob = await response.blob();
                    const url = URL.createObjectURL(blob);

                    const audio = document.getElementById('prodAudio');
                    audio.src = url;
                    document.getElementById('prodAudioPlayer').classList.remove('hidden');
                    audio.play();

                } catch (error) {
                    alert('Error: ' + error.message);
                } finally {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }
            }

        </script>
        <!-- DNA View Modal -->
        <div id="dnaViewModal"
            class="fixed inset-0 bg-black/90 hidden z-[70] flex items-center justify-center backdrop-blur-sm">
            <div class="bg-slate-900 border border-slate-700 rounded-2xl w-full max-w-2xl p-6 shadow-2xl relative">
                <button onclick="document.getElementById('dnaViewModal').classList.add('hidden')"
                    class="absolute top-4 right-4 text-slate-400 hover:text-white transition-colors bg-slate-800 rounded-full w-8 h-8 flex items-center justify-center">âœ•</button>
                <div class="flex items-center gap-2 mb-1">
                    <span class="text-2xl">ğŸ§¬</span>
                    <h3 class="text-xl font-bold text-white">Viral Structure DNA</h3>
                </div>
                <p class="text-xs text-slate-400 mb-6 pl-9">Timestamps & Narrative Flow Analysis</p>

                <div id="dnaTimelineContainer" class="space-y-0 max-h-[60vh] overflow-y-auto pr-2 custom-scrollbar">
                    <!-- Injected items -->
                </div>

                <div class="mt-6 pt-4 border-t border-slate-800 flex justify-end">
                    <button onclick="document.getElementById('dnaViewModal').classList.add('hidden')"
                        class="px-5 py-2.5 bg-indigo-600 hover:bg-indigo-500 text-white rounded-lg font-bold text-sm shadow-lg shadow-indigo-500/20 transition-all hover:scale-105">
                        í™•ì¸ (Close)
                    </button>
                </div>
            </div>
        </div>
</body>

</html>
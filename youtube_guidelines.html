<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YouTube ê°€ì´ë“œë¼ì¸ ì²´í¬ | Viral Shorts Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            min-height: 100vh;
        }

        .glass-panel {
            background: rgba(30, 41, 59, 0.5);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(148, 163, 184, 0.1);
        }

        .loader {
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .upload-zone {
            border: 2px dashed #475569;
            transition: all 0.3s;
        }

        .upload-zone:hover {
            border-color: #3b82f6;
            background: rgba(59, 130, 246, 0.05);
        }

        .upload-zone.dragover {
            border-color: #10b981;
            background: rgba(16, 185, 129, 0.1);
        }
    </style>
</head>

<body class="p-8">
    <div class="max-w-6xl mx-auto">
        <!-- Header -->
        <div class="text-center mb-12">
            <h1 class="text-5xl font-black text-white mb-4">
                ğŸ“‹ YouTube ê°€ì´ë“œë¼ì¸ ì²´í¬
            </h1>
            <p class="text-slate-400 text-lg">
                ì—…ë¡œë“œ ì „ ê°€ì´ë“œë¼ì¸ ìœ„ë°˜ ì—¬ë¶€ë¥¼ AIë¡œ ì‚¬ì „ ì²´í¬í•˜ì„¸ìš”
            </p>
        </div>

        <!-- Upload Section -->
        <div class="glass-panel rounded-2xl p-8 mb-8">
            <h2 class="text-2xl font-bold text-white mb-6">ğŸ“¤ ë¹„ë””ì˜¤ ì—…ë¡œë“œ</h2>

            <form id="uploadForm" enctype="multipart/form-data">
                <!-- File Upload Zone -->
                <div class="upload-zone rounded-xl p-12 text-center mb-6" id="uploadZone">
                    <div id="uploadPlaceholder">
                        <div class="text-6xl mb-4">ğŸ¬</div>
                        <p class="text-slate-300 font-bold text-lg mb-2">ë¹„ë””ì˜¤ íŒŒì¼ì„ ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­í•˜ì„¸ìš”</p>
                        <p class="text-slate-500 text-sm">MP4, MOV, AVI (ìµœëŒ€ 100MB)</p>
                        <input type="file" id="videoFile" accept="video/*" class="hidden" />
                    </div>
                    <div id="uploadInfo" class="hidden">
                        <div class="text-4xl mb-2">âœ…</div>
                        <p class="text-green-400 font-bold" id="fileName"></p>
                        <p class="text-slate-500 text-sm" id="fileSize"></p>
                    </div>
                </div>

                <!-- Title -->
                <div class="mb-4">
                    <label class="block text-slate-300 font-bold mb-2">ì œëª© (ì„ íƒì‚¬í•­)</label>
                    <input type="text" id="videoTitle"
                        class="w-full px-4 py-3 bg-slate-800 text-white rounded-lg border border-slate-700 focus:border-blue-500 focus:outline-none"
                        placeholder="ì˜ìƒ ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš” (ìƒëµ ê°€ëŠ¥)">
                </div>

                <!-- Description -->
                <div class="mb-6">
                    <label class="block text-slate-300 font-bold mb-2">ì„¤ëª…</label>
                    <textarea id="videoDescription" rows="3"
                        class="w-full px-4 py-3 bg-slate-800 text-white rounded-lg border border-slate-700 focus:border-blue-500 focus:outline-none"
                        placeholder="ì˜ìƒ ì„¤ëª…ì„ ì…ë ¥í•˜ì„¸ìš” (ì„ íƒì‚¬í•­)"></textarea>
                </div>

                <!-- Submit Button -->
                <button type="submit" id="analyzeBtn"
                    class="w-full bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-500 hover:to-purple-500 text-white font-bold py-4 rounded-xl transition-all transform hover:scale-[1.02]">
                    ğŸ” ê°€ì´ë“œë¼ì¸ ë¶„ì„ ì‹œì‘
                </button>
            </form>
        </div>

        <!-- Loading Section -->
        <div id="loadingSection" class="glass-panel rounded-2xl p-12 text-center hidden">
            <div class="loader w-16 h-16 border-4 border-t-blue-500 mx-auto mb-4"></div>
            <p class="text-white font-bold text-xl mb-2">AIë¡œ ê°€ì´ë“œë¼ì¸ ë¶„ì„ ì¤‘...</p>
            <p class="text-slate-400">ì˜ìƒ ë‚´ìš©, ìŒì„±, í…ìŠ¤íŠ¸ë¥¼ ê²€í† í•˜ê³  ìˆìŠµë‹ˆë‹¤</p>
        </div>

        <!-- Result Section -->
        <div id="resultSection" class="hidden">
            <div class="glass-panel rounded-2xl p-8 mb-6">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-2xl font-bold text-white">ë¶„ì„ ê²°ê³¼</h2>
                    <div id="statusBadge"></div>
                </div>

                <!-- Score -->
                <div class="bg-slate-800/50 rounded-xl p-6 mb-6 text-center">
                    <p class="text-slate-400 text-sm mb-2">ì•ˆì „ ì ìˆ˜</p>
                    <p class="text-5xl font-black text-white" id="score">--</p>
                    <p class="text-slate-500 text-sm mt-2">100ì  ë§Œì </p>
                </div>

                <!-- Summary -->
                <div class="bg-slate-800/50 rounded-xl p-6 mb-6">
                    <p class="text-slate-400 text-sm mb-2">ì¢…í•© í‰ê°€</p>
                    <p class="text-white" id="summary">--</p>
                </div>

                <!-- BGM Analysis -->
                <div class="bg-slate-800/50 rounded-xl p-6 mb-6" id="bgmSection"></div>

                <!-- Violations -->
                <div id="violationsContainer"></div>

                <!-- Action Buttons -->
                <div class="mt-6">
                    <button id="generateTitlesBtn"
                        class="w-full bg-gradient-to-r from-green-600 to-blue-600 hover:from-green-500 hover:to-blue-500 text-white font-bold py-4 rounded-xl transition-all transform hover:scale-[1.02]">
                        âœ¨ Shorts ì œëª© ìƒì„± (í•œ/ì¼/ë°œìŒ)
                    </button>
                </div>
            </div>

            <!-- Titles Section -->
            <div id="titlesSection" class="glass-panel rounded-2xl p-8 hidden">
                <h2 class="text-2xl font-bold text-white mb-6">ğŸ“ ìƒì„±ëœ Shorts ì œëª©</h2>
                <div id="titlesContent"></div>
            </div>

            <!-- VOICEVOX TTS Section -->
            <div id="voicevoxSection" class="glass-panel rounded-2xl p-8 hidden mt-6">
                <h2 class="text-2xl font-bold text-white mb-6">ğŸ™ï¸ ì¼ë³¸ì–´ TTS ìƒì„± (VOICEVOX)</h2>

                <!-- VOICEVOX Connection Status -->
                <div id="voicevoxStatus" class="mb-6 p-4 rounded-lg border">
                    <div class="flex items-center gap-3">
                        <div class="w-3 h-3 rounded-full" id="voicevoxStatusDot"></div>
                        <span id="voicevoxStatusText" class="text-white font-medium"></span>
                    </div>
                </div>

                <!-- Character Selection -->
                <div class="mb-8">
                    <div class="flex items-baseline justify-between mb-4">
                        <h3 class="text-xl font-bold text-white flex items-center gap-2">ğŸ‘¤ ìºë¦­í„° ì„ íƒ</h3>
                        <a href="https://hub.aivis-project.com/" target="_blank"
                            class="text-[10px] bg-slate-800/80 hover:bg-brand-600/20 text-brand-400 px-3 py-1.5 rounded-full border border-brand-500/30 transition-all flex items-center gap-1.5 group">
                            ğŸŒ AIVISS Hubì—ì„œ ë” ë§ì€ ìºë¦­í„° ë°œê²¬í•˜ê¸°
                            <span class="inline-block transition-transform group-hover:translate-x-0.5">â†’</span>
                        </a>
                    </div>
                    <div class="bg-slate-800/50 rounded-xl p-6">
                        <button id="loadCharactersBtn"
                            class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 rounded-lg mb-4">
                            ìºë¦­í„° ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
                        </button>

                        <!-- Category Tabs -->
                        <div id="categoryTabs" class="hidden mb-4">
                            <div class="flex flex-wrap gap-2 mb-4">
                                <button
                                    class="category-tab px-3 py-2 rounded-lg font-medium transition-all text-sm active"
                                    data-category="all">
                                    ì „ì²´
                                </button>
                                <button class="category-tab px-3 py-2 rounded-lg font-medium transition-all text-sm"
                                    data-category="ì—¬ì„± - ë°ê³  ê·€ì—¬ìš´">
                                    ğŸ‘§ ë°ê³  ê·€ì—¬ìš´
                                </button>
                                <button class="category-tab px-3 py-2 rounded-lg font-medium transition-all text-sm"
                                    data-category="ì—¬ì„± - ì°¨ë¶„í•˜ê³  ì„±ìˆ™">
                                    ğŸ‘© ì°¨ë¶„í•˜ê³  ì„±ìˆ™
                                </button>
                                <button class="category-tab px-3 py-2 rounded-lg font-medium transition-all text-sm"
                                    data-category="ë‚¨ì„± - ì²­ë…„">
                                    ğŸ‘¨ ë‚¨ì„± ì²­ë…„
                                </button>
                                <button class="category-tab px-3 py-2 rounded-lg font-medium transition-all text-sm"
                                    data-category="ë‚¨ì„± - ì¤‘ë…„/íŠ¹ì´">
                                    ğŸ‘´ ë‚¨ì„± ì¤‘ë…„
                                </button>
                                <button class="category-tab px-3 py-2 rounded-lg font-medium transition-all text-sm"
                                    data-category="íŠ¹ìˆ˜ - ë¡œë´‡/ê¸°ê³„">
                                    ğŸ¤– ë¡œë´‡/ê¸°ê³„
                                </button>
                                <button class="category-tab px-3 py-2 rounded-lg font-medium transition-all text-sm"
                                    data-category="íŠ¹ìˆ˜ - íŒíƒ€ì§€">
                                    âœ¨ íŒíƒ€ì§€
                                </button>
                            </div>
                        </div>

                        <div id="charactersGrid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 hidden">
                            <!-- Characters will be loaded here -->
                        </div>
                        <div id="selectedCharacterInfo" class="mt-4 hidden">
                            <div class="bg-blue-500/10 border border-blue-500/20 rounded-lg p-4">
                                <p class="text-blue-400 font-bold mb-2">ì„ íƒí•œ ìºë¦­í„°:</p>
                                <div class="flex items-center gap-4">
                                    <div class="flex-1">
                                        <div class="flex items-baseline gap-2">
                                            <p class="text-white font-medium text-lg" id="selectedCharacterName">ìºë¦­í„°ë¥¼
                                                ì„ íƒí•´ì£¼ì„¸ìš”</p>
                                            <span id="selectedCharacterEngine" class="hidden"></span>
                                        </div>
                                        <p class="text-brand-400 text-sm font-bold" id="selectedCharacterStyle"></p>
                                        <p class="text-slate-500 text-xs mt-1" id="selectedCharacterUseCase"></p>
                                    </div>
                                    <div class="flex gap-2">
                                        <button id="previewCharacterBtn"
                                            class="px-4 py-2 bg-blue-600 hover:bg-blue-500 text-white rounded-lg transition-colors flex items-center gap-2">
                                            ğŸ”Š ë¯¸ë¦¬ë“£ê¸°
                                        </button>
                                        <button id="stopPreviewBtn"
                                            class="px-4 py-2 bg-red-600 hover:bg-red-500 text-white rounded-lg hidden transition-colors flex items-center gap-2">
                                            â¹ï¸ ì •ì§€
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Script Generation -->
                <div class="mb-8">
                    <h3 class="text-xl font-bold text-white mb-4">ğŸ“ ì¼ë³¸ì–´ ëŒ€ë³¸</h3>
                    <div class="bg-slate-800/50 rounded-xl p-6">
                        <div class="flex gap-3 mb-4">
                            <button id="autoGenerateScriptBtn"
                                class="flex-1 bg-purple-600 hover:bg-purple-500 text-white font-bold py-3 rounded-lg">
                                ğŸ¤– ìë™ ìƒì„± (Gemini)
                            </button>
                            <button id="manualScriptBtn"
                                class="flex-1 bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-3 rounded-lg">
                                âœï¸ ì§ì ‘ ì…ë ¥
                            </button>
                        </div>

                        <!-- Timeline Editor -->
                        <div id="timelineEditor" class="space-y-4 hidden">
                            <div class="bg-slate-900/50 rounded-lg p-4">
                                <label class="text-slate-300 font-bold mb-2 block">íƒ€ì„ë¼ì¸ ëŒ€ë³¸</label>
                                <textarea id="scriptTextarea" rows="10"
                                    class="w-full px-4 py-3 bg-slate-800 text-white rounded-lg border border-slate-700 focus:border-purple-500 focus:outline-none font-mono"
                                    placeholder="ì˜ˆì‹œ:
[0-3ì´ˆ] çš†ã•ã‚“ã€ã“ã‚“ã«ã¡ã¯ï¼
[3-10ì´ˆ] ä»Šæ—¥ã¯é¢ç™½ã„å‹•ç”»ã‚’ç´¹ä»‹ã—ã¾ã™
[10-15ì´ˆ] ãƒãƒ£ãƒ³ãƒãƒ«ç™»éŒ²ãŠé¡˜ã„ã—ã¾ã™ï¼"></textarea>
                                <p class="text-slate-500 text-sm mt-2">
                                    ğŸ’¡ íƒ€ì„ë¼ì¸ í˜•ì‹ìœ¼ë¡œ ì…ë ¥í•˜ê±°ë‚˜, ì¼ë°˜ í…ìŠ¤íŠ¸ë¡œ ì…ë ¥í•˜ì„¸ìš”
                                </p>
                            </div>
                        </div>

                        <!-- Generated Script Display -->
                        <div id="generatedScriptDisplay" class="hidden">
                            <div class="bg-green-500/10 border border-green-500/20 rounded-lg p-4 mb-4">
                                <p class="text-green-400 font-bold mb-2">âœ… ëŒ€ë³¸ ìƒì„± ì™„ë£Œ</p>
                                <div id="generatedScriptContent"
                                    class="text-white whitespace-pre-wrap font-mono text-sm">
                                </div>
                            </div>
                            <button id="editGeneratedScriptBtn"
                                class="px-4 py-2 bg-slate-600 hover:bg-slate-500 text-white rounded-lg">
                                âœï¸ ìˆ˜ì •í•˜ê¸°
                            </button>
                        </div>
                    </div>
                </div>

                <!-- TTS Generation -->
                <div class="mb-8">
                    <h3 class="text-xl font-bold text-white mb-4">ğŸµ ìŒì„± ìƒì„±</h3>
                    <div class="bg-slate-800/50 rounded-xl p-6">
                        <button id="generateTTSBtn"
                            class="w-full bg-gradient-to-r from-pink-600 to-purple-600 hover:from-pink-500 hover:to-purple-500 text-white font-bold py-4 rounded-xl transition-all transform hover:scale-[1.02]"
                            disabled>
                            ğŸ™ï¸ TTS ìŒì„± íŒŒì¼ ìƒì„±
                        </button>
                        <p class="text-slate-500 text-sm mt-2 text-center">
                            ìºë¦­í„°ì™€ ëŒ€ë³¸ì„ ì„ íƒí•˜ë©´ ìƒì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤
                        </p>
                    </div>
                </div>

                <!-- Generated Audio -->
                <div id="generatedAudioSection" class="hidden">
                    <div
                        class="bg-gradient-to-r from-green-500/10 to-blue-500/10 border border-green-500/20 rounded-xl p-6">
                        <h3 class="text-xl font-bold text-white mb-4">ğŸ‰ ìŒì„± ìƒì„± ì™„ë£Œ!</h3>
                        <audio id="generatedAudio" controls class="w-full mb-4"></audio>
                        <button id="downloadAudioBtn"
                            class="w-full bg-green-600 hover:bg-green-500 text-white font-bold py-3 rounded-lg">
                            â¬‡ï¸ WAV íŒŒì¼ ë‹¤ìš´ë¡œë“œ
                        </button>
                    </div>
                </div>

            </div>

        </div>

        <!-- Enhanced VOICEVOX UI Script -->
        <script src="voicevox-ui-enhanced.js"></script>

        <script>
            const uploadZone = document.getElementById('uploadZone');
            const uploadPlaceholder = document.getElementById('uploadPlaceholder');
            const uploadInfo = document.getElementById('uploadInfo');
            const videoFileInput = document.getElementById('videoFile');
            const fileName = document.getElementById('fileName');
            const fileSize = document.getElementById('fileSize');
            const uploadForm = document.getElementById('uploadForm');
            const loadingSection = document.getElementById('loadingSection');
            const resultSection = document.getElementById('resultSection');

            window.selectedFile = null;
            window.selectedSpeakerId = null;
            window.selectedCharacterName = '';
            window.currentVideoAnalysis = null;

            // Click to upload
            uploadZone.addEventListener('click', () => {
                videoFileInput.click();
            });

            // File selected
            videoFileInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    handleFile(file);
                }
            });

            // Drag and drop
            uploadZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadZone.classList.add('dragover');
            });

            uploadZone.addEventListener('dragleave', () => {
                uploadZone.classList.remove('dragover');
            });

            uploadZone.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadZone.classList.remove('dragover');
                const file = e.dataTransfer.files[0];
                if (file && file.type.startsWith('video/')) {
                    handleFile(file);
                } else {
                    alert('ë¹„ë””ì˜¤ íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
                }
            });

            function handleFile(file) {
                selectedFile = file;
                fileName.textContent = file.name;
                fileSize.textContent = `${(file.size / 1024 / 1024).toFixed(2)} MB`;
                uploadPlaceholder.classList.add('hidden');
                uploadInfo.classList.remove('hidden');
            }

            // Form submit
            uploadForm.addEventListener('submit', async (e) => {
                e.preventDefault();

                if (!selectedFile) {
                    alert('ë¹„ë””ì˜¤ íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                    return;
                }

                const title = document.getElementById('videoTitle').value;
                const description = document.getElementById('videoDescription').value;

                // Show loading
                loadingSection.classList.remove('hidden');
                resultSection.classList.add('hidden');

                // Prepare form data
                const formData = new FormData();
                formData.append('video', selectedFile);
                formData.append('title', title);
                formData.append('description', description);

                try {
                    const response = await fetch('http://localhost:4000/api/guidelines/check-video', {
                        method: 'POST',
                        body: formData
                    });

                    const data = await response.json();

                    if (!response.ok) {
                        throw new Error(data.error || 'ë¶„ì„ ì‹¤íŒ¨');
                    }

                    // Hide loading, show result
                    loadingSection.classList.add('hidden');
                    displayResult(data.analysis);

                } catch (error) {
                    console.error('Analysis error:', error);
                    loadingSection.classList.add('hidden');
                    alert('ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
                }
            });

            function displayResult(analysis) {
                // Update global state
                window.currentVideoAnalysis = analysis;

                const { overallStatus, score, violations, summary, bgmAnalysis } = analysis;

                // Status badge
                const statusBadge = document.getElementById('statusBadge');
                if (overallStatus === 'safe') {
                    statusBadge.innerHTML = '<span class="px-4 py-2 bg-green-500 text-white rounded-full font-bold">âœ… ì•ˆì „</span>';
                } else if (overallStatus === 'warning') {
                    statusBadge.innerHTML = '<span class="px-4 py-2 bg-yellow-500 text-white rounded-full font-bold">âš ï¸ ì£¼ì˜</span>';
                } else {
                    statusBadge.innerHTML = '<span class="px-4 py-2 bg-red-500 text-white rounded-full font-bold">âŒ ìœ„í—˜</span>';
                }

                // Score
                document.getElementById('score').textContent = score;

                // Summary
                document.getElementById('summary').textContent = summary || 'ë¶„ì„ ì™„ë£Œ';

                // BGM Analysis
                if (bgmAnalysis) {
                    displayBgmAnalysis(bgmAnalysis);
                }

                // Violations
                const violationsContainer = document.getElementById('violationsContainer');
                if (violations && violations.length > 0) {
                    violationsContainer.innerHTML = `
                    <h3 class="text-xl font-bold text-white mb-4">ë°œê²¬ëœ ë¬¸ì œì </h3>
                    ${violations.map(v => `
                        <div class="bg-slate-800/50 rounded-xl p-6 mb-4">
                            <div class="flex items-start gap-4">
                                <div class="flex-shrink-0">
                                    ${v.severity === 'critical' ? 'ğŸ”´' : v.severity === 'high' ? 'ğŸŸ ' : v.severity === 'medium' ? 'ğŸŸ¡' : 'ğŸŸ¢'}
                                </div>
                                <div class="flex-1">
                                    <div class="flex items-center gap-2 mb-2">
                                        <span class="px-2 py-1 bg-slate-700 text-slate-300 rounded text-xs">${v.timestamp || 'ì „ì²´'}</span>
                                        <span class="px-2 py-1 bg-blue-600/20 text-blue-400 rounded text-xs">${v.category}</span>
                                    </div>
                                    <p class="text-white font-bold mb-2">${v.issue}</p>
                                    <p class="text-green-400 text-sm">ğŸ’¡ ê°œì„  ë°©ë²•: ${v.recommendation}</p>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                `;
                } else {
                    violationsContainer.innerHTML = `
                    <div class="bg-green-500/10 rounded-xl p-6 text-center">
                        <div class="text-4xl mb-2">ğŸ‰</div>
                        <p class="text-green-400 font-bold">ë¬¸ì œì ì´ ë°œê²¬ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤!</p>
                    </div>
                `;
                }

                resultSection.classList.remove('hidden');

                // Show VOICEVOX section and check connection
                document.getElementById('voicevoxSection').classList.remove('hidden');
                checkVoicevoxConnection();
            }

            function displayBgmAnalysis(bgm) {
                const bgmSection = document.getElementById('bgmSection');

                // Risk level colors
                const riskColors = {
                    'low': 'text-green-400',
                    'medium': 'text-yellow-400',
                    'high': 'text-red-400'
                };

                const riskIcons = {
                    'low': 'ğŸŸ¢',
                    'medium': 'ğŸŸ¡',
                    'high': 'ğŸ”´'
                };

                bgmSection.innerHTML = `
                <p class="text-slate-400 text-sm mb-4">ğŸµ ë°°ê²½ìŒì•…(BGM) ë¶„ì„</p>
                <div class="space-y-3">
                    <div class="flex items-center justify-between">
                        <span class="text-slate-300">ì €ì‘ê¶Œ ìœ„í—˜ë„</span>
                        <span class="${riskColors[bgm.copyrightRiskLevel] || 'text-gray-400'} font-bold">
                            ${riskIcons[bgm.copyrightRiskLevel] || 'âšª'} ${bgm.copyrightRiskLevel?.toUpperCase() || 'UNKNOWN'}
                        </span>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="text-slate-300">ë¶„ìœ„ê¸° ì í•©ì„±</span>
                        <span class="text-blue-400 font-bold">${bgm.atmosphereMatch || '-'}</span>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="text-slate-300">ìŒëŸ‰/í’ˆì§ˆ</span>
                        <span class="text-purple-400 font-bold">${bgm.volumeQuality || '-'}</span>
                    </div>
                    ${bgm.recommendation ? `
                        <div class="mt-4 pt-4 border-t border-slate-700">
                            <p class="text-emerald-400 text-sm">ğŸ’¡ ${bgm.recommendation}</p>
                        </div>
                    ` : ''}
                </div>
            `;
            }

            // Title generation handler
            document.getElementById('generateTitlesBtn').addEventListener('click', async () => {
                if (!selectedFile) {
                    alert('ë¨¼ì € ë¹„ë””ì˜¤ íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                    return;
                }

                const title = document.getElementById('videoTitle').value;
                const description = document.getElementById('videoDescription').value;

                // Show loading
                const btn = document.getElementById('generateTitlesBtn');
                const originalText = btn.textContent;
                btn.textContent = 'â³ ì œëª© ìƒì„± ì¤‘...';
                btn.disabled = true;

                // Prepare form data
                const formData = new FormData();
                formData.append('video', selectedFile);
                formData.append('title', title);
                formData.append('description', description);

                try {
                    const response = await fetch('http://localhost:4000/api/guidelines/generate-titles', {
                        method: 'POST',
                        body: formData
                    });

                    const data = await response.json();

                    if (!response.ok) {
                        throw new Error(data.error || 'ì œëª© ìƒì„± ì‹¤íŒ¨');
                    }

                    displayTitles(data.titles);

                } catch (error) {
                    console.error('Title generation error:', error);
                    alert('ì œëª© ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
                } finally {
                    btn.textContent = originalText;
                    btn.disabled = false;
                }
            });

            function displayTitles(titles) {
                const titlesSection = document.getElementById('titlesSection');
                const titlesContent = document.getElementById('titlesContent');

                titlesContent.innerHTML = `
                <!-- Video Interpretation -->
                ${titles.videoInterpretation ? `
                    <div class="bg-blue-500/10 border border-blue-500/20 rounded-xl p-6 mb-6">
                        <div class="flex items-start gap-3">
                            <div class="text-2xl">ğŸ¬</div>
                            <div>
                                <h3 class="text-blue-400 font-bold mb-2">ì˜ìƒ í•´ì„</h3>
                                <p class="text-slate-300 leading-relaxed">${titles.videoInterpretation}</p>
                            </div>
                        </div>
                    </div>
                ` : ''}

                <!-- Korean Titles -->
                <div class="mb-6">
                    <h3 class="text-xl font-bold text-white mb-4 flex items-center gap-2">
                        ğŸ‡°ğŸ‡· í•œêµ­ì–´ ì œëª©
                    </h3>
                    <div class="space-y-2">
                        ${titles.korean?.map((t, i) => `
                            <div class="bg-slate-800/50 rounded-lg p-4 hover:bg-slate-700/50 cursor-pointer transition-colors"
                                 onclick="copyToClipboard('${t.replace(/'/g, "\\'")}', 'í•œêµ­ì–´ ì œëª© ${i + 1}')">
                                <div class="flex items-center justify-between">
                                    <span class="text-white font-medium">${i + 1}. ${t}</span>
                                    <span class="text-slate-500 text-sm">ğŸ“‹ ë³µì‚¬</span>
                                </div>
                            </div>
                        `).join('') || '<p class="text-slate-500">ìƒì„±ëœ ì œëª©ì´ ì—†ìŠµë‹ˆë‹¤</p>'}
                    </div>
                </div>

                <!-- Japanese Titles -->
                <div class="mb-6">
                    <h3 class="text-xl font-bold text-white mb-4 flex items-center gap-2">
                        ğŸ‡¯ğŸ‡µ ì¼ë³¸ì–´ ì œëª©
                    </h3>
                    <div class="space-y-2">
                        ${titles.japanese?.map((t, i) => `
                            <div class="bg-slate-800/50 rounded-lg p-4 hover:bg-slate-700/50 cursor-pointer transition-colors"
                                 onclick="copyToClipboard('${t.replace(/'/g, "\\'")}', 'ì¼ë³¸ì–´ ì œëª© ${i + 1}')">
                                <div class="flex items-center justify-between">
                                    <span class="text-white font-medium">${i + 1}. ${t}</span>
                                    <span class="text-slate-500 text-sm">ğŸ“‹ ë³µì‚¬</span>
                                </div>
                            </div>
                        `).join('') || '<p class="text-slate-500">ìƒì„±ëœ ì œëª©ì´ ì—†ìŠµë‹ˆë‹¤</p>'}
                    </div>
                </div>

                <!-- Japanese Pronunciation -->
                <div class="mb-6">
                    <h3 class="text-xl font-bold text-white mb-4 flex items-center gap-2">
                        ğŸ—£ï¸ ì¼ë³¸ì–´ ë°œìŒ (í•œê¸€)
                    </h3>
                    <div class="space-y-2">
                        ${titles.japanesePronunciation?.map((t, i) => `
                            <div class="bg-slate-800/50 rounded-lg p-4 hover:bg-slate-700/50 cursor-pointer transition-colors"
                                 onclick="copyToClipboard('${t.replace(/'/g, "\\'")}', 'ì¼ë³¸ì–´ ë°œìŒ ${i + 1}')">
                                <div class="flex items-center justify-between">
                                    <span class="text-white font-medium">${i + 1}. ${t}</span>
                                    <span class="text-slate-500 text-sm">ğŸ“‹ ë³µì‚¬</span>
                                </div>
                            </div>
                        `).join('') || '<p class="text-slate-500">ìƒì„±ëœ ì œëª©ì´ ì—†ìŠµë‹ˆë‹¤</p>'}
                    </div>
                </div>
            `;

                titlesSection.classList.remove('hidden');
                titlesSection.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }

            function copyToClipboard(text, label) {
                navigator.clipboard.writeText(text).then(() => {
                    // Show toast notification
                    const toast = document.createElement('div');
                    toast.className = 'fixed bottom-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50';
                    toast.textContent = `âœ… ${label} ë³µì‚¬ë¨!`;
                    document.body.appendChild(toast);

                    setTimeout(() => {
                        toast.remove();
                    }, 2000);
                }).catch(err => {
                    console.error('Copy failed:', err);
                    alert('ë³µì‚¬ ì‹¤íŒ¨: ' + err.message);
                });
            }

            // ========================================
            // VOICEVOX TTS Functions
            // ========================================

            // Check VOICEVOX connection status
            async function checkVoicevoxConnection() {
                try {
                    const response = await fetch('http://localhost:4000/api/voicevox/speakers');
                    const data = await response.json();

                    if (response.ok && data.success) {
                        updateVoicevoxStatus(true, `ì—°ê²°ë¨ (${data.count}ê°œ ìºë¦­í„°)`);
                        return true;
                    } else {
                        updateVoicevoxStatus(false, 'VOICEVOX ì„œë²„ì— ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                        return false;
                    }
                } catch (error) {
                    updateVoicevoxStatus(false, 'VOICEVOXê°€ ì‹¤í–‰ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤');
                    return false;
                }
            }

            function updateVoicevoxStatus(isConnected, message) {
                const dot = document.getElementById('voicevoxStatusDot');
                const text = document.getElementById('voicevoxStatusText');
                const statusDiv = document.getElementById('voicevoxStatus');

                if (isConnected) {
                    dot.className = 'w-3 h-3 rounded-full bg-green-500 animate-pulse';
                    text.textContent = message;
                    statusDiv.className = 'mb-6 p-4 rounded-lg border border-green-500/20 bg-green-500/10';
                } else {
                    dot.className = 'w-3 h-3 rounded-full bg-red-500';
                    text.textContent = message;
                    statusDiv.className = 'mb-6 p-4 rounded-lg border border-red-500/20 bg-red-500/10';
                }
            }

            // Load VOICEVOX characters
            document.getElementById('loadCharactersBtn').addEventListener('click', async () => {
                const btn = document.getElementById('loadCharactersBtn');
                const originalText = btn.textContent;
                btn.textContent = 'â³ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...';
                btn.disabled = true;

                try {
                    const response = await fetch('http://localhost:4000/api/voicevox/speakers');
                    const data = await response.json();

                    if (!response.ok) {
                        throw new Error(data.message || 'ìºë¦­í„° ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                    }

                    displayCharacters(data.speakers);
                    document.getElementById('charactersGrid').classList.remove('hidden');

                } catch (error) {
                    alert('ì˜¤ë¥˜: ' + error.message + '\n\nVOICEVOX ì•±ì„ ì‹¤í–‰í•´ì£¼ì„¸ìš”');
                } finally {
                    btn.textContent = originalText;
                    btn.disabled = false;
                }
            });

            function displayCharacters(speakers) {
                const grid = document.getElementById('charactersGrid');
                grid.innerHTML = '';

                speakers.forEach(speaker => {
                    speaker.styles.forEach(style => {
                        const card = document.createElement('div');
                        card.className = 'bg-slate-700/50 hover:bg-slate-600/50 rounded-lg p-4 cursor-pointer transition-all border-2 border-transparent hover:border-blue-500';
                        card.onclick = () => selectCharacter(style.id, speaker.nameKr || speaker.name, style.nameKr || style.name, speaker.useCase || '');

                        // Use character image if available, otherwise fallback to emoji
                        const imageHtml = speaker.imageUrl
                            ? `<img src="${speaker.imageUrl}" alt="${speaker.name}" class="w-16 h-16 mx-auto mb-2 rounded-full object-cover" onerror="this.onerror=null; this.outerHTML='<div class=\\'text-4xl mb-2\\'>ğŸ¤</div>';">`
                            : '<div class="text-4xl mb-2">ğŸ¤</div>';

                        card.innerHTML = `
                        <div class="text-center">
                            ${imageHtml}
                            <p class="text-white font-bold text-sm mb-1">${speaker.nameKr || speaker.name}</p>
                            <p class="text-slate-400 text-xs">${style.nameKr || style.name}</p>
                            ${speaker.gender ? `<p class="text-slate-500 text-xs mt-1">${speaker.gender === 'female' ? 'ğŸ‘§' : speaker.gender === 'male' ? 'ğŸ‘¦' : 'ğŸ¤–'}</p>` : ''}
                        </div>
                    `;

                        grid.appendChild(card);
                    });
                });
            }

            function selectCharacter(speakerId, characterName, styleName, useCase = '') {
                window.selectedSpeakerId = speakerId;
                window.selectedCharacterName = `${characterName} (${styleName})`;

                // Update selected character info
                document.getElementById('selectedCharacterIcon').textContent = 'ğŸ¤';
                document.getElementById('selectedCharacterName').textContent = characterName;
                document.getElementById('selectedCharacterStyle').textContent = styleName;
                document.getElementById('selectedCharacterUseCase').textContent = useCase ? `ìš©ë„: ${useCase}` : '';
                document.getElementById('selectedCharacterInfo').classList.remove('hidden');

                // Enable TTS generation if script is ready
                checkTTSButtonState();

                console.log(`Selected character: ${selectedCharacterName}, ID: ${speakerId}`);
            }

            // Preview character voice
            document.getElementById('previewCharacterBtn').addEventListener('click', async () => {
                if (!window.selectedSpeakerId) {
                    alert('ìºë¦­í„°ë¥¼ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”');
                    return;
                }

                const btn = document.getElementById('previewCharacterBtn');
                const originalText = btn.textContent;
                btn.textContent = 'â³ ìƒì„± ì¤‘...';
                btn.disabled = true;

                try {
                    const response = await fetch('http://localhost:4000/api/voicevox/preview', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            speakerId: window.selectedSpeakerId,
                            sampleText: 'ã“ã‚“ã«ã¡ã¯ã€ã‚ˆã‚ã—ããŠé¡˜ã„ã—ã¾ã™ã€‚'
                        })
                    });

                    if (!response.ok) {
                        throw new Error('ìƒ˜í”Œ ìŒì„± ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
                    }

                    const audioBlob = await response.blob();
                    const audioUrl = URL.createObjectURL(audioBlob);
                    const audio = new Audio(audioUrl);
                    audio.play();

                } catch (error) {
                    alert('ì˜¤ë¥˜: ' + error.message);
                } finally {
                    btn.textContent = originalText;
                    btn.disabled = false;
                }
            });

            // Manual script input (Always allowed)
            document.getElementById('manualScriptBtn').addEventListener('click', () => {
                document.getElementById('timelineEditor').classList.remove('hidden');
                document.getElementById('generatedScriptDisplay').classList.add('hidden');
                checkTTSButtonState();

                // Ensure section is visible if opened manually (e.g. future standalone mode)
                // In current layout, buttons are inside the section, so section must be visible first.
                // But just in case we add a global entry point:
                document.getElementById('voicevoxSection').classList.remove('hidden');
                checkVoicevoxConnection();
            });

            // Auto generate script with Gemini
            document.getElementById('autoGenerateScriptBtn').addEventListener('click', async () => {
                if (!window.currentVideoAnalysis) {
                    alert('âš ï¸ ìë™ ëŒ€ë³¸ ìƒì„±ì€ ì˜ìƒ ë¶„ì„ ë°ì´í„°ê°€ í•„ìš”í•©ë‹ˆë‹¤.\në¨¼ì € ìƒë‹¨ì˜ "ê°€ì´ë“œë¼ì¸ ë¶„ì„ ì‹œì‘"ì„ ì§„í–‰í•´ì£¼ì„¸ìš”.\n\n(ì§ì ‘ ì…ë ¥ì€ ì–¸ì œë“ ì§€ ê°€ëŠ¥í•©ë‹ˆë‹¤!)');
                    return;
                }

                const btn = document.getElementById('autoGenerateScriptBtn');
                const originalText = btn.textContent;
                btn.textContent = 'â³ Geminië¡œ ìƒì„± ì¤‘...';
                btn.disabled = true;

                try {
                    const response = await fetch('http://localhost:4000/api/voicevox/generate-script', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            videoAnalysis: window.currentVideoAnalysis,
                            duration: 15
                        })
                    });

                    const data = await response.json();

                    if (!response.ok) {
                        throw new Error(data.message || 'ëŒ€ë³¸ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
                    }

                    displayGeneratedScript(data.script);

                } catch (error) {
                    alert('ì˜¤ë¥˜: ' + error.message);
                } finally {
                    btn.textContent = originalText;
                    btn.disabled = false;
                }
            });

            function displayGeneratedScript(script) {
                let scriptSummary = script.scriptSummary || 'ì¼ë³¸ì–´ ì‡¼ì¸  ëŒ€ë³¸ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.';
                let scriptText = '';

                if (script.timeline) {
                    script.timeline.forEach(segment => {
                        // Display Format: [0-3ì´ˆ] JP: ... / KR: ... / ë°œìŒ: ...
                        scriptText += `[${segment.start}-${segment.end}ì´ˆ]\n`;
                        scriptText += `ğŸ‡¯ğŸ‡µ ì¼ë³¸ì–´: ${segment.text_jp}\n`;
                        scriptText += `ğŸ‡°ğŸ‡· í•œêµ­ì–´: ${segment.text_kr}\n`;
                        scriptText += `ğŸ—£ï¸ ë°œìŒ: ${segment.text_pron}\n\n`;
                    });
                }

                document.getElementById('generatedScriptContent').innerHTML = `
                    <div class="mb-4 text-brand-400 font-bold">${scriptSummary}</div>
                    <div class="whitespace-pre-wrap font-medium">${scriptText}</div>
                `;
                document.getElementById('generatedScriptDisplay').classList.remove('hidden');
                document.getElementById('timelineEditor').classList.add('hidden');

                // Copy to textarea for potential editing
                document.getElementById('scriptTextarea').value = scriptText;

                checkTTSButtonState();
            }

            // Edit generated script
            document.getElementById('editGeneratedScriptBtn').addEventListener('click', () => {
                document.getElementById('timelineEditor').classList.remove('hidden');
                document.getElementById('generatedScriptDisplay').classList.add('hidden');
            });

            // Generate TTS
            document.getElementById('generateTTSBtn').addEventListener('click', async () => {
                if (!window.selectedSpeakerId) {
                    alert('ìºë¦­í„°ë¥¼ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”');
                    return;
                }

                const scriptText = document.getElementById('scriptTextarea').value.trim();
                if (!scriptText) {
                    alert('ëŒ€ë³¸ì„ ì…ë ¥í•´ì£¼ì„¸ìš”');
                    return;
                }

                // Extract Japanese text for TTS
                // We need to extract the parts after "ğŸ‡¯ğŸ‡µ ì¼ë³¸ì–´: " and before the next line
                const lines = scriptText.split('\n');
                let cleanText = '';

                if (scriptText.includes('ğŸ‡¯ğŸ‡µ ì¼ë³¸ì–´:')) {
                    // Trilingual format
                    cleanText = lines
                        .filter(line => line.includes('ğŸ‡¯ğŸ‡µ ì¼ë³¸ì–´:'))
                        .map(line => line.replace('ğŸ‡¯ğŸ‡µ ì¼ë³¸ì–´:', '').trim())
                        .join('\n');
                } else {
                    // Legacy or direct format
                    cleanText = lines
                        .map(line => line.replace(/^\[.*?\]\s*/, '')) // Remove [0-3ì´ˆ] markers
                        .filter(line => line.trim())
                        .join('\n');
                }

                const btn = document.getElementById('generateTTSBtn');
                const originalText = btn.textContent;
                btn.textContent = 'â³ ìŒì„± ìƒì„± ì¤‘...';
                btn.disabled = true;

                try {
                    const response = await fetch('http://localhost:4000/api/voicevox/generate-tts', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            text: cleanText,
                            speakerId: window.selectedSpeakerId,
                            engineUrl: window.selectedEngineUrl,
                            filename: `tts_${window.selectedSpeakerId}_${Date.now()}.wav`
                        })
                    });

                    if (!response.ok) {
                        throw new Error('TTS ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
                    }

                    const audioBlob = await response.blob();
                    const audioUrl = URL.createObjectURL(audioBlob);

                    // Display generated audio
                    const audio = document.getElementById('generatedAudio');
                    audio.src = audioUrl;
                    document.getElementById('generatedAudioSection').classList.remove('hidden');

                    // Setup download
                    document.getElementById('downloadAudioBtn').onclick = () => {
                        const a = document.createElement('a');
                        a.href = audioUrl;
                        a.download = `voicevox_tts_${Date.now()}.wav`;
                        a.click();
                    };

                    // Scroll to audio section
                    document.getElementById('generatedAudioSection').scrollIntoView({
                        behavior: 'smooth',
                        block: 'center'
                    });

                } catch (error) {
                    alert('ì˜¤ë¥˜: ' + error.message);
                } finally {
                    btn.textContent = originalText;
                    btn.disabled = false;
                }
            });

            function checkTTSButtonState() {
                const scriptText = document.getElementById('scriptTextarea').value.trim();
                const btn = document.getElementById('generateTTSBtn');
                const helpText = btn.nextElementSibling;

                if (window.selectedSpeakerId && scriptText) {
                    btn.disabled = false;
                    btn.classList.remove('opacity-50', 'cursor-not-allowed', 'grayscale');
                    btn.classList.add('hover:scale-[1.02]', 'hover:shadow-lg', 'hover:shadow-purple-500/20');
                    if (helpText) helpText.textContent = 'ğŸ‘† ì´ì œ ìŒì„± íŒŒì¼ì„ ìƒì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤!';
                } else {
                    btn.disabled = true;
                    btn.classList.add('opacity-50', 'cursor-not-allowed', 'grayscale');
                    btn.classList.remove('hover:scale-[1.02]');
                    if (helpText) helpText.textContent = 'ìºë¦­í„°ì™€ ëŒ€ë³¸ì„ ì„ íƒí•˜ë©´ ìƒì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤';
                }
            }

            // Listen for script changes
            document.getElementById('scriptTextarea').addEventListener('input', checkTTSButtonState);


        </script>
</body>

</html>
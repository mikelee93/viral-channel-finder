<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YouTube 가이드라인 체크 | Viral Shorts Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        body {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            min-height: 100vh;
        }

        .glass-panel {
            background: rgba(30, 41, 59, 0.5);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .upload-zone {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(168, 85, 247, 0.1) 100%);
            border: 2px dashed rgba(99, 102, 241, 0.5);
            cursor: pointer;
            transition: all 0.3s;
        }

        .upload-zone:hover {
            border-color: rgba(99, 102, 241, 0.8);
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.2) 0%, rgba(168, 85, 247, 0.2) 100%);
        }

        .glass {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
        }

        /* Loader animation */
        .loader {
            border-radius: 50%;
            border-top-color: currentColor;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .upload-zone.dragover {
            border-color: #10b981;
            background: rgba(16, 185, 129, 0.1);
        }
    </style>
</head>

<body class="p-8">
    <div class="max-w-6xl mx-auto">
        <div class="flex justify-end mb-6 gap-3">
            <a href="reddit_viral_finder.html"
                class="flex items-center gap-2 bg-orange-600/20 text-orange-400 border border-orange-500/30 px-4 py-2 rounded-lg hover:bg-orange-600/30 transition-colors font-bold">
                <span class="text-xl">🔥</span>
                <span>Reddit Viral Finder</span>
                <span>→</span>
            </a>
            <a href="viral_style_trainer.html"
                class="flex items-center gap-2 bg-blue-600/20 text-blue-400 border border-blue-500/30 px-4 py-2 rounded-lg hover:bg-blue-600/30 transition-colors font-bold">
                <span class="text-xl">🧪</span>
                <span>스타일 연구소로 이동</span>
                <span>→</span>
            </a>
        </div>

        <!-- Header -->
        <div class="text-center mb-12">
            <h1 class="text-5xl font-black text-white mb-4">
                📋 YouTube/Reddit 가이드라인 체크
            </h1>
            <p class="text-slate-400 text-lg">
                업로드 전 가이드라인 위반 여부를 AI로 사전 체크하세요
            </p>
        </div>

        <!-- Upload Section -->
        <div class="glass-panel rounded-2xl p-8 mb-8">
            <h2 class="text-2xl font-bold text-white mb-6">📤 비디오 업로드</h2>

            <form id="uploadForm" enctype="multipart/form-data">
                <!-- Video URL Input (New) -->
                <div class="mb-6 bg-slate-800/50 p-4 rounded-xl border border-slate-700/50">
                    <label class="block text-slate-300 font-bold mb-2">🌐 URL로 분석 (유튜브/레딧)</label>
                    <div class="flex gap-2">
                        <input type="text" id="videoUrlInput"
                            class="flex-1 px-4 py-3 bg-slate-900 text-white rounded-lg border border-slate-700 focus:border-blue-500 focus:outline-none font-mono text-sm"
                            placeholder="https://www.youtube.com/watch?v=... 또는 Reddit 비디오 URL">
                    </div>
                    <div id="vRedditWarning"
                        class="hidden mt-3 p-3 bg-yellow-500/20 border border-yellow-500/50 rounded-lg text-sm text-yellow-200">
                        <div class="flex items-start gap-3">
                            <span class="text-xl">⚠️</span>
                            <div>
                                <p class="font-bold mb-1">직접 미디어 링크(v.redd.it)가 감지되었습니다</p>
                                <p class="text-xs text-yellow-100/80 mb-2 leading-relaxed">
                                    이 링크는 영상 파일만 포함하고 있어 <strong>댓글 분석</strong>이 불가능합니다.
                                    대본 추출은 가능하지만, AI 하이라이트 품질을 위해 <strong>게시물 원본 URL</strong>을 사용하는 것을 권장합니다.
                                </p>
                                <a id="searchPostLink" href="#" target="_blank"
                                    class="inline-flex items-center gap-2 bg-yellow-600 hover:bg-yellow-500 text-black px-3 py-1.5 rounded font-bold transition-colors text-xs">
                                    🔍 Google에서 원본 게시물 찾기
                                </a>
                            </div>
                        </div>
                    </div>
                    <p class="text-slate-500 text-xs mt-2">파일 업로드 대신 URL을 입력하면 자동으로 다운로드하여 분석합니다.</p>
                </div>

                <!-- File Upload Zone -->
                <div class="upload-zone rounded-xl p-12 text-center mb-6" id="uploadZone">
                    <div id="uploadPlaceholder">
                        <div class="text-6xl mb-4">🎬</div>
                        <p class="text-slate-300 font-bold text-lg mb-2">비디오 파일을 드래그하거나 클릭하세요</p>
                        <p class="text-slate-500 text-sm">MP4, MOV, AVI (최대 100MB)</p>
                        <input type="file" id="videoFile" accept="video/*" class="hidden" />
                    </div>
                    <div id="uploadInfo" class="hidden">
                        <div class="text-4xl mb-2">✅</div>
                        <p class="text-green-400 font-bold" id="fileName"></p>
                        <p class="text-slate-500 text-sm" id="fileSize"></p>
                    </div>
                </div>

                <!-- Title -->
                <div class="mb-4">
                    <label class="block text-slate-300 font-bold mb-2">제목 (선택사항)</label>
                    <input type="text" id="videoTitle"
                        class="w-full px-4 py-3 bg-slate-800 text-white rounded-lg border border-slate-700 focus:border-blue-500 focus:outline-none"
                        placeholder="영상 제목을 입력하세요 (생략 가능)">
                </div>

                <!-- Description -->
                <div class="mb-6">
                    <label class="block text-slate-300 font-bold mb-2">설명</label>
                    <textarea id="videoDescription" rows="3"
                        class="w-full px-4 py-3 bg-slate-800 text-white rounded-lg border border-slate-700 focus:border-blue-500 focus:outline-none"
                        placeholder="영상 설명을 입력하세요 (선택사항)"></textarea>
                </div>

                <!-- Comments -->
                <div class="mb-6">
                    <label class="block text-slate-300 font-bold mb-2">
                        💬 바이럴 분석용 댓글 (선택사항)
                        <span class="text-xs text-slate-500 font-normal ml-2">원본 영상의 베스트 댓글을 넣으면 AI가 더 정확한 하이라이트를
                            잡습니다</span>
                    </label>
                    <!-- URL Scraper Input -->
                    <div class="flex gap-2 mb-3">
                        <input type="text" id="commentUrlInput"
                            placeholder="YouTube 또는 Reddit URL을 입력하면 댓글을 자동으로 긁어옵니다 (예: reddit.com/r/.../comments/...)"
                            class="flex-1 px-4 py-2 bg-slate-900 border border-slate-700 rounded-lg text-white font-mono text-sm focus:border-purple-500 focus:outline-none">
                        <button type="button" id="scrapeCommentsBtn"
                            class="bg-purple-600 hover:bg-purple-500 text-white px-4 py-2 rounded-lg font-bold text-sm transition-colors whitespace-nowrap flex items-center gap-2">
                            <span>🌐 댓글 가져오기</span>
                        </button>
                    </div>

                    <textarea id="videoComments" rows="4"
                        class="w-full px-4 py-3 bg-slate-800 text-white rounded-lg border border-slate-700 focus:border-blue-500 focus:outline-none"
                        placeholder="예: '3:20 이 부분이 진짜 웃김 ㅋㅋ', '마지막 반전 소름돋네 ㄷㄷ' 등\n(여러 댓글을 복사해 넣으셔도 좋습니다)"></textarea>
                </div>

                <!-- Submit Button -->
                <button type="submit" id="analyzeBtn"
                    class="w-full bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-500 hover:to-purple-500 text-white font-bold py-4 rounded-xl transition-all transform hover:scale-[1.02]">
                    🔍 가이드라인 분석 시작
                </button>
            </form>
        </div>

        <!-- Loading Section -->
        <div id="loadingSection" class="glass-panel rounded-2xl p-12 text-center hidden">
            <div class="loader w-16 h-16 border-4 border-t-blue-500 mx-auto mb-4"></div>
            <p class="text-white font-bold text-xl mb-2">AI로 가이드라인 분석 중...</p>
            <p class="text-slate-400">영상 내용, 음성, 텍스트를 검토하고 있습니다</p>
        </div>

        <!-- Result Section -->
        <div id="resultSection" class="hidden">
            <div class="glass-panel rounded-2xl p-8 mb-6">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-2xl font-bold text-white">분석 결과</h2>
                    <div id="statusBadge"></div>
                </div>

                <!-- Score -->
                <div class="bg-slate-800/50 rounded-xl p-6 mb-6 text-center">
                    <p class="text-slate-400 text-sm mb-2">안전 점수</p>
                    <p class="text-5xl font-black text-white" id="score">--</p>
                    <p class="text-slate-500 text-sm mt-2">100점 만점</p>
                </div>

                <!-- Summary -->
                <div class="bg-slate-800/50 rounded-xl p-6 mb-6">
                    <p class="text-slate-400 text-sm mb-2">종합 평가</p>
                    <p class="text-white" id="summary">--</p>
                </div>

                <!-- BGM Analysis -->
                <div class="bg-slate-800/50 rounded-xl p-6 mb-6" id="bgmSection"></div>

                <!-- Violations -->
                <div id="violationsContainer"></div>

                <!-- Action Buttons -->
                <div class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-4">
                    <button id="generateTitlesBtn"
                        class="bg-gradient-to-r from-green-600 to-blue-600 hover:from-green-500 hover:to-blue-500 text-white font-bold py-4 rounded-xl transition-all transform hover:scale-[1.02]">
                        ✨ Shorts 제목 생성 (한/일/발음)
                    </button>
                    <button id="extractTranscriptBtn"
                        class="bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-500 hover:to-pink-500 text-white font-bold py-4 rounded-xl transition-all transform hover:scale-[1.02]">
                        📝 영상 대본 추출
                    </button>
                    <!-- Whisper Provider Toggle -->
                    <div class="col-span-1 md:col-span-2 bg-slate-800/50 rounded-xl p-4 border border-slate-700">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-white font-bold mb-1">🎙️ Whisper ASR 엔진 선택</p>
                                <p class="text-slate-400 text-xs">유료는 정확한 타임스탬프, 무료는 예상 타임스탬프</p>
                            </div>
                            <div class="flex items-center gap-3 bg-slate-900 rounded-full p-1">
                                <button id="whisperOpenAI" onclick="selectWhisperProvider('openai')"
                                    class="px-4 py-2 rounded-full font-bold text-sm transition-all bg-gradient-to-r from-green-600 to-blue-600 text-white shadow-lg">
                                    💳 OpenAI (유료)
                                </button>
                                <button id="whisperHF" onclick="selectWhisperProvider('huggingface')"
                                    class="px-4 py-2 rounded-full font-bold text-sm transition-all text-slate-400 hover:text-white">
                                    🆓 HuggingFace (무료)
                                </button>
                            </div>
                        </div>
                    </div>
                    <button id="openAiProductionBtn"
                        class="col-span-1 md:col-span-2 bg-gradient-to-r from-amber-500 to-orange-600 hover:from-amber-400 hover:to-orange-500 text-white font-black py-4 rounded-xl transition-all transform hover:scale-[1.02] shadow-lg shadow-orange-500/20 flex items-center justify-center gap-3">
                        🧪 AI 자동 프로덕션 (스타일 적용)
                    </button>
                </div>
            </div>

            <!-- AI Production Result Section -->
            <div id="aiProductionSection" class="glass-panel rounded-2xl p-8 mb-6 hidden">
                <div class="flex items-center justify-between mb-8">
                    <h2 class="text-3xl font-black text-white flex items-center gap-3">
                        <span class="text-4xl">🎬</span> AI 프로덕션 결과
                    </h2>
                    <span class="px-4 py-2 bg-slate-800 rounded-lg text-slate-400 font-mono text-sm"
                        id="prodStyleLabel">스타일: -</span>
                </div>

                <!-- 3 Script Tabs -->
                <div class="mb-6">
                    <div class="flex gap-2 bg-slate-800/50 p-1 rounded-xl mb-4">
                        <button class="flex-1 py-3 rounded-lg font-bold text-white bg-slate-700 shadow-lg tab-btn"
                            onclick="switchScriptTab('jp')">🇯🇵 일본어</button>
                        <button class="flex-1 py-3 rounded-lg font-bold text-slate-400 hover:text-white tab-btn"
                            onclick="switchScriptTab('pron')">🗣️ 한글발음</button>
                        <button class="flex-1 py-3 rounded-lg font-bold text-slate-400 hover:text-white tab-btn"
                            onclick="switchScriptTab('kr')">🇰🇷 한국어</button>
                    </div>

                    <div class="bg-slate-900/50 rounded-xl p-6 h-[400px] overflow-y-auto border border-slate-700 relative font-mono leading-relaxed"
                        id="prodScriptDisplay">
                        <!-- Script Content -->
                    </div>
                </div>

                <!-- Audio / Voicevox -->
                <div class="bg-indigo-900/20 border border-indigo-500/30 rounded-xl p-6">
                    <h3 class="text-xl font-bold text-white mb-4 flex items-center gap-2">
                        🎙️ Voicevox 오디오
                    </h3>
                    <div id="prodAudioPlayer" class="hidden mb-4">
                        <audio id="prodAudio" controls class="w-full"></audio>
                    </div>
                    <div class="flex gap-3">
                        <button id="prodGenerateAudioBtn"
                            class="flex-1 bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-3 rounded-lg transition-all">
                            🔊 오디오 생성하기
                        </button>
                        <button id="prodDownloadSrtBtn"
                            class="bg-slate-700 hover:bg-slate-600 text-white font-bold py-3 px-6 rounded-lg transition-all">
                            📄 SRT 자막
                        </button>
                    </div>
                </div>
            </div>

            <!-- Style Selection Modal -->
            <div id="styleModal"
                class="fixed inset-0 bg-black/90 backdrop-blur-md z-50 hidden flex items-center justify-center p-4">
                <div
                    class="bg-slate-900 border border-slate-700 rounded-2xl w-full max-w-6xl h-[85vh] flex flex-col shadow-2xl overflow-hidden relative">
                    <!-- Header -->
                    <div class="p-6 border-b border-slate-700 flex justify-between items-center bg-slate-900 z-10">
                        <div>
                            <h2 class="text-2xl font-bold text-white flex items-center gap-2">🎨 스타일 선택 <span
                                    class="text-orange-500 text-sm bg-orange-500/10 px-2 py-0.5 rounded">Style
                                    Lab</span></h2>
                            <p class="text-slate-400 text-sm mt-1">벤치마킹할 채널(페르소나)을 선택하세요.</p>
                        </div>
                        <button onclick="document.getElementById('styleModal').classList.add('hidden')"
                            class="w-10 h-10 rounded-full bg-slate-800 text-slate-400 hover:bg-slate-700 hover:text-white transition-all flex items-center justify-center text-xl">×</button>
                    </div>

                    <!-- Content -->
                    <div class="flex-1 overflow-hidden flex">
                        <!-- Left: Categories -->
                        <div class="w-64 bg-slate-800/30 overflow-y-auto p-4 border-r border-slate-700 space-y-2"
                            id="styleCategories">
                            <!-- Categories injected here -->
                        </div>

                        <!-- Right: Channels -->
                        <div class="flex-1 overflow-y-auto p-8 bg-slate-900/50" id="styleChannelsContainer">
                            <div id="styleChannelsGrid"
                                class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-3 gap-6">
                                <!-- Channels injected here -->
                            </div>
                        </div>
                    </div>

                    <!-- Footer -->
                    <div class="p-6 border-t border-slate-700 bg-slate-800 flex justify-between items-center">
                        <div class="flex items-center gap-4">
                            <div id="selectedStylePreview"
                                class="w-12 h-12 rounded-full bg-slate-700 flex-shrink-0 bg-cover bg-center"></div>
                            <div>
                                <p class="text-slate-400 text-xs">선택된 스타일</p>
                                <p id="selectedStyleName" class="font-bold text-white text-lg">선택해주세요</p>
                                <!-- Fix for Hybrid Style Selection Error -->
                                <div id="appliedStyleResult"
                                    class="hidden mt-1 p-2 bg-pink-500/10 border border-pink-500/30 rounded text-sm">
                                </div>
                            </div>
                        </div>
                        <button id="startProductionBtn" disabled
                            class="bg-gradient-to-r from-orange-500 to-pink-600 hover:from-orange-400 hover:to-pink-500 text-white font-bold py-3 px-10 rounded-xl disabled:opacity-50 disabled:cursor-not-allowed transition-all shadow-lg transform hover:scale-[1.02]">
                            🚀 스타일 대본 생성 시작
                        </button>
                    </div>
                </div>
            </div>

            <!-- Transcript Extraction Section (Step 1) -->
            <div id="transcriptStepSection" class="glass-panel rounded-2xl p-8 mb-6 hidden">
                <h2 class="text-2xl font-bold text-white mb-6">📝 Step 1: 영상 대본 추출 결과</h2>

                <!-- Language Info -->
                <div class="bg-slate-800/50 rounded-xl p-4 mb-6">
                    <div class="flex items-center gap-4">
                        <span id="detectedLanguageFlag" class="text-4xl">🌐</span>
                        <div class="flex-1">
                            <div class="flex items-center gap-3 mb-1">
                                <p class="text-white font-bold text-xl" id="languageName">-</p>
                                <span id="translationBadge"
                                    class="px-3 py-1 bg-green-500/20 text-green-400 rounded-full text-sm font-bold hidden">
                                    🌐 한국어 번역 포함
                                </span>
                            </div>
                            <div class="flex gap-3 text-sm">
                                <span class="text-slate-400">
                                    <span class="text-purple-400 font-bold" id="transcriptDuration">-</span>초
                                </span>
                                <span class="text-slate-400">•</span>
                                <span class="text-slate-400">
                                    <span class="text-purple-400 font-bold" id="transcriptSegments">-</span>개 세그먼트
                                </span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Bilingual Transcript -->
                <div id="bilingualTranscriptContainer" class="mb-6">
                    <h3 class="text-lg font-bold text-white mb-4">대본 내용</h3>
                    <div class="space-y-3 max-h-[500px] overflow-y-auto" id="bilingualTranscript">
                        <!-- Dynamic segments will be inserted here -->
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="grid grid-cols-2 gap-3">
                    <button id="copyTranscriptBtn"
                        class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 rounded-lg transition-colors">
                        📋 대본 복사
                    </button>
                    <button id="extractHighlightsBtn"
                        class="bg-purple-600 hover:bg-purple-500 text-white font-bold py-3 rounded-lg transition-colors">
                        ✂️ 하이라이트 추출 →
                    </button>
                </div>
            </div>

            <!-- Highlight Selection Section (Step 2) -->
            <div id="highlightsStepSection" class="glass-panel rounded-2xl p-8 mb-6 hidden">
                <h2 class="text-2xl font-bold text-white mb-6">✂️ Step 2: 하이라이트 구간 선택</h2>

                <p class="text-slate-300 mb-6">AI가 분석한 가장 바이럴하기 좋은 구간들입니다. 하나를 선택해 보세요.</p>

                <!-- Highlights Grid -->
                <div id="highlightsGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-8">
                    <!-- Dynamic cards -->
                </div>

                <!-- Manual Selection (Optional) -->
                <div class="bg-slate-800/50 rounded-xl p-4 mb-6 hidden">
                    <h3 class="font-bold text-white mb-2">수동 구간 설정</h3>
                    <div class="flex items-center gap-4">
                        <input type="number" id="manualStart" placeholder="0.0"
                            class="bg-slate-900 border border-slate-700 rounded px-3 py-2 text-white w-24">
                        <span class="text-white">~</span>
                        <input type="number" id="manualEnd" placeholder="10.0"
                            class="bg-slate-900 border border-slate-700 rounded px-3 py-2 text-white w-24">
                    </div>
                </div>

                <div class="flex justify-center items-center gap-4">
                    <button id="cutHighlightsVideoBtn" disabled
                        class="w-full bg-gradient-to-r from-blue-600 to-cyan-600 hover:from-blue-500 hover:to-cyan-500 text-white font-bold py-3 px-8 rounded-xl transition-all transform hover:scale-[1.05] opacity-50 cursor-not-allowed flex items-center justify-center gap-2">
                        <span>✂️ 하이라이트 영상 자동 생성 (FFmpeg)</span>
                    </button>
                </div>
            </div>

            <!-- Titles Section -->
            <div id="titlesSection" class="glass-panel rounded-2xl p-8 hidden">
                <h2 class="text-2xl font-bold text-white mb-6">📝 생성된 Shorts 제목</h2>
                <div id="titlesContent"></div>
            </div>

            <!-- VOICEVOX TTS Section -->
            <div id="voicevoxSection" class="glass-panel rounded-2xl p-8 hidden mt-6">
                <h2 class="text-2xl font-bold text-white mb-6">🎙️ 일본어 TTS 생성 (VOICEVOX)</h2>

                <!-- VOICEVOX Connection Status -->
                <div id="voicevoxStatus" class="mb-6 p-4 rounded-lg border">
                    <div class="flex items-center gap-3">
                        <div class="w-3 h-3 rounded-full" id="voicevoxStatusDot"></div>
                        <span id="voicevoxStatusText" class="text-white font-medium"></span>
                    </div>
                </div>

                <!-- Character Selection -->
                <div class="mb-8">
                    <div class="flex items-baseline justify-between mb-4">
                        <h3 class="text-xl font-bold text-white flex items-center gap-2">👤 캐릭터 선택</h3>
                        <a href="https://hub.aivis-project.com/" target="_blank"
                            class="text-[10px] bg-slate-800/80 hover:bg-brand-600/20 text-brand-400 px-3 py-1.5 rounded-full border border-brand-500/30 transition-all flex items-center gap-1.5 group">
                            🌐 AIVISS Hub에서 더 많은 캐릭터 발견하기
                            <span class="inline-block transition-transform group-hover:translate-x-0.5">→</span>
                        </a>
                    </div>
                    <div class="bg-slate-800/50 rounded-xl p-6">
                        <button id="loadCharactersBtn"
                            class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 rounded-lg mb-4">
                            캐릭터 목록 불러오기
                        </button>

                        <!-- Category Tabs -->
                        <div id="categoryTabs" class="hidden mb-4">
                            <div class="flex flex-wrap gap-2 mb-4">
                                <button
                                    class="category-tab px-3 py-2 rounded-lg font-medium transition-all text-sm active"
                                    data-category="all">
                                    전체
                                </button>
                                <button class="category-tab px-3 py-2 rounded-lg font-medium transition-all text-sm"
                                    data-category="여성 - 밝고 귀여운">
                                    👧 밝고 귀여운
                                </button>
                                <button class="category-tab px-3 py-2 rounded-lg font-medium transition-all text-sm"
                                    data-category="여성 - 차분하고 성숙">
                                    👩 차분하고 성숙
                                </button>
                                <button class="category-tab px-3 py-2 rounded-lg font-medium transition-all text-sm"
                                    data-category="남성 - 청년">
                                    👨 남성 청년
                                </button>
                                <button class="category-tab px-3 py-2 rounded-lg font-medium transition-all text-sm"
                                    data-category="남성 - 중년/특이">
                                    👴 남성 중년
                                </button>
                                <button class="category-tab px-3 py-2 rounded-lg font-medium transition-all text-sm"
                                    data-category="특수 - 로봇/기계">
                                    🤖 로봇/기계
                                </button>
                                <button class="category-tab px-3 py-2 rounded-lg font-medium transition-all text-sm"
                                    data-category="특수 - 판타지">
                                    ✨ 판타지
                                </button>
                            </div>
                        </div>

                        <div id="charactersGrid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 hidden">
                            <!-- Characters will be loaded here -->
                        </div>
                        <div id="selectedCharacterInfo" class="mt-4 hidden">
                            <div class="bg-blue-500/10 border border-blue-500/20 rounded-lg p-4">
                                <p class="text-blue-400 font-bold mb-2">선택한 캐릭터:</p>
                                <div class="flex items-center gap-4">
                                    <div class="flex-1">
                                        <div class="flex items-baseline gap-2">
                                            <p class="text-white font-medium text-lg" id="selectedCharacterName">캐릭터를
                                                선택해주세요</p>
                                            <span id="selectedCharacterEngine" class="hidden"></span>
                                        </div>
                                        <p class="text-brand-400 text-sm font-bold" id="selectedCharacterStyle"></p>
                                        <p class="text-slate-500 text-xs mt-1" id="selectedCharacterUseCase"></p>
                                    </div>
                                    <div class="flex gap-2">
                                        <button id="previewCharacterBtn"
                                            class="px-4 py-2 bg-blue-600 hover:bg-blue-500 text-white rounded-lg transition-colors flex items-center gap-2">
                                            🔊 미리듣기
                                        </button>
                                        <button id="stopPreviewBtn"
                                            class="px-4 py-2 bg-red-600 hover:bg-red-500 text-white rounded-lg hidden transition-colors flex items-center gap-2">
                                            ⏹️ 정지
                                        </button>
                                    </div>
                                </div>

                                <!-- Audio Params UI -->
                                <div id="audioSettingsPanel" class="mt-4 pt-4 border-t border-blue-500/30">
                                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                        <!-- Speed -->
                                        <div>
                                            <div class="flex justify-between text-[10px] text-blue-300 mb-1">
                                                <span>話速 (Speed)</span>
                                                <span id="val-speedScale" class="font-mono">1.00</span>
                                            </div>
                                            <input type="range" id="param-speedScale" min="0.50" max="2.00" step="0.01"
                                                value="1.00"
                                                class="w-full h-1.5 bg-slate-900 rounded-lg appearance-none cursor-pointer accent-blue-500">
                                        </div>
                                        <!-- Pitch -->
                                        <div>
                                            <div class="flex justify-between text-[10px] text-blue-300 mb-1">
                                                <span>音高 (Pitch)</span>
                                                <span id="val-pitchScale" class="font-mono">0.00</span>
                                            </div>
                                            <input type="range" id="param-pitchScale" min="-0.15" max="0.15" step="0.01"
                                                value="0.00"
                                                class="w-full h-1.5 bg-slate-900 rounded-lg appearance-none cursor-pointer accent-blue-500">
                                        </div>
                                        <!-- Intonation -->
                                        <div>
                                            <div class="flex justify-between text-[10px] text-blue-300 mb-1">
                                                <span>抑揚 (Intonation)</span>
                                                <span id="val-intonationScale" class="font-mono">1.00</span>
                                            </div>
                                            <input type="range" id="param-intonationScale" min="0.00" max="2.00"
                                                step="0.01" value="1.00"
                                                class="w-full h-1.5 bg-slate-900 rounded-lg appearance-none cursor-pointer accent-blue-500">
                                        </div>
                                        <!-- Volume -->
                                        <div>
                                            <div class="flex justify-between text-[10px] text-blue-300 mb-1">
                                                <span>音量 (Volume)</span>
                                                <span id="val-volumeScale" class="font-mono">1.00</span>
                                            </div>
                                            <input type="range" id="param-volumeScale" min="0.00" max="2.00" step="0.01"
                                                value="1.00"
                                                class="w-full h-1.5 bg-slate-900 rounded-lg appearance-none cursor-pointer accent-blue-500">
                                        </div>
                                        <!-- Pre-phoneme -->
                                        <div>
                                            <div class="flex justify-between text-[10px] text-blue-300 mb-1">
                                                <span>開始無音 (Start Pause)</span>
                                                <span id="val-prePhonemeLength" class="font-mono">0.10</span>
                                            </div>
                                            <input type="range" id="param-prePhonemeLength" min="0.00" max="1.50"
                                                step="0.01" value="0.10"
                                                class="w-full h-1.5 bg-slate-900 rounded-lg appearance-none cursor-pointer accent-blue-500">
                                        </div>
                                        <!-- Post-phoneme -->
                                        <div>
                                            <div class="flex justify-between text-[10px] text-blue-300 mb-1">
                                                <span>間の長さ (Pause/Gap)</span>
                                                <span id="val-postPhonemeLength" class="font-mono">0.10</span>
                                            </div>
                                            <input type="range" id="param-postPhonemeLength" min="0.00" max="1.50"
                                                step="0.01" value="0.10"
                                                class="w-full h-1.5 bg-slate-900 rounded-lg appearance-none cursor-pointer accent-blue-500">
                                        </div>

                                        <!-- Reset -->
                                        <div class="flex items-end justify-end col-span-2">
                                            <button id="resetAudioParamsBtn"
                                                class="text-xs text-blue-400 hover:text-white flex items-center gap-1 transition-colors px-2 py-1 bg-blue-500/20 rounded hover:bg-blue-500/40">
                                                <span>↺</span> 설정 초기화
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Script Generation -->
                <div class="mb-8">
                    <h3 class="text-xl font-bold text-white mb-4">📝 일본어 대본</h3>
                    <div class="bg-slate-800/50 rounded-xl p-6">

                        <!-- Timeline Editor (Always Visible) -->
                        <div id="timelineEditor" class="space-y-4">
                            <div class="bg-slate-900/50 rounded-lg p-4">
                                <label class="text-slate-300 font-bold mb-2 block">타임라인 대본</label>
                                <textarea id="scriptTextarea" rows="10"
                                    class="w-full px-4 py-3 bg-slate-800 text-white rounded-lg border border-slate-700 focus:border-purple-500 focus:outline-none font-mono"
                                    placeholder="예시:
[0-3초] 皆さん、こんにちは！
[3-10초] 今日は面白い動画を紹介します
[10-15초] チャンネル登録お願いします！"></textarea>
                                <p class="text-slate-500 text-sm mt-2">
                                    💡 타임라인 형식으로 입력하거나, 일반 텍스트로 입력하세요
                                </p>
                            </div>
                        </div>

                    </div>
                </div>

                <!-- TTS Generation -->
                <div class="mb-8">
                    <h3 class="text-xl font-bold text-white mb-4">🎵 음성 생성</h3>
                    <div class="bg-slate-800/50 rounded-xl p-6">
                        <button id="generateTTSBtn"
                            class="w-full bg-gradient-to-r from-pink-600 to-purple-600 hover:from-pink-500 hover:to-purple-500 text-white font-bold py-4 rounded-xl transition-all transform hover:scale-[1.02]"
                            disabled>
                            🎙️ TTS 음성 파일 생성
                        </button>
                        <p class="text-slate-500 text-sm mt-2 text-center">
                            캐릭터와 대본을 선택하면 생성할 수 있습니다
                        </p>
                    </div>
                </div>

                <!-- Generated Audio -->
                <div id="generatedAudioSection" class="hidden">
                    <div
                        class="bg-gradient-to-r from-green-500/10 to-blue-500/10 border border-green-500/20 rounded-xl p-6">
                        <h3 class="text-xl font-bold text-white mb-4">🎉 음성 생성 완료!</h3>
                        <audio id="generatedAudio" controls class="w-full mb-4"></audio>
                        <button id="downloadAudioBtn"
                            class="w-full bg-green-600 hover:bg-green-500 text-white font-bold py-3 rounded-lg mb-2 transition-all">
                            ⬇️ WAV 파일 다운로드
                        </button>
                        <button id="downloadNarratorSrtBtn"
                            class="w-full bg-slate-700 hover:bg-slate-600 text-blue-400 font-bold py-3 rounded-lg transition-all hidden">
                            📜 나레이터 SRT 자막 다운로드
                        </button>
                    </div>
                </div>

            </div>

        </div>

        <!-- Enhanced VOICEVOX UI Script -->
        <script src="voicevox-ui-enhanced.js"></script>

        <script>
            // Function to fetch comments
            async function fetchComments(url) {
                const commentInput = document.getElementById('videoComments');
                const fetchBtn = document.getElementById('fetchCommentsBtn');

                if (!commentInput) return;

                // Visual feedback
                commentInput.placeholder = "💬 Reddit/YouTube 댓글을 가져오는 중입니다...";
                if (fetchBtn) {
                    fetchBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 가져오는 중...';
                    fetchBtn.disabled = true;
                }

                try {
                    const response = await fetch('/api/guidelines/scrape-comments', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ url })
                    });

                    const data = await response.json();

                    if (data.success && data.comments && data.comments.length > 0) {
                        commentInput.value = data.comments.join('\n');
                        // Show success toast or message? For now just populate
                        if (fetchBtn) fetchBtn.innerHTML = '<i class="fas fa-check"></i> 가져오기 성공!';
                    } else {
                        commentInput.placeholder = "댓글을 찾을 수 없습니다. 직접 입력해주세요.";
                        if (fetchBtn) fetchBtn.innerHTML = '🌐 댓글 가져오기';
                    }
                } catch (e) {
                    console.error('Failed to fetch comments:', e);
                    commentInput.placeholder = "댓글 가져오기 실패. URL을 확인해주세요.";
                    if (fetchBtn) fetchBtn.innerHTML = '🌐 댓글 가져오기';
                } finally {
                    if (fetchBtn) {
                        setTimeout(() => {
                            fetchBtn.disabled = false;
                            if (fetchBtn.innerHTML.includes('성공')) {
                                setTimeout(() => fetchBtn.innerHTML = '🌐 댓글 가져오기', 2000);
                            }
                        }, 500);
                    }
                }
            }

            // Auto-load from URL params
            window.addEventListener('DOMContentLoaded', () => {
                const urlParams = new URLSearchParams(window.location.search);
                const autoUrl = urlParams.get('url') || urlParams.get('videoUrl'); // Handle both params
                const autoTitle = urlParams.get('title');
                const autoStart = urlParams.get('autoStart'); // Optional flag
                const styleIdParam = urlParams.get('styleId'); // NEW: Style ID from Finder

                // Store globally for Production Modal to use later
                if (styleIdParam) {
                    window.preSelectedStyleId = styleIdParam;
                    console.log('✅ Pre-selected Style ID:', styleIdParam);
                }

                if (autoUrl) {
                    const urlInput = document.getElementById('videoUrlInput');
                    const commentInput = document.getElementById('commentUrlInput');

                    if (urlInput) {
                        urlInput.value = autoUrl;
                        urlInput.focus();
                        urlInput.parentElement.parentElement.classList.add('ring-2', 'ring-blue-500');
                    }

                    if (commentInput) {
                        commentInput.value = autoUrl;
                    }

                    // Auto-trigger comment scraping ONLY if not v.redd.it
                    if (!autoUrl.includes('v.redd.it')) {
                        setTimeout(() => {
                            const scrapeBtn = document.getElementById('scrapeCommentsBtn');
                            if (scrapeBtn) scrapeBtn.click();
                        }, 500);
                    } else {
                        console.log('Skipping auto-comment scrape for v.redd.it URL');
                    }

                    if (autoTitle) {
                        const titleInput = document.getElementById('videoTitle');
                        if (titleInput) titleInput.value = autoTitle;
                    }

                    // If specifically requested to auto-start
                    if (autoStart === 'true') {
                        // Small delay to ensure UI is ready
                        setTimeout(() => {
                            const form = document.getElementById('uploadForm');
                            if (form) form.dispatchEvent(new Event('submit'));
                        }, 500);
                    }
                }

                // Add explicit listener for manual input
                const urlInput = document.getElementById('videoUrlInput');
                if (urlInput) {
                    urlInput.addEventListener('change', (e) => {
                        if (e.target.value && e.target.value.length > 10) {
                            fetchComments(e.target.value);
                        }
                    });
                }
            });
        </script>

        <script>
            const uploadZone = document.getElementById('uploadZone');
            const uploadPlaceholder = document.getElementById('uploadPlaceholder');
            const uploadInfo = document.getElementById('uploadInfo');
            const videoFileInput = document.getElementById('videoFile');
            const fileName = document.getElementById('fileName');
            const fileSize = document.getElementById('fileSize');
            const uploadForm = document.getElementById('uploadForm');
            const loadingSection = document.getElementById('loadingSection');
            const resultSection = document.getElementById('resultSection');

            window.selectedFile = null;
            window.selectedSpeakerId = null;
            window.selectedCharacterName = '';
            window.currentVideoAnalysis = null;

            // Click to upload
            uploadZone.addEventListener('click', () => {
                videoFileInput.click();
            });

            // File selected
            videoFileInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    handleFile(file);
                }
            });

            // Drag and drop
            // Drag and drop
            uploadZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadZone.classList.add('border-pink-500', 'bg-slate-800');
            });

            uploadZone.addEventListener('dragleave', () => {
                uploadZone.classList.remove('border-pink-500', 'bg-slate-800');
            });

            uploadZone.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadZone.classList.remove('border-pink-500', 'bg-slate-800');
                const file = e.dataTransfer.files[0];
                if (file && file.type.startsWith('video/')) {
                    handleFile(file);
                } else {
                    alert('비디오 파일만 업로드 가능합니다.');
                }
            });

            function handleFile(file) {
                selectedFile = file;
                fileName.textContent = file.name;
                fileSize.textContent = `${(file.size / 1024 / 1024).toFixed(2)} MB`;
                uploadPlaceholder.classList.add('hidden');
                uploadInfo.classList.remove('hidden');
            }

            // v.redd.it Warning Logic
            const urlInput = document.getElementById('videoUrlInput');
            const warningBox = document.getElementById('vRedditWarning');
            const searchLink = document.getElementById('searchPostLink');

            function checkVRedditUrl() {
                const url = urlInput.value.trim();
                if (url.includes('v.redd.it')) {
                    warningBox.classList.remove('hidden');
                    // Create a Google search URL to find the post
                    const searchUrl = `https://www.google.com/search?q=site:reddit.com+url:${encodeURIComponent(url)}`;
                    searchLink.href = searchUrl;
                } else {
                    warningBox.classList.add('hidden');
                }
            }

            urlInput.addEventListener('input', checkVRedditUrl);

            // Check on load if auto-filled
            if (urlInput.value) checkVRedditUrl();

            // Form submit
            uploadForm.addEventListener('submit', async (e) => {
                e.preventDefault();

                const videoUrl = document.getElementById('videoUrlInput').value.trim();

                if (!selectedFile && !videoUrl) {
                    alert('비디오 파일을 선택하거나 URL을 입력해주세요.');
                    return;
                }

                const title = document.getElementById('videoTitle').value;
                const description = document.getElementById('videoDescription').value;

                // Show loading
                loadingSection.classList.remove('hidden');
                resultSection.classList.add('hidden');

                // Reset previous results
                document.getElementById('violationsContainer').innerHTML = '';
                document.getElementById('bgmSection').innerHTML = '';

                try {
                    let response;

                    if (selectedFile) {
                        // File Upload scenarios
                        const formData = new FormData();
                        formData.append('video', selectedFile);
                        formData.append('title', title);
                        formData.append('description', description);

                        response = await fetch('http://localhost:4000/api/guidelines/check-video', {
                            method: 'POST',
                            body: formData
                        });
                    } else {
                        // URL Scenario
                        response = await fetch('http://localhost:4000/api/guidelines/check-video-url', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                url: videoUrl,
                                title: title,
                                description: description
                            })
                        });
                    }

                    const data = await response.json();

                    if (!response.ok) {
                        throw new Error(data.error || '분석 실패');
                    }

                    // Hide loading, show result
                    loadingSection.classList.add('hidden');

                    if (data.analysis) {
                        displayResult(data.analysis);
                    } else {
                        throw new Error('분석 결과가 없습니다.');
                    }

                    // If URL mode, maybe auto-fill title if returned?
                    if (data.title && !title) {
                        document.getElementById('videoTitle').value = data.title;
                    }

                } catch (error) {
                    console.error('Analysis error:', error);
                    loadingSection.classList.add('hidden');
                    alert('분석 중 오류가 발생했습니다: ' + error.message);
                }
            });

            function displayResult(analysis) {
                // Update global state
                window.currentVideoAnalysis = analysis;

                const { overallStatus, score, violations, summary, bgmAnalysis } = analysis;

                // Status badge
                const statusBadge = document.getElementById('statusBadge');
                if (overallStatus === 'safe') {
                    statusBadge.innerHTML = '<span class="px-4 py-2 bg-green-500 text-white rounded-full font-bold">✅ 안전</span>';
                } else if (overallStatus === 'warning') {
                    statusBadge.innerHTML = '<span class="px-4 py-2 bg-yellow-500 text-white rounded-full font-bold">⚠️ 주의</span>';
                } else {
                    statusBadge.innerHTML = '<span class="px-4 py-2 bg-red-500 text-white rounded-full font-bold">❌ 위험</span>';
                }

                // Score
                document.getElementById('score').textContent = score;

                // Summary
                document.getElementById('summary').textContent = summary || '분석 완료';

                // Video Explanation
                const explanationContainer = document.getElementById('explanationContainer') || (() => {
                    const div = document.createElement('div');
                    div.id = 'explanationContainer';
                    div.className = 'bg-blue-600/10 border border-blue-500/20 rounded-xl p-6 mb-6';
                    document.getElementById('bgmSection').insertAdjacentElement('beforebegin', div);
                    return div;
                })();

                if (analysis.videoExplanation) {
                    explanationContainer.innerHTML = `
                        <div class="mb-6">
                            <div class="flex items-start gap-3 bg-blue-600/10 border border-blue-500/20 rounded-xl p-6">
                                <div class="text-2xl">📝</div>
                                <div>
                                    <h3 class="text-blue-400 font-bold mb-2">영상 상세 설명</h3>
                                    <p class="text-slate-300 leading-relaxed">${renderColorTags(analysis.videoExplanation)}</p>
                                </div>
                            </div>
                        </div>

                        ${analysis.viralScore ? `
                        <!-- Viral Insights Section -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                            <div class="bg-gradient-to-br from-pink-600/20 to-purple-600/20 border border-pink-500/30 rounded-xl p-6">
                                <div class="flex items-center gap-2 mb-4">
                                    <span class="text-2xl">🔥</span>
                                    <h3 class="text-pink-400 font-bold text-lg">바이럴 가능성</h3>
                                    <span class="ml-auto text-3xl font-black text-white">${analysis.viralScore} / 100</span>
                                </div>
                                <div class="space-y-4">
                                    <div>
                                        <p class="text-slate-400 text-xs uppercase tracking-wider mb-1">바이럴 예측 요인</p>
                                        <p class="text-slate-200 text-sm leading-relaxed">${analysis.viralReason || '제공된 분석 없음'}</p>
                                    </div>
                                    <div>
                                        <p class="text-slate-400 text-xs uppercase tracking-wider mb-1">주요 타겟층</p>
                                        <p class="text-slate-200 text-sm leading-relaxed">${analysis.targetAudience || '제공된 분석 없음'}</p>
                                    </div>
                                </div>
                            </div>

                            <div class="bg-slate-800/80 border border-slate-700/50 rounded-xl p-6">
                                <div class="flex items-center gap-2 mb-4">
                                    <span class="text-2xl">✂️</span>
                                    <h3 class="text-blue-400 font-bold text-lg">핵심 모먼트</h3>
                                </div>
                                <div class="space-y-2">
                                    ${analysis.keyMoments ? analysis.keyMoments.map(m => `
                                        <div class="flex items-start gap-2 bg-slate-900/50 p-2 rounded text-sm text-slate-300">
                                            <span class="text-blue-500">•</span>
                                            <span>${m}</span>
                                        </div>
                                    `).join('') : '<p class="text-slate-500 italic">추천 장면 없음</p>'}
                                </div>
                                ${analysis.timelineAnalysis ? `
                                <div class="mt-4 pt-4 border-t border-slate-700">
                                    <p class="text-slate-400 text-xs uppercase tracking-wider mb-1">타임라인 흐름</p>
                                    <p class="text-slate-300 text-xs">${analysis.timelineAnalysis}</p>
                                </div>
                                ` : ''}
                            </div>
                        </div>
                        ` : ''}
                    `;
                    explanationContainer.classList.remove('hidden');
                } else {
                    explanationContainer.classList.add('hidden');
                }

                // BGM Analysis
                if (bgmAnalysis) {
                    displayBgmAnalysis(bgmAnalysis);
                }

                // Violations
                const violationsContainer = document.getElementById('violationsContainer');
                if (violations && violations.length > 0) {
                    violationsContainer.innerHTML = `
                    <h3 class="text-xl font-bold text-white mb-4">발견된 문제점</h3>
                        ${violations.map(v => `
                        <div class="bg-slate-800/50 rounded-xl p-6 mb-4">
                            <div class="flex items-start gap-4">
                                <div class="flex-shrink-0">
                                    ${v.severity === 'critical' ? '🔴' : v.severity === 'high' ? '🟠' : v.severity === 'medium' ? '🟡' : '🟢'}
                                </div>
                                <div class="flex-1">
                                    <div class="flex items-center gap-2 mb-2">
                                        <span class="px-2 py-1 bg-slate-700 text-slate-300 rounded text-xs">${v.timestamp || '전체'}</span>
                                        <span class="px-2 py-1 bg-blue-600/20 text-blue-400 rounded text-xs">${v.category}</span>
                                    </div>
                                    <p class="text-white font-bold mb-2">${v.issue}</p>
                                    <p class="text-green-400 text-sm">💡 개선 방법: ${v.recommendation}</p>
                                </div>
                            </div>
                        </div>
                    `).join('')
                        }
                `;
                } else {
                    violationsContainer.innerHTML = `
                    <div class="bg-green-500/10 rounded-xl p-6 text-center">
                        <div class="text-4xl mb-2">🎉</div>
                        <p class="text-green-400 font-bold">문제점이 발견되지 않았습니다!</p>
                    </div>
                    `;
                }

                resultSection.classList.remove('hidden');

                // Show VOICEVOX section and check connection
                document.getElementById('voicevoxSection').classList.remove('hidden');
                checkVoicevoxConnection();
            }

            function displayBgmAnalysis(bgm) {
                const bgmSection = document.getElementById('bgmSection');

                // Risk level colors
                const riskColors = {
                    'low': 'text-green-400',
                    'medium': 'text-yellow-400',
                    'high': 'text-red-400'
                };

                const riskIcons = {
                    'low': '🟢',
                    'medium': '🟡',
                    'high': '🔴'
                };

                bgmSection.innerHTML = `
                    <p class="text-slate-400 text-sm mb-4">🎵 배경음악(BGM) 분석</p>
                        <div class="space-y-3">
                            <div class="flex items-center justify-between">
                                <span class="text-slate-300">저작권 위험도</span>
                                <span class="${riskColors[bgm.copyrightRiskLevel] || 'text-gray-400'} font-bold">
                                    ${riskIcons[bgm.copyrightRiskLevel] || '⚪'} ${bgm.copyrightRiskLevel?.toUpperCase() || 'UNKNOWN'}
                                </span>
                            </div>
                            <div class="flex items-center justify-between">
                                <span class="text-slate-300">분위기 적합성</span>
                                <span class="text-blue-400 font-bold">${bgm.atmosphereMatch || '-'}</span>
                            </div>
                            <div class="flex items-center justify-between">
                                <span class="text-slate-300">음량/품질</span>
                                <span class="text-purple-400 font-bold">${bgm.volumeQuality || '-'}</span>
                            </div>
                            ${bgm.recommendation ? `
                        <div class="mt-4 pt-4 border-t border-slate-700">
                            <p class="text-emerald-400 text-sm">💡 ${bgm.recommendation}</p>
                        </div>
                    ` : ''}
                        </div>
                `;
            }

            // Title generation handler
            document.getElementById('generateTitlesBtn').addEventListener('click', async () => {
                if (!selectedFile) {
                    alert('먼저 비디오 파일을 선택해주세요.');
                    return;
                }

                const title = document.getElementById('videoTitle').value;
                const description = document.getElementById('videoDescription').value;

                // Show loading
                const btn = document.getElementById('generateTitlesBtn');
                const originalText = btn.textContent;
                btn.textContent = '⏳ 제목 생성 중...';
                btn.disabled = true;

                // Prepare form data
                const formData = new FormData();
                formData.append('video', selectedFile);
                formData.append('title', title);
                formData.append('description', description);

                try {
                    const response = await fetch('http://localhost:4000/api/guidelines/generate-titles', {
                        method: 'POST',
                        body: formData
                    });

                    const data = await response.json();

                    if (!response.ok) {
                        throw new Error(data.error || '제목 생성 실패');
                    }

                    displayTitles(data.titles);

                } catch (error) {
                    console.error('Title generation error:', error);
                    alert('제목 생성 중 오류가 발생했습니다: ' + error.message);
                } finally {
                    btn.textContent = originalText;
                    btn.disabled = false;
                }
            });

            function displayTitles(titles) {
                const titlesSection = document.getElementById('titlesSection');
                const titlesContent = document.getElementById('titlesContent');

                titlesContent.innerHTML = `
                    < !--Video Interpretation-- >
                        ${titles.videoInterpretation ? `
                    <div class="bg-blue-500/10 border border-blue-500/20 rounded-xl p-6 mb-6">
                        <div class="flex items-start gap-3">
                            <div class="text-2xl">🎬</div>
                            <div>
                                <h3 class="text-blue-400 font-bold mb-2">영상 해석</h3>
                                <p class="text-slate-300 leading-relaxed">${titles.videoInterpretation}</p>
                            </div>
                        </div>
                    </div>
                ` : ''
                    }

                < !--Korean Titles-- >
                <div class="mb-6">
                    <h3 class="text-xl font-bold text-white mb-4 flex items-center gap-2">
                        🇰🇷 한국어 제목
                    </h3>
                    <div class="space-y-2">
                        ${titles.korean?.map((t, i) => `
                            <div class="bg-slate-800/50 rounded-lg p-4 hover:bg-slate-700/50 cursor-pointer transition-colors"
                                 onclick="copyToClipboard('${t.replace(/'/g, "\\'")}', '한국어 제목 ${i + 1}')">
                                <div class="flex items-center justify-between">
                                    <span class="text-white font-medium">${i + 1}. ${t}</span>
                                    <span class="text-slate-500 text-sm">📋 복사</span>
                                </div>
                            </div>
                        `).join('') || '<p class="text-slate-500">생성된 제목이 없습니다</p>'}
                    </div>
                </div>

                <!--Japanese Titles-- >
                <div class="mb-6">
                    <h3 class="text-xl font-bold text-white mb-4 flex items-center gap-2">
                        🇯🇵 일본어 제목
                    </h3>
                    <div class="space-y-2">
                        ${titles.japanese?.map((t, i) => `
                            <div class="bg-slate-800/50 rounded-lg p-4 hover:bg-slate-700/50 cursor-pointer transition-colors"
                                 onclick="copyToClipboard('${t.replace(/'/g, "\\'")}', '일본어 제목 ${i + 1}')">
                                <div class="flex items-center justify-between">
                                    <span class="text-white font-medium">${i + 1}. ${t}</span>
                                    <span class="text-slate-500 text-sm">📋 복사</span>
                                </div>
                            </div>
                        `).join('') || '<p class="text-slate-500">생성된 제목이 없습니다</p>'}
                    </div>
                </div>

                <!--Japanese Pronunciation-- >
                    <div class="mb-6">
                        <h3 class="text-xl font-bold text-white mb-4 flex items-center gap-2">
                            🗣️ 일본어 발음 (한글)
                        </h3>
                        <div class="space-y-2">
                            ${titles.japanesePronunciation?.map((t, i) => `
                            <div class="bg-slate-800/50 rounded-lg p-4 hover:bg-slate-700/50 cursor-pointer transition-colors"
                                 onclick="copyToClipboard('${t.replace(/'/g, "\\'")}', '일본어 발음 ${i + 1}')">
                                <div class="flex items-center justify-between">
                                    <span class="text-white font-medium">${i + 1}. ${t}</span>
                                    <span class="text-slate-500 text-sm">📋 복사</span>
                                </div>
                            </div>
                        `).join('') || '<p class="text-slate-500">생성된 제목이 없습니다</p>'}
                        </div>
                    </div>
                `;

                titlesSection.classList.remove('hidden');
                titlesSection.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }

            function copyToClipboard(text, label) {
                navigator.clipboard.writeText(text).then(() => {
                    // Show toast notification
                    const toast = document.createElement('div');
                    toast.className = 'fixed bottom-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50';
                    toast.textContent = `✅ ${label} 복사됨!`;
                    document.body.appendChild(toast);

                    setTimeout(() => {
                        toast.remove();
                    }, 2000);
                }).catch(err => {
                    console.error('Copy failed:', err);
                    alert('복사 실패: ' + err.message);
                });
            }

            // ========================================
            // VOICEVOX TTS Functions
            // ========================================

            // Check VOICEVOX connection status
            async function checkVoicevoxConnection() {
                try {
                    const response = await fetch('http://localhost:4000/api/voicevox/speakers');
                    const data = await response.json();

                    if (response.ok && data.success) {
                        updateVoicevoxStatus(true, `연결됨(${data.count}개 캐릭터)`);
                        return true;
                    } else {
                        updateVoicevoxStatus(false, 'VOICEVOX 서버에 연결할 수 없습니다');
                        return false;
                    }
                } catch (error) {
                    updateVoicevoxStatus(false, 'VOICEVOX가 실행되지 않았습니다');
                    return false;
                }
            }

            function updateVoicevoxStatus(isConnected, message) {
                const dot = document.getElementById('voicevoxStatusDot');
                const text = document.getElementById('voicevoxStatusText');
                const statusDiv = document.getElementById('voicevoxStatus');

                if (isConnected) {
                    dot.className = 'w-3 h-3 rounded-full bg-green-500 animate-pulse';
                    text.textContent = message;
                    statusDiv.className = 'mb-6 p-4 rounded-lg border border-green-500/20 bg-green-500/10';
                } else {
                    dot.className = 'w-3 h-3 rounded-full bg-red-500';
                    text.textContent = message;
                    statusDiv.className = 'mb-6 p-4 rounded-lg border border-red-500/20 bg-red-500/10';
                }
            }

            // Load VOICEVOX characters
            document.getElementById('loadCharactersBtn').addEventListener('click', async () => {
                const btn = document.getElementById('loadCharactersBtn');
                const originalText = btn.textContent;
                btn.textContent = '⏳ 불러오는 중...';
                btn.disabled = true;

                try {
                    const response = await fetch('http://localhost:4000/api/voicevox/speakers');
                    const data = await response.json();

                    if (!response.ok) {
                        throw new Error(data.message || '캐릭터 목록을 불러올 수 없습니다');
                    }

                    displayCharacters(data.speakers);
                    document.getElementById('charactersGrid').classList.remove('hidden');

                } catch (error) {
                    alert('오류: ' + error.message + '\n\nVOICEVOX 앱을 실행해주세요');
                } finally {
                    btn.textContent = originalText;
                    btn.disabled = false;
                }
            });

            function displayCharacters(speakers) {
                const grid = document.getElementById('charactersGrid');
                grid.innerHTML = '';

                speakers.forEach(speaker => {
                    speaker.styles.forEach(style => {
                        const card = document.createElement('div');
                        card.className = 'bg-slate-700/50 hover:bg-slate-600/50 rounded-lg p-4 cursor-pointer transition-all border-2 border-transparent hover:border-blue-500';
                        card.onclick = () => selectCharacter(style.id, speaker.nameKr || speaker.name, style.nameKr || style.name, speaker.useCase || '');

                        // Use character image if available, otherwise fallback to emoji
                        const imageHtml = speaker.imageUrl
                            ? `<img src="${speaker.imageUrl}" alt="${speaker.name}" class="w-16 h-16 mx-auto mb-2 rounded-full object-cover" onerror="this.onerror=null; this.outerHTML='<div class=\\'text-4xl mb-2\\'>🎤</div>';">`
                            : '<div class="text-4xl mb-2">🎤</div>';

                        card.innerHTML = `
                    <div class="text-center">
                        ${imageHtml}
                            <p class="text-white font-bold text-sm mb-1">${speaker.nameKr || speaker.name}</p>
                            <p class="text-slate-400 text-xs">${style.nameKr || style.name}</p>
                            ${speaker.gender ? `<p class="text-slate-500 text-xs mt-1">${speaker.gender === 'female' ? '👧' : speaker.gender === 'male' ? '👦' : '🤖'}</p>` : ''}
                        </div>
                    `;

                        grid.appendChild(card);
                    });
                });
            }

            function selectCharacter(speakerId, characterName, styleName, useCase = '') {
                window.selectedSpeakerId = speakerId;
                window.selectedCharacterName = `${characterName} (${styleName})`;

                // Update selected character info
                document.getElementById('selectedCharacterIcon').textContent = '🎤';
                document.getElementById('selectedCharacterName').textContent = characterName;
                document.getElementById('selectedCharacterStyle').textContent = styleName;
                document.getElementById('selectedCharacterUseCase').textContent = useCase ? `용도: ${useCase} ` : '';
                document.getElementById('selectedCharacterInfo').classList.remove('hidden');

                // Enable TTS generation if script is ready
                checkTTSButtonState();

                console.log(`Selected character: ${selectedCharacterName}, ID: ${speakerId} `);
            }

            // Preview character voice
            document.getElementById('previewCharacterBtn').addEventListener('click', async () => {
                if (!window.selectedSpeakerId) {
                    alert('캐릭터를 먼저 선택해주세요');
                    return;
                }

                const btn = document.getElementById('previewCharacterBtn');
                const originalText = btn.textContent;
                btn.textContent = '⏳ 생성 중...';
                btn.disabled = true;

                try {
                    // Get Audio Params from UI
                    const audioOptions = {
                        speedScale: document.getElementById('param-speedScale') ? document.getElementById('param-speedScale').value : 1.0,
                        pitchScale: document.getElementById('param-pitchScale') ? document.getElementById('param-pitchScale').value : 0.0,
                        intonationScale: document.getElementById('param-intonationScale') ? document.getElementById('param-intonationScale').value : 1.0,
                        volumeScale: document.getElementById('param-volumeScale') ? document.getElementById('param-volumeScale').value : 1.0,
                        prePhonemeLength: document.getElementById('param-prePhonemeLength') ? document.getElementById('param-prePhonemeLength').value : 0.1,
                        postPhonemeLength: document.getElementById('param-postPhonemeLength') ? document.getElementById('param-postPhonemeLength').value : 0.1
                    };

                    const response = await fetch('http://localhost:4000/api/voicevox/preview', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            speakerId: window.selectedSpeakerId,
                            sampleText: 'こんにちは、よろしくお願いします。',
                            options: audioOptions
                        })
                    });

                    if (!response.ok) {
                        throw new Error('샘플 음성 생성에 실패했습니다');
                    }

                    const audioBlob = await response.blob();
                    const audioUrl = URL.createObjectURL(audioBlob);
                    const audio = new Audio(audioUrl);
                    audio.play();

                } catch (error) {
                    alert('오류: ' + error.message);
                } finally {
                    btn.textContent = originalText;
                    btn.disabled = false;
                }
            });





            // Generate TTS
            document.getElementById('generateTTSBtn').addEventListener('click', async () => {
                if (!window.selectedSpeakerId) {
                    alert('캐릭터를 먼저 선택해주세요');
                    return;
                }

                const scriptText = document.getElementById('scriptTextarea').value.trim();
                if (!scriptText) {
                    alert('대본을 입력해주세요');
                    return;
                }


                // -------------------------------------------------------------
                // 1) Parse Script for SRT & clean text for TTS
                // -------------------------------------------------------------
                const lines = scriptText.split('\n');
                let cleanText = '';
                let srtContent = '';
                let srtIndex = 1;
                let estimatedTime = 0; // For auto-generating timestamps

                // Helper to format srt time: seconds -> 00:00:00,000
                const formatSRTTimestamp = (seconds) => {
                    const date = new Date(0);
                    date.setSeconds(seconds);
                    const hh = String(Math.floor(seconds / 3600)).padStart(2, '0');
                    const mm = String(Math.floor((seconds % 3600) / 60)).padStart(2, '0');
                    const ss = Math.floor(seconds % 60);
                    const ms = Math.floor((seconds % 1) * 1000);
                    return `${hh}:${mm}:${String(ss).padStart(2, '0')},${String(ms).padStart(3, '0')}`;
                };

                // Helper to estimate speech duration (rough: 5 chars per second for Japanese)
                const estimateDuration = (text) => {
                    return Math.max(2, text.length / 5); // Minimum 2 seconds
                };

                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (!line) continue;

                    // Check for timestamp pattern: [0-4초] ...
                    const timeMatch = line.match(/^\[(\d+)-(\d+)초\]\s*(.*)/);

                    if (timeMatch) {
                        // Has explicit timestamp
                        const startSec = parseInt(timeMatch[1]);
                        const endSec = parseInt(timeMatch[2]);
                        const rawText = timeMatch[3];

                        // 1. TTS용 정제: 슬래시(/) -> 쉼표(、)로 변환하여 쉼(Pause) 유도, 대괄호 제거
                        const textForTTS = rawText.replace(/\//g, '、').replace(/[\[\]]/g, ' ');

                        // 2. SRT용 정제: 슬래시(/) 제거, 불필요한 공백 제거
                        const textForSRT = rawText.replace(/\//g, ' ').replace(/[\[\]]/g, '').trim();

                        // Append to SRT
                        srtContent += `${srtIndex}\n`;
                        srtContent += `${formatSRTTimestamp(startSec)} --> ${formatSRTTimestamp(endSec)}\n`;
                        srtContent += `${textForSRT}\n\n`;
                        srtIndex++;

                        // Append to Audio Text
                        cleanText += textForTTS + '\n';
                        estimatedTime = endSec; // Update estimated time
                    } else {
                        // No timestamp - auto-generate based on text length
                        const textForTTS = line.replace(/\//g, '、').replace(/[\[\]]/g, ' ');
                        const textForSRT = line.replace(/\//g, ' ').replace(/[\[\]]/g, '').trim();

                        if (textForSRT) {
                            const duration = estimateDuration(textForSRT);
                            const startSec = estimatedTime;
                            const endSec = estimatedTime + duration;

                            // Append to SRT
                            srtContent += `${srtIndex}\n`;
                            srtContent += `${formatSRTTimestamp(startSec)} --> ${formatSRTTimestamp(endSec)}\n`;
                            srtContent += `${textForSRT}\n\n`;
                            srtIndex++;

                            estimatedTime = endSec;
                        }

                        cleanText += textForTTS + '\n';
                    }
                }

                if (!cleanText.trim()) {
                    cleanText = scriptText; // Fallback if parsing failed
                }


                // -------------------------------------------------------------
                // 2) Generate Audio
                // -------------------------------------------------------------
                const btn = document.getElementById('generateTTSBtn');
                const originalText = btn.textContent;
                btn.textContent = '⏳ 음성 & 자막 생성 중...';
                btn.disabled = true;

                try {
                    // Get Audio Params from UI
                    const audioOptions = {
                        speedScale: document.getElementById('param-speedScale') ? document.getElementById('param-speedScale').value : 1.0,
                        pitchScale: document.getElementById('param-pitchScale') ? document.getElementById('param-pitchScale').value : 0.0,
                        intonationScale: document.getElementById('param-intonationScale') ? document.getElementById('param-intonationScale').value : 1.0,
                        volumeScale: document.getElementById('param-volumeScale') ? document.getElementById('param-volumeScale').value : 1.0,
                        prePhonemeLength: document.getElementById('param-prePhonemeLength') ? document.getElementById('param-prePhonemeLength').value : 0.1,
                        postPhonemeLength: document.getElementById('param-postPhonemeLength') ? document.getElementById('param-postPhonemeLength').value : 0.1
                    };

                    const response = await fetch('http://localhost:4000/api/voicevox/generate-tts', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            text: cleanText,
                            speakerId: window.selectedSpeakerId,
                            engineUrl: window.selectedEngineUrl || '', // Fallback to empty if not set
                            filename: `tts_${window.selectedSpeakerId}_${Date.now()}.wav`,
                            options: audioOptions
                        })
                    });

                    if (!response.ok) {
                        throw new Error('TTS 생성에 실패했습니다');
                    }

                    const audioBlob = await response.blob();

                    // Store blob globally for manual download
                    window.currentAudioBlob = audioBlob;
                    window.currentAudioFilename = `voicevox_tts_${Date.now()}.wav`;

                    // Store SRT content globally for button access
                    window.currentNarratorSRT = srtContent;
                    console.log('📜 Narrator SRT Content Length:', srtContent.length);
                    console.log('📜 SRT Preview:', srtContent.substring(0, 200));

                    // Display generated audio - Use data URL to prevent IDM interception
                    const audio = document.getElementById('generatedAudio');
                    const reader = new FileReader();
                    reader.onload = function (e) {
                        audio.src = e.target.result; // Data URL instead of blob URL
                        document.getElementById('generatedAudioSection').classList.remove('hidden');

                        // Scroll to audio section after loading
                        setTimeout(() => {
                            document.getElementById('generatedAudioSection').scrollIntoView({
                                behavior: 'smooth',
                                block: 'center'
                            });
                        }, 100);
                    };
                    reader.readAsDataURL(audioBlob);

                    // Setup manual download buttons
                    document.getElementById('downloadAudioBtn').onclick = () => {
                        const a = document.createElement('a');
                        const url = URL.createObjectURL(window.currentAudioBlob);
                        a.href = url;
                        a.download = window.currentAudioFilename;
                        a.click();
                        URL.revokeObjectURL(url);
                    };

                    const narratorSrtBtn = document.getElementById('downloadNarratorSrtBtn');
                    if (window.currentNarratorSRT && window.currentNarratorSRT.trim()) {
                        console.log('✅ Showing Narrator SRT button');
                        narratorSrtBtn.classList.remove('hidden');
                        narratorSrtBtn.onclick = () => {
                            downloadSRTMlob(window.currentNarratorSRT, `narrator_jp_${Date.now()}.srt`);
                        };
                    } else {
                        console.log('❌ Hiding Narrator SRT button (no content)');
                        narratorSrtBtn.classList.add('hidden');
                    }

                } catch (error) {
                    alert('오류: ' + error.message);
                } finally {
                    btn.textContent = originalText;
                    btn.disabled = false;
                }
            });

            function downloadSRTMlob(content, filename = `narrator_${Date.now()}.srt`) {
                const blob = new Blob([content], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
            }

            function checkTTSButtonState() {
                const scriptText = document.getElementById('scriptTextarea').value.trim();
                const btn = document.getElementById('generateTTSBtn');
                const helpText = btn.nextElementSibling;

                if (window.selectedSpeakerId && scriptText) {
                    btn.disabled = false;
                    btn.classList.remove('opacity-50', 'cursor-not-allowed', 'grayscale');
                    btn.classList.add('hover:scale-[1.02]', 'hover:shadow-lg', 'hover:shadow-purple-500/20');
                    if (helpText) helpText.textContent = '👆 이제 음성 파일을 생성할 수 있습니다!';
                } else {
                    btn.disabled = true;
                    btn.classList.add('opacity-50', 'cursor-not-allowed', 'grayscale');
                    btn.classList.remove('hover:scale-[1.02]');
                    if (helpText) helpText.textContent = '캐릭터와 대본을 선택하면 생성할 수 있습니다';
                }
            }

            // Listen for script changes
            document.getElementById('scriptTextarea').addEventListener('input', checkTTSButtonState);

            // ========================================
            // TRANSCRIPT EXTRACTION (Step 1)
            // ========================================

            // Whisper Provider Selection
            let selectedWhisperProvider = 'openai'; // Default to OpenAI

            window.selectWhisperProvider = function (provider) {
                selectedWhisperProvider = provider;

                const openAIBtn = document.getElementById('whisperOpenAI');
                const hfBtn = document.getElementById('whisperHF');

                if (provider === 'openai') {
                    // Highlight OpenAI button
                    openAIBtn.className = 'px-4 py-2 rounded-full font-bold text-sm transition-all bg-gradient-to-r from-green-600 to-blue-600 text-white shadow-lg';
                    hfBtn.className = 'px-4 py-2 rounded-full font-bold text-sm transition-all text-slate-400 hover:text-white';
                } else {
                    // Highlight HuggingFace button
                    openAIBtn.className = 'px-4 py-2 rounded-full font-bold text-sm transition-all text-slate-400 hover:text-white';
                    hfBtn.className = 'px-4 py-2 rounded-full font-bold text-sm transition-all bg-gradient-to-r from-purple-600 to-pink-600 text-white shadow-lg';
                }

                console.log('[Whisper Provider] Selected:', provider);
            }

            // Extract transcript button handler
            document.getElementById('extractTranscriptBtn').addEventListener('click', async () => {
                const videoUrl = document.getElementById('videoUrlInput').value.trim();

                if (!selectedFile && !videoUrl) {
                    alert('먼저 비디오 파일을 선택하거나 URL을 입력해주세요.');
                    return;
                }

                const transcriptSection = document.getElementById('transcriptStepSection');

                // Generate cache key
                let cacheKey;
                if (selectedFile) {
                    cacheKey = `transcript_${selectedFile.name}_${selectedFile.size} `;
                } else {
                    // Simple hash for URL
                    cacheKey = `transcript_url_${btoa(videoUrl).substring(0, 32)} `;
                }

                // Check localStorage cache first
                const cachedTranscript = localStorage.getItem(cacheKey);
                if (cachedTranscript) {
                    try {
                        const transcript = JSON.parse(cachedTranscript);
                        console.log('[Cache] 💾 Using cached transcript');

                        // Show cached indicator
                        transcriptSection.classList.remove('hidden');
                        document.getElementById('bilingualTranscript').innerHTML = `
                    < div class="flex items-center justify-center p-8 bg-green-500/10 border border-green-500/20 rounded-xl mb-4" >
                        <div class="text-center">
                            <div class="text-4xl mb-2">💾</div>
                            <p class="text-green-400 font-bold text-lg">캐시된 대본 사용 중</p>
                            <p class="text-slate-400 text-sm mt-1">이전에 추출한 대본을 재사용합니다 (무료!)</p>
                            <button onclick="document.getElementById('extractTranscriptBtn').dataset.forceRefresh='true'; document.getElementById('extractTranscriptBtn').click();"
                                class="mt-3 text-xs bg-slate-700 hover:bg-slate-600 text-white px-3 py-1.5 rounded transition-colors">
                                🔄 대본 재추출 (API 재호출)
                            </button>
                        </div>
                            </div >
                    `;

                        // Display immediately
                        setTimeout(() => {
                            currentTranscriptData = transcript;
                            displayBilingualTranscript(transcript);
                            transcriptSection.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                        }, 100);

                        return; // Exit early, don't call API
                    } catch (e) {
                        console.error('[Cache] Error parsing cached data:', e);
                        localStorage.removeItem(cacheKey); // Remove corrupted cache
                    }
                }

                // Check if force refresh
                const extractBtn = document.getElementById('extractTranscriptBtn');
                const forceRefresh = extractBtn.dataset.forceRefresh === 'true';
                if (forceRefresh) {
                    delete extractBtn.dataset.forceRefresh;
                    localStorage.removeItem(cacheKey); // Clear cache for force refresh
                }

                // Show section & reset
                transcriptSection.classList.remove('hidden');

                const providerName = selectedWhisperProvider === 'openai' ? 'OpenAI (유료)' : 'HuggingFace (무료)';
                document.getElementById('bilingualTranscript').innerHTML = `
                    <div class="flex items-center justify-center p-12">
                        <div class="text-center">
                            <div class="loader w-12 h-12 border-4 border-t-purple-500 mx-auto mb-4"></div>
                            <p class="text-white font-bold text-lg">대본 추출 중...</p>
                            <p class="text-slate-400 text-sm mt-2">${providerName} Whisper ASR</p>
                            ${!selectedFile ? '<p class="text-xs text-blue-400 mt-1">URL 다운로드 중... (시간이 걸릴 수 있습니다)</p>' : ''}
                        </div>
                    </div>
                    `;

                // Prepare form data with provider selection
                const formData = new FormData();
                if (selectedFile) {
                    formData.append('video', selectedFile);
                } else if (videoUrl) {
                    formData.append('url', videoUrl);
                }
                formData.append('provider', selectedWhisperProvider); // Send provider choice

                try {
                    const response = await fetch('http://localhost:4000/api/guidelines/extract-transcript', {
                        method: 'POST',
                        body: formData
                    });

                    const data = await response.json();

                    if (!response.ok) {
                        throw new Error(data.error || '대본 추출 실패');
                    }

                    // Store for next step
                    currentTranscriptData = data.transcript;

                    // Save to localStorage cache
                    try {
                        localStorage.setItem(cacheKey, JSON.stringify(data.transcript));
                        console.log('[Cache] 💾 Transcript cached successfully');
                    } catch (e) {
                        console.warn('[Cache] Failed to cache transcript:', e);
                    }

                    // Display transcript
                    displayBilingualTranscript(data.transcript);

                    // Scroll to results
                    transcriptSection.scrollIntoView({ behavior: 'smooth', block: 'nearest' });

                } catch (error) {
                    console.error('Transcript extraction error:', error);
                    document.getElementById('bilingualTranscript').innerHTML = `
                    <div class="p-6 bg-red-500/10 border border-red-500/20 rounded-lg text-center">
                            <p class="text-red-400 font-bold mb-2">❌ 오류 발생</p>
                            <p class="text-slate-300 text-sm">${error.message}</p>
                        </div>
                    `;
                }
            });

            function displayBilingualTranscript(transcript) {
                // Update language info
                const languageFlags = {
                    'English': '🇺🇸',
                    'english': '🇺🇸',
                    '한국어': '🇰🇷',
                    'korean': '🇰🇷',
                    '日本語': '🇯🇵',
                    'japanese': '🇯🇵',
                    '中文': '🇨🇳',
                    'chinese': '🇨🇳'
                };

                document.getElementById('detectedLanguageFlag').textContent = languageFlags[transcript.languageName] || '🌐';
                document.getElementById('languageName').textContent = transcript.languageName;
                document.getElementById('transcriptDuration').textContent = transcript.duration.toFixed(1);
                document.getElementById('transcriptSegments').textContent = transcript.segments.length;

                // Show translation badge if has translation
                if (transcript.hasTranslation) {
                    document.getElementById('translationBadge').classList.remove('hidden');
                }

                // Video Explanation (Summary)
                const transcriptExplanation = document.getElementById('transcriptExplanation') || (() => {
                    const div = document.createElement('div');
                    div.id = 'transcriptExplanation';
                    div.className = 'bg-purple-600/10 border border-purple-500/20 rounded-xl p-6 mb-6';
                    document.getElementById('bilingualTranscriptContainer').insertAdjacentElement('beforebegin', div);
                    return div;
                })();

                if (transcript.videoExplanation) {
                    transcriptExplanation.innerHTML = `
                    <div class="flex items-start gap-3">
                            <div class="text-2xl">💡</div>
                            <div>
                                <h3 class="text-purple-400 font-bold mb-2">AI 영상 요약</h3>
                                <p class="text-slate-300 leading-relaxed">${renderColorTags(transcript.videoExplanation)}</p>
                            </div>
                        </div>
                    `;
                    transcriptExplanation.classList.remove('hidden');
                } else {
                    transcriptExplanation.classList.add('hidden');
                }

                // Build bilingual segments
                const segmentsHTML = transcript.segments.map((seg, i) => {
                    const emotionColor = seg.emotion === 'excitement' ? 'border-yellow-400' :
                        seg.emotion === 'tension' ? 'border-red-400' :
                            seg.emotion === 'surprise' ? 'border-orange-400' :
                                'border-blue-400';

                    const showBilingual = transcript.hasTranslation;

                    return `
                    <div class="bg-slate-800/50 rounded-xl p-4 border-l-4 ${emotionColor}">
                        <div class="flex items-center gap-2 mb-3">
                            <span class="text-xs font-mono text-purple-300">${formatTime(seg.start)} → ${formatTime(seg.end)}</span>
                            ${seg.emotion ? `<span class="text-xs bg-pink-500/30 px-2 py-0.5 rounded">${seg.emotion}</span>` : ''}
                        </div>
                            ${showBilingual ? `
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <p class="text-xs text-slate-400 mb-1">${languageFlags[transcript.languageName] || '🌐'} Original</p>
                                        <p class="text-white">${seg.text}</p>
                                    </div>
                                    <div>
                                        <p class="text-xs text-slate-400 mb-1">🇰🇷 한국어</p>
                                        <p class="text-white">${seg.textKo}</p>
                                    </div>
                                </div>
                            ` : `
                                <p class="text-white">${seg.text}</p>
                            `}
                        </div>
                    `;
                }).join('');

                document.getElementById('bilingualTranscript').innerHTML = segmentsHTML;
            }

            // Copy transcript button
            document.getElementById('copyTranscriptBtn').addEventListener('click', () => {
                const transcriptDiv = document.getElementById('bilingualTranscript');
                const segments = transcriptDiv.querySelectorAll('.bg-slate-800\\/50');

                let textToCopy = '';
                segments.forEach((seg) => {
                    const text = seg.textContent.trim();
                    textToCopy += text + '\n\n';
                });

                navigator.clipboard.writeText(textToCopy).then(() => {
                    const btn = document.getElementById('copyTranscriptBtn');
                    const originalText = btn.textContent;
                    btn.textContent = '✅ 복사 완료!';
                    setTimeout(() => {
                        btn.textContent = originalText;
                    }, 2000);
                }).catch(err => {
                    alert('복사 실패: ' + err.message);
                });
            });

            // Current transcript data buffer
            let currentTranscriptData = null;
            let selectedHighlight = null;

            // Extract highlights button
            document.getElementById('extractHighlightsBtn').addEventListener('click', async () => {
                if (!currentTranscriptData) {
                    alert('먼저 대본을 추출해주세요.');
                    return;
                }

                const highlightsSection = document.getElementById('highlightsStepSection');
                const highlightsGrid = document.getElementById('highlightsGrid');

                // Show section & loading
                highlightsSection.classList.remove('hidden');
                highlightsGrid.innerHTML = `
                    <div class="col-span-full flex items-center justify-center p-12">
                        <div class="text-center">
                            <div class="loader w-12 h-12 border-4 border-t-pink-500 mx-auto mb-4"></div>
                            <p class="text-white font-bold text-xl">AI가 바이럴 구간 분석 중...</p>
                            <p class="text-slate-400 text-sm mt-2">Hook, 감정선, 기승전결 분석</p>
                        </div>
                    </div>
                    `;

                highlightsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });

                // Get metadata from inputs
                const title = document.getElementById('videoTitle').value;
                const comments = document.getElementById('videoComments').value;

                try {
                    const response = await fetch('http://localhost:4000/api/guidelines/extract-highlights', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            transcript: currentTranscriptData,
                            title: title,
                            comments: comments
                        })
                    });

                    const data = await response.json();

                    if (!response.ok) {
                        throw new Error(data.error || '하이라이트 추출 실패');
                    }

                    // Display Director Plan
                    if (data.directorPlan) {
                        displayDirectorPlan(
                            data.directorPlan,
                            data.viralTitle,
                            data.loopStrategy,
                            data.thumbnailText,
                            data.sourceInfo,
                            data  // Pass entire data object
                        );
                    } else if (data.highlights) {
                        // Fallback for old version
                        displayHighlights(data.highlights);
                    }

                } catch (error) {
                    console.error('Highlight extraction error:', error);
                    highlightsGrid.innerHTML = `
                    <div class="col-span-full p-6 bg-red-500/10 border border-red-500/20 rounded-lg text-center">
                            <p class="text-red-400 font-bold mb-2">❌ 오류 발생</p>
                            <p class="text-slate-300 text-sm">${error.message}</p>
                        </div>
                    `;
                }
            });

            function displayDirectorPlan(plan, viralTitle, loopStrategy, thumbnailText, sourceInfo, response = {}) {
                const grid = document.getElementById('highlightsGrid');
                grid.innerHTML = ''; // Clear existing

                // Title Card with Loop Strategy, Thumbnail, Source
                const titleCard = document.createElement('div');
                titleCard.className = 'col-span-full bg-gradient-to-r from-purple-900/50 to-blue-900/50 p-6 rounded-xl border border-purple-500/30 mb-4';
                titleCard.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <h3 class="text-xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-pink-400 mb-2">
                                🎬 AI Director's Cut 설계도
                            </h3>

                            <!-- 3-Language Titles -->
                            <div class="mb-3">
                                <p class="text-slate-400 text-xs mb-1">📌 제목안 (3개 국어)</p>
                                <div class="space-y-1">
                                    <p class="text-white text-base font-bold">🇰🇷 ${response.viralTitle_kr || viralTitle || '제목 미정'}</p>
                                    <p class="text-blue-300 text-base font-bold">🇯🇵 ${response.viralTitle_jp || ''}</p>
                                    <p class="text-orange-300 text-sm font-mono">🗣️ ${response.viralTitle_pron || ''}</p>
                                </div>
                            </div>

                            <p class="text-slate-400 text-sm mt-1">이 설계도를 따라 CapCut에서 편집하세요.</p>

                            <!-- 3 Thumbnail Options -->
                            ${response.thumbnailText && Array.isArray(response.thumbnailText) ? `
                            <div class="mt-4">
                                <span class="text-yellow-400 font-bold text-xs block mb-2">🎨 썸네일 문구 추천 3가지 (CapCut용)</span>
                                <div class="grid grid-cols-1 gap-2">
                                    ${response.thumbnailText.map((thumb, idx) => `
                                        <div class="bg-slate-800/50 border border-slate-700 rounded-lg p-3 hover:border-yellow-500 transition-colors">
                                            <div class="text-[10px] text-slate-500 mb-1">${thumb.strategy || `대안 ${idx + 1}`}</div>
                                            
                                            <!-- Line 1 -->
                                            <div class="mb-2">
                                                <div class="text-yellow-300 font-black text-lg leading-tight mb-1">
                                                    ${thumb.line1_jp || thumb.line1 || ''}
                                                </div>
                                                <div class="text-orange-300 font-mono text-xs mb-1">
                                                    ${thumb.line1_pron || ''}
                                                </div>
                                                ${thumb.line1_kr ? `<div class="text-slate-400 text-xs">🇰🇷 ${thumb.line1_kr}</div>` : ''}
                                            </div>
                                            
                                            <!-- Line 2 -->
                                            <div>
                                                <div class="text-red-400 font-bold text-base leading-tight mb-1">
                                                    ${thumb.line2_jp || thumb.line2 || ''}
                                                </div>
                                                <div class="text-orange-300 font-mono text-xs mb-1">
                                                    ${thumb.line2_pron || ''}
                                                </div>
                                                ${thumb.line2_kr ? `<div class="text-slate-400 text-xs">🇰🇷 ${thumb.line2_kr}</div>` : ''}
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                            ` : thumbnailText ? `
                            <div class="mt-4 bg-slate-800/50 border border-slate-700 rounded-lg p-3 max-w-md">
                                <span class="text-yellow-400 font-bold text-xs block mb-2">🎨 썸네일 문구 (CapCut용)</span>
                                <div class="text-white font-black text-xl leading-tight mb-1">${thumbnailText.line1}</div>
                                <div class="text-slate-300 font-bold text-base">${thumbnailText.line2}</div>
                            </div>` : ''}

                            ${sourceInfo && sourceInfo !== 'Unknown' ? `
                            <div class="mt-2 inline-block bg-blue-500/20 border border-blue-500/30 rounded px-2 py-1">
                                <span class="text-blue-300 text-xs">📺 출처: ${sourceInfo}</span>
                            </div>` : ''}
                        </div>
                        ${loopStrategy ? `
                        <div class="bg-indigo-500/20 border border-indigo-500/50 rounded-lg p-3 max-w-sm ml-4">
                            <span class="text-indigo-300 font-bold text-xs block mb-1">🔄 Infinite Loop Strategy</span>
                            <p class="text-indigo-100 text-xs leading-tight">${loopStrategy}</p>
                        </div>` : ''
                    }
                    </div>
                    `;
                grid.appendChild(titleCard);

                // Add Download Buttons
                grid.parentElement.insertAdjacentHTML('afterbegin', `
                    <div class="flex gap-2 mb-4 justify-end flex-wrap">
                        <button onclick="downloadDirectorImage()" class="bg-pink-600 hover:bg-pink-500 text-white px-3 py-1.5 rounded-lg text-sm font-bold flex items-center gap-2 transition-colors">
                            📸 설계도 이미지 저장 (.png)
                        </button>
                        <button onclick="downloadFullTranscript()" class="bg-indigo-600 hover:bg-indigo-500 text-white px-3 py-1.5 rounded-lg text-sm font-bold flex items-center gap-2 transition-colors">
                            📄 전체 대본 다운로드 (.txt)
                        </button>
                        <button onclick="downloadDirectorScript()" class="bg-purple-600 hover:bg-purple-500 text-white px-3 py-1.5 rounded-lg text-sm font-bold flex items-center gap-2 transition-colors">
                            🎬 하이라이트 대본 다운로드 (.txt)
                        </button>
                        <div class="relative">
                            <button id="srtDropdownBtn" class="bg-green-600 hover:bg-green-500 text-white px-3 py-1.5 rounded-lg text-sm font-bold flex items-center gap-2 transition-colors">
                                📝 SRT 자막 다운로드 ▼
                            </button>
                            <div id="srtDropdownMenu" class="hidden absolute right-0 mt-1 bg-slate-800 border border-slate-600 rounded-lg shadow-xl overflow-hidden z-50 min-w-[200px]">
                                <button onclick="downloadSRT('en')" class="w-full text-left px-4 py-2 text-white hover:bg-slate-700 transition-colors text-sm flex items-center gap-2">
                                    🇺🇸 영어 (English)
                                </button>
                                <button onclick="downloadSRT('jp')" class="w-full text-left px-4 py-2 text-white hover:bg-slate-700 transition-colors text-sm flex items-center gap-2">
                                    🇯🇵 일본어 (Japanese)
                                </button>
                                <button onclick="downloadSRT('pron')" class="w-full text-left px-4 py-2 text-white hover:bg-slate-700 transition-colors text-sm flex items-center gap-2">
                                    🗣️ 일본어 발음 (Korean Pron.)
                                </button>
                                <button onclick="downloadSRT('kr')" class="w-full text-left px-4 py-2 text-white hover:bg-slate-700 transition-colors text-sm flex items-center gap-2">
                                    🇰🇷 한국어 (Korean)
                                </button>
                            </div>
                        </div>
                    </div>
                    `);

                // Add SRT dropdown toggle functionality
                setTimeout(() => {
                    const srtBtn = document.getElementById('srtDropdownBtn');
                    const srtMenu = document.getElementById('srtDropdownMenu');

                    if (srtBtn && srtMenu) {
                        srtBtn.addEventListener('click', (e) => {
                            e.stopPropagation();
                            srtMenu.classList.toggle('hidden');
                        });

                        // Close dropdown when clicking outside
                        document.addEventListener('click', (e) => {
                            if (!srtBtn.contains(e.target) && !srtMenu.contains(e.target)) {
                                srtMenu.classList.add('hidden');
                            }
                        });
                    }
                }, 100);

                // Render Plan Items
                plan.forEach((scene, index) => {
                    // Defensive check for null/undefined start/end
                    const s = parseFloat(scene.start);
                    const e = parseFloat(scene.end);
                    const hasValidTime = !isNaN(s) && !isNaN(e) && e > s;

                    const sceneStart = hasValidTime ? s : 0;
                    const sceneEnd = hasValidTime ? e : 0;
                    const duration = (sceneEnd - sceneStart).toFixed(1);

                    const sceneCard = document.createElement('div');
                    sceneCard.className = `col-span-full ${hasValidTime ? 'bg-slate-800/50 border-slate-700' : 'bg-red-900/20 border-red-500/50'} border p-5 rounded-xl hover:border-purple-500 transition-colors group`;

                    if (!hasValidTime) {
                        console.warn(`[Display] Scene ${index + 1} has invalid timestamps:`, { start: scene.start, end: scene.end });
                    }

                    const sceneStage = scene.stage || '';
                    const badgeColor = sceneStage.includes('Intro') ? 'bg-pink-600' :
                        sceneStage.includes('Body') ? 'bg-blue-600' :
                            sceneStage.includes('Climax') ? 'bg-orange-600' : 'bg-gray-600';

                    // Prepare Narration & SFX HTML
                    const narrationHtml = (scene.narration_kr || scene.narration_jp) ? `
                    <div class="mt-3 bg-gradient-to-r from-green-900/30 to-blue-900/30 p-4 rounded-lg border border-green-500/30">
                            <span class="text-[11px] text-green-400 font-bold tracking-wider uppercase block mb-2">🗣️ Narration (CapCut 자막용)</span>
                            <div class="space-y-2">
                                ${scene.narration_kr ? `
                                <div>
                                    <span class="text-[10px] text-slate-500 block">🇰🇷 한국어</span>
                                    <p class="text-white text-base font-bold">"${scene.narration_kr}"</p>
                                </div>` : ''}
                                ${scene.narration_jp ? `
                                <div>
                                    <span class="text-[10px] text-slate-500 block">🇯🇵 일본어</span>
                                    <p class="text-blue-300 text-base font-bold">"${scene.narration_jp}"</p>
                                </div>` : ''}
                                ${scene.narration_pron ? `
                                <div>
                                    <span class="text-[10px] text-slate-500 block">🗣️ 발음</span>
                                    <p class="text-orange-300 text-sm font-mono">"${scene.narration_pron}"</p>
                                </div>` : ''}
                            </div>
                        </div> ` : '';

                    const sfxHtml = scene.sfx_suggestion ? `
                    <div class="mt-2 flex items-center gap-2">
                            <span class="text-[10px] text-yellow-500/70 border border-yellow-500/30 px-1.5 py-0.5 rounded uppercase font-bold">🎵 SFX</span>
                            <span class="text-xs text-yellow-100/80">${scene.sfx_suggestion}</span>
                        </div> ` : '';

                    // Enhanced Transcript HTML with 4 Languages (Ordered: Original → Korean → Japanese+Pron paired)
                    const transcriptHtml = (scene.original_transcript || scene.text_jp) ? `
                    <details class="mt-3 group/details" open>
                                    <summary class="text-xs text-slate-500 cursor-pointer hover:text-slate-300 select-none flex items-center gap-1 mb-2">
                                        <span class="group-open/details:rotate-90 transition-transform">▼</span> 🗣️ 4개 국어 대사 (편집용)
                                    </summary>
                                    <div class="space-y-3 pl-2 border-l-2 border-slate-700">
                                        ${scene.original_transcript ? `
                                        <div>
                                            <span class="text-[10px] text-slate-500 block">🇺🇸 원문 (Original)</span>
                                            <p class="text-slate-300 text-xs font-mono">"${scene.original_transcript}"</p>
                                        </div>` : ''}
                                        
                                        ${scene.text_kr ? `
                                        <div>
                                            <span class="text-[10px] text-slate-500 block">🇰🇷 한국어 (자막)</span>
                                            <p class="text-white text-sm font-bold">"${scene.text_kr}"</p>
                                        </div>` : ''}

                                        ${(scene.text_jp || scene.text_pron) ? `
                                        <div class="bg-slate-900/50 p-2 rounded-lg border border-slate-700/50">
                                            <span class="text-[10px] text-blue-400 block mb-1">🇯🇵 일본어 & 발음</span>
                                            ${scene.text_jp ? `
                                            <p class="text-blue-200 text-sm font-bold leading-relaxed mb-1">
                                                "${scene.text_jp.replace(/\//g, '<span class="text-yellow-500/50 mx-1">/</span>')}"
                                            </p>` : ''}
                                            ${scene.text_pron ? `
                                            <p class="text-xs text-orange-300/80 font-mono">
                                                "${scene.text_pron.replace(/\//g, '<span class="text-yellow-500/50 mx-1">/</span>')}"
                                            </p>` : ''}
                                        </div>` : ''}
                                    </div>
                                </details> ` : '';

                    sceneCard.innerHTML = `
                    <!--Timeline at Top(like image)-->
                        <div class="flex items-center justify-between bg-slate-900/50 -m-5 mb-4 p-3 rounded-t-xl border-b border-slate-700">
                            <span class="${badgeColor} text-white text-xs font-bold px-3 py-1 rounded-full">${sceneStage || 'Clip'}</span>
                            <div class="flex items-center gap-2">
                                ${hasValidTime ? `
                                    <span class="text-purple-300 font-mono font-bold text-sm">${formatTime(sceneStart)}</span>
                                    <div class="w-[1px] h-4 bg-slate-600"></div>
                                    <span class="text-purple-300 font-mono font-bold text-sm">${formatTime(sceneEnd)}</span>
                                    <span class="text-slate-500 text-xs text-nowrap">(${duration}s)</span>
                                ` : `
                                    <span class="text-red-400 font-bold text-xs flex items-center gap-1">
                                        <i class="fas fa-exclamation-triangle"></i> 시간 정보 없음 (편집 불가)
                                    </span>
                                `}
                            </div>
                        </div>

                        <!--Content -->
                    <div>
                        <h4 class="text-white font-bold text-lg mb-1">${scene.description}</h4>
                        <p class="text-slate-400 text-sm mb-2">💡 ${scene.reason}</p>

                        ${narrationHtml}
                        ${sfxHtml}
                        ${transcriptHtml}

                        <div class="mt-3 flex gap-2">
                            <button onclick="navigator.clipboard.writeText('${sceneStart.toFixed(2)}-${sceneEnd.toFixed(2)}')"
                                class="text-xs bg-slate-700 hover:bg-slate-600 text-white px-2 py-1 rounded transition-colors">
                                ⏱️ 정밀 타임코드 복사
                            </button>
                        </div>
                    </div>
                `;
                    grid.appendChild(sceneCard);
                });

                // Store plan for Step 3
                window.currentDirectorPlan = plan;

                // Enable video cutting status
                if (plan.length > 0) {
                    // Enable video cutting button
                    const cutBtn = document.getElementById('cutHighlightsVideoBtn');
                    cutBtn.disabled = false;
                    cutBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                    cutBtn.onclick = cutHighlightsVideo; // Bind the function

                    // ---------------------------------------------------------
                    // AUTO-POPULATE TIMELINE SCRIPT (VOICEVOX)
                    // ---------------------------------------------------------
                    let timelineScript = '';
                    let accumulatedTime = 0;

                    plan.forEach(scene => {
                        const sceneStart = scene.start ?? 0;
                        const sceneEnd = scene.end ?? 0;
                        const duration = sceneEnd - sceneStart;
                        const startTime = accumulatedTime;
                        const endTime = accumulatedTime + duration;

                        // Priority: Use strictly Narration JP only
                        // We do NOT fallback to text_jp (original transcript) because that includes dialogue
                        // which the user specifically doesn't want in the TTS script.
                        const text = scene.narration_jp || '';

                        if (text) {
                            timelineScript += `${text}\n`;
                        }

                        accumulatedTime += duration;
                    });

                    const scriptArea = document.getElementById('scriptTextarea');
                    scriptArea.value = timelineScript;

                    // Flash effect to indicate auto-population
                    scriptArea.classList.add('bg-blue-900/30', 'transition-colors', 'duration-500');
                    setTimeout(() => scriptArea.classList.remove('bg-blue-900/30'), 1000);

                    // Update UI state
                    checkTTSButtonState();
                    // ---------------------------------------------------------
                }
            }

            // Download Functions
            window.downloadFullTranscript = function () {
                if (!currentTranscriptData) { alert('대본 데이터가 없습니다.'); return; }

                let content = `🎥 전체 영상 대본(언어: ${currentTranscriptData.languageName}) \n`;
                content += `총 길이: ${currentTranscriptData.duration} 초\n\n`;

                currentTranscriptData.segments.forEach(seg => {
                    content += `[${formatTime(seg.start)} - ${formatTime(seg.end)}](${seg.emotion}) \n`;
                    content += `${seg.text} \n\n`;
                });

                downloadTextFile(content, `full_transcript_${Date.now()}.txt`);
            }

            window.downloadDirectorScript = function () {
                if (!window.currentDirectorPlan) { alert('하이라이트 데이터가 없습니다.'); return; }

                let content = `🎬 AI Director's Cut 하이라이트 대본\n`;
                content += `====================================\n\n`;

                window.currentDirectorPlan.forEach((scene, i) => {
                    const sceneStart = scene.start ?? 0;
                    const sceneEnd = scene.end ?? 0;
                    const sceneStage = scene.stage || 'Clip';
                    content += `Scene ${i + 1}: ${sceneStage} (${formatTime(sceneStart)} - ${formatTime(sceneEnd)})\n`;
                    content += `------------------------------------\n`;
                    content += `내용: ${scene.description}\n`;
                    if (scene.sfx_suggestion) content += `SFX: ${scene.sfx_suggestion}\n`;

                    // Add Narration Section
                    if (scene.narration_kr || scene.narration_jp) {
                        content += `\n🗣️ Narration (CapCut 자막용)\n`;
                        if (scene.narration_kr) content += `🇰🇷 한국어\n"${scene.narration_kr}"\n\n`;
                        if (scene.narration_jp) content += `🇯🇵 일본어\n"${scene.narration_jp}"\n\n`;
                        if (scene.narration_pron) content += `🗣️ 발음\n"${scene.narration_pron}"\n`;
                    }

                    content += `\n[대사]\n`;
                    content += `KR: ${scene.description}\n`; // Using description as KR summary
                    if (scene.original_transcript) content += `ORI: ${scene.original_transcript}\n`;
                    if (scene.text_jp) content += `JP: ${scene.text_jp}\n`;
                    if (scene.text_pron) content += `PRON: ${scene.text_pron}\n`;
                    content += `\n\n`;
                });

                downloadTextFile(content, `director_highlights_${Date.now()}.txt`);
            }

            function downloadTextFile(content, filename) {
                const blob = new Blob([content], { type: 'text/plain' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                a.click();
                window.URL.revokeObjectURL(url);
            }

            // Download SRT subtitle file
            window.downloadSRT = function (language) {
                if (!window.currentDirectorPlan || window.currentDirectorPlan.length === 0) {
                    alert('하이라이트 데이터가 없습니다.');
                    return;
                }

                let langName = 'Unknown';
                switch (language) {
                    case 'en': langName = 'English'; break;
                    case 'jp': langName = 'Japanese'; break;
                    case 'pron': langName = 'Japanese_Pronunciation'; break;
                    case 'kr': langName = 'Korean'; break;
                }

                let srtContent = '';
                let index = 1;
                let accumulatedTime = 0;

                window.currentDirectorPlan.forEach((scene) => {
                    let text = '';

                    switch (language) {
                        case 'en': text = scene.original_transcript || scene.description; break;
                        case 'jp': text = scene.text_jp || ''; break;
                        case 'pron': text = scene.text_pron || ''; break;
                        case 'kr': text = scene.text_kr || scene.description; break;
                        default: text = scene.description;
                    }

                    // Calculate duration and relative timestamps for the highlight video
                    const duration = scene.end - scene.start;
                    const startTime = accumulatedTime;
                    const endTime = accumulatedTime + duration;

                    // Update accumulated time for next scene
                    accumulatedTime += duration;

                    if (!text || text.trim() === '') return;

                    srtContent += `${index}\n`;
                    srtContent += `${formatSRTTimestamp(startTime)} --> ${formatSRTTimestamp(endTime)}\n`;
                    srtContent += `${text}\n\n`;

                    index++;
                });

                if (srtContent === '') {
                    alert('선택한 언어의 자막 데이터가 없습니다.');
                    return;
                }

                const blob = new Blob([srtContent], { type: 'text/plain; charset=utf-8' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `highlights_${langName}_${Date.now()}.srt`;
                a.click();
                window.URL.revokeObjectURL(url);
            }

            // Download Director Plan as Image
            window.downloadDirectorImage = async function () {
                const element = document.getElementById('highlightsGrid');
                if (!element) return;

                const btn = event.currentTarget || document.querySelector('button[onclick="downloadDirectorImage()"]');
                const originalText = btn ? btn.innerHTML : '📸 설계도 이미지 저장 (.png)';
                if (btn) btn.innerHTML = '⏳ 캡처 준비...';

                try {
                    // 1. 모든 Details 열기 (숨겨진 내용 캡처 위해)
                    const details = element.querySelectorAll('details');
                    details.forEach(d => d.open = true);

                    // 2. 렌더링 안정화를 위해 잠시 대기
                    await new Promise(resolve => setTimeout(resolve, 300));

                    if (btn) btn.innerHTML = '📸 저장 중...';

                    // 3. html2canvas 캡처 (전체 높이 설정)
                    const canvas = await html2canvas(element, {
                        backgroundColor: '#111827', // dark-gray-900 background
                        scale: 2, // High resolution
                        logging: false,
                        useCORS: true,
                        allowTaint: true,
                        scrollY: -window.scrollY,      // Handle current scroll position
                        windowWidth: document.documentElement.offsetWidth,
                        height: element.scrollHeight + 50, // Force full height
                        windowHeight: element.scrollHeight + 100
                    });

                    const link = document.createElement('a');
                    link.download = `director_plan_full_${Date.now()}.png`;
                    link.href = canvas.toDataURL('image/png');
                    link.click();
                } catch (err) {
                    console.error('Image capture error:', err);
                    alert('이미지 저장 실패: ' + err.message);
                } finally {
                    if (btn) btn.innerHTML = originalText;
                }
            }

            // Helper: Format timestamp for SRT (HH:MM:SS,mmm)
            function formatSRTTimestamp(seconds) {
                const hours = Math.floor(seconds / 3600);
                const minutes = Math.floor((seconds % 3600) / 60);
                const secs = Math.floor(seconds % 60);
                const millis = Math.floor((seconds % 1) * 1000);

                return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(secs).padStart(2, '0')},${String(millis).padStart(3, '0')}`;
            }

            async function generateFinalScript() {
                if (!window.currentDirectorPlan || !currentTranscriptData) {
                    alert('필요한 데이터가 없습니다.');
                    return;
                }

                const btn = document.getElementById('generateFinalScriptBtn');
                const originalText = btn.innerHTML;
                btn.innerHTML = '⏳ AI가 대본 생성 중... (약 15초)';
                btn.disabled = true;

                try {
                    const response = await fetch('http://localhost:4000/api/guidelines/generate-final-script', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            directorPlan: window.currentDirectorPlan,
                            transcript: currentTranscriptData
                        })
                    });

                    const data = await response.json();

                    if (!response.ok) throw new Error(data.error || '대본 생성 실패');

                    // Render Step 3
                    displayFinalScript(data.finalScript);

                } catch (error) {
                    alert('오류 발생: ' + error.message);
                } finally {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }
            }

            // Fixed Syntax Error
            function displayFinalScript(script) {
                // Show Titles Section
                const section = document.getElementById('titlesSection');
                const content = document.getElementById('titlesContent');

                section.classList.remove('hidden');
                section.scrollIntoView({ behavior: 'smooth' });

                let html = '';
                html += '<div class="flex justify-between items-center mb-6">';
                html += '<h2 class="text-2xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-green-400 to-blue-500">📝 최종 1분 미만 압축 대본</h2>';
                html += '<button onclick="copyFinalScript()" class="bg-slate-700 hover:bg-slate-600 text-white font-bold px-4 py-2 rounded-lg transition-colors">📋 전체 대본 복사</button>';
                html += '</div>';

                let clipboardText = '';

                script.forEach(function (line) {
                    // Manual string concatenation for blockText - REMOVED BACKTICKS
                    let blockText = '[' + line.time + '] ' + line.stage + '\n';
                    blockText += 'KR: ' + line.textKO + '\n';
                    blockText += 'JP: ' + line.textJP + '\n';
                    blockText += '발음: ' + line.textPron + '\n\n';

                    clipboardText += blockText;

                    // Manual string concatenation for HTML - REMOVED BACKTICKS
                    html += '<div class="bg-slate-800/50 border border-slate-700 rounded-xl p-6 mb-4 hover:border-green-500 transition-colors">';

                    html += '<div class="flex justify-between items-start mb-2">';
                    html += '<span class="text-green-400 font-mono font-bold text-sm">' + line.time + '</span>';
                    html += '<span class="bg-slate-700 text-white text-xs px-2 py-1 rounded">' + line.stage + '</span>';
                    html += '</div>';

                    html += '<div class="space-y-3">';

                    html += '<div>';
                    html += '<span class="text-xs text-slate-500 block mb-1">🇰🇷 한국어 (자막용)</span>';
                    html += '<p class="text-white font-bold text-lg">' + renderColorTags(line.textKO) + '</p>';
                    html += '</div>';

                    html += '<div class="grid grid-cols-1 md:grid-cols-2 gap-4">';
                    html += '<div class="bg-slate-900/50 p-3 rounded-lg">';
                    html += '<span class="text-xs text-slate-500 block mb-1">🇯🇵 일본어</span>';
                    html += '<p class="text-slate-300">' + renderColorTags(line.textJP) + '</p>';
                    html += '</div>';

                    html += '<div class="bg-slate-900/50 p-3 rounded-lg">';
                    html += '<span class="text-xs text-slate-500 block mb-1">🗣️ 발음</span>';
                    html += '<p class="text-orange-300 font-mono">' + renderColorTags(line.textPron) + '</p>';
                    html += '</div>';

                    html += '</div>'; // End grid
                    html += '</div>'; // End space-y-3
                    html += '</div>'; // End card container
                });

                content.innerHTML = html;
                window.finalScriptText = clipboardText;
            }

            function copyFinalScript() {
                if (window.finalScriptText) {
                    navigator.clipboard.writeText(window.finalScriptText).then(() => {
                        alert('대본이 복사되었습니다! CapCut에 붙여넣으세요.');
                    });
                }
            }

            function displayHighlights(highlights) {
                // Legacy support (Keep existing code structure if needed, or remove)
                const grid = document.getElementById('highlightsGrid');
                grid.innerHTML = '<p class="text-red-500 text-center col-span-full">⚠️ 구버전 API 응답입니다.</p>';
            }


            // Also store transcript data when extracted
            /* In extractTranscriptBtn handler:
               currentTranscriptData = data.transcript;
            */

            function formatTime(seconds) {
                const mins = Math.floor(seconds / 60);
                const secs = Math.floor(seconds % 60);
                return `${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
            }

            // Render Color Tags helper
            function renderColorTags(text) {
                if (!text) return '';
                // Convert <color=#HEX>...</color> to <span> with style
                // Add subtle glow and bold for premium feel
                return text.replace(/<color=(#[0-9A-F]{6})>(.*?)<\/color>/gi, (match, color, p2) => {
                    return `<span style="color:${color}; font-weight: 800; text-shadow: 0 0 10px ${color}44;">${p2}</span>`;
                });
            }

            // ========================================
            // COMMENT SCRAPER LOGIC
            // ========================================
            document.getElementById('scrapeCommentsBtn').addEventListener('click', async () => {
                const urlInput = document.getElementById('commentUrlInput');
                const url = urlInput.value.trim();
                const btn = document.getElementById('scrapeCommentsBtn');
                const output = document.getElementById('videoComments');

                if (!url) {
                    alert('URL을 입력해주세요.');
                    return;
                }

                const originalText = btn.innerHTML;
                btn.innerHTML = '<span class="loader w-4 h-4 border-2 border-t-white inline-block mr-2 animate-spin rounded-full"></span> 가져오는 중...';
                btn.disabled = true;

                try {
                    const response = await fetch('http://localhost:4000/api/guidelines/scrape-comments', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ url })
                    });

                    const data = await response.json();

                    if (!response.ok) {
                        throw new Error(data.error || '댓글 가져오기 실패');
                    }

                    if (data.comments && data.comments.length > 0) {
                        const formattedComments = data.comments.join('\n\n');
                        const existing = output.value ? output.value + '\n\n' : '';
                        output.value = existing + `--- [${new URL(url).hostname} 댓글] ---\n` + formattedComments;

                        // Flash success
                        urlInput.value = ''; // Clean input
                        alert(`✅ ${data.comments.length}개의 댓글을 성공적으로 가져왔습니다!`);
                    } else {
                        alert('가져올 댓글이 없습니다.');
                    }

                } catch (error) {
                    console.error('Scraper Error:', error);
                    alert('실패: ' + error.message);
                } finally {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }
            });

            // ========================================
            // VIDEO CUTTING FUNCTIONALITY
            // ========================================
            async function cutHighlightsVideo() {
                if (!window.currentDirectorPlan || window.currentDirectorPlan.length === 0) {
                    alert('하이라이트가 선택되지 않았습니다.');
                    return;
                }

                if (!selectedFile) {
                    alert('원본 영상 파일이 필요합니다. 영상을 다시 업로드해주세요.');
                    return;
                }

                const cutBtn = document.getElementById('cutHighlightsVideoBtn');
                const originalHTML = cutBtn.innerHTML;
                cutBtn.disabled = true;
                cutBtn.innerHTML = '<span class="loader w-5 h-5 border-2 border-t-white mr-2"></span> 영상 편집 중... (최대 1-2분 소요)';

                try {
                    // Log the raw director plan for debugging
                    console.log('[Video Cut] Raw Director Plan:', window.currentDirectorPlan);
                    console.log('[Video Cut] Total scenes in plan:', window.currentDirectorPlan.length);

                    // Extract highlights array from director plan
                    // ONLY include original_clip type (speaker dialogue), exclude all narration
                    const invalidScenes = [];
                    const narrationScenes = [];

                    const highlights = window.currentDirectorPlan
                        .filter((scene, index) => {
                            // Skip narration scenes (user will add them manually)
                            if (scene.type && scene.type.includes('narration')) {
                                narrationScenes.push({
                                    index: index + 1,
                                    stage: scene.stage || 'Unknown',
                                    type: scene.type,
                                    start: scene.start,
                                    end: scene.end,
                                    description: scene.narration_kr || scene.description || 'Narration'
                                });
                                return false; // Skip narration scenes
                            }

                            // Ensure start and end are valid numbers
                            const s = parseFloat(scene.start);
                            const e = parseFloat(scene.end);
                            const isValid = !isNaN(s) && !isNaN(e) && e > s;

                            if (!isValid) {
                                invalidScenes.push({
                                    index: index + 1,
                                    stage: scene.stage || 'Unknown',
                                    type: scene.type || 'Unknown',
                                    start: scene.start,
                                    end: scene.end,
                                    description: scene.description || scene.text_kr || 'No description'
                                });
                            }

                            return isValid;
                        })
                        .map(scene => ({
                            start: parseFloat(scene.start),
                            end: parseFloat(scene.end)
                        }));

                    // Log filtering results
                    if (narrationScenes.length > 0) {
                        console.log(`[Video Cut] 📝 Skipped ${narrationScenes.length} narration scenes (you'll add these manually):`);
                        narrationScenes.forEach(scene => {
                            console.log(`  Scene ${scene.index} (${scene.type}): ${scene.start}s - ${scene.end}s - "${scene.description.substring(0, 50)}..."`);
                        });
                    }

                    if (invalidScenes.length > 0) {
                        console.warn('[Video Cut] ⚠️ Filtered out invalid scenes:', invalidScenes);
                        console.warn('[Video Cut] Invalid scene details:');
                        invalidScenes.forEach(scene => {
                            console.warn(`  Scene ${scene.index} (${scene.stage}/${scene.type}): start=${scene.start}, end=${scene.end} - "${scene.description.substring(0, 50)}..."`);
                        });
                    }

                    console.log(`[Video Cut] ✅ ${highlights.length} speaker clips to cut (excluding ${narrationScenes.length} narration scenes)`);

                    if (highlights.length === 0) {
                        const errorMsg = `편집할 수 있는 유효한 하이라이트 구간이 없습니다.\n\n` +
                            `전체 씬: ${window.currentDirectorPlan.length}개\n` +
                            `유효하지 않은 씬: ${invalidScenes.length}개\n\n` +
                            `문제가 있는 씬:\n` +
                            invalidScenes.map(s => `- Scene ${s.index} (${s.type}): start=${s.start}, end=${s.end}`).join('\n');

                        alert(errorMsg);
                        console.error('[Video Cut] All scenes have invalid timestamps. Check the AI response.');
                        cutBtn.disabled = false;
                        cutBtn.innerHTML = originalHTML;
                        return;
                    }

                    console.log('[Video Cut] Cutting speaker clips:', highlights);

                    // Create form data
                    const formData = new FormData();
                    formData.append('video', selectedFile);
                    formData.append('highlights', JSON.stringify(highlights));

                    // Send to API
                    const response = await fetch('http://localhost:4000/api/guidelines/cut-highlights', {
                        method: 'POST',
                        body: formData
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || '영상 편집에 실패했습니다');
                    }

                    // Download the generated video
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `highlights_${Date.now()}.mp4`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);

                    alert('✅ 하이라이트 영상이 성공적으로 생성되었습니다!\n다운로드를 확인하세요.');

                } catch (error) {
                    console.error('[Video Cut] Error:', error);
                    alert('❌ 오류 발생: ' + error.message);
                } finally {
                    cutBtn.disabled = false;
                    cutBtn.innerHTML = originalHTML;
                }
            }

        </script>
        <script>
            // ========================================
            // AI PRODUCTION PIPELINE LOGIC
            // ========================================

            let availableStyles = null;
            let currentProductionScript = null; // Stores generated script

            // 1. Open Production Modal
            document.getElementById('openAiProductionBtn').addEventListener('click', async () => {
                if (!currentTranscriptData) {
                    alert('⚠️ 대본이 추출되지 않았습니다.\n먼저 왼쪽의 "📝 영상 대본 추출" 버튼을 눌러주세요.');
                    return;
                }

                document.getElementById('styleModal').classList.remove('hidden');

                if (!availableStyles) {
                    await loadStyles();
                }
            });

            // 2. Load Styles from Backend
            async function loadStyles() {
                const container = document.getElementById('styleChannelsGrid');
                container.innerHTML = '<div class="col-span-full text-center text-white"><div class="loader w-10 h-10 border-4 border-t-orange-500 mx-auto mb-4"></div>스타일 불러오는 중...</div>';

                try {
                    const response = await fetch('http://localhost:4000/api/production/styles');
                    const data = await response.json();

                    if (data.success) {
                        availableStyles = data.styles;
                        renderStyleCategories(data.styles);
                        renderStyleChannels(getAllChannels(data.styles));

                        // AUTO-SELECT STYLE IF PASSED FROM FINDER
                        if (window.preSelectedStyleId) {
                            const all = getAllChannels(data.styles);
                            const target = all.find(c => c.id == window.preSelectedStyleId);
                            if (target) {
                                console.log('🎯 Auto-selecting Style:', target.name);
                                // Wait a tick for DOM
                                setTimeout(() => {
                                    // Find card and trigger click
                                    // We need to find the specific card element to visual highlight
                                    // But selectStyle function handles visual update if we pass element
                                    // Let's just call selectStyle logic directly
                                    selectStyle(target, null);

                                    // Also maybe filter category? (Optional)
                                    // For now just select it.
                                }, 100);
                            }
                        }
                    }
                } catch (error) {
                    console.error('Failed to load styles:', error);
                    container.innerHTML = '<div class="col-span-full text-center text-red-400">스타일 로드 실패</div>';
                }
            }

            // Helper: Flatten styles
            function getAllChannels(stylesMap) {
                let all = [];
                Object.values(stylesMap).forEach(list => all = all.concat(list));
                return all;
            }

            // 3. Render Categories
            function renderStyleCategories(stylesMap) {
                const catContainer = document.getElementById('styleCategories');
                catContainer.innerHTML = '';

                // Define 15 Fixed Categories (Same as HotChannel Style Lab)
                const CATEGORIES = [
                    '영화/애니메이션', '자동차', '음악', '반려동물/동물', '스포츠',
                    '여행/이벤트', '게임', '인물/블로그', '코미디', '엔터테인먼트',
                    '뉴스/정치', '노하우/스타일', '교육', '과학기술', '비영리/사회운동', '일반'
                ];

                // 'All' button
                const allChannels = getAllChannels(stylesMap);
                const allBtn = document.createElement('button');
                allBtn.className = 'w-full text-left px-4 py-3 rounded-lg bg-orange-500/20 text-orange-400 font-bold mb-2 border border-orange-500/30';
                allBtn.textContent = `📂 전체 보기(${allChannels.length})`;
                allBtn.onclick = () => renderStyleChannels(allChannels, 'ALL');
                catContainer.appendChild(allBtn);

                // Render all 15 categories (plus 'General' if used)
                CATEGORIES.forEach(cat => {
                    const count = stylesMap[cat] ? stylesMap[cat].length : 0;

                    const btn = document.createElement('button');
                    btn.className = 'w-full text-left px-4 py-2 rounded-lg hover:bg-slate-700 text-slate-300 transition-colors text-sm flex justify-between items-center';
                    // Highlight if active logic could be added here

                    btn.innerHTML = `
                        <span > ${cat}</span>
                            <span class="text-xs text-slate-500 bg-slate-800 px-2 py-0.5 rounded-full">${count}</span>
                    `;

                    btn.onclick = () => {
                        // Visual update for category buttons
                        document.querySelectorAll('#styleCategories button').forEach(b => {
                            b.classList.remove('bg-slate-700', 'text-white');
                            b.classList.add('text-slate-300');
                        });
                        btn.classList.add('bg-slate-700', 'text-white');
                        btn.classList.remove('text-slate-300');

                        if (count > 0) {
                            renderStyleChannels(stylesMap[cat], cat);
                            // AUTO-SELECT LOGIC: Pick the first channel automatically
                            const firstChannel = stylesMap[cat][0];
                            if (firstChannel) {
                                // Wait a tick for DOM rendering then select
                                setTimeout(() => {
                                    // Default to first channel, but user can click 'Blend All'
                                    selectStyle(firstChannel);
                                    console.log('🎯 Auto-selected first channel in category:', firstChannel.name);
                                }, 50);
                            }
                        } else {
                            // Optional: Show empty state or still clear grid
                            renderStyleChannels([], cat);
                            document.getElementById('styleChannelsGrid').innerHTML = `
                        <div class="col-span-full py-10 text-center text-slate-500 flex flex-col items-center justify-center" >
                                    <div class="text-4xl mb-2 opacity-50">📂</div>
                                    <p class="font-bold">이 카테고리에 등록된 스타일이 없습니다.</p>
                                    <p class="text-xs mt-1">스타일 연구소에서 이 카테고리의 채널을 저장해보세요!</p>
                                </div>
                        `;
                        }
                    };
                    catContainer.appendChild(btn);
                });
            }

            // 4. Render Channels (Cards)
            function renderStyleChannels(channels, categoryName = null) {
                const grid = document.getElementById('styleChannelsGrid');
                grid.innerHTML = '';

                if (channels.length === 0) {
                    grid.innerHTML = '<div class="col-span-full text-center text-slate-500">채널이 없습니다.</div>';
                    return;
                }

                // NEW: Inject "Blend All" Card if multiple channels exist in a specific category
                if (categoryName && categoryName !== 'ALL' && channels.length > 1) {
                    const blendCard = document.createElement('div');
                    blendCard.className = 'bg-gradient-to-br from-indigo-900 to-purple-900 rounded-xl overflow-hidden cursor-pointer hover:ring-2 hover:ring-pink-500 transition-all group style-card flex flex-col h-full border border-indigo-500/30 shadow-lg shadow-indigo-500/20';
                    blendCard.dataset.id = 'BLEND_ALL';

                    blendCard.innerHTML = `
                        <div class="h-24 bg-black/40 relative overflow-hidden flex-shrink-0 flex items-center justify-center" >
                             <div class="text-4xl">🧪</div>
                             <div class="absolute inset-0 bg-gradient-to-t from-indigo-900/80 to-transparent"></div>
                             <div class="absolute bottom-2 left-3 font-bold text-white text-lg shadow-black drop-shadow-md">Hybrid ${categoryName}</div>
                        </div>
                        <div class="p-4 flex flex-col flex-1">
                            <div class="text-xs text-pink-400 mb-2 font-bold uppercase tracking-wider">ULTIMATE BLEND</div>
                            <p class="text-indigo-200 text-sm line-clamp-3 leading-relaxed mb-4 flex-1">
                                Combine the DNA of all <strong>${channels.length} channels</strong> in this category to create a unique, high-performance hybrid persona.
                            </p>
                            <button class="w-full bg-indigo-600 hover:bg-pink-600 text-white text-xs font-bold py-2 rounded-lg transition-colors flex items-center justify-center gap-1 shadow-md">
                                <span>🚀</span> Select Hybrid Style
                            </button>
                        </div>
                    `;
                    blendCard.onclick = (e) => selectHybridStyle(channels, categoryName, e.currentTarget);
                    grid.appendChild(blendCard);
                }

                channels.forEach(ch => {
                    const card = document.createElement('div');
                    card.dataset.id = ch.id; // Store ID for auto-selection
                    card.className = 'bg-slate-800 rounded-xl overflow-hidden cursor-pointer hover:ring-2 hover:ring-orange-500 transition-all group style-card flex flex-col h-full'; // Added flex/h-full
                    card.onclick = (e) => selectStyle(ch, e.currentTarget);

                    const hasDna = ch.strategy?.structure_template && ch.strategy.structure_template.length > 0;

                    card.innerHTML = `
                        <div class="h-24 bg-slate-700 relative overflow-hidden flex-shrink-0" >
                            ${ch.thumbnail ? `<img src="${ch.thumbnail}" class="w-full h-full object-cover opacity-60 group-hover:opacity-100 transition-opacity">` : ''}
                             <div class="absolute inset-0 bg-gradient-to-t from-slate-900 to-transparent"></div>
                             <div class="absolute bottom-2 left-3 font-bold text-white text-lg shadow-black drop-shadow-md">${ch.name}</div>
                        </div>
                        <div class="p-4 flex flex-col flex-1">
                            <div class="text-xs text-orange-400 mb-2 font-bold uppercase tracking-wider">${ch.strategy?.tone || 'Style'}</div>
                            <p class="text-slate-400 text-sm line-clamp-2 leading-relaxed mb-4 flex-1">${ch.summary || 'AI 분석 데이터 없음'}</p>

                            <!-- DNA Button -->
                            ${hasDna ? `
                            <button onclick="event.stopPropagation(); openDnaModal('${ch.id}')" 
                                class="w-full bg-slate-700 hover:bg-indigo-600 hover:text-white text-slate-300 text-xs font-bold py-2 rounded-lg transition-colors flex items-center justify-center gap-1 border border-slate-600 hover:border-indigo-500">
                                <span>🧬</span> DNA 분석 (구조 보기)
                            </button>
                            ` : ''}
                        </div>
                    `;
                    grid.appendChild(card);
                });
            }

            // NEW: Select Hybrid Style Logic
            function selectHybridStyle(channels, categoryName, cardElement) {
                // Collect all IDs
                const ids = channels.map(c => c.id);
                window.selectedStyleId = 'HYBRID'; // Marker
                window.selectedHybridIds = ids;
                window.selectedHybridCategory = categoryName;

                // UI Feedback
                document.querySelectorAll('.style-card').forEach(c => c.classList.remove('ring-4', 'ring-pink-500', 'ring-orange-500'));
                cardElement.classList.add('ring-4', 'ring-pink-500');

                // Update Result UI
                const resultDiv = document.getElementById('appliedStyleResult');
                resultDiv.innerHTML = `
                    <div class="font-bold text-pink-400 text-lg">🧪 Hybrid ${categoryName} Style</div>
                    <div class="text-xs text-slate-400">Blending ${channels.length} Personas</div>
                `;
                resultDiv.classList.remove('hidden');

                // Show notification
                // alert(`Blending ${channels.length} channels for ultimate style!`);
            }

            // DNA Modal Logic
            window.openDnaModal = function (id) {
                const allChannels = getAllChannels(availableStyles);
                // Use loose equality to handle string/number ID mismatch
                const ch = allChannels.find(c => c.id == id);
                if (!ch) {
                    console.warn('Channel not found for DNA modal:', id);
                    return;
                }
                if (!ch.strategy?.structure_template) {
                    alert('이 스타일에는 DNA 구조 데이터가 없습니다.');
                    return;
                }

                const container = document.getElementById('dnaTimelineContainer');
                container.innerHTML = ch.strategy.structure_template.map((step, idx) => {
                    const colors = ['border-blue-500', 'border-purple-500', 'border-pink-500', 'border-orange-500'];
                    const color = colors[idx % colors.length];
                    const badgeColor = step.type === 'Hook' ? 'bg-red-500' : 'bg-slate-600';

                    return `
                        <div class="flex gap-4 relative" >
                        <!--Left: Time-->
                        <div class="w-16 text-right pt-2">
                             <span class="text-xs font-mono text-slate-500 block">${step.time}</span>
                        </div>
                        
                        <!--Timeline Line-->
                        <div class="absolute left-[4.5rem] top-3 bottom-0 w-0.5 bg-slate-800"></div>
                        <div class="absolute left-[4.35rem] top-3 w-3 h-3 rounded-full bg-slate-700 border-2 border-slate-900 z-10"></div>

                        <!--Right: Card-->
                        <div class="flex-1 bg-slate-800/80 p-4 rounded-xl border-l-4 ${color} mb-3 ml-4">
                            <div class="flex justify-between items-start mb-2">
                                <span class="${badgeColor} text-white text-[10px] font-bold px-2 py-0.5 rounded uppercase tracking-wider">${step.type}</span>
                                <span class="text-slate-500 text-[10px]">⏱️ ${step.time}</span>
                            </div>
                            <p class="text-slate-300 text-sm font-medium leading-relaxed">${step.description}</p>
                        </div>
                    </div>
                        `;
                }).join('');

                document.getElementById('dnaViewModal').classList.remove('hidden');
            };

            // 5. Select Style Logic
            let selectedStyleId = null;

            function selectStyle(channel, element) {
                selectedStyleId = channel.id;

                // Find element if not passed (Auto-selection)
                if (!element) {
                    element = document.querySelector(`.style-card[data-id="${channel.id}"]`);
                }

                // Visual Update
                document.querySelectorAll('.style-card').forEach(c => c.classList.remove('ring-2', 'ring-orange-500'));
                if (element) {
                    element.classList.add('ring-2', 'ring-orange-500');
                    element.scrollIntoView({ behavior: 'smooth', block: 'center' }); // Auto-scroll to selection
                }

                document.getElementById('selectedStyleName').textContent = channel.name;
                document.getElementById('selectedStylePreview').style.backgroundImage = `url(${channel.thumbnail})`;

                const btn = document.getElementById('startProductionBtn');
                btn.disabled = false;
                btn.classList.remove('opacity-50', 'cursor-not-allowed');
            }

            // 6. Start Production (Generate Script)
            // 6. Start Production (Generate Script)
            document.getElementById('startProductionBtn').addEventListener('click', async () => {
                // Check for either single style OR hybrid style
                if ((!selectedStyleId && !window.selectedHybridIds) || !currentTranscriptData) return;

                const btn = document.getElementById('startProductionBtn');
                btn.textContent = '⏳ AI가 스타일에 맞춰 대본을 재구성하는 중...';
                btn.disabled = true;

                // Prepare Text AND Segments (for timeline mapping)
                const transcriptText = currentTranscriptData.segments.map(s => s.text).join(' ');
                const transcriptSegments = currentTranscriptData.segments; // Include full timeline data

                // PREPARE PAYLOAD
                const payload = {
                    transcriptText: transcriptText,
                    transcriptSegments: transcriptSegments, // Send segments with timestamps
                    // Pass visual analysis data if available
                    videoExplanation: window.currentVideoAnalysis?.videoExplanation,
                    keyMoments: window.currentVideoAnalysis?.keyMoments,
                    timelineAnalysis: window.currentVideoAnalysis?.timelineAnalysis
                };

                // Handle Hybrid vs Single Style
                if (window.selectedStyleId === 'HYBRID' && window.selectedHybridIds) {
                    payload.styleIds = window.selectedHybridIds;
                    payload.isHybrid = true;
                    payload.categoryName = window.selectedHybridCategory;
                } else {
                    payload.styleId = selectedStyleId;
                }

                try {
                    const response = await fetch('http://localhost:4000/api/production/generate', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    const result = await response.json();

                    if (!response.ok) throw new Error(result.error || '생성 실패');

                    // Success!
                    document.getElementById('styleModal').classList.add('hidden');
                    renderProductionResult(result);

                } catch (error) {
                    alert('오류: ' + error.message);
                } finally {
                    btn.textContent = '🚀 스타일 대본 생성 시작';
                    btn.disabled = false;
                }
            });

            // 7. Render Result
            function renderProductionResult(result) {
                const section = document.getElementById('aiProductionSection');
                section.classList.remove('hidden');
                section.scrollIntoView({ behavior: 'smooth' });

                const styleName = result.styleMetadata?.name || 'Unknown Style';
                const scriptData = result.data.script || [];

                // Collect narration text for Voicevox (Strip color tags for clean audio generation)
                const narrationSegments = scriptData.filter(s => s.type === 'Narration');
                const narrationJapaneseText = narrationSegments.map(s => {
                    // Strip <color=#HEX> and </color> but keep text
                    return s.text_jp.replace(/<color=#[A-Fa-f0-9]{6}>/g, '').replace(/<\/color>/g, '');
                }).join('\n');

                // Unified Display HTML for Full Shorts Processing
                let scriptHTML = scriptData.map((s, idx) => {
                    // Segment Badge Color
                    let segColor = 'bg-slate-700';
                    if (s.section?.includes('Hook')) segColor = 'bg-red-600';
                    if (s.section?.includes('Twist') || s.section?.includes('Climax')) segColor = 'bg-purple-600';
                    if (s.section?.includes('Conclusion')) segColor = 'bg-green-600';

                    // Type Icon & Color Coding
                    const isDialogue = s.type === 'Dialogue';
                    const typeIcon = isDialogue ? '💬' : '🎙️';
                    const typeLabel = s.type || 'Narration';

                    // Color coding: Dialogue = blue, Narration = orange
                    const typeColor = isDialogue ? 'bg-blue-600' : 'bg-orange-600';
                    const borderColor = isDialogue ? 'border-blue-500/30' : 'border-orange-500/30';
                    const bgColor = isDialogue ? 'bg-slate-800/80' : 'bg-slate-800/60';

                    // Timeline display for (CapCut editing)
                    const timelineInfo = (s.start_time && s.end_time)
                        ? `<span class="font-mono text-xs text-blue-300 ml-2">📹 ${s.start_time} → ${s.end_time}</span>`
                        : '';

                    return `
                        <div class="mb-6 ${bgColor} rounded-xl overflow-hidden border ${borderColor} hover:border-indigo-500/30 transition-colors">
                        <!--Header with Segment & Time-->
                        <div class="bg-slate-700/30 px-5 py-3 flex items-center justify-between border-b border-white/5">
                            <div class="flex items-center gap-3">
                                <span class="${segColor} text-white text-[10px] font-bold px-2 py-0.5 rounded uppercase tracking-wider shadow-sm">
                                    ${s.section || 'Segment'}
                                </span>
                                <span class="font-mono text-sm text-indigo-300 font-bold">⏱️ ${s.time}</span>
                                ${timelineInfo}
                            </div>
                            <div class="flex gap-2">
                                ${s.visual_cue ? `<span class="text-xs text-slate-400 bg-slate-900/50 px-2 py-1 rounded border border-white/10" title="Visual Cue">🎥 ${s.visual_cue}</span>` : ''}
                                ${s.sfx ? `<span class="text-xs text-yellow-400/80 bg-yellow-900/20 px-2 py-1 rounded border border-yellow-500/20" title="Sound Effect">🔊 ${s.sfx}</span>` : ''}
                            </div>
                        </div>
                        
                        <div class="p-6 space-y-5">
                            <!-- Speaker Info with Type Badge -->
                            <div class="flex items-center gap-2 mb-1">
                                <span class="text-xs font-bold text-white ${typeColor} px-2 py-0.5 rounded-md">${typeIcon} ${s.speaker || typeLabel}</span>
                            </div>

                            <!-- Original Text (for Dialogue only) -->
                            ${isDialogue && s.original_text ? `
                            <div class="bg-slate-900/40 border border-blue-500/20 rounded-lg p-3 mb-3">
                                <p class="text-xs text-blue-400 font-semibold mb-1">📄 원본 대사</p>
                                <p class="text-sm text-slate-300 italic leading-relaxed">${s.original_text}</p>
                            </div>` : ''}

                            <!-- Japanese (Main) -->
                            <div>
                                <p class="text-xl text-white font-medium leading-relaxed font-sans tracking-wide mb-3">${renderColorTags(s.text_jp)}</p>
                            </div>

                            <!-- Pronunciation -->
                            <div class="pl-4 border-l-2 border-slate-700">
                                <p class="text-slate-400 text-sm leading-relaxed font-mono opacity-80 mb-2">${renderColorTags(s.text_pron)}</p>
                            </div>

                            <!-- Korean -->
                            <div class="pl-4 border-l-2 border-slate-700">
                                <p class="text-slate-500 text-sm leading-relaxed">${renderColorTags(s.text_kr)}</p>
                            </div>
                        </div>
                    </div>
                        `;
                }).join('');

                const titles = result.data.titles || [];
                const thumbnails = result.data.thumbnails || [];

                // Render Titles Row
                let titlesHTML = '';
                if (titles.length > 0) {
                    titlesHTML = `
                        <div class="bg-indigo-900/20 rounded-2xl p-6 mb-8 border border-indigo-500/20">
                            <div class="flex items-center gap-3 mb-6">
                                <span class="text-2xl">🔥</span>
                                <h3 class="text-lg font-bold text-white">AI 추천 바이럴 제목</h3>
                            </div>
                            <div class="grid grid-cols-1 gap-4">
                                ${titles.map((t, i) => `
                                    <div class="bg-indigo-900/40 p-5 rounded-xl border border-indigo-500/10 hover:border-indigo-500/30 transition-all">
                                        <div class="flex items-center gap-2 mb-3">
                                            <span class="bg-indigo-600 text-[10px] font-bold px-2 py-0.5 rounded text-white">VARIANT #${i + 1}</span>
                                        </div>
                                        <p class="text-white font-bold text-lg mb-3 leading-tight">${t.kr}</p>
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3 opacity-80">
                                            <div class="bg-black/20 p-2 rounded">
                                                <span class="text-[9px] text-slate-500 block mb-0.5">🇯🇵 일본어</span>
                                                <p class="text-slate-300 text-xs">${t.jp}</p>
                                            </div>
                                            <div class="bg-black/20 p-2 rounded">
                                                <span class="text-[9px] text-slate-500 block mb-0.5">🗣️ 발음</span>
                                                <p class="text-indigo-300 text-xs font-mono">${t.pron}</p>
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                }

                // Render Thumbnail Phrases Row
                let thumbnailsHTML = '';
                if (thumbnails.length > 0) {
                    thumbnailsHTML = `
                        <div class="bg-amber-900/20 rounded-2xl p-6 mb-8 border border-amber-500/20">
                            <div class="flex items-center gap-3 mb-6">
                                <span class="text-2xl">🖼️</span>
                                <h3 class="text-lg font-bold text-white">썸네일 문구 추천</h3>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                ${thumbnails.map((t, i) => `
                                    <div class="bg-amber-900/40 p-4 rounded-xl border border-amber-500/10 flex flex-col h-full">
                                        <div class="mb-3">
                                            <span class="bg-amber-600 text-[10px] font-bold px-2 py-0.5 rounded text-white uppercase">Design #${i + 1}</span>
                                        </div>
                                        <p class="text-white font-black text-base mb-3 leading-snug whitespace-pre-line flex-grow">${t.kr}</p>
                                        <div class="space-y-2 pt-3 border-t border-white/5 opacity-80">
                                            <div>
                                                <span class="text-[9px] text-slate-500 block">🇯🇵 JP</span>
                                                <p class="text-slate-300 text-[11px] leading-tight whitespace-pre-line">${t.jp}</p>
                                            </div>
                                            <div>
                                                <span class="text-[9px] text-slate-500 block">🗣️ PRON</span>
                                                <p class="text-amber-200 text-[11px] font-mono leading-tight whitespace-pre-line">${t.pron}</p>
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                }

                section.innerHTML = `
                        <div class="max-w-4xl mx-auto py-8">
                        <div class="flex items-center justify-between mb-8">
                            <div class="flex items-center gap-4">
                                <div class="w-12 h-12 bg-indigo-600 rounded-2xl flex items-center justify-center text-2xl shadow-lg shadow-indigo-500/20">🎬</div>
                                <div>
                                    <h2 class="text-2xl font-bold text-white">Production Result</h2>
                                    <p class="text-slate-400 text-sm flex items-center gap-2">
                                        Applied Style: <span class="text-indigo-400 font-bold bg-indigo-400/10 px-2 py-0.5 rounded">${styleName}</span>
                                    </p>
                                </div>
                            </div>
                            <button onclick="document.getElementById('aiProductionSection').classList.add('hidden')" 
                                class="px-4 py-2 hover:bg-slate-800 text-slate-500 hover:text-white rounded-lg transition-colors">
                                Close
                            </button>
                        </div>

                        <!-- Viral Strategy Logic -->
                        ${result.data.viral_logic ? `
                        <div class="bg-gradient-to-r from-purple-900/40 to-indigo-900/40 rounded-xl p-5 mb-8 border-l-4 border-purple-500">
                            <div class="flex items-start gap-3">
                                <span class="text-2xl">🧠</span>
                                <div>
                                    <h3 class="text-white font-bold text-sm mb-1 uppercase tracking-wider text-purple-300">Viral Strategy Logic</h3>
                                    <p class="text-slate-200 text-sm leading-relaxed">${result.data.viral_logic}</p>
                                </div>
                            </div>
                        </div>
                        ` : ''}

                        <!-- Viral Potential Score -->
                        ${result.data.viral_potential ? `
                        <div class="bg-gradient-to-r from-pink-900/40 to-red-900/40 rounded-xl p-5 mb-8 border-l-4 border-pink-500">
                            <div class="flex items-start gap-4">
                                <div class="bg-pink-500/20 p-3 rounded-full">
                                    <span class="text-3xl">🔥</span>
                                </div>
                                <div>
                                    <h3 class="text-white font-bold text-sm mb-1 uppercase tracking-wider text-pink-300">Viral Potential Score: <span class="text-2xl text-white ml-2">${result.data.viral_potential.score}/100</span></h3>
                                    <p class="text-slate-200 text-sm leading-relaxed">${result.data.viral_potential.reason}</p>
                                </div>
                            </div>
                        </div>
                        ` : ''}

                        <!-- Key Moments -->
                        ${result.data.key_moments && result.data.key_moments.length > 0 ? `
                        <div class="bg-slate-800/50 rounded-xl p-5 mb-8 border border-slate-700">
                            <h3 class="text-white font-bold text-sm mb-4 uppercase tracking-wider text-blue-300 flex items-center gap-2">
                                <span>✂️</span> Key Moments
                            </h3>
                            <div class="space-y-3">
                                ${result.data.key_moments.map(m => `
                                    <div class="flex items-start gap-3 bg-slate-900/50 p-3 rounded-lg border border-slate-700/50">
                                        <span class="font-mono text-blue-400 font-bold text-sm bg-blue-900/30 px-2 py-1 rounded">${m.time}</span>
                                        <p class="text-slate-300 text-sm">${m.description}</p>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        ` : ''}

                        ${titlesHTML}
                        ${thumbnailsHTML}

                        <!-- Timeline Script Section(Integrated)-->
                        <div class="bg-slate-900/50 rounded-2xl p-6 mb-8 border border-orange-500/20">
                            <div class="flex items-center gap-3 mb-4">
                                <span class="text-2xl">📝</span>
                                <div>
                                    <h3 class="text-lg font-bold text-white">타임라인 대본</h3>
                                    <p class="text-sm text-slate-400">나레이션을 Voicevox로 생성하거나 SRT로 다운로드하세요</p>
                                </div>
                            </div>
                            
                            <div class="mb-4">
                                <textarea id="scriptTextarea" rows="10" 
                                    class="w-full px-4 py-3 bg-slate-800 text-white rounded-lg border border-slate-700 focus:border-purple-500 focus:outline-none font-mono" 
                                    placeholder="예시:
[0-3초] 皆さん、こんにちは！
[3-10초] 今日는 재미있는 영상을 소개합니다
[10-15초] 구독 부탁드립니다!">${narrationJapaneseText}</textarea>
                                <p class="text-slate-500 text-sm mt-2">
                                    💡 타임라인 형식으로 입력하거나, 일반 텍스트로 입력하세요
                                </p>
                            </div>

                            <div class="flex gap-3 flex-wrap">
                                <button id="downloadNarrationSrtBtn" 
                                    class="px-5 py-3 bg-purple-600 hover:bg-purple-500 text-white font-bold rounded-xl transition-all shadow-lg hover:shadow-purple-500/25 flex items-center gap-2">
                                    <span>🎙️</span>
                                    <span>나레이션 SRT</span>
                                </button>
                                <button id="downloadDialogueSrtBtn" 
                                    class="px-5 py-3 bg-blue-600 hover:bg-blue-500 text-white font-bold rounded-xl transition-all shadow-lg hover:shadow-blue-500/25 flex items-center gap-2">
                                    <span>💬</span>
                                    <span>원본 대사 SRT</span>
                                </button>
                                <button id="generateNarrationBtn" 
                                    class="px-5 py-3 bg-orange-600 hover:bg-orange-500 text-white font-bold rounded-xl transition-all shadow-lg hover:shadow-orange-500/25 flex items-center gap-2">
                                    <span>🔊</span>
                                    <span>Voicevox 생성</span>
                                </button>
                                <div id="narrationAudioPlayer" class="hidden flex-1 bg-black/40 rounded-xl p-2 border border-orange-500/20">
                                    <audio id="narrationAudio" controls class="w-full h-10"></audio>
                                </div>
                            </div>
                        </div>

                        <div id="unifiedScriptContainer" class="mb-10">
                            ${scriptHTML}
                        </div>
                    </div>
                `;

                // Attach Voicevox generation event listener for narration
                document.getElementById('generateNarrationBtn').addEventListener('click', async () => {
                    if (!window.selectedSpeakerId) {
                        alert('⚠️ Voicevox 캐릭터를 먼저 선택해주세요!\n아래 Voicevox 섹션에서 캐릭터를 선택하세요.');
                        document.getElementById('voicevoxSection')?.scrollIntoView({ behavior: 'smooth' });
                        return;
                    }

                    const btn = document.getElementById('generateNarrationBtn');
                    const originalHTML = btn.innerHTML;
                    btn.innerHTML = '<span>⏳</span><span>생성 중...</span>';
                    btn.disabled = true;

                    // Strip word separators ("/") completely for natural Japanese audio flow
                    // Japanese doesn't use spaces, so we remove "/" without replacement
                    const cleanNarrationText = narrationJapaneseText.replace(/\s*\/\s*/g, '');

                    // Collect Voicevox audio settings from UI
                    const options = {
                        speedScale: parseFloat(document.getElementById('param-speedScale')?.value || 1.0),
                        pitchScale: parseFloat(document.getElementById('param-pitchScale')?.value || 0.0),
                        intonationScale: parseFloat(document.getElementById('param-intonationScale')?.value || 1.0),
                        volumeScale: parseFloat(document.getElementById('param-volumeScale')?.value || 1.0),
                        prePhonemeLength: parseFloat(document.getElementById('param-prePhonemeLength')?.value || 0.1),
                        postPhonemeLength: parseFloat(document.getElementById('param-postPhonemeLength')?.value || 0.1)
                    };

                    try {
                        const response = await fetch('/api/voicevox/generate-tts', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                text: cleanNarrationText,
                                speakerId: window.selectedSpeakerId,
                                options: options
                            })
                        });

                        if (!response.ok) throw new Error('Voicevox 생성 실패');

                        const blob = await response.blob();
                        const url = URL.createObjectURL(blob);

                        const audio = document.getElementById('narrationAudio');
                        audio.src = url;
                        document.getElementById('narrationAudioPlayer').classList.remove('hidden');
                        audio.play();

                        alert('✅ 나레이션 오디오가 생성되었습니다!');
                    } catch (error) {
                        alert('❌ 오류: ' + error.message);
                    } finally {
                        btn.innerHTML = originalHTML;
                        btn.disabled = false;
                    }
                });

                // Helper to generate and download SRT
                const downloadSRT = (type) => {
                    const scriptData = result.data.script || [];
                    let validSegments = [];
                    let filenamePrefix = '';

                    if (type === 'narration') {
                        validSegments = scriptData.filter(s => s.type === 'Narration' && s.text_jp);
                        filenamePrefix = 'Narration';
                    } else if (type === 'dialogue') {
                        validSegments = scriptData.filter(s => s.type === 'Dialogue' && s.text_jp);
                        filenamePrefix = 'Dialogue';
                    }

                    if (validSegments.length === 0) {
                        alert(`⚠️ SRT로 변환할 ${type === 'narration' ? '나레이션' : '대사'}가 없습니다.`);
                        return;
                    }

                    let srtContent = '';
                    validSegments.forEach((seg, idx) => {
                        const index = idx + 1;
                        let startTime = seg.start_time || '00:00';
                        let endTime = seg.end_time || '00:00';

                        // Infer end time if missing
                        if (!seg.end_time && seg.time) {
                            startTime = seg.time;
                        }

                        // Helper to convert MM:SS to HH:MM:SS,mmm
                        const formatTime = (timeStr) => {
                            if (!timeStr) return '00:00:00,000';
                            const parts = timeStr.split(':');
                            const mm = parts[0].padStart(2, '0');
                            const ssPart = parts[1] || '00';
                            const ss = ssPart.split('.')[0].padStart(2, '0');
                            const ms = ssPart.split('.')[1]
                                ? ssPart.split('.')[1].padEnd(3, '0').substring(0, 3)
                                : '000';
                            return `00:${mm}:${ss},${ms} `;
                        };

                        const srtStart = formatTime(startTime);
                        const srtEnd = formatTime(endTime);

                        // CLEAN TEXT: Remove HTML tags, Remove "/", Remove spaces
                        let cleanText = seg.text_jp
                            .replace(/<[^>]*>/g, '')
                            .replace(/\//g, '')
                            .replace(/\s+/g, '')
                            .trim();

                        srtContent += `${index} \n${srtStart} --> ${srtEnd} \n${cleanText} \n\n`;
                    });

                    // Download SRT file with UTF-8 BOM for compatibility
                    const blob = new Blob(['\uFEFF' + srtContent], { type: 'text/plain;charset=utf-8' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `${filenamePrefix}_${new Date().getTime()}.srt`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                };

                // Attach SRT download event listeners
                document.getElementById('downloadNarrationSrtBtn').addEventListener('click', () => downloadSRT('narration'));
                document.getElementById('downloadDialogueSrtBtn').addEventListener('click', () => downloadSRT('dialogue'));

            }

            // Audio Generation Helper
            async function generateProductionAudio(scriptData) {
                if (!window.selectedSpeakerId) {
                    alert('⚠️ Select a Character (Speaker) from the section below first!');
                    document.getElementById('voicevoxSection').scrollIntoView({ behavior: 'smooth' });
                    // Highlight effect
                    const section = document.getElementById('voicevoxSection');
                    section.classList.add('ring-2', 'ring-indigo-500');
                    setTimeout(() => section.classList.remove('ring-2', 'ring-indigo-500'), 2000);
                    return;
                }

                const btn = document.getElementById('prodGenerateAudioBtn');
                const originalText = btn.innerHTML;
                btn.innerHTML = '<span>⏳</span> Generating...';
                btn.disabled = true;

                const jpText = scriptData.map(s => s.text_jp).join(' ');

                try {
                    const response = await fetch('http://localhost:4000/api/voicevox/generate-tts', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            text: jpText,
                            speakerId: window.selectedSpeakerId
                        })
                    });

                    if (!response.ok) throw new Error('TTS Generation Failed');

                    const blob = await response.blob();
                    const url = URL.createObjectURL(blob);

                    const audio = document.getElementById('prodAudio');
                    audio.src = url;
                    document.getElementById('prodAudioPlayer').classList.remove('hidden');
                    audio.play();

                } catch (error) {
                    alert('Error: ' + error.message);
                } finally {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }
            }

            // ========================================
            // AUDIO SETTINGS UI LOGIC
            // ========================================
            document.addEventListener('input', (e) => {
                if (e.target.id && e.target.id.startsWith('param-')) {
                    const paramName = e.target.id.replace('param-', '');
                    const valSpan = document.getElementById('val-' + paramName);
                    if (valSpan) valSpan.textContent = parseFloat(e.target.value).toFixed(2);
                }
            });

            const resetBtn = document.getElementById('resetAudioParamsBtn');
            if (resetBtn) {
                resetBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    const defaults = {
                        speedScale: 1.00,
                        pitchScale: 0.00,
                        intonationScale: 1.00,
                        volumeScale: 1.00,
                        prePhonemeLength: 0.10,
                        postPhonemeLength: 0.10
                    };

                    Object.keys(defaults).forEach(key => {
                        const input = document.getElementById('param-' + key);
                        const label = document.getElementById('val-' + key);
                        if (input) input.value = defaults[key];
                        if (label) label.textContent = defaults[key].toFixed(2);
                    });
                });
            }

        </script>
        <!-- DNA View Modal -->
        <div id="dnaViewModal"
            class="fixed inset-0 bg-black/90 hidden z-[70] flex items-center justify-center backdrop-blur-sm">
            <div class="bg-slate-900 border border-slate-700 rounded-2xl w-full max-w-2xl p-6 shadow-2xl relative">
                <button onclick="document.getElementById('dnaViewModal').classList.add('hidden')"
                    class="absolute top-4 right-4 text-slate-400 hover:text-white transition-colors bg-slate-800 rounded-full w-8 h-8 flex items-center justify-center">✕</button>
                <div class="flex items-center gap-2 mb-1">
                    <span class="text-2xl">🧬</span>
                    <h3 class="text-xl font-bold text-white">Viral Structure DNA</h3>
                </div>
                <p class="text-xs text-slate-400 mb-6 pl-9">Timestamps & Narrative Flow Analysis</p>

                <div id="dnaTimelineContainer" class="space-y-0 max-h-[60vh] overflow-y-auto pr-2 custom-scrollbar">
                    <!-- Injected items -->
                </div>

                <div class="mt-6 pt-4 border-t border-slate-800 flex justify-end">
                    <button onclick="document.getElementById('dnaViewModal').classList.add('hidden')"
                        class="px-5 py-2.5 bg-indigo-600 hover:bg-indigo-500 text-white rounded-lg font-bold text-sm shadow-lg shadow-indigo-500/20 transition-all hover:scale-105">
                        확인 (Close)
                    </button>
                </div>
            </div>
        </div>

        <script>
            // ═══════════════════════════════════════════════════════════════════════════
            // Comment Scraping Functionality (YouTube + Reddit)
            // ═══════════════════════════════════════════════════════════════════════════
            document.getElementById('scrapeCommentsBtn').addEventListener('click', async () => {
                const urlInput = document.getElementById('commentUrlInput');
                const commentsTextarea = document.getElementById('videoComments');
                const btn = document.getElementById('scrapeCommentsBtn');
                const url = urlInput.value.trim();

                if (!url) {
                    alert('URL을 입력해주세요');
                    return;
                }

                // Detect platform
                const isReddit = url.includes('reddit.com') || url.includes('v.redd.it');
                const isYouTube = url.includes('youtube.com') || url.includes('youtu.be');

                if (!isReddit && !isYouTube) {
                    alert('YouTube 또는 Reddit URL만 지원합니다');
                    return;
                }

                // Update button state
                btn.disabled = true;
                btn.innerHTML = '<span>⏳ 댓글 가져오는 중...</span>';

                try {
                    if (isReddit) {
                        await scrapeRedditComments(url, commentsTextarea);
                    } else if (isYouTube) {
                        alert('YouTube 댓글 가져오기는 아직 구현되지 않았습니다.\n현재는 Reddit URL만 지원합니다.');
                    }
                } catch (error) {
                    console.error('Comment scraping error:', error);
                    alert('댓글 가져오기 실패: ' + error.message);
                } finally {
                    // Restore button
                    btn.disabled = false;
                    btn.innerHTML = '<span>🌐 댓글 가져오기</span>';
                }
            });

            async function scrapeRedditComments(url, textarea) {
                const response = await fetch(`http://localhost:4000/api/reddit/comments?url=${encodeURIComponent(url)}`);

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Reddit API 호출 실패');
                }

                const data = await response.json();

                if (!data.success || !data.comments) {
                    throw new Error('댓글 데이터를 가져올 수 없습니다');
                }

                // Format comments for textarea
                const formattedComments = data.comments
                    .slice(0, 50) // Limit to top 50 comments
                    .map(comment => {
                        const indent = '  '.repeat(comment.depth);
                        return `${indent}[${comment.score}↑] ${comment.author}: ${comment.text}`;
                    })
                    .join('\n\n');

                textarea.value = formattedComments;

                // Show success message
                alert(`✅ Reddit 댓글 ${data.comments.length}개를 가져왔습니다!\n게시물: ${data.post.title}`);
            }
        </script>
</body>


</html>
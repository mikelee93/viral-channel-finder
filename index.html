<!DOCTYPE html>
<html lang="ko" class="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="referrer" content="no-referrer">
    <title>YouTube Viral Finder & AI Analyzer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="hot_channels_v3.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://unpkg.com/marked@4.0.0/marked.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        brand: {
                            50: '#f0f9ff',
                            100: '#e0f2fe',
                            500: '#0ea5e9',
                            600: '#0284c7',
                            700: '#0369a1',
                            900: '#0c4a6e',
                        },
                        accent: {
                            400: '#a78bfa',
                            500: '#8b5cf6',
                            600: '#7c3aed',
                        }
                    },
                    animation: {
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    }
                }
            }
        }

        // --- Global Variables ---
        let scriptGenPlatform = '';

        // === HOT Channel Finder Variables ===
        let selectedCategories = [];
        let selectedCountry = 'KR';

        const CHANNEL_CATEGORIES = [
            { id: 'entertainment', name: 'ì—”í„°í…Œì¸ë¨¼íŠ¸', icon: 'ğŸ¬' },
            { id: 'game', name: 'ê²Œì„/eìŠ¤í¬ì¸ ', icon: 'ğŸ®' },
            { id: 'vlog', name: 'ì¼ìƒ/ë¸Œì´ë¡œê·¸', icon: 'ğŸ“¹' },
            { id: 'food', name: 'ìŒì‹/ë¨¹ë°©', icon: 'ğŸœ' },
            { id: 'beauty', name: 'ë·°í‹°/ë©”ì´í¬ì—…', icon: 'ğŸ’„' },
            { id: 'sports', name: 'ìŠ¤í¬ì¸ ', icon: 'âš½' },
            { id: 'music', name: 'ìŒì•…', icon: 'ğŸµ' },
            { id: 'education', name: 'êµìœ¡', icon: 'ğŸ“š' },
            { id: 'tech', name: 'ê³¼í•™/ê¸°ìˆ ', icon: 'ğŸ’»' },
            { id: 'news', name: 'ë‰´ìŠ¤/ì •ì¹˜', icon: 'ğŸ“°' }
        ];

        // === Tab Switching Function ===
        function switchTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
            });

            // Remove active class from all tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('font-bold', 'text-brand-400', 'border-brand-500', 'bg-brand-500/10');
                btn.classList.add('font-medium', 'text-slate-400', 'border-transparent');
            });

            // Show selected tab content
            const selectedContent = document.getElementById(`content-${tabName}`);
            if (selectedContent) {
                selectedContent.classList.remove('hidden');
            }

            // Highlight selected tab button
            const selectedBtn = document.getElementById(`tab-${tabName}`);
            if (selectedBtn) {
                selectedBtn.classList.remove('font-medium', 'text-slate-400', 'border-transparent');
                selectedBtn.classList.add('font-bold', 'text-brand-400', 'border-brand-500', 'bg-brand-500/10');
            }
        }

        // === Initialize Category Buttons ===
        function initializeCategoryButtons() {
            const container = document.getElementById('categoryButtons');
            if (!container) return;

            // Add 'All' category at the beginning
            const categories = [{ id: 'all', name: 'ì „ì²´', icon: 'ğŸŒŸ' }, ...CHANNEL_CATEGORIES];

            container.innerHTML = categories.map(cat => `
                <button onclick="toggleCategory('${cat.id}')" 
                        id="cat-btn-${cat.id}"
                        data-category="${cat.id}"
                        class="category-btn flex items-center gap-2 px-4 py-2.5 rounded-full bg-slate-800/80 hover:bg-slate-700 text-slate-300 hover:text-white transition-all border border-slate-700 whitespace-nowrap ${cat.id === 'all' ? 'border-brand-500 bg-brand-500/10 text-brand-400 font-bold' : ''}">
                    <span class="text-lg">${cat.icon}</span>
                    <span class="text-sm font-medium">${cat.name}</span>
                </button>
            `).join('');

            // Set 'all' as selected by default if empty
            if (selectedCategories.length === 0) {
                selectedCategories = ['all'];
            }
        }

        // === Toggle Category Selection ===
        function toggleCategory(categoryId) {
            const btns = document.querySelectorAll('.category-btn');

            if (categoryId === 'all') {
                selectedCategories = ['all'];
                btns.forEach(btn => {
                    btn.classList.remove('border-brand-500', 'bg-brand-500/10', 'text-brand-400', 'font-bold');
                    btn.classList.add('border-slate-700', 'bg-slate-800/80', 'text-slate-300');
                });
                const allBtn = document.getElementById('cat-btn-all');
                if (allBtn) {
                    allBtn.classList.add('border-brand-500', 'bg-brand-500/10', 'text-brand-400', 'font-bold');
                    allBtn.classList.remove('border-slate-700', 'bg-slate-800/80', 'text-slate-300');
                }
            } else {
                // Remove 'all' if selected
                const allIdx = selectedCategories.indexOf('all');
                if (allIdx > -1) {
                    selectedCategories.splice(allIdx, 1);
                    const allBtn = document.getElementById('cat-btn-all');
                    if (allBtn) {
                        allBtn.classList.remove('border-brand-500', 'bg-brand-500/10', 'text-brand-400', 'font-bold');
                        allBtn.classList.add('border-slate-700', 'bg-slate-800/80', 'text-slate-300');
                    }
                }

                const btn = document.getElementById(`cat-btn-${categoryId}`);
                const index = selectedCategories.indexOf(categoryId);

                if (index > -1) {
                    selectedCategories.splice(index, 1);
                    if (btn) {
                        btn.classList.remove('border-brand-500', 'bg-brand-500/10', 'text-brand-400', 'font-bold');
                        btn.classList.add('border-slate-700', 'bg-slate-800/80', 'text-slate-300');
                    }

                    // If none selected, default back to all
                    if (selectedCategories.length === 0) {
                        toggleCategory('all');
                    }
                } else {
                    selectedCategories.push(categoryId);
                    if (btn) {
                        btn.classList.add('border-brand-500', 'bg-brand-500/10', 'text-brand-400', 'font-bold');
                        btn.classList.remove('border-slate-700', 'bg-slate-800/80', 'text-slate-300');
                    }
                }
            }
        }



        // === Toggle Advanced Filters ===
        function toggleAdvancedFilters() {
            const filters = document.getElementById('advancedFilters');
            if (filters) {
                filters.classList.toggle('hidden');
            }
        }

        // === Get Selected Country ===
        function getSelectedCountry() {
            return selectedCountry;
        }

        // === Country Button Click Handler ===
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize category buttons
            initializeCategoryButtons();

            // Setup tab click handlers
            document.getElementById('tab-video-search')?.addEventListener('click', () => switchTab('video-search'));
            document.getElementById('tab-channel-finder')?.addEventListener('click', () => switchTab('channel-finder'));

            // Setup country button handlers
            document.querySelectorAll('.country-btn').forEach(btn => {
                btn.addEventListener('click', function () {
                    // Remove active state from all country buttons
                    document.querySelectorAll('.country-btn').forEach(b => {
                        b.classList.remove('bg-brand-600', 'text-white');
                        b.classList.add('bg-slate-700', 'text-slate-300');
                    });

                    // Add active state to clicked button
                    this.classList.remove('bg-slate-700', 'text-slate-300');
                    this.classList.add('bg-brand-600', 'text-white');

                    // Update selected country
                    selectedCountry = this.getAttribute('data-country');
                });
            });
        });

        // === Search Channels Function ===
        async function searchChannels() {
            if (selectedCategories.length === 0) {
                alert('ìµœì†Œ 1ê°œ ì´ìƒì˜ ì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }

            const subscriberMin = document.getElementById('channelSubMin')?.value || 0;
            const subscriberMax = document.getElementById('channelSubMax')?.value || 10000000;
            const viewPeriod = document.getElementById('channelViewPeriod')?.value || '7days';
            const country = document.getElementById('channelCountry')?.value || 'all';
            const sortBy = document.getElementById('channelSortBy')?.value || 'daily_views';
            const q = document.getElementById('channelSearchInput')?.value || '';

            const resultsDiv = document.getElementById('channelResults');
            const gridDiv = document.getElementById('channelResultsGrid');

            if (resultsDiv) resultsDiv.classList.remove('hidden');
            if (gridDiv) {
                gridDiv.innerHTML = `
                    <div class="col-span-full flex flex-col items-center justify-center py-20">
                        <div class="loader w-12 h-12 border-4 border-t-brand-500 mb-4"></div>
                        <p class="text-slate-400 animate-pulse font-medium text-lg">ë°ì´í„° ë¶„ì„ ì—”ì§„ ê°€ë™ ì¤‘...</p>
                        <p class="text-slate-500 text-sm mt-2">ì±„ë„ í™œë™ì„±ê³¼ ìˆ˜ìµì„±ì„ ê³„ì‚°í•˜ê³  ìˆìŠµë‹ˆë‹¤.</p>
                    </div>
                `;
            }

            try {
                const response = await fetch('http://localhost:4000/api/search-channels', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        categories: selectedCategories,
                        subscriberMin: parseInt(subscriberMin),
                        subscriberMax: parseInt(subscriberMax),
                        viewPeriod,
                        country,
                        sortBy,
                        q
                    })
                });

                const data = await response.json();

                if (!response.ok) throw new Error(data.error || 'ê²€ìƒ‰ ì‹¤íŒ¨');

                renderChannelCards(data.channels || []);

                const countEl = document.getElementById('channelCount');
                if (countEl) countEl.textContent = `(${(data.count || 0).toLocaleString()}ê°œ ì±„ë„)`;

            } catch (error) {
                console.error('Channel search error:', error);
                if (gridDiv) {
                    gridDiv.innerHTML = `
                        <div class="col-span-full text-center py-20 bg-slate-800/50 rounded-2xl border border-dashed border-slate-700">
                            <div class="bg-red-500/10 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
                                <span class="text-3xl text-red-500">âš ï¸</span>
                            </div>
                            <p class="text-red-400 font-bold text-lg">ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ ë°œìƒ</p>
                            <p class="text-slate-500 mt-2">${error.message}</p>
                            <button onclick="searchChannels()" class="mt-6 px-6 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded-lg transition">ë‹¤ì‹œ ì‹œë„í•˜ê¸°</button>
                        </div>
                    `;
                }
            }
        }

        // === Render Channel Cards ===
        function renderChannelCards(channels) {
            const gridDiv = document.getElementById('channelResultsGrid');
            if (!gridDiv) return;

            if (channels.length === 0) {
                gridDiv.innerHTML = `
                    <div class="col-span-full text-center py-20">
                        <p class="text-slate-400 text-lg">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
                        <p class="text-slate-500 mt-2">í•„í„° ì¡°ê±´ì„ ì™„í™”í•˜ì‹œê±°ë‚˜ ë‹¤ë¥¸ ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•´ë³´ì„¸ìš”.</p>
                    </div>
                `;
                return;
            }

            gridDiv.innerHTML = channels.map(channel => {
                // Calculate estimated revenue
                // Estimated revenue: views / 1000 * 200 KRW
                const dailyViews = channel.dailyViewGrowth || 0;
                const monthlyViews = dailyViews * 30;
                const dailyRevenue = (dailyViews / 1000) * 200;
                const monthlyRevenue = dailyRevenue * 30;

                return `
                <div class="bg-slate-800/40 border border-slate-700/50 hover:border-brand-500/50 rounded-2xl p-5 transition-all hover:transform hover:-translate-y-1 group relative overflow-hidden">
                    <div class="absolute top-0 right-0 p-3 flex gap-1">
                        ${channel.isSocialTiktok ? '<span class="w-5 h-5 bg-white/10 rounded-full flex items-center justify-center text-[10px]" title="Tiktok">ğŸµ</span>' : ''}
                        ${channel.isSocialInsta ? '<span class="w-5 h-5 bg-white/10 rounded-full flex items-center justify-center text-[10px]" title="Instagram">ğŸ“¸</span>' : ''}
                        ${channel.isSocialNaver ? '<span class="w-5 h-5 bg-white/10 rounded-full flex items-center justify-center text-[10px]" title="Naver">N</span>' : ''}
                    </div>
                    
                    <div class="flex items-center gap-4 mb-6">
                        <img src="${channel.channelThumbnail}" class="w-16 h-16 rounded-full border-2 border-slate-700 group-hover:border-brand-500 transition-colors" alt="${channel.channelTitle}">
                        <div class="flex-1 min-w-0">
                            <h3 class="font-bold text-slate-100 truncate text-lg group-hover:text-brand-400 transition-colors" title="${channel.channelTitle}">${channel.channelTitle}</h3>
                            <div class="flex items-center gap-2 text-sm text-slate-400 mt-1">
                                <span class="bg-slate-700/50 px-2 py-0.5 rounded text-xs">êµ¬ë…ì ${formatCompactNumber(channel.subscriberCount)}</span>
                                <span class="bg-brand-500/10 text-brand-400 px-2 py-0.5 rounded text-xs font-bold">TOP ${channel.categoryRank || '-'}ìœ„</span>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-3 mb-6">
                        <div class="bg-slate-900/50 p-3 rounded-xl border border-slate-700/30">
                            <p class="text-[10px] text-slate-500 uppercase tracking-wider mb-1">ì¼ í‰ê·  ì¡°íšŒìˆ˜</p>
                            <p class="text-brand-400 font-bold text-lg">+${formatCompactNumber(dailyViews)}</p>
                            <p class="text-[10px] text-slate-400 mt-1">ì›” ì˜ˆìƒ: ${formatCompactNumber(monthlyViews)}</p>
                        </div>
                        <div class="bg-slate-900/50 p-3 rounded-xl border border-slate-700/30">
                            <p class="text-[10px] text-slate-500 uppercase tracking-wider mb-1">ì›” ì˜ˆìƒ ìˆ˜ìµ</p>
                            <p class="text-orange-400 font-bold text-lg">â‚©${(monthlyRevenue / 10000).toFixed(0)}ë§Œ</p>
                            <p class="text-[10px] text-slate-400 mt-1">1000ë·° ë‹¹ 200ì›</p>
                        </div>
                    </div>

                    <div class="flex gap-2">
                        <button onclick="openChannelModal('${channel.channelId}')" class="flex-1 bg-brand-600 hover:bg-brand-500 text-white py-2.5 rounded-xl text-sm font-bold transition-all shadow-lg shadow-brand-900/20 active:scale-95">
                            ë¶„ì„ ë¦¬í¬íŠ¸
                        </button>
                        <a href="https://youtube.com/channel/${channel.channelId}" target="_blank" class="w-11 h-11 flex items-center justify-center bg-slate-700 hover:bg-slate-600 text-white rounded-xl transition-all active:scale-95">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z"/></svg>
                        </a>
                    </div>
                </div>
                `;
            }).join('');
        }

        // === Trending Videos Functions ===
        async function loadTrendingVideos() {
            const country = document.getElementById('channelCountry')?.value || 'KR';
            const filter = window.currentTrendingFilter || 'all';
            const tableBody = document.getElementById('trendingVideosTableBody');

            if (!tableBody) return;

            tableBody.innerHTML = `
                <tr>
                    <td colspan="7" class="py-20 text-center">
                        <div class="flex flex-col items-center">
                            <div class="loader w-10 h-10 border-4 border-t-orange-500 mb-4"></div>
                            <p class="text-slate-400 animate-pulse font-medium">ì¸ê¸° ê¸‰ìƒìŠ¹ ë°ì´í„° ìˆ˜ì§‘ ì¤‘...</p>
                        </div>
                    </td>
                </tr>
            `;

            try {
                const response = await fetch(`http://localhost:4000/api/trending?country=${country}&filter=${filter}`);
                const data = await response.json();

                if (!response.ok) throw new Error(data.error || 'Trending fetch failed');

                renderTrendingVideos(data.videos || []);

            } catch (error) {
                console.error('Trending error:', error);
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="7" class="py-20 text-center text-red-400 bg-red-400/5">
                            ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. (${error.message})
                        </td>
                    </tr>
                `;
            }
        }

        function renderTrendingVideos(videos) {
            const tableBody = document.getElementById('trendingVideosTableBody');
            if (!tableBody) return;

            if (videos.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="7" class="py-20 text-center text-slate-500">
                            í•´ë‹¹ ì¡°ê±´ì˜ ì¸ê¸° ê¸‰ìƒìŠ¹ ì˜ìƒì´ ì—†ìŠµë‹ˆë‹¤.
                        </td>
                    </tr>
                `;
                return;
            }

            tableBody.innerHTML = videos.map((video, index) => {
                const views = formatCompactNumber(video.viewCount);
                const published = timeAgo(video.publishedAt);

                return `
                <tr class="border-b border-slate-700/50 hover:bg-slate-700/20 transition-colors group">
                    <td class="py-4 pl-4 text-slate-500 font-bold group-hover:text-brand-400 transition-colors">${index + 1}</td>
                    <td class="py-4 px-2">
                        <div class="flex gap-4">
                            <div class="relative w-32 aspect-video rounded-lg overflow-hidden flex-shrink-0 group-hover:ring-2 ring-brand-500 transition-all">
                                <img src="${video.thumbnail}" class="w-full h-full object-cover">
                                <span class="absolute bottom-1 right-1 bg-black/80 text-[10px] text-white px-1.5 py-0.5 rounded font-bold">${video.duration}</span>
                            </div>
                            <div class="flex-1 min-w-0 py-1">
                                <p class="text-slate-100 font-bold line-clamp-2 leading-tight group-hover:text-brand-400 transition-colors mb-1" title="${video.title}">${video.title}</p>
                                <p class="text-xs text-slate-400 flex items-center gap-2">
                                    <span class="hover:text-white transition-colors cursor-pointer">${video.channelTitle}</span>
                                    <span class="w-1 h-1 bg-slate-600 rounded-full"></span>
                                    <span>${published}</span>
                                </p>
                            </div>
                        </div>
                    </td>
                    <td class="py-4 px-2 text-slate-300 font-medium">${views}</td>
                    <td class="py-4 px-2">
                        <span class="text-orange-400 font-bold">+${formatCompactNumber(video.hourlyViews)}/h</span>
                    </td>
                    <td class="py-4 px-2 text-brand-400 font-bold">${video.vpi || '-'}</td>
                    <td class="py-4 px-2 text-slate-400 text-xs">${video.tags?.slice(0, 2).join(', ') || '-'}</td>
                    <td class="py-4 pr-4 text-right">
                        <button onclick="analyzeViralVideo('${video.videoId}')" class="bg-slate-700 hover:bg-brand-600 text-white px-3 py-1.5 rounded-lg text-xs font-bold transition-all whitespace-nowrap active:scale-95">ë¶„ì„í•˜ê¸°</button>
                    </td>
                </tr>
                `;
            }).join('');
        }

        function switchTrendingFilter(filter) {
            window.currentTrendingFilter = filter;
            const btns = document.querySelectorAll('.trending-filter-btn');
            btns.forEach(btn => {
                if (btn.getAttribute('onclick').includes(filter)) {
                    btn.classList.add('bg-brand-500', 'text-white');
                    btn.classList.remove('bg-slate-700', 'text-slate-300');
                } else {
                    btn.classList.remove('bg-brand-500', 'text-white');
                    btn.classList.add('bg-slate-700', 'text-slate-300');
                }
            });
            loadTrendingVideos();
        }

        // === Helper: Format Compact Number (e.g., 1.2M, 3.4K) ===
        function formatCompactNumber(num) {
            const n = parseInt(num);
            if (isNaN(n)) return '0';

            // For Korean style: ì–µ(100M), ë§Œ(10K)
            if (n >= 100000000) return (n / 100000000).toFixed(1) + 'ì–µ';
            if (n >= 10000) return (n / 10000).toFixed(1) + 'ë§Œ';
            if (n >= 1000) return (n / 1000).toFixed(1) + 'ì²œ';

            return n.toLocaleString();
        }

        // === Helper: Time Ago ===
        function timeAgo(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const seconds = Math.floor((now - date) / 1000);

            let interval = Math.floor(seconds / 31536000);
            if (interval >= 1) return interval + "ë…„ ì „";
            interval = Math.floor(seconds / 2592000);
            if (interval >= 1) return interval + "ë‹¬ ì „";
            interval = Math.floor(seconds / 86400);
            if (interval >= 1) return interval + "ì¼ ì „";
            interval = Math.floor(seconds / 3600);
            if (interval >= 1) return interval + "ì‹œê°„ ì „";
            interval = Math.floor(seconds / 60);
            if (interval >= 1) return interval + "ë¶„ ì „";
            return Math.floor(seconds) + "ì´ˆ ì „";
        }

        // === Escape HTML ===
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // === Format Number Helper (Legacy) ===
        function formatNumber(num) {
            const n = parseInt(num);
            if (isNaN(n)) return '0';
            return n.toLocaleString();
        }

        // Ensure formatCompactNumber is also available globally if needed
        window.formatCompactNumber = formatCompactNumber;
        window.timeAgo = timeAgo;

        // === Open Channel Modal (Shows Recent Videos) ===
        async function openChannelModal(channelId, channelName) {
            openModal();

            const modalContent = document.getElementById('modalContent');

            modalContent.innerHTML = `
                <div class="flex items-center justify-center py-8">
                    <div class="loader"></div>
                    <p class="ml-4 text-brand-400">${escapeHtml(channelName)}ì˜ ìµœê·¼ ì˜ìƒì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
                </div>
            `;

            try {
                const response = await fetch('http://localhost:4000/api/channel-videos', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ channelId, maxResults: 20 })
                });

                const data = await response.json();

                if (!response.ok) throw new Error(data.error || 'ì˜ìƒ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨');

                modalContent.innerHTML = `
                    <div class="space-y-4">
                        <h3 class="text-xl font-bold text-white mb-4">
                            ${escapeHtml(channelName)} - ìµœê·¼ ì˜ìƒ
                        </h3>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 max-h-[600px] overflow-y-auto">
                            ${(data.videos || []).map(video => `
                                <div class="bg-slate-800/50 rounded-lg p-3 hover:bg-slate-700/50 transition cursor-pointer"
                                     onclick="reprocessVideo('${video.id.videoId}', '${escapeHtml(video.snippet.title).replace(/'/g, "\\'")}')">
                                    <img src="${video.snippet.thumbnails.medium.url}" 
                                         class="w-full rounded mb-2"
                                         alt="${escapeHtml(video.snippet.title)}">
                                    <h4 class="text-sm font-bold text-white line-clamp-2 mb-1">
                                        ${escapeHtml(video.snippet.title)}
                                    </h4>
                                    <p class="text-xs text-slate-400">
                                        ${new Date(video.snippet.publishedAt).toLocaleDateString()}
                                    </p>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;

            } catch (error) {
                console.error('Channel videos error:', error);
                modalContent.innerHTML = `
                    <div class="text-center py-8">
                        <p class="text-red-400">ì˜ìƒ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤: ${error.message}</p>
                    </div>
                `;
            }
        }

        async function searchManualChannel() {
            const input = document.getElementById('manualChannelInput');
            const channelName = input.value.trim();

            if (!channelName) {
                alert('ì±„ë„ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            // Show loading
            const outputDiv = document.getElementById('ocrOutput');
            outputDiv.innerHTML = `
                <div class="flex items-center justify-center py-12">
                    <div class="loader w-12 h-12 border-4 border-t-purple-500"></div>
                    <p class="ml-4 text-slate-300">ê²€ìƒ‰ ì¤‘...</p>
                </div>
            `;

            try {
                // Remove @ if present
                const cleanName = channelName.replace('@', '');

                // Use server endpoint (already has YouTube API key)
                const response = await fetch('http://localhost:4000/api/ocr-source', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        detectedText: cleanName,
                        manualSearch: true
                    })
                });

                const data = await response.json();

                if (!response.ok || !data.channelName) {
                    outputDiv.innerHTML = `
                        <div class="text-center py-8">
                            <p class="text-lg text-red-400 mb-2">âŒ "${channelName}" ê²€ìƒ‰ ì‹¤íŒ¨</p>
                            <p class="text-sm text-slate-500">ì±„ë„ëª…ì„ í™•ì¸í•˜ê±°ë‚˜ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.</p>
                        </div>
                    `;
                    return;
                }

                // Display results
                displayOCRResults(data);

            } catch (error) {
                console.error('Manual search error:', error);
                outputDiv.innerHTML = `
                    <div class="text-center py-8">
                        <p class="text-lg text-red-400 mb-2">ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ ë°œìƒ</p>
                        <p class="text-sm text-slate-500">${error.message}</p>
                        <p class="text-xs text-slate-600 mt-2">ì„œë²„ê°€ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.</p>
                    </div>
                `;
            }
        }

        async function reprocessVideo(videoId, videoTitle) {
            // ëŒ“ê¸€ + ìë§‰ ë°ì´í„° ì¶”ì¶œ ëª¨ë‹¬ ì—´ê¸°
            openModal();

            const modalContent = document.getElementById('modalContent');

            // ë¡œë”© ìƒíƒœ í‘œì‹œ
            modalContent.innerHTML = `
                <div class="flex flex-col items-center justify-center py-12 space-y-4">
                    <div class="loader w-12 h-12 border-4 border-t-brand-500"></div>
                    <p class="text-brand-400 animate-pulse">ëŒ“ê¸€ê³¼ ìë§‰ì„ ë¶„ì„í•˜ëŠ” ì¤‘...</p>
                    <p class="text-sm text-slate-500">${videoTitle}</p>
                </div>
            `;

            try {
                // 1. ëŒ“ê¸€ ê°€ì ¸ì˜¤ê¸°
                const commentsUrl = `https://www.googleapis.com/youtube/v3/commentThreads?part=snippet&videoId=${videoId}&maxResults=50&order=relevance&textFormat=plainText&key=${YOUTUBE_API_KEY}`;
                const commentsRes = await fetch(commentsUrl);
                const commentsData = await commentsRes.json();

                const comments = commentsData.items && commentsData.items.length > 0
                    ? commentsData.items.map(item => item.snippet.topLevelComment.snippet.textDisplay).join('\n- ')
                    : 'ëŒ“ê¸€ ì—†ìŒ';

                // 2. ìë§‰ ê°€ì ¸ì˜¤ê¸°
                let transcript = 'ìë§‰ ì—†ìŒ';
                try {
                    const transcriptRes = await fetch('http://localhost:4000/api/get-transcript', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ videoId: videoId })
                    });
                    const transcriptData = await transcriptRes.json();

                    if (transcriptRes.ok && transcriptData.success) {
                        transcript = transcriptData.transcript;
                    }
                } catch (e) {
                    console.warn('ìë§‰ ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨:', e);
                }

                // 3. ëª¨ë‹¬ì— ë°ì´í„° í‘œì‹œ
                modalContent.innerHTML = `
                    <div class="space-y-6">
                        <div class="bg-slate-800/50 rounded-xl p-4 border border-slate-700">
                            <h4 class="text-lg font-bold text-white mb-2">ğŸ“¹ ì˜ìƒ ì œëª©</h4>
                            <p class="text-slate-300">${escapeHtml(videoTitle)}</p>
                        </div>
                        
                        <div class="bg-slate-800/50 rounded-xl p-4 border border-slate-700">
                            <h4 class="text-lg font-bold text-white mb-2">ğŸ’¬ ì‹œì²­ì ëŒ“ê¸€ (Top 50)</h4>
                            <div class="max-h-60 overflow-y-auto bg-slate-900/50 rounded-lg p-4">
                                <textarea id="commentsText" class="w-full bg-transparent text-sm text-slate-300 outline-none resize-none whitespace-pre-wrap" rows="8" placeholder="ëŒ“ê¸€ì„ ë¶™ì—¬ë„£ê±°ë‚˜ ìˆ˜ë™ìœ¼ë¡œ ì…ë ¥í•˜ì„¸ìš”...">- ${escapeHtml(comments)}</textarea>
                            </div>
                        </div>
                        
                        <div class="bg-slate-800/50 rounded-xl p-4 border border-slate-700">
                            <h4 class="text-lg font-bold text-white mb-3">ğŸ“ ì˜ìƒ ìë§‰ (Transcript)</h4>
                            <div class="flex gap-2 mb-3">
                                <select id="aiProvider" class="flex-1 bg-slate-700 border border-slate-600 rounded-lg px-3 py-2 text-white text-sm">
                                    <option value="gemini">Gemini 2.5 Flash</option>
                                    <option value="claude">Claude Sonnet 4.5</option>
                                </select>
                                <select id="scriptStyle" class="flex-1 bg-slate-700 border border-slate-600 rounded-lg px-3 py-2 text-white text-sm">
                                    <option value="viral_shorts">ğŸ”¥ ë°”ì´ëŸ´ Shorts (500-800ì)</option>
                                    <option value="viral_shorts_reverse">ğŸ”„ ë°”ì´ëŸ´ Shorts ì—­ìˆœ</option>
                                    <option value="viral_shorts_loop">ğŸ” ë°”ì´ëŸ´ Shorts ë¬´í•œ ë£¨í”„</option>
                                    <option value="humor">ğŸ˜‚ ìœ ë¨¸ (ë°˜ì „ ì½”ë¯¸ë””)</option>
                                    <option value="senior_shorts_drama">ğŸ‘´ ì‹œë‹ˆì–´ ì‚¬ì—° Shorts</option>
                                    <option value="senior_shorts_drama_reverse">ğŸ”„ ì‹œë‹ˆì–´ ì‚¬ì—° ì—­ìˆœ</option>
                                    <option value="senior_shorts_drama_thirdperson">ğŸ‘ï¸ ì‹œë‹ˆì–´ ì‚¬ì—° 3ì¸ì¹­</option>
                                    <option value="senior_shorts_drama_detail">âœ¨ ì‹œë‹ˆì–´ ì‚¬ì—° ë””í…Œì¼</option>
                                </select>
                                <button onclick="generateScriptFromModal('${videoId}', '${escapeHtml(videoTitle).replace(/'/g, "\\'")}')" 
                                    class="bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-500 hover:to-pink-500 text-white font-bold px-6 py-2 rounded-lg transition">
                                    ëŒ€ë³¸ ì¬ì‘ì„±
                                </button>
                            </div>
                            <!-- Viral Pattern Toggle -->
                            <div class="flex items-center gap-2 mb-3 px-1">
                                <input type="checkbox" id="useViralPatterns" class="w-4 h-4 text-emerald-600 bg-slate-700 border-slate-600 rounded focus:ring-emerald-500 focus:ring-2" checked>
                                <label for="useViralPatterns" class="text-sm text-emerald-400 font-bold cursor-pointer select-none flex items-center gap-2">
                                    <span>ğŸ§¬</span> í•™ìŠµëœ ë°”ì´ëŸ´ íŒ¨í„´ ì ìš© (Analyzed Patterns)
                                </label>
                            </div>
                                </button>
                                <button onclick="analyzeAndSaveViral()" 
                                    class="bg-gradient-to-r from-emerald-600 to-teal-600 hover:from-emerald-500 hover:to-teal-500 text-white font-bold px-6 py-2 rounded-lg transition flex items-center gap-2">
                                    <span>ğŸ§¬</span>
                                    <span>ë°”ì´ëŸ´ ë¶„ì„ & ì €ì¥</span>
                                </button>
                            </div>
                            <!-- Viral Analysis Result Area -->
                            <div id="viralAnalysisResult" class="hidden mb-4 p-4 bg-emerald-900/20 border border-emerald-500/30 rounded-lg"></div>
                            <div class="max-h-96 overflow-y-auto bg-slate-900/50 rounded-lg p-4">
                                <textarea id="transcriptText" class="w-full bg-transparent text-sm text-slate-300 outline-none resize-none" rows="15">${escapeHtml(transcript)}</textarea>
                            </div>
                        </div>
                        
                        <div id="rewriteResult" class="hidden bg-slate-800/50 rounded-xl p-4 border border-slate-700">
                            <h4 class="text-lg font-bold text-white mb-3">âœ¨ ì¬ì‘ì„±ëœ ëŒ€ë³¸</h4>
                            <div id="rewriteContent" class="bg-slate-900/50 rounded-lg p-4"></div>
                        </div>
                    </div>
                `;

                // Store data globally for script generation
                window.currentVideoId = videoId;
                window.currentVideoTitle = videoTitle;
                window.currentComments = comments;
                window.currentTranscript = transcript;

            } catch (error) {
                console.error('ë°ì´í„° ë¡œë“œ ì—ëŸ¬:', error);
                modalContent.innerHTML = `
                    <div class="text-center py-12">
                        <p class="text-red-400 font-bold text-lg mb-2">âŒ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨</p>
                        <p class="text-slate-400">${error.message}</p>
                    </div>
                `;
            }
        }

        // ëª¨ë‹¬ì—ì„œ ëŒ€ë³¸ ìƒì„± í•¨ìˆ˜
        async function generateScriptFromModal(videoId, videoTitle) {
            const aiProvider = document.getElementById('aiProvider').value;
            const style = document.getElementById('scriptStyle').value;
            const useViralPatterns = document.getElementById('useViralPatterns')?.checked || false;
            const transcriptText = document.getElementById('transcriptText').value;
            const commentsText = document.getElementById('commentsText')?.value || ''; // Read from textarea
            const resultDiv = document.getElementById('rewriteResult');
            const resultContent = document.getElementById('rewriteContent');

            resultDiv.classList.remove('hidden');
            resultContent.innerHTML = `
                <div class="flex items-center justify-center py-8 space-y-4">
                    <div class="loader w-8 h-8 border-4 border-t-brand-500"></div>
                    <p class="ml-4 text-brand-400 animate-pulse">ëŒ€ë³¸ì„ ì¬ì‘ì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤...</p>
                </div>
            `;

            try {
                const response = await fetch('http://localhost:4000/api/transcript-rewrite', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        videoId: videoId,
                        videoTitle: videoTitle,
                        comments: commentsText, // Use textarea value
                        transcript: transcriptText,
                        style: style,
                        aiProvider: aiProvider,
                        useViralPatterns: useViralPatterns
                    })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'ëŒ€ë³¸ ìƒì„± ì‹¤íŒ¨');
                }

                // í•œêµ­ì–´ ëŒ€ë³¸ ì €ì¥ (ì¼ë³¸ì–´ ë²ˆì—­ì— ì‚¬ìš©)
                window.currentKoreanScript = data.scriptMarkdown;

                resultContent.innerHTML = `
                    <div class="space-y-4">
                        <pre class="whitespace-pre-wrap font-sans text-slate-300">${data.scriptMarkdown}</pre>
                        <button onclick="translateToJapanese()"
                            class="w-full bg-gradient-to-r from-red-600 to-orange-600 hover:from-red-500 hover:to-orange-500 text-white font-bold py-3 px-6 rounded-lg shadow-lg transform transition hover:scale-[1.02] flex items-center justify-center gap-2">
                            <span class="text-xl">ğŸ‡¯ğŸ‡µ</span>
                            <span>ì¼ë³¸ì–´ë¡œ ë²ˆì—­ (ì œëª© + í¸ì§‘ ê°€ì´ë“œ í¬í•¨)</span>
                        </button>
                        <div id="japaneseTranslation" class="hidden mt-6"></div>
                    </div>
                `;

            } catch (error) {
                console.error('ëŒ€ë³¸ ìƒì„± ì—ëŸ¬:', error);
                resultContent.innerHTML = `
                    <div class="text-center py-4">
                        <p class="text-red-400">ëŒ€ë³¸ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}</p>
                    </div>
                `;
            }
        }

        // ì¼ë³¸ì–´ ë²ˆì—­ í•¨ìˆ˜
        async function translateToJapanese() {
            const japaneseDiv = document.getElementById('japaneseTranslation');

            japaneseDiv.classList.remove('hidden');
            japaneseDiv.innerHTML = `
                <div class="flex items-center justify-center py-8">
                    <div class="loader w-8 h-8 border-4 border-t-red-500"></div>
                    <p class="ml-4 text-red-400 animate-pulse">ì¼ë³¸ì–´ë¡œ ë²ˆì—­ ì¤‘...</p>
                </div>
            `;

            try {
                // Gemini APIë¡œ ì§ì ‘ ìš”ì²­
                const prompt = `
ë‹¹ì‹ ì€ ì „ë¬¸ ì¼ë³¸ì–´ ë²ˆì—­ê°€ì´ì YouTube Shorts ì½˜í…ì¸  ì „ë¬¸ê°€ì…ë‹ˆë‹¤.
ì•„ë˜ í•œêµ­ì–´ ëŒ€ë³¸ì„ ì¼ë³¸ì–´ë¡œ ë²ˆì—­í•˜ê³ , ì¶”ê°€ ì •ë³´ë¥¼ ì œê³µí•´ì£¼ì„¸ìš”.

**í•œêµ­ì–´ ëŒ€ë³¸:**
${window.currentKoreanScript}

**ì¶œë ¥ í˜•ì‹ (ë°˜ë“œì‹œ ì´ í˜•ì‹ì„ ì§€ì¼œì£¼ì„¸ìš”):**

## 1. ì œëª© + 2ì¤„ í›„í‚¹ ë¬¸êµ¬ (3ì„¸íŠ¸)

**ì„¸íŠ¸ 1:**
- ì œëª©: [ì¼ë³¸ì–´ ì œëª©] ([í•œêµ­ì–´ ë²ˆì—­])
- í›„í‚¹ ë¬¸êµ¬ 1ì¤„: [ì¼ë³¸ì–´ ë¬¸êµ¬]
- í›„í‚¹ ë¬¸êµ¬ 2ì¤„: [ì¼ë³¸ì–´ ë¬¸êµ¬]
- í•œêµ­ì–´:
  - 1ì¤„: [í•œêµ­ì–´]
  - 2ì¤„: [í•œêµ­ì–´]

**ì„¸íŠ¸ 2:**
- ì œëª©: [ì¼ë³¸ì–´ ì œëª©] ([í•œêµ­ì–´ ë²ˆì—­])
- í›„í‚¹ ë¬¸êµ¬ 1ì¤„: [ì¼ë³¸ì–´ ë¬¸êµ¬]
- í›„í‚¹ ë¬¸êµ¬ 2ì¤„: [ì¼ë³¸ì–´ ë¬¸êµ¬]
- í•œêµ­ì–´:
  - 1ì¤„: [í•œêµ­ì–´]
  - 2ì¤„: [í•œêµ­ì–´]

**ì„¸íŠ¸ 3:**
- ì œëª©: [ì¼ë³¸ì–´ ì œëª©] ([í•œêµ­ì–´ ë²ˆì—­])
- í›„í‚¹ ë¬¸êµ¬ 1ì¤„: [ì¼ë³¸ì–´ ë¬¸êµ¬]
- í›„í‚¹ ë¬¸êµ¬ 2ì¤„: [ì¼ë³¸ì–´ ë¬¸êµ¬]
- í•œêµ­ì–´:
  - 1ì¤„: [í•œêµ­ì–´]
  - 2ì¤„: [í•œêµ­ì–´]

**í›„í‚¹ ë¬¸êµ¬ ì‘ì„± ì›ì¹™:**
- ê° ì¤„ì€ 10-15ì ì´ë‚´
- 1ì¤„: ê¶ê¸ˆì¦ ìœ ë°œ / ì¶©ê²©ì ì¸ ìƒí™©
- 2ì¤„: êµ¬ì²´ì ì¸ ë‚´ìš© / ê²°ê³¼ ì•”ì‹œ
- ì˜ˆì‹œ: "æŠ•ã’ãŸæŠ•æ‰‹æœ¬äººã‚‚é©šã„ãŸ / å²ä¸Šæœ€å¼·ã®é­”çƒ"

## 2. ì¼ë³¸ì–´ ë¬¸ì¥ ë‚˜ëˆ„ê¸° (ìŠ¬ë˜ì‹œë¡œ êµ¬ë¶„)
- **ë°˜ë“œì‹œ ê° ë¬¸ì¥ì„ ìŠ¬ë˜ì‹œ(/)ë¡œ êµ¬ë¶„**
- YouTube Shortsìš©ìœ¼ë¡œ ì§§ê²Œ ëŠì–´ì„œ
- CapCutì—ì„œ ìë§‰ íƒ€ì´ë° ë§ì¶”ê¸° ì‰½ê²Œ
- í•œ ì¤„ì— 5-7ë‹¨ì–´ ì •ë„
- ì˜ˆì‹œ:
  å½¼ã¯ / æµ·ã®åº•ã§ / æ€ªæˆ‘ã‚’ã—ãŸ / é­šã‚’ / è¦‹ã¤ã‘ã¾ã—ãŸ / ãã—ã¦ / æ­»ã¬ã¾ã§ / ä»£ã‚ã‚Šã« / æ¯æ—¥ / ã‚«ãƒ‹ã‚’ / ä¸ãˆã¾ã—ãŸ

## 3. í•œêµ­ì–´ / ì¼ë³¸ì–´ / ë°œìŒ (3ë‹¨ êµ¬ì„±)
ê° ë¸”ë¡ë§ˆë‹¤ ì •í™•íˆ ì´ í˜•ì‹ìœ¼ë¡œ:

**[ë¸”ë¡ 1]**
- í•œêµ­ì–´: [ì›ë³¸ í•œêµ­ì–´ ë¬¸ì¥]
- ì¼ë³¸ì–´: [ë²ˆì—­ëœ ì¼ë³¸ì–´ ë¬¸ì¥]
- ë°œìŒ: [ì¼ë³¸ì–´ë¥¼ í•œêµ­ì–´ ë°œìŒìœ¼ë¡œ, ì˜ˆ: ì¹´ë ˆì™€ / ìš°ë¯¸ë…¸ ì†Œì½”ë° / ì¼€ê°€ì˜¤ ì‹œíƒ€]

**[ë¸”ë¡ 2]**
- í•œêµ­ì–´: [ì›ë³¸ í•œêµ­ì–´ ë¬¸ì¥]
- ì¼ë³¸ì–´: [ë²ˆì—­ëœ ì¼ë³¸ì–´ ë¬¸ì¥]
- ë°œìŒ: [ì¼ë³¸ì–´ë¥¼ í•œêµ­ì–´ ë°œìŒìœ¼ë¡œ]

(ëª¨ë“  ë¸”ë¡ ë°˜ë³µ...)

## 4. CapCut í¸ì§‘ ê°€ì´ë“œ
í›…í‚¹ í¬ì¸íŠ¸ 3-5ê°œ ì§€ì •, ê° í¬ì¸íŠ¸ë§ˆë‹¤ ì •í™•íˆ ì´ í˜•ì‹ìœ¼ë¡œ:

**í¬ì¸íŠ¸ 1: [íƒ€ì´ë°]ì´ˆ**
- í°íŠ¸ ìƒ‰ìƒ: [ë¹¨ê°•/ë…¸ë‘/í°ìƒ‰ ë“±]
- íš¨ê³¼: [ì•„ë˜ CapCut íš¨ê³¼ ì¤‘ ì„ íƒ]
- ì¶”ì²œ ì´ìœ : [ì´ìœ  ì„¤ëª…]

**CapCut íš¨ê³¼ ëª©ë¡ (ì´ ì¤‘ì—ì„œë§Œ ì„ íƒ):**
- ì´ˆí¬ ê·¸ë˜í”¼í‹°, VHS ë…¸ì´ì¦ˆ, ë¸”ë ›íƒ€ì„ í”„ë¦¬ì¦ˆ, ëª¨ë˜ í¬ì»¤ìŠ¤
- í˜ì´ë“œ ì¸, ë Œì¦ˆ ì¤Œ, ê°€ë¡œ íŒ€, íƒ€ì„ ìŠ¤íƒ‘, ë‹¹ê¹€ ì´ˆì 
- 3D ë¼ì¸, í´ë˜ì‹ ì¸íŠ¸ë¡œ, íŒŒí‹°, ê·¹ì , ì‚¬ìƒ‰ ë¸”ëŸ¬
- ë¦¬ë²„ìŠ¤, í¬ë¡œë§ˆí‹± ëŸ¬ì‹œ, ê¸€ë¦¬ì¹˜, ìŠ¬í”” ìŠ¤íŠ¸ë¡œí¬
- ë¯¸ìŠ¤íŠ¸, ìŠ¤í†± ë¦¬í”Œë ‰ì…˜, í„°ë„ ë¸”ë™, í”Œë˜ì‹œ ì¤Œ

**ë²ˆì—­ ì›ì¹™:**
- ìì—°ìŠ¤ëŸ¬ìš´ ì¼ë³¸ì–´ êµ¬ì–´ì²´ ì‚¬ìš©
- ì›ë³¸ì˜ ë‰˜ì•™ìŠ¤ì™€ í…œí¬ ìœ ì§€
- Shortsìš©ìœ¼ë¡œ ì§§ê³  ì„íŒ©íŠ¸ ìˆê²Œ
- ì‹œì²­ìê°€ ì´í•´í•˜ê¸° ì‰½ê²Œ
- ë¬¸ì¥ì€ ë°˜ë“œì‹œ ìŠ¬ë˜ì‹œ(/)ë¡œ êµ¬ë¶„!
`;

                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=${GEMINI_API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{ text: prompt }]
                        }]
                    })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error?.message || 'ë²ˆì—­ ì‹¤íŒ¨');
                }

                const translatedText = data.candidates[0].content.parts[0].text;

                japaneseDiv.innerHTML = `
                    <div class="bg-gradient-to-r from-red-900/30 to-orange-900/30 rounded-xl p-6 border-2 border-red-500/30">
                        <div class="flex items-center gap-3 mb-4">
                            <span class="text-3xl">ğŸ‡¯ğŸ‡µ</span>
                            <h4 class="text-xl font-bold text-red-400">ì¼ë³¸ì–´ ë²ˆì—­ ê²°ê³¼</h4>
                        </div>
                        <div class="prose prose-invert max-w-none">
                            ${marked.parse(translatedText)}
                        </div>
                    </div>
                `;

            } catch (error) {
                console.error('ì¼ë³¸ì–´ ë²ˆì—­ ì—ëŸ¬:', error);
                japaneseDiv.innerHTML = `
                    <div class="text-center py-4">
                        <p class="text-red-400">ë²ˆì—­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}</p>
                    </div>
                `;
            }
        }

        // Helper: Format timestamp (seconds to MM:SS)
        function formatTimestamp(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        // Helper: Copy timestamps in formatted style
        function copyTimestampsFormatted() {
            if (!window.uploadedSegments) {
                alert('íƒ€ì„ìŠ¤íƒ¬í”„ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            const formatted = window.uploadedSegments.map(seg =>
                `[${formatTimestamp(seg.start)} - ${formatTimestamp(seg.end)}] ${seg.text}`
            ).join('\n');

            navigator.clipboard.writeText(formatted).then(() => {
                alert('íƒ€ì„ìŠ¤íƒ¬í”„ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
            }).catch(err => {
                console.error('Copy failed:', err);
                alert('ë³µì‚¬ ì‹¤íŒ¨');
            });
        }

        // Helper: Save to viral archive
        async function saveTranscriptToViralArchive(title, transcript, viewCount, likeCount, platform) {
            try {
                const response = await fetch('http://localhost:4000/api/analyze-and-save', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        videoId: 'uploaded_' + Date.now(),
                        title: title,
                        transcript: transcript,
                        comments: `í”Œë«í¼: ${platform}, ì¢‹ì•„ìš”: ${likeCount}`,
                        viewCount: viewCount
                    })
                });

                const data = await response.json();

                if (!response.ok) throw new Error(data.error || 'ì €ì¥ ì‹¤íŒ¨');

                alert('âœ… ë°”ì´ëŸ´ ë¶„ì„ì´ ì™„ë£Œë˜ê³  ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!\n\nViral Score: ' + data.data.viralPoint.score);
                console.log('Viral Analysis:', data.data.viralPoint);

            } catch (error) {
                console.error('Save Error:', error);
                alert('âŒ ì €ì¥ ì‹¤íŒ¨: ' + error.message);
            }
        }

        // Helper: Escape HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Helper: Copy to clipboard
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                alert('í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
            }).catch(err => {
                console.error('Copy failed:', err);
                alert('ë³µì‚¬ ì‹¤íŒ¨');
            });
        }

        // --- Viral Analysis & Save Function ---
        async function analyzeAndSaveViral() {
            const resultDiv = document.getElementById('viralAnalysisResult');
            const videoId = window.currentVideoId;
            const title = window.currentVideoTitle;
            const transcript = document.getElementById('transcriptText').value;
            const comments = window.currentComments;

            if (!videoId) return alert('ë¹„ë””ì˜¤ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');

            resultDiv.classList.remove('hidden');
            resultDiv.innerHTML = `
                <div class="flex items-center justify-center py-4">
                    <div class="loader w-6 h-6 border-2 border-t-emerald-500"></div>
                    <p class="ml-3 text-emerald-400 animate-pulse text-sm">AIê°€ ë°”ì´ëŸ´ í¬ì¸íŠ¸ë¥¼ ë¶„ì„í•˜ê³  ì €ì¥ì†Œì— ê¸°ë¡ ì¤‘ì…ë‹ˆë‹¤...</p>
                </div>
            `;

            try {
                // Using Gemini directly if backend logic is complex, OR call the new backend endpoint
                // We implemented /api/analyze-and-save in server.js, so let's call that.

                const response = await fetch('http://localhost:4000/api/analyze-and-save', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        videoId,
                        title,
                        transcript,
                        comments,
                        viewCount: 'N/A' // View count isn't easily available in current modal scope, could pass if stored
                    })
                });

                const data = await response.json();

                if (!response.ok) throw new Error(data.error || 'ë¶„ì„ ì‹¤íŒ¨');

                const point = data.data.viralPoint;

                resultDiv.innerHTML = `
                    <div class="flex flex-col gap-2">
                        <div class="flex items-center justify-between">
                            <h4 class="font-bold text-emerald-400 flex items-center gap-2">
                                <span>âœ… ì €ì¥ ì™„ë£Œ</span>
                                <span class="text-xs bg-emerald-800 text-emerald-200 px-2 py-0.5 rounded-full">Viral Score: ${point.score}</span>
                            </h4>
                            <span class="text-xs text-slate-500">${new Date().toLocaleTimeString()}</span>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-2 text-sm mt-2">
                            <div class="bg-slate-900/50 p-2 rounded border border-slate-700">
                                <span class="text-slate-400 text-xs block mb-1">ğŸ£ Hook</span>
                                <span class="text-slate-200">${point.hook}</span>
                            </div>
                            <div class="bg-slate-900/50 p-2 rounded border border-slate-700">
                                <span class="text-slate-400 text-xs block mb-1">ğŸ—ï¸ Structure</span>
                                <span class="text-slate-200">${point.structure}</span>
                            </div>
                            <div class="bg-slate-900/50 p-2 rounded border border-slate-700">
                                <span class="text-slate-400 text-xs block mb-1">â¤ï¸ Emotion</span>
                                <span class="text-slate-200">${point.emotion}</span>
                            </div>
                            <div class="bg-slate-900/50 p-2 rounded border border-slate-700">
                                <span class="text-slate-400 text-xs block mb-1">ğŸ’¡ Why Viral?</span>
                                <span class="text-slate-200">${point.summary || point.viral_reason}</span>
                            </div>
                        </div>
                    </div>
                `;

            } catch (error) {
                console.error('Viral Analysis Error:', error);
                resultDiv.innerHTML = `
                    <div class="text-center py-2">
                        <p class="text-red-400 text-sm">âŒ ë¶„ì„ ì‹¤íŒ¨: ${error.message}</p>
                    </div>
                `;
            }
        }

    </script>
    <style>
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #1e293b;
        }

        ::-webkit-scrollbar-thumb {
            background: #475569;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #64748b;
        }

        .glass-panel {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .viral-glow {
            box-shadow: 0 0 15px rgba(234, 179, 8, 0.3);
            border: 1px solid rgba(234, 179, 8, 0.5);
        }

        /* Loading Spinner */
        .loader {
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            border-top: 3px solid #3b82f6;
            width: 24px;
            height: 24px;
            -webkit-animation: spin 1s linear infinite;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body class="bg-slate-900 text-slate-100 min-h-screen font-sans selection:bg-brand-500 selection:text-white">

    <!-- API Key Configuration Modal (Initial Overlay) -->
    <div id="apiKeyModal"
        class="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm transition-opacity duration-300">
        <div class="bg-slate-800 p-8 rounded-2xl shadow-2xl border border-slate-700 max-w-md w-full mx-4">
            <h2
                class="text-2xl font-bold mb-4 text-transparent bg-clip-text bg-gradient-to-r from-brand-400 to-accent-400">
                API í‚¤ ì„¤ì •</h2>
            <p class="text-slate-400 mb-6 text-sm">ì• í”Œë¦¬ì¼€ì´ì…˜ ì‚¬ìš©ì„ ìœ„í•´ API í‚¤ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”. ì´ í‚¤ëŠ” ë¸Œë¼ìš°ì €ì—ë§Œ ì €ì¥ë©ë‹ˆë‹¤.</p>

            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-semibold text-slate-500 uppercase mb-1">YouTube Data API
                        Key</label>
                    <input type="password" id="inputYoutubeKey"
                        class="w-full bg-slate-900 border border-slate-700 rounded-lg px-4 py-2 text-white focus:ring-2 focus:ring-brand-500 focus:border-transparent outline-none transition-all"
                        placeholder="AIzaSy...">
                </div>
                <div>
                    <label class="block text-xs font-semibold text-slate-500 uppercase mb-1">Gemini API Key</label>
                    <input type="password" id="inputGeminiKey"
                        class="w-full bg-slate-900 border border-slate-700 rounded-lg px-4 py-2 text-white focus:ring-2 focus:ring-accent-500 focus:border-transparent outline-none transition-all"
                        placeholder="AIzaSy...">
                </div>
                <div>
                    <label class="block text-xs font-semibold text-slate-500 uppercase mb-1">Apify API Token</label>
                    <input type="password" id="inputApifyToken"
                        class="w-full bg-slate-900 border border-slate-700 rounded-lg px-4 py-2 text-white focus:ring-2 focus:ring-green-500 focus:border-transparent outline-none transition-all"
                        placeholder="apify_api_...">
                    <p class="text-xs text-slate-500 mt-1">YouTube ìë§‰ ì¶”ì¶œìš© (ì„ íƒ ì‚¬í•­)</p>
                </div>
                <button onclick="saveApiKeys()"
                    class="w-full bg-gradient-to-r from-brand-600 to-accent-600 hover:from-brand-500 hover:to-accent-500 text-white font-bold py-3 rounded-lg shadow-lg transform transition hover:scale-[1.02] active:scale-[0.98]">
                    ì‹œì‘í•˜ê¸°
                </button>
            </div>
        </div>
    </div>

    <!-- Analysis & Rewrite Modal -->
    <div id="analysisModal"
        class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm transition-opacity duration-300">
        <div
            class="bg-slate-800 p-8 rounded-2xl shadow-2xl border border-slate-700 max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-6">
                <h2 id="modal-title"
                    class="text-2xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-brand-400 to-accent-400">
                    ëŒ€ë³¸ ì¶”ì¶œ ì™„ë£Œ</h2>
                <button onclick="closeModal()" class="text-slate-400 hover:text-white transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>

            <!-- Modal Content (dynamically populated) -->
            <div id="modalContent">
                <!-- Content will be injected here by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Main App Container -->
    <div class="w-full px-6 py-8">

        <!-- Header -->
        <header class="text-center mb-12 relative">
            <div
                class="absolute top-0 left-1/2 -translate-x-1/2 w-full h-32 bg-brand-500/20 blur-[100px] -z-10 rounded-full">
            </div>
            <h1 class="text-4xl md:text-6xl font-extrabold mb-4 tracking-tight">
                <span
                    class="text-transparent bg-clip-text bg-gradient-to-r from-white via-brand-200 to-brand-400">YouTube</span>
                <span class="text-transparent bg-clip-text bg-gradient-to-r from-brand-400 to-accent-500">Viral
                    Finder</span>
            </h1>
            <p class="text-slate-400 text-lg max-w-2xl mx-auto">
                ìœ íŠœë¸Œ ë¹…ë°ì´í„°ë¥¼ ë¶„ì„í•˜ì—¬ í„°ì§€ëŠ” ì†Œì¬ì™€ ë²¤ì¹˜ë§ˆí‚¹í•  ì±„ë„ì„ ì°¾ì•„ë“œë¦½ë‹ˆë‹¤.
            </p>
        </header>

        <!-- Tab Navigation -->
        <div class="mb-6 border-b border-slate-700">
            <nav class="flex gap-2">
                <button id="tab-channel-finder"
                    class="tab-btn px-6 py-3 font-bold text-brand-400 border-b-2 border-brand-500 bg-brand-500/10 transition-all hover:text-brand-300 hover:border-brand-400">
                    ğŸ”¥ HOT ì±„ë„ íŒŒì¸ë”
                </button>
                <button onclick="window.open('http://localhost:4000/multilang_keywords.html', '_blank')"
                    class="tab-btn px-6 py-3 font-medium text-slate-400 border-b-2 border-transparent hover:text-brand-300 transition-all hover:border-brand-400">
                    ğŸŒ ë‹¤êµ­ì–´ í‚¤ì›Œë“œ ê²€ìƒ‰ê¸°
                </button>
                <button onclick="window.open('http://localhost:4000/youtube_guidelines.html', '_blank')"
                    class="tab-btn px-6 py-3 font-medium text-slate-400 border-b-2 border-transparent hover:text-brand-300 transition-all hover:border-brand-400">
                    ğŸ“‹ YouTube ê°€ì´ë“œë¼ì¸
                </button>
            </nav>
        </div>

        <!-- Tab Contents -->

        <!-- HOT Channel Finder Tab -->
        <div id="content-channel-finder" class="tab-content">
            <!-- HOT Channel Finder Top Navigation -->
            <div class="flex items-center gap-6 mb-8 border-b border-slate-700/50">
                <button onclick="switchChannelSubTab('hot-channels')" id="subtab-hot-channels"
                    class="pb-4 px-2 text-brand-400 border-b-2 border-brand-500 font-bold transition-all">HOT ì±„ë„
                    íŒŒì¸ë”</button>
                <button onclick="switchChannelSubTab('trending-videos')" id="subtab-trending-videos"
                    class="pb-4 px-2 text-slate-400 hover:text-slate-200 border-b-2 border-transparent font-medium transition-all">ì‹¤ì‹œê°„
                    ì¸ê¸° ê¸‰ìƒìŠ¹ íŒŒì¸ë”</button>
            </div>

            <div id="channel-finder-main-content">
                <!-- Heading -->
                <div class="text-center mb-10">
                    <div class="inline-block p-3 bg-brand-500/10 rounded-2xl mb-4">
                        <span class="text-3xl text-brand-500">ğŸ”¥</span>
                    </div>
                    <h1 class="text-4xl font-black text-white mb-3 tracking-tighter">HOT ì±„ë„ íŒŒì¸ë”</h1>
                    <p class="text-slate-400 text-lg">êµ¬ë…ì ëŒ€ë¹„ ì¡°íšŒìˆ˜ê°€ í­ë°œì ìœ¼ë¡œ ì„±ì¥í•˜ëŠ” <span class="text-brand-400 font-bold">ìˆ¨ì€
                            ë³´ì„</span> ì±„ë„ì„ ì‹¤ì‹œê°„ìœ¼ë¡œ ë°œêµ´í•˜ì„¸ìš”.</p>
                </div>

                <!-- Filter Bar -->
                <div class="flex flex-wrap items-center gap-3 mb-8">
                    <button onclick="openAdvancedFilterModal()"
                        class="flex items-center gap-2 px-5 py-3 bg-slate-800 hover:bg-slate-700 border border-slate-700 rounded-xl text-slate-200 font-bold transition-all shadow-lg active:scale-95 group">
                        <svg class="w-5 h-5 text-brand-400 group-hover:rotate-90 transition-transform duration-300"
                            fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4">
                            </path>
                        </svg>
                        ê³ ê¸‰ í•„í„° ì„¤ì •
                    </button>
                    <button onclick="openCategoryFilterModal()"
                        class="flex items-center gap-2 px-5 py-3 bg-slate-800 hover:bg-slate-700 border border-slate-700 rounded-xl text-slate-200 font-bold transition-all shadow-lg active:scale-95 group">
                        <svg class="w-5 h-5 text-brand-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M4 6h16M4 12h16M4 18h7">
                            </path>
                        </svg>
                        ì¹´í…Œê³ ë¦¬ í•„í„°
                    </button>
                    <div class="relative">
                        <select id="channelSortOrder"
                            class="appearance-none pl-5 pr-12 py-3 bg-slate-800 border border-slate-700 rounded-xl text-slate-200 font-bold focus:outline-none focus:ring-2 focus:ring-brand-500 transition-all shadow-lg">
                            <option value="total_views">ì •ë ¬: ì´ ì¡°íšŒìˆ˜ìˆœ</option>
                            <option value="growth">ì •ë ¬: ì¼ì¼ ì¦ê°ìˆœ</option>
                            <option value="subscribers">ì •ë ¬: êµ¬ë…ììˆœ</option>
                        </select>
                        <div
                            class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-4 text-slate-500">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M19 9l-7 7-7-7">
                                </path>
                            </svg>
                        </div>
                    </div>
                    <div class="flex-1 min-w-[300px] relative">
                        <input type="text" id="channelSearchKeyword" placeholder="ì±„ë„ëª… ê²€ìƒ‰..."
                            class="w-full bg-slate-900/50 backdrop-blur-sm border border-slate-700 rounded-xl pl-12 pr-4 py-3 text-white focus:border-brand-500 outline-none transition-all shadow-inner text-lg">
                        <svg class="absolute left-4 top-1/2 -translate-y-1/2 w-6 h-6 text-slate-500" fill="none"
                            stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                        </svg>
                    </div>
                </div>

                <div class="flex items-center justify-between mb-6 px-1">
                    <div class="text-slate-400 text-sm">
                        ë°œêµ´ëœ ì±„ë„ <span id="discovered-channels-total" class="text-slate-100 font-extrabold">0</span> ê°œ |
                        ğŸ“Š í†µê³„ ì¡°íšŒ <span class="text-brand-400 font-bold">ë¬´ì œí•œ</span>
                    </div>
                    <div class="flex items-center gap-4">
                        <button onclick="searchHotChannels()"
                            class="px-8 py-3 bg-gradient-to-r from-brand-600 to-red-600 hover:from-brand-500 hover:to-red-500 text-white font-black rounded-xl shadow-xl shadow-brand-900/20 transform transition hover:scale-[1.05] active:scale-95 text-lg">
                            ğŸš€ HOT ì±„ë„ ì°¾ê¸°
                        </button>
                    </div>
                </div>

                <!-- Channel Cards Container -->
                <div id="channelResultsGrid" class="space-y-6 min-h-[400px]">
                    <!-- Empty State / Loading / Cards will be injected here -->
                    <div class="flex flex-col items-center justify-center py-20 text-slate-600">
                        <svg class="w-20 h-20 mb-4 opacity-20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1"
                                d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10">
                            </path>
                        </svg>
                        <p class="text-xl font-bold">ì¡°ê±´ì„ ì„¤ì •í•˜ê³  ìƒë‹¨ì˜ 'HOT ì±„ë„ ì°¾ê¸°' ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”.</p>
                    </div>
                </div>
            </div>

            <!-- Trending Videos Main Content (Initially Hidden) -->
            <div id="trending-videos-main-content" class="hidden">
                <div class="text-center mb-10">
                    <div class="inline-block p-3 bg-red-500/10 rounded-2xl mb-4">
                        <span class="text-3xl">ğŸ“ˆ</span>
                    </div>
                    <h1 class="text-4xl font-black text-white mb-3 tracking-tighter">ì‹¤ì‹œê°„ ì¸ê¸° ê¸‰ìƒìŠ¹</h1>
                    <p class="text-slate-400 text-lg">ì§€ê¸ˆ <span class="text-red-400 font-bold">ê°€ì¥ ëœ¨ê±°ìš´</span> ìœ íŠœë¸Œ ì˜ìƒì„
                        ì‹¤ì‹œê°„ìœ¼ë¡œ
                        í™•ì¸í•˜ì„¸ìš”.</p>
                </div>

                <div class="flex justify-center mb-8">
                    <div class="bg-slate-800/80 p-1.5 rounded-2xl flex gap-1 shadow-2xl border border-slate-700">
                        <button onclick="switchTrendingFilter('all')" id="trending-filter-all"
                            class="px-8 py-3 rounded-xl bg-brand-600 text-white font-black shadow-lg shadow-brand-900/40 transition-all">ì „ì²´
                            <span class="ml-2 text-xs opacity-70">600</span></button>
                        <button onclick="switchTrendingFilter('long')" id="trending-filter-long"
                            class="px-8 py-3 rounded-xl text-slate-400 hover:text-white font-bold transition-all">ë¡±í¼
                            <span class="ml-2 text-xs opacity-50">300</span></button>
                        <button onclick="switchTrendingFilter('short')" id="trending-filter-short"
                            class="px-8 py-3 rounded-xl text-slate-400 hover:text-white font-bold transition-all">ìˆí¼
                            <span class="ml-2 text-xs opacity-50">300</span></button>
                    </div>
                </div>

                <div id="trendingVideosList" class="glass-panel rounded-3xl overflow-hidden border border-slate-700/50">
                    <table class="w-full text-left">
                        <thead class="bg-slate-800/50 border-b border-slate-700">
                            <tr class="text-slate-400 text-sm font-bold">
                                <th class="px-6 py-4 text-center w-20">ìˆœìœ„</th>
                                <th class="px-6 py-4">ì˜ìƒ ì •ë³´</th>
                                <th class="px-6 py-4">ì±„ë„</th>
                                <th class="px-6 py-4 text-right">ì¡°íšŒìˆ˜</th>
                                <th class="px-6 py-4 text-center w-24">ë§í¬</th>
                            </tr>
                        </thead>
                        <tbody id="trendingVideosTableBody" class="divide-y divide-slate-800/50">
                            <!-- Trending items will be injected here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Multilingual Keyword Finder Content -->
            <div id="multilang-keywords-content" class="hidden">
                <!-- Category Selection -->
                <div class="glass-panel rounded-2xl p-8 mb-8">
                    <h2 class="text-2xl font-bold text-white mb-6 flex items-center gap-3">
                        <span class="text-3xl">ğŸ“‚</span>
                        ì¹´í…Œê³ ë¦¬ ì„ íƒ
                    </h2>

                    <div id="multilangCategoryGrid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-3">
                        <!-- Categories will be populated here -->
                    </div>
                </div>

                <!-- Language Filter -->
                <div class="glass-panel rounded-2xl p-8 mb-8">
                    <h2 class="text-2xl font-bold text-white mb-6 flex items-center gap-3">
                        <span class="text-3xl">ğŸŒ</span>
                        ì–¸ì–´ ì„ íƒ
                    </h2>

                    <div class="flex gap-6">
                        <label class="flex items-center gap-3 cursor-pointer group">
                            <input type="checkbox" id="multilang-ko" checked
                                class="w-5 h-5 rounded border-slate-600 bg-slate-700 text-blue-600 focus:ring-blue-500">
                            <span class="text-lg text-slate-300 group-hover:text-white transition">ğŸ‡°ğŸ‡· í•œêµ­ì–´</span>
                        </label>
                        <label class="flex items-center gap-3 cursor-pointer group">
                            <input type="checkbox" id="multilang-en" checked
                                class="w-5 h-5 rounded border-slate-600 bg-slate-700 text-blue-600 focus:ring-blue-500">
                            <span class="text-lg text-slate-300 group-hover:text-white transition">ğŸ‡ºğŸ‡¸ ì˜ì–´</span>
                        </label>
                        <label class="flex items-center gap-3 cursor-pointer group">
                            <input type="checkbox" id="multilang-ja" checked
                                class="w-5 h-5 rounded border-slate-600 bg-slate-700 text-blue-600 focus:ring-blue-500">
                            <span class="text-lg text-slate-300 group-hover:text-white transition">ğŸ‡¯ğŸ‡µ ì¼ë³¸ì–´</span>
                        </label>
                    </div>

                    <button onclick="searchMultilangKeywords()"
                        class="mt-6 px-8 py-3 bg-gradient-to-r from-blue-600 to-cyan-600 hover:from-blue-500 hover:to-cyan-500 text-white font-bold rounded-xl shadow-lg transition-all transform hover:scale-105">
                        ğŸ” í‚¤ì›Œë“œ ê²€ìƒ‰
                    </button>
                </div>

                <!-- Loading -->
                <div id="multilangLoadingSection" class="hidden glass-panel rounded-2xl p-12 text-center mb-8">
                    <div class="loader w-16 h-16 border-4 border-blue-500 border-t-transparent mx-auto mb-4"
                        style="border-radius: 50%; animation: spin 1s linear infinite;"></div>
                    <p class="text-white font-bold text-xl">í‚¤ì›Œë“œ ë¶„ì„ ì¤‘...</p>
                    <p class="text-slate-400 mt-2">YouTube Trending ì˜ìƒì„ ë¶„ì„í•˜ê³  ë²ˆì—­í•˜ê³  ìˆìŠµë‹ˆë‹¤</p>
                </div>

                <!-- Keyword Table -->
                <div id="multilangKeywordSection" class="hidden glass-panel rounded-2xl p-8 mb-8">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-2xl font-bold text-white flex items-center gap-3">
                            <span class="text-3xl">ğŸ”¥</span>
                            ê¸‰ìƒìŠ¹ í‚¤ì›Œë“œ
                            <span id="multilangCategoryTitle" class="text-blue-400"></span>
                        </h2>
                        <span id="multilangCachedBadge"
                            class="hidden px-4 py-2 bg-green-600/20 text-green-400 rounded-lg text-sm font-bold border border-green-500/30">
                            ğŸ’¾ ìºì‹œë¨
                        </span>
                    </div>

                    <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead>
                                <tr class="border-b border-slate-700">
                                    <th class="pb-4 text-slate-400 font-bold text-sm">#</th>
                                    <th class="pb-4 text-slate-400 font-bold text-sm">ğŸ‡°ğŸ‡· í•œêµ­ì–´</th>
                                    <th class="pb-4 text-slate-400 font-bold text-sm">ğŸ‡ºğŸ‡¸ ì˜ì–´</th>
                                    <th class="pb-4 text-slate-400 font-bold text-sm">ğŸ‡¯ğŸ‡µ ì¼ë³¸ì–´</th>
                                    <th class="pb-4 text-slate-400 font-bold text-sm text-center">ê²€ìƒ‰ëŸ‰ (Total View)</th>
                                </tr>
                            </thead>
                            <tbody id="multilangKeywordTableBody">
                                <!-- Keywords will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Viral Videos Preview -->
                <div id="multilangViralVideosSection" class="hidden glass-panel rounded-2xl p-8">
                    <h2 class="text-2xl font-bold text-white mb-6 flex items-center gap-3">
                        <span class="text-3xl">ğŸ¬</span>
                        ë°”ì´ëŸ´ ì˜ìƒ í”„ë¦¬ë·°
                        <span id="multilangSelectedKeyword" class="text-purple-400"></span>
                    </h2>

                    <div id="multilangViralVideosGrid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                        <!-- Videos will be populated here -->
                    </div>
                </div>
            </div>
        </div> <!-- End of HOT Channel Finder Tab -->

        <!-- AI Analysis Modal -->
        <div id="analysisModal" class="fixed inset-0 z-50 hidden" aria-labelledby="modal-title" role="dialog"
            aria-modal="true">
            <!-- Backdrop -->
            <div class="fixed inset-0 bg-black/80 backdrop-blur-sm transition-opacity" onclick="closeModal()"></div>

            <div class="fixed inset-0 z-10 overflow-y-auto">
                <div class="flex min-h-full items-end justify-center p-4 text-center sm:items-center sm:p-0">
                    <div
                        class="relative transform overflow-hidden rounded-2xl bg-slate-900 border border-slate-700 text-left shadow-2xl transition-all sm:my-8 sm:w-full sm:max-w-4xl">

                        <!-- Modal Header -->
                        <div
                            class="bg-slate-800/50 px-6 py-4 border-b border-slate-700 flex justify-between items-center">
                            <div class="flex items-center gap-3">
                                <div class="p-2 bg-gradient-to-br from-brand-500 to-accent-500 rounded-lg">
                                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor"
                                        viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                                    </svg>
                                </div>
                                <h3 class="text-xl font-bold text-white" id="modal-title">ëŒ“ê¸€ + ìë§‰ ë°ì´í„° ì¶”ì¶œ</h3>
                            </div>
                            <button onclick="closeModal()" class="text-slate-400 hover:text-white transition-colors">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>

                        <!-- Modal Body -->
                        <div class="px-6 py-6 max-h-[70vh] overflow-y-auto custom-scrollbar">
                            <div id="modalContent" class="prose prose-invert prose-lg max-w-none">
                                <div class="flex flex-col items-center justify-center py-12 space-y-4">
                                    <div class="loader"></div>
                                    <p class="text-slate-400 animate-pulse">ëŒ“ê¸€ì„ ë¶„ì„í•˜ê³  ëŒ€ë³¸ì„ ì¬ì‘ì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤...</p>
                                </div>
                            </div>
                        </div>

                        <!-- Modal Footer -->
                        <div class="bg-slate-800/50 px-6 py-4 border-t border-slate-700 flex justify-end">
                            <button type="button" class="text-sm text-slate-400 hover:text-white transition-colors"
                                onclick="closeModal()">ë‹«ê¸°</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Channel Detail Modal -->
        <div id="channelModal" class="fixed inset-0 z-50 hidden" aria-labelledby="channel-modal-title" role="dialog"
            aria-modal="true">
            <!-- Backdrop -->
            <div class="fixed inset-0 bg-black/80 backdrop-blur-sm transition-opacity" onclick="closeChannelModal()">
            </div>

            <div class="fixed inset-0 z-10 overflow-y-auto">
                <div class="flex min-h-full items-end justify-center p-4 text-center sm:items-center sm:p-0">
                    <div
                        class="relative transform overflow-hidden rounded-2xl bg-slate-900 border border-slate-700 text-left shadow-2xl transition-all sm:my-8 sm:w-full sm:max-w-5xl">

                        <!-- Modal Header -->
                        <div
                            class="bg-gradient-to-r from-red-900/50 to-slate-900/50 px-6 py-4 border-b border-slate-700">
                            <div class="flex justify-between items-start">
                                <div id="channelHeaderInfo" class="flex items-center gap-4">
                                    <!-- Channel info will be loaded here -->
                                    <div class="w-16 h-16 bg-slate-700 rounded-full animate-pulse"></div>
                                    <div>
                                        <div class="h-6 w-40 bg-slate-700 rounded animate-pulse mb-2"></div>
                                        <div class="h-4 w-24 bg-slate-700 rounded animate-pulse"></div>
                                    </div>
                                </div>
                                <button onclick="closeChannelModal()"
                                    class="text-slate-400 hover:text-white transition-colors">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M6 18L18 6M6 6l12 12"></path>
                                    </svg>
                                </button>
                            </div>

                            <!-- Channel Stats -->
                            <div id="channelStats" class="mt-4 grid grid-cols-3 md:grid-cols-5 gap-3">
                                <!-- Stats will be loaded here -->
                            </div>
                        </div>

                        <!-- Modal Body - Videos Grid -->
                        <div class="px-6 py-6 max-h-[60vh] overflow-y-auto custom-scrollbar">
                            <div class="flex items-center justify-between mb-4">
                                <h4 class="text-lg font-bold text-white">ì±„ë„ ì˜ìƒ</h4>
                                <div class="flex gap-2">
                                    <button onclick="sortChannelVideos('date')"
                                        class="channel-sort-btn text-xs px-3 py-1 rounded-lg bg-slate-700 text-slate-300 hover:bg-brand-600 hover:text-white transition-colors"
                                        data-sort="date">ìµœì‹ ìˆœ</button>
                                    <button onclick="sortChannelVideos('views')"
                                        class="channel-sort-btn text-xs px-3 py-1 rounded-lg bg-slate-700 text-slate-300 hover:bg-brand-600 hover:text-white transition-colors"
                                        data-sort="views">ì¡°íšŒìˆ˜ìˆœ</button>
                                </div>
                            </div>
                            <div id="channelVideosGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                <!-- Videos will be loaded here -->
                                <div class="flex flex-col items-center justify-center py-12 col-span-full">
                                    <div class="loader"></div>
                                    <p class="text-slate-400 animate-pulse mt-4">ì±„ë„ ì˜ìƒì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
                                </div>
                            </div>
                        </div>

                        <!-- Modal Footer -->
                        <div
                            class="bg-slate-800/50 px-6 py-4 border-t border-slate-700 flex justify-between items-center">
                            <a id="channelYoutubeLink" href="#" target="_blank" rel="noopener noreferrer"
                                class="text-sm bg-red-600 hover:bg-red-500 text-white px-4 py-2 rounded-lg transition-colors flex items-center gap-2">
                                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                                    <path
                                        d="M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z" />
                                </svg>
                                YouTubeì—ì„œ ë³´ê¸°
                            </a>
                            <button type="button" class="text-sm text-slate-400 hover:text-white transition-colors"
                                onclick="closeChannelModal()">ë‹«ê¸°</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <script>
            const DEFAULT_YOUTUBE_KEY = 'AIzaSyBNyle0lxe-LUCEtRW3mI2WOfWvkQRmdKk';
            const DEFAULT_GEMINI_KEY = 'AIzaSyATQ84LNLhs7snbzrcE2IRX6ig54BZsSB8';
            const DEFAULT_APIFY_TOKEN = 'apify_api_VhYHi230U8JbqA9Cf8erX1KvVDtIIC3RW0gh';
            const APIFY_ACTOR_ID = 'pintostudio~youtube-transcript-scraper';

            let YOUTUBE_API_KEY = '';
            let GEMINI_API_KEY = '';
            let APIFY_TOKEN = '';

            // --- Initialization ---
            document.addEventListener('DOMContentLoaded', () => {
                const storedYoutube = localStorage.getItem('yt_viral_yt_key');
                const storedGemini = localStorage.getItem('yt_viral_gemini_key');
                const storedApify = localStorage.getItem('yt_viral_apify_token');

                // Load stored keys or fall back to defaults
                YOUTUBE_API_KEY = storedYoutube || DEFAULT_YOUTUBE_KEY;
                GEMINI_API_KEY = storedGemini || DEFAULT_GEMINI_KEY;
                APIFY_TOKEN = storedApify || DEFAULT_APIFY_TOKEN;

                // Pre-fill inputs
                document.getElementById('inputYoutubeKey').value = YOUTUBE_API_KEY;
                document.getElementById('inputGeminiKey').value = GEMINI_API_KEY;
                document.getElementById('inputApifyToken').value = APIFY_TOKEN;

                // Show modal if any key is missing (though defaults should cover it)
                if (!YOUTUBE_API_KEY) {
                    document.getElementById('apiKeyModal').classList.remove('hidden');
                } else {
                    document.getElementById('apiKeyModal').classList.add('hidden');
                }

                // Enter key support
                const keywordInput = document.getElementById('keyword');
                if (keywordInput) {
                    keywordInput.addEventListener('keypress', function (e) {
                        if (e.key === 'Enter') {
                            startSearch();
                        }
                    });
                }

                // Slider value update
                const slider = document.getElementById('viralThreshold');
                const output = document.getElementById('thresholdValue');
                if (slider && output) {
                    slider.oninput = function () {
                        output.innerHTML = this.value + '%';
                    }
                }

                // === HOT Channel Finder Initialization ===
                if (typeof initializeCategoryButtons === 'function') {
                    initializeCategoryButtons();
                }

                // Tab Button Event Listeners
                const videoTabBtn = document.getElementById('tab-video-search');
                if (videoTabBtn) {
                    videoTabBtn.addEventListener('click', () => switchTab('video-search'));
                }

                const channelTabBtn = document.getElementById('tab-channel-finder');
                if (channelTabBtn) {
                    channelTabBtn.addEventListener('click', () => switchTab('channel-finder'));
                }
            });

            function saveApiKeys() {
                const ytKey = document.getElementById('inputYoutubeKey').value.trim();
                const geminiKey = document.getElementById('inputGeminiKey').value.trim();
                const apifyToken = document.getElementById('inputApifyToken').value.trim();

                if (!ytKey) {
                    alert('YouTube API í‚¤ëŠ” ë°˜ë“œì‹œ ì…ë ¥í•´ì•¼ í•©ë‹ˆë‹¤.');
                    return;
                }

                YOUTUBE_API_KEY = ytKey;
                GEMINI_API_KEY = geminiKey;
                APIFY_TOKEN = apifyToken;

                localStorage.setItem('yt_viral_yt_key', ytKey);
                localStorage.setItem('yt_viral_gemini_key', geminiKey);
                localStorage.setItem('yt_viral_apify_token', apifyToken);

                document.getElementById('apiKeyModal').classList.add('hidden');
            }

            // Quick Search Function for Viral Discovery
            function quickSearch(keyword, duration, dateFilter, order) {
                // Set search parameters
                document.getElementById('keyword').value = keyword;
                document.getElementById('videoDuration').value = duration;
                document.getElementById('publishedAfter').value = dateFilter;
                document.getElementById('searchOrder').value = order;

                // Execute search
                startSearch();
            }

            // --- Core Logic: YouTube Search & Data ---

            let globalProcessedItems = []; // Store items globally for sorting
            let globalSelectedVideos = []; // Store selected videos for script generation

            async function startSearch() {
                const keyword = document.getElementById('keyword').value.trim();
                // const maxResults = document.getElementById('maxResults').value; // Removed single page limit usage
                const videoDuration = document.getElementById('videoDuration').value;

                // New Inputs
                const publishedAfter = document.getElementById('publishedAfter').value;
                const searchOrder = document.getElementById('searchOrder').value;
                const searchLimit = parseInt(document.getElementById('searchLimit').value) || 200;

                if (!keyword) {
                    alert('ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                    return;
                }

                if (!YOUTUBE_API_KEY) {
                    alert('YouTube API í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                    return;
                }

                setLoading(true, "Deep Search ê°€ë™ ì¤‘... ìµœëŒ€ 200ê°œì˜ ì˜ìƒì„ ë¶„ì„í•©ë‹ˆë‹¤.");
                document.getElementById('resultsGrid').innerHTML = '';
                document.getElementById('emptyState').classList.add('hidden');
                document.getElementById('sortBar').classList.add('hidden');

                try {
                    // Determine Date Filter
                    let publishedAfterDate = '';
                    let publishedBeforeDate = '';
                    let dateRangeFilter = null; // For custom date range filtering
                    if (publishedAfter !== 'any') {
                        const date = new Date();
                        switch (publishedAfter) {
                            case '1week': date.setDate(date.getDate() - 7); break;
                            case '2week': date.setDate(date.getDate() - 14); break;
                            case '3week': date.setDate(date.getDate() - 21); break;
                            case '1month': date.setMonth(date.getMonth() - 1); break;
                            case '2month_range':
                                // For 50-70 days range, use precise API date range
                                const endDate = new Date();
                                endDate.setDate(endDate.getDate() - 50); // 50ì¼ ì „ê¹Œì§€
                                const startDate = new Date();
                                startDate.setDate(startDate.getDate() - 70); // 70ì¼ ì „ë¶€í„°
                                publishedAfterDate = startDate.toISOString();
                                publishedBeforeDate = endDate.toISOString();
                                dateRangeFilter = { minDays: 50, maxDays: 70 };
                                break;
                            case '2month': date.setMonth(date.getMonth() - 2); break;
                            case '3month': date.setMonth(date.getMonth() - 3); break;
                        }
                        if (!publishedAfterDate) {
                            publishedAfterDate = date.toISOString();
                        }
                    }

                    // --- 1. Deep Search Loop ---
                    let allItems = [];
                    let nextPageToken = '';
                    let fetchedCount = 0;
                    let pageCount = 0;

                    while (fetchedCount < searchLimit) {
                        // Update Loading Text
                        pageCount++;
                        setLoading(true, `Deep Search ${pageCount}ë‹¨ê³„: ë°ì´í„° ìˆ˜ì§‘ ì¤‘ (${fetchedCount}/${searchLimit})...`);

                        let searchUrl = `https://www.googleapis.com/youtube/v3/search?part=snippet&type=video&q=${encodeURIComponent(keyword)}&maxResults=50&key=${YOUTUBE_API_KEY}`;

                        if (videoDuration !== 'any') {
                            if (videoDuration === '1_to_3') {
                                searchUrl += `&videoDuration=short`; // Gets < 4 min
                            } else {
                                searchUrl += `&videoDuration=${videoDuration}`;
                            }
                        }
                        if (publishedAfterDate) searchUrl += `&publishedAfter=${publishedAfterDate}`;
                        if (publishedBeforeDate) searchUrl += `&publishedBefore=${publishedBeforeDate}`;
                        // For date range filter, force viewCount order to get hottest videos
                        const effectiveOrder = dateRangeFilter ? 'viewCount' : searchOrder;
                        if (effectiveOrder) searchUrl += `&order=${effectiveOrder}`;
                        if (nextPageToken) searchUrl += `&pageToken=${nextPageToken}`;

                        const searchRes = await fetch(searchUrl);
                        const searchData = await searchRes.json();

                        if (!searchRes.ok) throw new Error(searchData.error?.message || 'Search failed');

                        if (!searchData.items || searchData.items.length === 0) break;

                        allItems = allItems.concat(searchData.items);
                        fetchedCount += searchData.items.length;
                        nextPageToken = searchData.nextPageToken;

                        if (!nextPageToken) break; // No more pages
                    }

                    if (allItems.length === 0) {
                        setLoading(false);
                        document.getElementById('emptyState').classList.remove('hidden');
                        return;
                    }

                    // --- 2. Batch Fetch Details ---
                    const videoIds = allItems.map(item => item.id.videoId);

                    // YouTube API limits 'id' parameter to 50 items
                    const videoDetailsPromises = [];
                    for (let i = 0; i < videoIds.length; i += 50) {
                        const chunk = videoIds.slice(i, i + 50).join(',');
                        videoDetailsPromises.push(
                            fetch(`https://www.googleapis.com/youtube/v3/videos?part=statistics,snippet,contentDetails&id=${chunk}&key=${YOUTUBE_API_KEY}`)
                                .then(res => res.json())
                        );
                    }

                    setLoading(true, "ì˜ìƒ ìƒì„¸ ì •ë³´ë¥¼ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤...");
                    const videosResponses = await Promise.all(videoDetailsPromises);
                    let allVideos = [];
                    videosResponses.forEach(data => {
                        if (data.items) allVideos = allVideos.concat(data.items);
                    });

                    // --- Filter by Custom Duration (1m ~ 3m) if selected ---
                    if (videoDuration === '1_to_3') {
                        setLoading(true, "ì˜ìƒ ê¸¸ì´(1~3ë¶„) í•„í„°ë§ ì¤‘...");
                        allVideos = allVideos.filter(video => {
                            const dur = video.contentDetails?.duration;
                            if (!dur) return false;
                            const match = dur.match(/PT(\d+H)?(\d+M)?(\d+S)?/);
                            if (!match) return false;

                            const h = parseInt((match[1] || '').replace('H', '')) || 0;
                            const m = parseInt((match[2] || '').replace('M', '')) || 0;
                            const s = parseInt((match[3] || '').replace('S', '')) || 0;

                            const totalSeconds = h * 3600 + m * 60 + s;
                            // 1 min (60s) <= duration < 3 min (180s)
                            return totalSeconds >= 60 && totalSeconds < 180;
                        });

                        if (allVideos.length === 0) {
                            setLoading(false);
                            document.getElementById('resultsGrid').innerHTML = `
                            <div class="col-span-full text-center py-20">
                                <h3 class="text-xl font-medium text-slate-300">ì¡°ê±´ì— ë§ëŠ” ì˜ìƒì´ ì—†ìŠµë‹ˆë‹¤</h3>
                                <p class="text-slate-500 mt-2">1ë¶„~3ë¶„ ë¯¸ë§Œì˜ ì˜ìƒì„ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</p>
                            </div>
                        `;
                            return;
                        }
                    }

                    // --- 3. Batch Fetch Channels ---
                    const channelIds = [...new Set(allVideos.map(item => item.snippet.channelId))];
                    const channelDetailsPromises = [];
                    for (let i = 0; i < channelIds.length; i += 50) {
                        const chunk = channelIds.slice(i, i + 50).join(',');
                        channelDetailsPromises.push(
                            fetch(`https://www.googleapis.com/youtube/v3/channels?part=statistics&id=${chunk}&key=${YOUTUBE_API_KEY}`)
                                .then(res => res.json())
                        );
                    }

                    setLoading(true, "ì±„ë„ ë°ì´í„°ë¥¼ ë¶„ì„í•˜ê³  ë–¡ìƒ ì§€ìˆ˜ë¥¼ ê³„ì‚° ì¤‘ì…ë‹ˆë‹¤...");
                    const channelsResponses = await Promise.all(channelDetailsPromises);
                    const channelMap = {};
                    channelsResponses.forEach(data => {
                        if (data.items) {
                            data.items.forEach(ch => {
                                channelMap[ch.id] = ch.statistics.subscriberCount;
                            });
                        }
                    });

                    // Get Custom Threshold
                    const viralThreshold = parseInt(document.getElementById('viralThreshold').value);

                    // --- 4. Process & Render ---
                    globalProcessedItems = allVideos.map(video => {
                        const viewCount = parseInt(video.statistics.viewCount || 0);
                        const channelId = video.snippet.channelId;
                        const subscriberCount = parseInt(channelMap[channelId] || 0);

                        let performanceRatio = 0;
                        let ratioDisplay = 'N/A';
                        let isViral = false;

                        if (subscriberCount > 0) {
                            performanceRatio = (viewCount / subscriberCount) * 100;
                            ratioDisplay = performanceRatio.toFixed(1) + '%';
                            if (performanceRatio >= viralThreshold) isViral = true;
                        }

                        // Velocity Calculation (Daily Views)
                        const publishedDate = new Date(video.snippet.publishedAt);
                        const now = new Date();
                        const hoursDiff = Math.abs(now - publishedDate) / 36e5;
                        const daysDiff = hoursDiff / 24;
                        const effectiveDays = daysDiff < 1 ? 1 : daysDiff; // Avoid division by zero, min 1 day
                        const dailyVelocity = viewCount / effectiveDays;

                        let velocityDisplay = formatCompactNumber(dailyVelocity) + '/ì¼';

                        const durationStr = parseDuration(video.contentDetails?.duration);

                        // Format Date relative (e.g., "3 days ago") or absolute
                        const dateDisplay = timeAgo(publishedDate);

                        return {
                            id: video.id,
                            title: video.snippet.title,
                            thumbnail: video.snippet.thumbnails.medium.url,
                            channelId: video.snippet.channelId,
                            channelTitle: video.snippet.channelTitle,
                            publishedAt: publishedDate.toLocaleDateString(),
                            dateDisplay: dateDisplay,
                            duration: durationStr,
                            viewCount: viewCount,
                            subscriberCount: subscriberCount,
                            ratioDisplay: ratioDisplay,
                            velocityDisplay: velocityDisplay,
                            rawVelocity: dailyVelocity,
                            isViral: isViral,
                            rawRatio: performanceRatio
                        };
                    });

                    // Initial Sort: Rising (Ratio)
                    sortResults('ratio');
                    document.getElementById('sortBar').classList.remove('hidden');

                } catch (error) {
                    console.error(error);
                    alert(`ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`);
                } finally {
                    setLoading(false);
                }
            }

            function sortResults(type) {
                const btns = document.querySelectorAll('.sort-btn');
                btns.forEach(btn => {
                    if (btn.dataset.sort === type) {
                        btn.classList.add('bg-brand-600', 'text-white');
                        btn.classList.remove('bg-slate-700', 'text-slate-200');
                    } else {
                        btn.classList.remove('bg-brand-600', 'text-white');
                        btn.classList.add('bg-slate-700', 'text-slate-200');
                    }
                });

                if (type === 'views') {
                    globalProcessedItems.sort((a, b) => b.viewCount - a.viewCount);
                } else if (type === 'subscribers') {
                    globalProcessedItems.sort((a, b) => b.subscriberCount - a.subscriberCount);
                } else if (type === 'ratio') {
                    globalProcessedItems.sort((a, b) => b.rawRatio - a.rawRatio);
                } else if (type === 'velocity') {
                    globalProcessedItems.sort((a, b) => b.rawVelocity - a.rawVelocity);
                }

                renderResults(globalProcessedItems);
            }

            function renderResults(items) {
                const grid = document.getElementById('resultsGrid');
                grid.innerHTML = ''; // Clear existing

                items.forEach((item, index) => {
                    // ... (Existing render logic, mostly same) ...
                    const isViral = item.isViral;
                    const cardClass = isViral
                        ? 'bg-slate-800 rounded-2xl overflow-hidden shadow-lg viral-glow transform transition hover:-translate-y-1 hover:shadow-2xl border border-yellow-500/30'
                        : 'bg-slate-800 rounded-2xl overflow-hidden shadow-lg border border-slate-700 transform transition hover:-translate-y-1 hover:shadow-xl hover:border-slate-600';

                    const badge = isViral
                        ? `<span class="absolute top-2 right-2 bg-yellow-500 text-black text-xs font-bold px-2 py-1 rounded-full shadow-lg z-10 flex items-center gap-1">
                        <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M12.395 2.553a1 1 0 00-1.45-.385c-.345.23-.614.558-.822.88-.214.33-.403.713-.57 1.116-.334.804-.614 1.768-.84 2.734a31.365 31.365 0 00-.613 3.58 2.64 2.64 0 01-.945-1.067c-.328-.68-.398-1.534-.398-2.654A1 1 0 005.05 6.05 6.981 6.981 0 003 11a7 7 0 1011.95-4.95c-.592-.591-.98-.985-1.348-1.467-.363-.476-.724-1.063-1.207-2.03zM12.12 15.12A3 3 0 017 13s.879.5 2.5.5c0-1 .5-4 1.25-4.5.5 1 .786 1.293 1.371 1.879A2.99 2.99 0 0113 13a2.99 2.99 0 01-.879 2.121z" clip-rule="evenodd"/></svg>
                        VIRAL (${item.ratioDisplay})
                       </span>`
                        : `<span class="absolute top-2 right-2 bg-slate-900/80 backdrop-blur text-slate-300 text-xs font-medium px-2 py-1 rounded-full border border-slate-600">
                        ì„±ê³¼: ${item.ratioDisplay}
                       </span>`;

                    const html = `
                    <div class="${cardClass}" style="animation-delay: ${index * 10}ms" data-video-id="${item.id}">
                        <a href="https://www.youtube.com/watch?v=${item.id}" target="_blank" rel="noopener noreferrer" class="block relative aspect-video group">
                            <img src="${item.thumbnail}" alt="${item.title}" class="w-full h-full object-cover transition duration-500 group-hover:scale-105">
                            
                            <!-- Selection Checkbox -->
                            <div class="absolute top-2 left-2 z-20" onclick="event.stopPropagation()">
                                <input type="checkbox" 
                                    id="select-${item.id}" 
                                    class="video-select-checkbox w-5 h-5 rounded border-2 border-white bg-slate-900/50 backdrop-blur checked:bg-brand-500 checked:border-brand-500 cursor-pointer transition-all hover:scale-110"
                                    onchange="toggleVideoSelection('${item.id}')">
                            </div>
                            
                            ${badge}
                            <div class="absolute bottom-2 left-2 bg-brand-600/90 text-white text-xs font-bold px-2 py-0.5 rounded shadow-sm">
                                ğŸš€ ${item.velocityDisplay}
                            </div>
                            <div class="absolute bottom-2 right-2 bg-black/70 text-white text-xs px-1.5 py-0.5 rounded">
                                ${formatNumber(item.viewCount)}íšŒ
                            </div>
                        </a>
                        <div class="p-5">
                            <h3 class="font-bold text-lg mb-2 line-clamp-2 leading-snug text-slate-100 group-hover:text-brand-400 transition-colors">
                                <a href="https://www.youtube.com/watch?v=${item.id}" target="_blank" rel="noopener noreferrer">${item.title}</a>
                            </h3>
                            <div class="flex items-center justify-between text-sm text-slate-400 mb-4">
                                <button onclick="event.stopPropagation(); openChannelModal('${item.channelId}', '${escapeHtml(item.channelTitle)}')" class="flex items-center gap-1 hover:text-brand-400 transition-colors cursor-pointer">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                                    ${item.channelTitle}
                                </button>
                                <span>êµ¬ë…ì ${formatNumber(item.subscriberCount)}</span>
                            </div>
                            <div class="flex items-center gap-3 text-xs text-slate-500 mb-4 font-mono">
                                <span class="flex items-center gap-1 bg-slate-700/50 px-2 py-1 rounded">
                                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                                    ${item.dateDisplay}
                                </span>
                                <span class="flex items-center gap-1 bg-slate-700/50 px-2 py-1 rounded">
                                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                    ${item.duration}
                                </span>
                            </div>
                            
                            <div class="pt-4 border-t border-slate-700/50 space-y-2">
                                <button onclick="reprocessVideo('${item.id}', '${escapeHtml(item.title)}')" class="w-full bg-slate-700 hover:bg-brand-600 text-white font-medium py-2.5 px-4 rounded-lg transition-all flex items-center justify-center gap-2 group">
                                    <svg class="w-5 h-5 text-brand-400 group-hover:text-white transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                                    </svg>
                                    AI ëŒ“ê¸€ + ìë§‰ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
                                </button>
                                <button onclick="downloadThumbnail('${item.thumbnail}', '${escapeHtml(item.title)}')" class="w-full bg-green-700 hover:bg-green-600 text-white font-medium py-2.5 px-4 rounded-lg transition-all flex items-center justify-center gap-2 group">
                                    <svg class="w-5 h-5 text-green-300 group-hover:text-white transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                    </svg>
                                    ì¸ë„¤ì¼ ë‹¤ìš´ë¡œë“œ
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                    grid.innerHTML += html;
                });
            }


            // --- Core Logic: AI Analysis (Client-Side) ---

            async function analyzeVideo(videoIdArgument, videoTitleArgument) {
                // 1. Argument Handling & Platform Detection
                let videoId = videoIdArgument;
                let videoTitle = videoTitleArgument;
                let platform = selectedPlatform || 'youtube'; // Default to YouTube if not selected

                // If argument is missing (called from Main Logic button), get from input
                if (!videoId) {
                    const urlInput = document.getElementById('viralVideoUrl').value.trim();

                    if (!urlInput) {
                        alert('ì˜ìƒ URLì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                        return;
                    }

                    // Simple Platform Detection based on URL
                    if (urlInput.includes('tiktok.com')) platform = 'tiktok';
                    else if (urlInput.includes('instagram.com')) platform = 'instagram';
                    else if (urlInput.includes('youtube.com') || urlInput.includes('youtu.be')) platform = 'youtube';

                    // Extract ID based on platform
                    if (platform === 'youtube') {
                        if (urlInput.includes('/shorts/')) {
                            videoId = urlInput.split('/shorts/')[1].split('?')[0];
                        } else if (urlInput.includes('v=')) {
                            videoId = urlInput.split('v=')[1].split('&')[0];
                        } else if (urlInput.includes('youtu.be/')) {
                            videoId = urlInput.split('youtu.be/')[1].split('?')[0];
                        } else {
                            // Fallback: try to usage URL as ID or alert
                            videoId = urlInput;
                        }
                    } else {
                        // For TikTok/Instagram, we might pass the full URL to the backend
                        videoId = urlInput;
                    }
                }

                if (!videoTitle) {
                    videoTitle = "ë¶„ì„ ëŒ€ìƒ ì˜ìƒ (" + platform + ")";
                }

                console.log(`[Analyze] Platform: ${platform}, ID/URL: ${videoId}`);

                openModal();
                const modalContent = document.getElementById('modalContent');

                // --- TIKTOK / INSTAGRAM LOGIC (via Server Apify) ---
                if (platform === 'tiktok' || platform === 'instagram') {
                    modalContent.innerHTML = `
                    <div class="flex flex-col items-center justify-center py-12 space-y-6">
                        <div class="loader w-12 h-12 border-4 border-t-pink-500"></div>
                        <div class="text-center space-y-2">
                            <p class="text-xl font-semibold text-white">${platform === 'tiktok' ? 'TikTok' : 'Instagram'} ë°ì´í„°ë¥¼ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤...</p>
                            <p class="text-slate-400 text-sm">Apify Actorë¥¼ êµ¬ë™ ì¤‘ì…ë‹ˆë‹¤. (ì•½ 10-20ì´ˆ ì†Œìš”)</p>
                        </div>
                    </div>
                `;

                    try {
                        const res = await fetch('/api/analyze-social', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ url: videoId, platform: platform })
                        });

                        const data = await res.json();

                        if (!res.ok) throw new Error(data.error || 'Social analysis failed');

                        // Success
                        const result = data.data; // { title, transcript, comments, ... }

                        // Update Global State
                        window.currentComments = result.comments;
                        window.currentTranscript = result.transcript;
                        window.currentVideoTitle = result.title;

                        // Render (Re-use existing render logic roughly)
                        renderAnalysisResult(modalContent, result.title, result.comments, result.transcript, videoId);

                    } catch (error) {
                        console.error(error);
                        modalContent.innerHTML = `
                        <div class="bg-red-500/10 border border-red-500/50 rounded-xl p-6 text-center">
                            <h3 class="text-red-400 font-bold text-lg mb-2">ë¶„ì„ ì‹¤íŒ¨</h3>
                            <p class="text-slate-300 text-sm">${error.message}</p>
                        </div>
                    `;
                    }

                    return; // Stop here for social
                }

                // --- YOUTUBE LOGIC (Existing) ---

                // Convert shorts URL to watch URL for better transcript extraction (Double check)
                if (videoId.length > 20 && videoId.includes('/shorts/')) {
                    // If by chance videoId was passed as full URL in existing logic
                    videoId = videoId.split('/shorts/')[1].split('?')[0];
                }

                modalContent.innerHTML = `
                <div class="flex flex-col items-center justify-center py-12 space-y-6">
                    <div class="loader w-12 h-12 border-4 border-t-brand-500"></div>
                    <div class="text-center space-y-2">
                        <p class="text-xl font-semibold text-white">ëŒ“ê¸€ì„ ìˆ˜ì§‘í•˜ê³  ìˆìŠµë‹ˆë‹¤...</p>
                        <p class="text-slate-400 text-sm">ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.</p>
                    </div>
                </div>
            `;

                try {
                    if (!YOUTUBE_API_KEY) throw new Error('YouTube API í‚¤ê°€ ì„¤ì •ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤.');
                    // Apify check removed as we use local server now

                    // 1. Fetch Comments
                    const commentsUrl = `https://www.googleapis.com/youtube/v3/commentThreads?part=snippet&videoId=${videoId}&maxResults=50&order=relevance&textFormat=plainText&key=${YOUTUBE_API_KEY}`;
                    const commentsRes = await fetch(commentsUrl);
                    const commentsData = await commentsRes.json();

                    if (!commentsRes.ok) throw new Error(commentsData.error?.message || 'Failed to fetch comments');

                    const comments = commentsData.items
                        ? commentsData.items
                            .map(item => item.snippet.topLevelComment.snippet.textDisplay)
                            .join('\n- ')
                        : '';

                    if (!comments) {
                        modalContent.innerHTML = `
                        <div class="text-center py-10 text-slate-400">
                            ë¶„ì„í•  ëŒ“ê¸€ì´ ì¶©ë¶„í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ëŒ“ê¸€ ì‚¬ìš©ì´ ì¤‘ì§€ë˜ì—ˆê±°ë‚˜ ëŒ“ê¸€ì´ ì—†ëŠ” ì˜ìƒì…ë‹ˆë‹¤.
                        </div>
                    `;
                        return;
                    }

                    // 2. Update Loading State
                    modalContent.innerHTML = `
                    <div class="flex flex-col items-center justify-center py-12 space-y-6">
                        <div class="loader w-12 h-12 border-4 border-t-accent-500"></div>
                        <div class="text-center space-y-2">
                            <p class="text-xl font-semibold text-white">ìë§‰ì„ ì¶”ì¶œí•˜ê³  ìˆìŠµë‹ˆë‹¤...</p>
                            <p class="text-slate-400 text-sm">ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.</p>
                        </div>
                    </div>
                `;

                    // 3. Fetch Transcript via Server (youtube-transcript)
                    let transcriptText = '';
                    try {
                        const transcriptRes = await fetch('http://localhost:4000/api/get-transcript', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ videoId: videoId })
                        });

                        if (!transcriptRes.ok) {
                            const errorData = await transcriptRes.json();
                            console.warn('Transcript fetch failed:', errorData);
                            transcriptText = `(ìë§‰ ì¶”ì¶œ ì‹¤íŒ¨) ${errorData.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}`;
                        } else {
                            const transcriptData = await transcriptRes.json();
                            if (transcriptData.success) {
                                transcriptText = transcriptData.transcript;
                            } else {
                                transcriptText = "(ìë§‰ ì—†ìŒ)";
                            }
                        }
                    } catch (e) {
                        console.error('Transcript API Error:', e);
                        transcriptText = "(ìë§‰ ì¶”ì¶œ ì¤‘ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜)";
                    }

                    if (!transcriptText) transcriptText = "(ìë§‰ ì—†ìŒ)";

                    const trimmedTranscript = transcriptText.slice(0, 50000);
                    const trimmedComments = comments.slice(0, 8000);
                    window.currentComments = trimmedComments;
                    window.currentTranscript = trimmedTranscript;
                    window.currentVideoTitle = videoTitle;

                    // 4. Render Results
                    renderAnalysisResult(modalContent, videoTitle, trimmedComments, trimmedTranscript, videoId);

                } catch (error) {
                    console.error(error);
                    modalContent.innerHTML = `
    <div class="bg-red-500/10 border border-red-500/50 rounded-xl p-6 text-center">
        <h3 class="text-red-400 font-bold text-lg mb-2">ë°ì´í„° ê°€ì ¸ì˜¤ê¸° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤</h3>
        <p class="text-slate-300 text-sm">${error.message}</p>
    </div>
    `;
                }
            }

            // Helper to render analysis result (Shared between YouTube and TikTok)
            function renderAnalysisResult(container, title, comments, transcript, videoId) {
                container.innerHTML = `
                    <div class="space-y-6">
                        <div>
                            <h3 class="text-xl font-bold text-white mb-2">ì˜ìƒ ì œëª©</h3>
                            <p class="text-slate-300 bg-slate-800 p-4 rounded-lg border border-slate-700">${title}</p>
                        </div>

                        <div>
                            <h3 class="text-xl font-bold text-white mb-2">ì‹œì²­ì ëŒ“ê¸€ (Top 50)</h3>
                            <textarea id="commentsText" class="w-full h-60 bg-slate-800/50 p-4 rounded-lg border border-slate-700 text-slate-300 font-sans text-sm focus:outline-none focus:ring-2 focus:ring-brand-500 resize-none custom-scrollbar" placeholder="ëŒ“ê¸€ì„ ë¶™ì—¬ë„£ê±°ë‚˜ ìˆ˜ë™ìœ¼ë¡œ ì…ë ¥í•˜ì„¸ìš”...">${comments || '(No comments available)'}</textarea>
                        </div>

                        <div>
                            <div class="flex justify-between items-center mb-2">
                                <h3 class="text-xl font-bold text-white">ì˜ìƒ ìë§‰ (Transcript)</h3>
                                <div class="flex gap-2">
                                    <select id="aiProvider" class="bg-slate-700 text-white text-sm rounded-lg px-3 py-1.5 focus:outline-none focus:ring-2 focus:ring-accent-500">
                                        <option value="gemini">Gemini 2.5 Flash</option>
                                        <option value="claude">Claude Sonnet 4.5</option>
                                    </select>
                                    <select id="rewriteStyle" class="bg-slate-700 text-white text-sm rounded-lg px-3 py-1.5 focus:outline-none focus:ring-2 focus:ring-brand-500">
                                        <optgroup label="ğŸ“± ìˆí¼ (5000ì ë¯¸ë§Œ)">
                                            <option value="viral_shorts">ğŸ”¥ ë°”ì´ëŸ´ Shorts (500-800ì)</option>
                                            <option value="viral_shorts_reverse">ğŸ”„ ë°”ì´ëŸ´ Shorts ì—­ìˆœ (500-800ì)</option>
                                            <option value="viral_shorts_loop">ğŸ” ë°”ì´ëŸ´ Shorts ë£¨í”„ (500-800ì)</option>
                                            <option value="humor">ìœ ë¨¸ (800~900ì)</option>
                                            <option value="senior_shorts_drama">ì‹œë‹ˆì–´ Shorts Drama (1300ì)</option>
                                            <option value="senior_shorts_drama_reverse">ì‹œë‹ˆì–´ Shorts - ì—­ìˆœ êµ¬ì¡° (1300ì)</option>
                                            <option value="senior_shorts_drama_thirdperson">ì‹œë‹ˆì–´ Shorts - 3ì¸ì¹­ ì‹œì  (1300ì)</option>
                                            <option value="senior_shorts_drama_detail">ì‹œë‹ˆì–´ Shorts - ë””í…Œì¼ ë³€ê²½ (1300ì)</option>
                                        </optgroup>
                                        <optgroup label="ğŸ“º ë¡±í¼ (5000ì ì´ìƒ)">
                                            <option value="mystery">ë¯¸ìŠ¤í„°ë¦¬</option>
                                            <option value="senior_news">ì‹œë‹ˆì–´ë‰´ìŠ¤</option>
                                            <option value="touching_story">ê°ë™/í•´ì™¸ì‚¬ì—°</option>
                                            <option value="economy">ê²½ì œ</option>
                                        </optgroup>
                                    </select>
                                    <button onclick="rewriteScript('${videoId}')" class="bg-brand-600 hover:bg-brand-500 text-white text-sm font-bold px-4 py-1.5 rounded-lg transition-colors shadow-lg">
                                        ëŒ€ë³¸ ì¬ì‘ì„±
                                    </button>
                                    <button onclick="extractWhisperTranscript('${videoId}')" class="bg-purple-600 hover:bg-purple-500 text-white text-sm font-bold px-4 py-1.5 rounded-lg transition-colors shadow-lg" title="ì‹¤ì œ ëŒ€ì‚¬ í¬í•¨ (ì²˜ë¦¬ ì‹œê°„ +30-60ì´ˆ)">
                                        ğŸ™ï¸ Whisper ì¶”ì¶œ (ëŠë¦¼)
                                    </button>
                                </div>
                            </div>
                            ${transcript && transcript !== '(ìë§‰ ì¶”ì¶œ ì‹¤íŒ¨)' && transcript !== '(ìë§‰ ì—†ìŒ)' && transcript !== '(ìë§‰ ì¶”ì¶œ ì¤‘ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜)' ? `
                                <div class="mb-2 p-2 bg-green-900/20 border border-green-500/30 rounded-lg">
                                    <p class="text-green-400 text-sm">âœ… ìë§‰ì´ ìë™ìœ¼ë¡œ ì¶”ì¶œë˜ì—ˆìŠµë‹ˆë‹¤. í•„ìš”ì‹œ ì•„ë˜ì—ì„œ ìˆ˜ì • ê°€ëŠ¥í•©ë‹ˆë‹¤.</p>
                                </div>
                            ` : `
                                <div class="mb-2 p-2 bg-yellow-900/20 border border-yellow-500/30 rounded-lg">
                                    <p class="text-yellow-400 text-sm">âš ï¸ ìë§‰ ìë™ ì¶”ì¶œ ì‹¤íŒ¨. YouTube Summary Extension ë“±ìœ¼ë¡œ ìë§‰ì„ ë³µì‚¬í•´ì„œ ì•„ë˜ì— ë¶™ì—¬ë„£ì–´ì£¼ì„¸ìš”.</p>
                                </div>
                            `}
                            <textarea id="transcriptText" class="w-full h-96 bg-slate-800/50 p-4 rounded-lg border border-slate-700 text-slate-300 font-sans text-sm focus:outline-none focus:ring-2 focus:ring-brand-500 resize-y" placeholder="ì—¬ê¸°ì— ìë§‰ì„ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”...">${transcript}</textarea>
                        </div>

                        <div id="rewriteSection" class="hidden">
                            <h3 class="text-xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-brand-400 to-accent-500 mb-2">AI ì¬ì‘ì„± ëŒ€ë³¸</h3>
                            <div id="rewriteResult" class="prose prose-invert prose-sm max-w-none bg-slate-800/50 p-4 rounded-lg border-2 border-brand-500/30 max-h-96 overflow-y-auto custom-scrollbar shadow-lg viral-glow">
                                <!-- Result will appear here -->
                            </div>
                            
                            <!-- Translation Button (below Korean script) -->
                            <div class="mt-4 flex justify-center">
                                <button onclick="translateScriptToJapanese()" id="translateJapaneseBtn" class="bg-gradient-to-r from-red-600 to-orange-600 hover:from-red-500 hover:to-orange-500 text-white font-bold px-6 py-3 rounded-lg transition-all shadow-lg flex items-center gap-2 hover:scale-105">
                                    <span class="text-xl">ğŸ‡¯ğŸ‡µ</span>
                                    <span>ì¼ë³¸ì–´ë¡œ ë²ˆì—­ + ë°œìŒ ìƒì„±</span>
                                </button>
                            </div>
                            
                            <!-- Japanese Translation Section -->
                            <div id="japaneseSection" class="hidden mt-6">
                                <div class="flex justify-between items-center mb-3">
                                    <h3 class="text-xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-red-400 to-orange-500">ğŸ‡¯ğŸ‡µ ì¼ë³¸ì–´ ë²ˆì—­ ê²°ê³¼</h3>
                                    <button onclick="copyTranslationToText()" class="bg-slate-700 hover:bg-slate-600 text-white text-sm font-bold px-4 py-2 rounded-lg transition-all shadow-md flex items-center gap-2">
                                        <span>ğŸ“‹</span>
                                        <span>í…ìŠ¤íŠ¸ ë³µì‚¬</span>
                                    </button>
                                </div>
                                <div id="japaneseResult" class="bg-slate-800/50 p-6 rounded-lg border-2 border-orange-500/30 max-h-96 overflow-y-auto custom-scrollbar shadow-lg">
                                    <!-- Japanese translation will appear here -->
                                </div>
                            </div>
                        </div>
                    </div>
    `;
            }

            // Download video thumbnail
            async function downloadThumbnail(thumbnailUrl, videoTitle) {
                try {
                    // Try to get maxres thumbnail by replacing any default quality suffix
                    // Covers: default.jpg, mqdefault.jpg, hqdefault.jpg, sddefault.jpg
                    const highResUrl = thumbnailUrl.replace(/\/(default|mqdefault|hqdefault|sddefault)\.jpg/, '/maxresdefault.jpg');

                    // Fetch the image
                    const response = await fetch(highResUrl);
                    if (!response.ok) {
                        // Fallback to original thumbnail if maxres doesn't exist
                        const fallbackResponse = await fetch(thumbnailUrl);
                        if (!fallbackResponse.ok) throw new Error('Failed to download thumbnail');
                        const blob = await fallbackResponse.blob();
                        downloadBlob(blob, videoTitle);
                    } else {
                        const blob = await response.blob();
                        downloadBlob(blob, videoTitle);
                    }
                } catch (error) {
                    console.error('Thumbnail download error:', error);
                    alert('ì¸ë„¤ì¼ ë‹¤ìš´ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message);
                }
            }

            function downloadBlob(blob, videoTitle) {
                // Create sanitized filename from video title
                const sanitized = videoTitle
                    .replace(/[<>:"/\\|?*]/g, '') // Remove invalid characters
                    .replace(/\s+/g, '_') // Replace spaces with underscores
                    .substring(0, 100); // Limit length

                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${sanitized}_thumbnail.jpg`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
            }

            async function extractWhisperTranscript(videoId) {
                const transcriptTextarea = document.getElementById('transcriptText');
                if (!transcriptTextarea) return;

                // Show loading state
                const originalValue = transcriptTextarea.value;
                transcriptTextarea.value = originalValue + '\n\nâ³ Whisperë¡œ ì˜¤ë””ì˜¤ ì¶”ì¶œ ì¤‘... (30-60ì´ˆ ì†Œìš”)\nì‹¤ì œ ëŒ€ì‚¬ë¥¼ í¬í•¨í•œ ì™„ì „í•œ ìë§‰ì„ ê°€ì ¸ì˜¤ê³  ìˆìŠµë‹ˆë‹¤...';
                transcriptTextarea.disabled = true;

                try {
                    const response = await fetch('http://localhost:4000/api/whisper-transcript', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ videoId })
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.message || errorData.error || 'Whisper ì¶”ì¶œ ì‹¤íŒ¨');
                    }

                    const data = await response.json();

                    if (data.success && data.transcript) {
                        // Add Whisper transcript below YouTube captions
                        transcriptTextarea.value = originalValue + '\n\n' + '='.repeat(50) + '\nğŸ™ï¸ Whisper ì˜¤ë””ì˜¤ ì¶”ì¶œ (ì‹¤ì œ ëŒ€ì‚¬ í¬í•¨)\n' + '='.repeat(50) + '\n\n' + data.transcript;

                        // Update global variable for rewriting
                        window.currentTranscript = transcriptTextarea.value;

                        alert('âœ… Whisper ì¶”ì¶œ ì™„ë£Œ!\nì‹¤ì œ ëŒ€ì‚¬ê°€ í¬í•¨ëœ ì™„ì „í•œ ìë§‰ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.');
                    } else {
                        throw new Error('Whisper ì‘ë‹µì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤');
                    }
                } catch (error) {
                    console.error('Whisper Error:', error);
                    transcriptTextarea.value = originalValue;

                    if (error.message.includes('npm install')) {
                        alert('âš ï¸ Whisper ê¸°ëŠ¥ ì‚¬ìš© ë¶ˆê°€\n\n' + error.message);
                    } else {
                        alert('âŒ Whisper ì¶”ì¶œ ì‹¤íŒ¨\n\n' + error.message + '\n\nOpenAI API í‚¤ê°€ ì˜¬ë°”ë¥¸ì§€ í™•ì¸í•˜ì„¸ìš”.');
                    }
                } finally {
                    transcriptTextarea.disabled = false;
                }
            }

            async function rewriteScript(videoId) {
                const style = document.getElementById('rewriteStyle').value;
                const aiProvider = document.getElementById('aiProvider').value;
                const videoTitle = window.currentVideoTitle || '';

                const rewriteSection = document.getElementById('rewriteSection');
                const rewriteResult = document.getElementById('rewriteResult');

                // Read comments from textarea (supports manual paste)
                const commentsTextarea = document.getElementById('commentsText');
                const comments = commentsTextarea ? commentsTextarea.value : window.currentComments;

                if (!comments) {
                    alert('ëŒ“ê¸€ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ëŒ“ê¸€ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                    return;
                }

                rewriteSection.classList.remove('hidden');
                rewriteResult.innerHTML = `
    <div class="flex flex-col items-center justify-center py-8 space-y-4">
        <div class="loader w-8 h-8 border-4 border-t-brand-500"></div>
        <p class="text-brand-400 animate-pulse text-sm">ëŒ€ë³¸ì„ ì¬ì‘ì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤... (${aiProvider === 'claude' ? 'Claude' : 'Gemini'} - ${style})</p>
    </div>
    `;

                // Scroll to the rewrite section
                rewriteSection.scrollIntoView({ behavior: 'smooth' });

                try {
                    // Read transcript from textarea (supports manual paste)
                    const transcriptTextarea = document.getElementById('transcriptText');
                    const transcript = transcriptTextarea ? transcriptTextarea.value : window.currentTranscript;

                    if (!transcript || transcript.trim().length === 0) {
                        alert('ìë§‰ì„ ì…ë ¥í•´ì£¼ì„¸ìš”. YouTube Summary Extension ë“±ìœ¼ë¡œ ìë§‰ì„ ë³µì‚¬í•´ì„œ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”.');
                        return;
                    }

                    const res = await fetch('/api/transcript-rewrite', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            videoId,
                            videoTitle,
                            comments,
                            transcript, // Pass the actual transcript from frontend
                            style,
                            aiProvider
                        })
                    });

                    const data = await res.json();

                    if (!res.ok) throw new Error(data.error || 'Rewrite failed');

                    rewriteResult.innerHTML = `
    <pre class="whitespace-pre-wrap font-sans text-slate-300">${data.scriptMarkdown}</pre>`;

                } catch (error) {
                    console.error(error);
                    rewriteResult.innerHTML = `
    <div class="text-red-400 text-center py-4">
        ëŒ€ë³¸ ì‘ì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}
    </div>
    `;
                }
            }

            // Translate Korean Script to Japanese with Pronunciation
            async function translateScriptToJapanese() {
                const rewriteResult = document.getElementById('rewriteResult');
                const japaneseSection = document.getElementById('japaneseSection');
                const japaneseResult = document.getElementById('japaneseResult');
                const translateBtn = document.getElementById('translateJapaneseBtn');

                // Get Korean script from rewriteResult
                const koreanScript = rewriteResult.textContent.trim();

                if (!koreanScript || koreanScript.length < 10) {
                    alert('ë¨¼ì € ëŒ€ë³¸ì„ ìƒì„±í•´ì£¼ì„¸ìš”.');
                    return;
                }

                // Show loading state
                translateBtn.disabled = true;
                translateBtn.innerHTML = '<span class="animate-pulse">ë²ˆì—­ ì¤‘...</span>';
                japaneseSection.classList.remove('hidden');
                japaneseResult.innerHTML = `
                <div class="flex items-center justify-center py-8">
                    <div class="loader w-8 h-8 border-4 border-t-orange-500"></div>
                    <p class="ml-4 text-orange-400 animate-pulse">ì¼ë³¸ì–´ë¡œ ë²ˆì—­í•˜ê³  ìˆìŠµë‹ˆë‹¤...</p>
                </div>
            `;

                try {
                    const response = await fetch('/api/translate-to-japanese', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ koreanScript })
                    });

                    const data = await response.json();

                    if (!response.ok) {
                        throw new Error(data.error || 'ë²ˆì—­ ì‹¤íŒ¨');
                    }

                    // Store translation data globally for copy function
                    window.currentTranslationData = data.translation;

                    // Display translation in section-based format
                    japaneseResult.innerHTML = `
                    <div class="space-y-6">
                        ${data.translation.map((section, idx) => `
                            <div class="bg-slate-900/50 rounded-lg border border-slate-700 p-4">
                                <h4 class="text-lg font-bold text-orange-400 mb-3">${section.section || ''}</h4>
                                <div class="space-y-2">
                                    <div>
                                        <p class="text-xs font-semibold text-slate-500 mb-1">ğŸ‡°ğŸ‡· í•œêµ­ì–´</p>
                                        <p class="text-sm text-slate-200 leading-relaxed">${section.korean || ''}</p>
                                    </div>
                                    <div>
                                        <p class="text-xs font-semibold text-slate-500 mb-1">ğŸ‡¯ğŸ‡µ ì¼ë³¸ì–´</p>
                                        <p class="text-sm text-white font-medium leading-relaxed">${section.japanese || ''}</p>
                                    </div>
                                    <div>
                                        <p class="text-xs font-semibold text-slate-500 mb-1">ğŸ”Š ë°œìŒ (í•œê¸€)</p>
                                        <p class="text-sm text-orange-300 leading-relaxed">${section.pronunciation || ''}</p>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;

                    // Scroll to Japanese section
                    japaneseSection.scrollIntoView({ behavior: 'smooth', block: 'nearest' });

                } catch (error) {
                    console.error('Translation error:', error);
                    japaneseResult.innerHTML = `
                    <div class="text-center py-4 text-red-400">
                        ë²ˆì—­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}
                    </div>
                `;
                } finally {
                    // Restore button
                    translateBtn.disabled = false;
                    translateBtn.innerHTML = `
                    <span class="text-lg">ğŸ‡¯ğŸ‡µ</span>
                    <span>ì¼ë³¸ì–´ ë²ˆì—­ + ë°œìŒ</span>
                `;
                }
            }

            // Copy Japanese translation to clipboard
            function copyTranslationToText() {
                if (!window.currentTranslationData || window.currentTranslationData.length === 0) {
                    alert('ë²ˆì—­ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                    return;
                }

                // Format translation data as text
                const textLines = window.currentTranslationData.map(section => {
                    return `${section.section || ''}\n\ní•œêµ­ì–´:\n${section.korean || ''}\n\nì¼ë³¸ì–´:\n${section.japanese || ''}\n\në°œìŒ (í•œê¸€):\n${section.pronunciation || ''}\n\n${'='.repeat(50)}`;
                }).join('\n\n');

                // Copy to clipboard
                navigator.clipboard.writeText(textLines).then(() => {
                    // Show success feedback
                    const btn = event.target.closest('button');
                    const originalHTML = btn.innerHTML;
                    btn.innerHTML = '<span>âœ…</span><span>ë³µì‚¬ ì™„ë£Œ!</span>';
                    btn.classList.add('bg-green-600');

                    setTimeout(() => {
                        btn.innerHTML = originalHTML;
                        btn.classList.remove('bg-green-600');
                    }, 2000);
                }).catch(err => {
                    console.error('ë³µì‚¬ ì‹¤íŒ¨:', err);
                    alert('ë³µì‚¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                });
            }

            // --- Utility Functions ---

            function timeAgo(date) {
                const seconds = Math.floor((new Date() - date) / 1000);
                let interval = seconds / 31536000;
                if (interval > 1) return Math.floor(interval) + "ë…„ ì „";
                interval = seconds / 2592000;
                if (interval > 1) return Math.floor(interval) + "ê°œì›” ì „";
                interval = seconds / 86400;
                if (interval > 1) return Math.floor(interval) + "ì¼ ì „";
                interval = seconds / 3600;
                if (interval > 1) return Math.floor(interval) + "ì‹œê°„ ì „";
                return "ë°©ê¸ˆ ì „";
            }

            function parseDuration(duration) {
                if (!duration) return "";
                const match = duration.match(/PT(\d+H)?(\d+M)?(\d+S)?/);
                if (!match) return ""; // Return empty string if format doesn't match

                const hours = (match[1] || '').replace('H', '');
                const minutes = (match[2] || '').replace('M', '');
                const seconds = (match[3] || '').replace('S', '');

                let parts = [];
                if (hours) parts.push(hours);
                parts.push(minutes.padStart(hours ? 2 : 1, '0') || '0');
                parts.push(seconds.padStart(2, '0') || '00');

                // Format nice text e.g. "12ë¶„ 30ì´ˆ" or "1ì‹œê°„ 2ë¶„" if preferred, 
                // but standard timestamp "12:30" is cleaner for cards. 
                // Let's use Korean format since user asked for "ëª‡ë¶„ì§œë¦¬".

                let str = "";
                if (hours) str += `${hours}ì‹œê°„ `;
                if (minutes) str += `${minutes}ë¶„ `;
                if (seconds && !hours && !minutes) str += `${seconds}ì´ˆ`; // Only show seconds if < 1 min
                else if (seconds) str += `${seconds}ì´ˆ`;

                return str || "0ì´ˆ";
            }

            function formatCompactNumber(number) {
                const formatter = Intl.NumberFormat('ko', { notation: "compact" });
                return formatter.format(Math.floor(number));
            }

            function formatNumber(num) {
                if (num >= 10000) {
                    return (num / 10000).toFixed(1) + 'ë§Œ';
                }
                return num.toLocaleString();
            }

            function formatDate(dateStr) {
                if (!dateStr) return '';
                const date = new Date(dateStr);
                return date.toLocaleDateString('ko-KR', { year: 'numeric', month: 'long', day: 'numeric' });
            }

            function escapeHtml(text) {
                if (!text) return '';
                return text
                    .replace(/&/g, "&amp;")
                    .replace(/</g, "&lt;").replace(/>/g, "&gt;")
                    .replace(/"/g, "&quot;")
                    .replace(/'/g, "&#039;");
            }

            function setLoading(isLoading, message = "") {
                const loading = document.getElementById('loading');
                const loadingText = document.getElementById('loadingText');

                if (isLoading) {
                    loading.classList.remove('hidden');
                    loadingText.textContent = message;
                } else {
                    loading.classList.add('hidden');
                }
            }

            // ===== Social Media Viral Finder Functions =====
            let selectedPlatform = 'tiktok'; // default

            function selectPlatform(platform) {
                selectedPlatform = platform;

                // Update button states
                document.getElementById('platformTikTok').classList.remove('border-pink-500', 'from-pink-600', 'to-rose-600');
                document.getElementById('platformInstagram').classList.remove('border-pink-500', 'from-pink-600', 'to-rose-600');
                document.getElementById('platformFacebook').classList.remove('border-pink-500', 'from-pink-600', 'to-rose-600');

                if (platform === 'tiktok') {
                    const btn = document.getElementById('platformTikTok');
                    btn.classList.add('border-pink-500', 'from-pink-600', 'to-rose-600');

                    // Hide engagement filters for TikTok (top 30 by views automatically)
                    document.getElementById('engagementFilters').style.display = 'none';
                } else if (platform === 'instagram') {
                    const btn = document.getElementById('platformInstagram');
                    btn.classList.add('border-pink-500', 'from-pink-600', 'to-rose-600');

                    // Hide engagement filters for Instagram (top 30 by engagement automatically)
                    document.getElementById('engagementFilters').style.display = 'none';
                } else if (platform === 'facebook') {
                    const btn = document.getElementById('platformFacebook');
                    btn.classList.add('border-pink-500', 'from-pink-600', 'to-rose-600');

                    // Hide engagement filters for Facebook (top 30 by engagement automatically)
                    document.getElementById('engagementFilters').style.display = 'none';
                }
            }

            async function searchSocialViral() {
                const timePeriod = document.getElementById('socialTimePeriod').value;
                const language = document.getElementById('socialLanguage').value;
                const category = document.getElementById('socialCategory').value;

                const filters = {
                    minLikes: parseInt(document.getElementById('minLikes').value) || 100000,
                    minComments: parseInt(document.getElementById('minComments').value) || 1000,
                    minSaves: parseInt(document.getElementById('minSaves').value) || 5000,
                    minShares: parseInt(document.getElementById('minShares').value) || 1000
                };

                // Show loading
                const btn = document.getElementById('socialSearchBtn');
                const originalText = btn.innerHTML;
                btn.disabled = true;
                btn.innerHTML = `
                <div class="loader w-6 h-6 border-4 border-t-white"></div>
                <span>ê²€ìƒ‰ ì¤‘...</span>
            `;

                try {
                    const response = await fetch('http://localhost:4000/api/find-viral-social', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            platform: selectedPlatform,
                            timePeriod,
                            language,
                            category,
                            filters
                        })
                    });

                    const data = await response.json();

                    if (!response.ok) {
                        throw new Error(data.error || 'ê²€ìƒ‰ ì‹¤íŒ¨');
                    }

                    displaySocialViralResults(data.videos);

                    // Show results container
                    document.getElementById('socialViralResults').classList.remove('hidden');
                    document.getElementById('socialResultCount').textContent = `${data.count}ê°œ ì˜ìƒ ë°œê²¬`;

                } catch (error) {
                    console.error('Social viral search error:', error);
                    alert(`ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}\n\nì°¸ê³ : ì´ ê¸°ëŠ¥ì€ Apifyì™€ Whisper API ì—°ë™ì´ í•„ìš”í•©ë‹ˆë‹¤.`);
                } finally {
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                }
            }

            function displaySocialViralResults(videos) {
                const grid = document.getElementById('socialViralGrid');

                if (!videos || videos.length === 0) {
                    grid.innerHTML = `
                    <div class="col-span-full text-center py-12">
                        <p class="text-slate-400 text-lg">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
                        <p class="text-slate-500 text-sm mt-2">í•„í„° ì¡°ê±´ì„ ì¡°ì •í•´ë³´ì„¸ìš”.</p>
                    </div>
                `;
                    return;
                }

                grid.innerHTML = videos.map(video => `
                <div class="bg-slate-800/50 rounded-xl overflow-hidden border border-slate-700 hover:border-pink-500/50 transition group">
                    <div class="relative aspect-[9/16] bg-slate-900">
                        <img src="${video.thumbnail}" alt="Thumbnail" class="w-full h-full object-cover">
                        <div class="absolute top-2 right-2 bg-black/60 backdrop-blur-sm px-2 py-1 rounded text-xs font-bold text-white">
                            ğŸ”¥ ${video.outlierScore}
                        </div>
                    </div>
                    <div class="p-4">
                        <h4 class="text-white font-bold text-sm mb-2 line-clamp-2">${escapeHtml(video.title)}</h4>
                        <p class="text-slate-400 text-xs mb-3">@${escapeHtml(video.author)}</p>
                        
                        <div class="grid grid-cols-2 gap-2 mb-3 text-xs">
                            <div class="flex items-center gap-1 text-pink-400">
                                <span>ğŸ’—</span>
                                <span>${formatSocialNumber(video.likes)}</span>
                            </div>
                            <div class="flex items-center gap-1 text-blue-400">
                                <span>ğŸ’¬</span>
                                <span>${formatSocialNumber(video.comments)}</span>
                            </div>
                            <div class="flex items-center gap-1 text-yellow-400">
                                <span>ğŸ”–</span>
                                <span>${formatSocialNumber(video.saves)}</span>
                            </div>
                            <div class="flex items-center gap-1 text-green-400">
                                <span>â†—ï¸</span>
                                <span>${formatSocialNumber(video.shares)}</span>
                            </div>
                        </div>
                        
                        <div class="flex gap-2">
                            <button onclick="analyzeSocialVideo('${video.url}')" 
                                class="flex-1 bg-gradient-to-r from-pink-600 to-rose-600 hover:from-pink-500 hover:to-rose-500 text-white text-xs font-bold py-2 px-3 rounded-lg transition">
                                ë¶„ì„í•˜ê¸°
                            </button>
                            <a href="${video.url}" target="_blank"
                                class="bg-slate-700 hover:bg-slate-600 text-white text-xs font-bold py-2 px-3 rounded-lg transition flex items-center justify-center">
                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
                                </svg>
                            </a>
                        </div>
                    </div>
                </div>
            `).join('');
            }

            function formatSocialNumber(num) {
                if (!num) return '0';
                if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
                if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
                return num.toString();
            }

            async function analyzeSocialVideo(videoUrl) {
                alert(`TikTok/Instagram ì˜ìƒ ë¶„ì„ ê¸°ëŠ¥ì€ Whisper API ì—°ë™ í›„ ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.\n\nì˜ìƒ URL: ${videoUrl}\n\në‹¤ìŒ ë‹¨ê³„:\n1. ì˜ìƒ ë‹¤ìš´ë¡œë“œ (yt-dlp)\n2. Whisperë¡œ ìë§‰ ìƒì„±\n3. ëŒ€ë³¸ ì¬ì‘ì„±`);

                // TODO: Implement actual analysis
                // 1. Download video using yt-dlp
                // 2. Generate transcript using Whisper
                // 3. Open modal with transcript and rewrite options
            }
            // ===== End Social Media Viral Finder Functions =====

            function openModal() {
                document.getElementById('analysisModal').classList.remove('hidden');
                document.body.style.overflow = 'hidden';
            }

            function closeModal() {
                document.getElementById('analysisModal').classList.add('hidden');
                document.body.style.overflow = 'auto';
            }

            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // Multi-Video Script Generation Functions
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

            let selectedAIProvider = 'gemini'; // Default

            function toggleVideoSelection(videoId) {
                const checkbox = document.getElementById(`select-${videoId}`);

                if (checkbox.checked) {
                    // Add to selection
                    if (globalSelectedVideos.length >= 5) {
                        alert('ìµœëŒ€ 5ê°œ ì˜ìƒê¹Œì§€ë§Œ ì„ íƒ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
                        checkbox.checked = false;
                        return;
                    }
                    // Find video data from globalProcessedItems
                    const videoData = globalProcessedItems.find(item => item.id === videoId);
                    if (videoData) {
                        globalSelectedVideos.push(videoData);
                    }
                } else {
                    // Remove from selection
                    globalSelectedVideos = globalSelectedVideos.filter(v => v.id !== videoId);
                }

                updateSelectionUI();
            }

            function updateSelectionUI() {
                const count = globalSelectedVideos.length;
                const floatingBtn = document.getElementById('floatingActionBtn');
                const counter = document.getElementById('selectionCounter');

                counter.textContent = count;

                if (count > 0) {
                    floatingBtn.classList.remove('hidden');
                } else {
                    floatingBtn.classList.add('hidden');
                }
            }

            function openScriptGenerationModal() {
                if (globalSelectedVideos.length === 0) {
                    alert('ë¨¼ì € ì˜ìƒì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                    return;
                }

                const modal = document.getElementById('scriptGenerationModal');
                const countDisplay = document.getElementById('selectedVideoCount');
                const preview = document.getElementById('selectedVideosPreview');

                countDisplay.textContent = `${globalSelectedVideos.length}ê°œ ì˜ìƒ ì„ íƒë¨`;

                // Populate preview
                preview.innerHTML = globalSelectedVideos.map((v, idx) => `
                <div class="mb-2 pb-2 border-b border-slate-700 last:border-0">
                    <span class="font-bold text-brand-400">${idx + 1}.</span> ${v.title}
                </div>
            `).join('');

                // Reset generated script display
                document.getElementById('generatedScriptContainer').classList.add('hidden');
                document.getElementById('generatedScriptContent').innerHTML = '';

                // Select default AI provider
                selectAIProvider('gemini');

                modal.classList.remove('hidden');
            }

            function closeScriptModal() {
                document.getElementById('scriptGenerationModal').classList.add('hidden');
            }

            function selectAIProvider(provider) {
                selectedAIProvider = provider;

                // Update UI
                const geminiBtn = document.getElementById('aiProviderGemini');
                const claudeBtn = document.getElementById('aiProviderClaude');

                if (provider === 'gemini') {
                    geminiBtn.classList.add('border-brand-500', 'bg-brand-900/30');
                    geminiBtn.classList.remove('border-slate-700');
                    claudeBtn.classList.remove('border-accent-500', 'bg-accent-900/30');
                    claudeBtn.classList.add('border-slate-700');
                } else {
                    claudeBtn.classList.add('border-accent-500', 'bg-accent-900/30');
                    claudeBtn.classList.remove('border-slate-700');
                    geminiBtn.classList.remove('border-brand-500', 'bg-brand-900/30');
                    geminiBtn.classList.add('border-slate-700');
                }
            }

            async function generateScriptFromSelected() {
                const generateBtn = document.getElementById('generateScriptBtn');
                const scriptContainer = document.getElementById('generatedScriptContainer');
                const scriptContent = document.getElementById('generatedScriptContent');

                // Show loading
                generateBtn.disabled = true;
                generateBtn.innerHTML = `
                <div class="loader w-5 h-5 border-2 border-t-white"></div>
                <span>ëŒ€ë³¸ ìƒì„± ì¤‘...</span>
            `;

                scriptContainer.classList.remove('hidden');
                scriptContent.innerHTML = `
                <div class="flex flex-col items-center justify-center py-12 space-y-4">
                    <div class="loader w-12 h-12 border-4 border-t-brand-500"></div>
                    <p class="text-slate-400 animate-pulse">ìë§‰ì„ ìˆ˜ì§‘í•˜ê³  AIê°€ ëŒ€ë³¸ì„ ìƒì„±í•˜ëŠ” ì¤‘ì…ë‹ˆë‹¤...</p>
                    <p class="text-xs text-slate-500">ì„ íƒëœ ${globalSelectedVideos.length}ê°œ ì˜ìƒ ë¶„ì„ ì¤‘</p>
                </div>
            `;

                try {
                    // Step 1: Fetch transcripts and comments for all selected videos
                    const videosWithData = await Promise.all(globalSelectedVideos.map(async (video) => {
                        try {
                            // Fetch comments
                            const commentsUrl = `https://www.googleapis.com/youtube/v3/commentThreads?part=snippet&videoId=${video.id}&maxResults=10&order=relevance&textFormat=plainText&key=${YOUTUBE_API_KEY}`;
                            const commentsRes = await fetch(commentsUrl);
                            const commentsData = await commentsRes.json();
                            const comments = commentsData.items
                                ? commentsData.items.map(item => item.snippet.topLevelComment.snippet.textDisplay).join('\n- ')
                                : 'ëŒ“ê¸€ ì—†ìŒ';

                            // Fetch transcript via our own backend (using youtube-transcript)
                            let transcript = 'ìë§‰ ì—†ìŒ';
                            try {
                                const transcriptRes = await fetch('http://localhost:4000/api/get-transcript', {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({ videoId: video.id })
                                });
                                const transcriptData = await transcriptRes.json();

                                if (transcriptRes.ok && transcriptData.success) {
                                    transcript = transcriptData.transcript;
                                } else {
                                    console.warn(`Transcript fetch failed logic: ${transcriptData.error}`);
                                }
                            } catch (e) {
                                console.warn('Transcript fetch err:', e);
                            }

                            return {
                                videoId: video.id,
                                title: video.title,
                                transcript: transcript,
                                comments: comments
                            };
                        } catch (error) {
                            console.error(`Failed to fetch data for video ${video.id}:`, error);
                            return {
                                videoId: video.id,
                                title: video.title,
                                transcript: 'ìë§‰ ìˆ˜ì§‘ ì‹¤íŒ¨',
                                comments: 'ëŒ“ê¸€ ìˆ˜ì§‘ ì‹¤íŒ¨'
                            };
                        }
                    }));

                    // Step 2: Call backend API to generate script
                    const response = await fetch('http://localhost:4000/api/generate-script-from-multiple', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            videos: videosWithData,
                            aiProvider: selectedAIProvider
                        })
                    });

                    if (!response.ok) {
                        const errorText = await response.text();
                        throw new Error(errorText || 'API í˜¸ì¶œ ì‹¤íŒ¨');
                    }

                    const result = await response.json();

                    // Display generated script (as plain text with formatting)
                    scriptContent.innerHTML = `<pre class="whitespace-pre-wrap font-sans text-slate-300">${result.scriptMarkdown}</pre>`;

                    // Update button
                    generateBtn.disabled = false;
                    generateBtn.innerHTML = `
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                    </svg>
                    <span>ìƒì„± ì™„ë£Œ!</span>
                `;

                } catch (error) {
                    console.error('Script generation error:', error);
                    scriptContent.innerHTML = `
                    <div class="text-center py-10 text-red-400">
                        <p class="font-bold mb-2">âŒ ëŒ€ë³¸ ìƒì„± ì‹¤íŒ¨</p>
                        <p class="text-sm">${error.message}</p>
                    </div>
                `;

                    generateBtn.disabled = false;
                    generateBtn.innerHTML = `
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                    </svg>
                    <span>ë‹¤ì‹œ ì‹œë„</span>
                `;
                }
            }

            function copyScriptToClipboard() {
                const scriptContent = document.getElementById('generatedScriptContent').innerText;
                navigator.clipboard.writeText(scriptContent).then(() => {
                    alert('ëŒ€ë³¸ì´ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
                }).catch(err => {
                    console.error('ë³µì‚¬ ì‹¤íŒ¨:', err);
                    alert('ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                });
            }

            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // Channel Detail Modal Functions
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

            let currentChannelVideos = [];
            let currentChannelId = '';

            async function openChannelModal(channelId, channelTitle) {
                currentChannelId = channelId;
                const modal = document.getElementById('channelModal');
                const headerInfo = document.getElementById('channelHeaderInfo');
                const statsContainer = document.getElementById('channelStats');
                const videosGrid = document.getElementById('channelVideosGrid');
                const youtubeLink = document.getElementById('channelYoutubeLink');

                // Show modal with loading state
                modal.classList.remove('hidden');
                document.body.style.overflow = 'hidden';

                // Set YouTube link
                youtubeLink.href = `https://www.youtube.com/channel/${channelId}`;

                // Reset to loading state
                headerInfo.innerHTML = `
                <div class="w-16 h-16 bg-slate-700 rounded-full animate-pulse"></div>
                <div>
                    <div class="h-6 w-40 bg-slate-700 rounded animate-pulse mb-2"></div>
                    <div class="h-4 w-24 bg-slate-700 rounded animate-pulse"></div>
                </div>
            `;
                statsContainer.innerHTML = '';
                videosGrid.innerHTML = `
                <div class="flex flex-col items-center justify-center py-12 col-span-full">
                    <div class="loader"></div>
                    <p class="text-slate-400 animate-pulse mt-4">ì±„ë„ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
                </div>
            `;

                try {
                    // 1. Fetch channel details
                    const channelRes = await fetch(
                        `https://www.googleapis.com/youtube/v3/channels?part=snippet,statistics,brandingSettings&id=${channelId}&key=${YOUTUBE_API_KEY}`
                    );
                    const channelData = await channelRes.json();

                    if (!channelData.items || channelData.items.length === 0) {
                        throw new Error('ì±„ë„ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    }

                    const channel = channelData.items[0];
                    const snippet = channel.snippet;
                    const stats = channel.statistics;
                    const thumbnail = snippet.thumbnails?.medium?.url || snippet.thumbnails?.default?.url || '';

                    // Render header
                    headerInfo.innerHTML = `
                    <img src="${thumbnail}" alt="${snippet.title}" class="w-16 h-16 rounded-full object-cover border-2 border-slate-600">
                    <div>
                        <h3 class="text-xl font-bold text-white">${snippet.title}</h3>
                        <p class="text-sm text-slate-400">@${snippet.customUrl || channelId}</p>
                    </div>
                `;

                    // Render stats
                    statsContainer.innerHTML = `
                    <div class="bg-slate-800/50 rounded-lg p-3 text-center">
                        <div class="text-lg font-bold text-brand-400">${formatNumber(parseInt(stats.subscriberCount) || 0)}</div>
                        <div class="text-xs text-slate-500">êµ¬ë…ì</div>
                    </div>
                    <div class="bg-slate-800/50 rounded-lg p-3 text-center">
                        <div class="text-lg font-bold text-white">${formatNumber(parseInt(stats.videoCount) || 0)}</div>
                        <div class="text-xs text-slate-500">ì˜ìƒ</div>
                    </div>
                    <div class="bg-slate-800/50 rounded-lg p-3 text-center">
                        <div class="text-lg font-bold text-white">${formatCompactNumber(parseInt(stats.viewCount) || 0)}</div>
                        <div class="text-xs text-slate-500">ì´ ì¡°íšŒìˆ˜</div>
                    </div>
                    <div class="bg-slate-800/50 rounded-lg p-3 text-center hidden md:block">
                        <div class="text-lg font-bold text-white">${new Date(snippet.publishedAt).getFullYear()}</div>
                        <div class="text-xs text-slate-500">ê°œì„¤ë…„ë„</div>
                    </div>
                    <div class="bg-slate-800/50 rounded-lg p-3 text-center hidden md:block">
                        <div class="text-lg font-bold text-white">${snippet.country || '-'}</div>
                        <div class="text-xs text-slate-500">êµ­ê°€</div>
                    </div>
                `;

                    // 2. Fetch channel videos
                    videosGrid.innerHTML = `
                    <div class="flex flex-col items-center justify-center py-8 col-span-full">
                        <div class="loader"></div>
                        <p class="text-slate-400 animate-pulse mt-4">ì˜ìƒ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
                    </div>
                `;

                    const videosRes = await fetch(
                        `https://www.googleapis.com/youtube/v3/search?part=snippet&channelId=${channelId}&maxResults=30&order=date&type=video&key=${YOUTUBE_API_KEY}`
                    );
                    const videosData = await videosRes.json();

                    if (!videosData.items || videosData.items.length === 0) {
                        videosGrid.innerHTML = `
                        <div class="text-center py-12 col-span-full text-slate-400">
                            ì˜ìƒì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.
                        </div>
                    `;
                        return;
                    }

                    // 3. Fetch video statistics
                    const videoIds = videosData.items.map(v => v.id.videoId).join(',');
                    const videoStatsRes = await fetch(
                        `https://www.googleapis.com/youtube/v3/videos?part=statistics,contentDetails&id=${videoIds}&key=${YOUTUBE_API_KEY}`
                    );
                    const videoStatsData = await videoStatsRes.json();

                    // Merge data
                    currentChannelVideos = videosData.items.map(video => {
                        const stats = videoStatsData.items?.find(s => s.id === video.id.videoId);
                        return {
                            id: video.id.videoId,
                            title: video.snippet.title,
                            thumbnail: video.snippet.thumbnails?.medium?.url || video.snippet.thumbnails?.default?.url,
                            publishedAt: new Date(video.snippet.publishedAt),
                            viewCount: parseInt(stats?.statistics?.viewCount) || 0,
                            duration: stats?.contentDetails?.duration || ''
                        };
                    });

                    // Initial render (sorted by date)
                    sortChannelVideos('date');

                } catch (error) {
                    console.error('Channel modal error:', error);
                    videosGrid.innerHTML = `
                    <div class="text-center py-12 col-span-full">
                        <p class="text-red-400 font-bold">ì˜¤ë¥˜ ë°œìƒ</p>
                        <p class="text-slate-400 text-sm mt-2">${error.message}</p>
                    </div>
                `;
                }
            }

            function closeChannelModal() {
                document.getElementById('channelModal').classList.add('hidden');
                document.body.style.overflow = 'auto';
            }

            function sortChannelVideos(type) {
                // Update button styles
                document.querySelectorAll('.channel-sort-btn').forEach(btn => {
                    if (btn.dataset.sort === type) {
                        btn.classList.add('bg-brand-600', 'text-white');
                        btn.classList.remove('bg-slate-700', 'text-slate-300');
                    } else {
                        btn.classList.remove('bg-brand-600', 'text-white');
                        btn.classList.add('bg-slate-700', 'text-slate-300');
                    }
                });

                // Sort videos
                if (type === 'date') {
                    currentChannelVideos.sort((a, b) => b.publishedAt - a.publishedAt);
                } else if (type === 'views') {
                    currentChannelVideos.sort((a, b) => b.viewCount - a.viewCount);
                }

                renderChannelVideos();
            }

            function renderChannelVideos() {
                const grid = document.getElementById('channelVideosGrid');

                grid.innerHTML = currentChannelVideos.map(video => `
                <div class="bg-slate-800 rounded-lg overflow-hidden hover:ring-2 hover:ring-brand-500 transition-all group">
                    <div class="relative aspect-video cursor-pointer" onclick="window.open('https://www.youtube.com/watch?v=${video.id}', '_blank')">
                        <img src="${video.thumbnail}" alt="${escapeHtml(video.title)}" class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-300">
                        <div class="absolute bottom-1 right-1 bg-black/80 text-white text-xs px-1.5 py-0.5 rounded">
                            ${parseDuration(video.duration)}
                        </div>
                        <div class="absolute bottom-1 left-1 bg-brand-600/90 text-white text-xs px-1.5 py-0.5 rounded">
                            ${formatNumber(video.viewCount)}íšŒ
                        </div>
                    </div>
                    <div class="p-3">
                        <h5 class="font-medium text-sm text-white line-clamp-2 mb-2 group-hover:text-brand-400 transition-colors cursor-pointer" onclick="window.open('https://www.youtube.com/watch?v=${video.id}', '_blank')">${escapeHtml(video.title)}</h5>
                        <div class="flex justify-between text-xs text-slate-400 mb-3">
                            <span>ì¡°íšŒìˆ˜ ${formatNumber(video.viewCount)}</span>
                            <span>${timeAgo(video.publishedAt)}</span>
                        </div>
                        <button onclick="event.stopPropagation(); closeChannelModal(); analyzeVideo('${video.id}', '${escapeHtml(video.title).replace(/'/g, "\\'")}');" 
                            class="w-full bg-gradient-to-r from-brand-600 to-accent-600 hover:from-brand-500 hover:to-accent-500 text-white text-xs font-bold py-2 px-3 rounded-lg transition-all flex items-center justify-center gap-1.5">
                            <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                            </svg>
                            AI ëŒ“ê¸€ + ìë§‰ ê°€ì ¸ì˜¤ê¸°
                        </button>
                    </div>
                </div>
            `).join('');
            }
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // Global Trend Sniper Functions
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

            async function analyzeTrends() {
                const country = document.getElementById('trendCountry').value;
                const genre = document.getElementById('trendGenre').value;
                const trendBtn = document.getElementById('trendBtn');
                const trendModal = document.getElementById('trendModal');
                const resultContent = document.getElementById('trendResultContent');

                trendBtn.disabled = true;
                trendBtn.innerHTML = `
                <div class="w-4 h-4 border-2 border-slate-300 border-t-white rounded-full animate-spin"></div>
                <span>ìŠ¤ë‚˜ì´í•‘ ì¤‘...</span>
            `;

                // Open modal in loading state
                trendModal.classList.remove('hidden');
                document.body.style.overflow = 'hidden';
                resultContent.innerHTML = `
                <div class="flex flex-col items-center justify-center py-20 space-y-4">
                    <div class="relative w-16 h-16">
                        <div class="absolute top-0 left-0 w-full h-full border-4 border-slate-700 rounded-full animate-pulse"></div>
                        <div class="absolute top-0 left-0 w-full h-full border-4 border-t-brand-500 rounded-full animate-spin"></div>
                    </div>
                    <p class="text-brand-400 font-medium animate-bounce">${country}ì˜ ì‹¤ì‹œê°„ íŠ¸ë Œë“œë¥¼ ì •ë°€ ì¡°ì‚¬ ì¤‘ì…ë‹ˆë‹¤...</p>
                    <p class="text-xs text-slate-500">Perplexity AIê°€ ìµœì‹  ê²€ìƒ‰ì–´ì™€ SNSë¥¼ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤.</p>
                </div>
            `;

                try {
                    const response = await fetch('http://localhost:4000/api/analyze-trends', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ country, genre, dateRange: '1week_to_2months' })
                    });

                    if (!response.ok) {
                        const errorText = await response.text();
                        throw new Error(errorText || 'íŠ¸ë Œë“œ ë¶„ì„ ì‹¤íŒ¨');
                    }

                    const data = await response.json();

                    // Store for mini widget
                    lastTrendData = data;

                    // Render Visual Dashboard
                    resultContent.innerHTML = renderTrendDashboard(data);

                } catch (error) {
                    console.error('Trend analysis error:', error);
                    resultContent.innerHTML = `
                    <div class="text-center py-20">
                        <div class="text-5xl mb-4">âš ï¸</div>
                        <h3 class="text-xl font-bold text-red-400 mb-2">ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤</h3>
                        <p class="text-slate-400 mb-6">${error.message}</p>
                        <div class="bg-red-900/20 border border-red-900/50 p-4 rounded-lg text-sm text-red-200 inline-block text-left">
                             1. .env íŒŒì¼ì— PERPLEXITY_API_KEYê°€ ì˜¬ë°”ë¥´ê²Œ ì„¤ì •ë˜ì—ˆëŠ”ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.<br>
                             2. ì„œë²„ê°€ ì •ìƒì ìœ¼ë¡œ ì‘ë™ ì¤‘ì¸ì§€ í™•ì¸í•´ì£¼ì„¸ìš”. (npm run dev)
                        </div>
                    </div>
                `;
                } finally {
                    trendBtn.disabled = false;
                    trendBtn.innerHTML = `
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
                    </svg>
                    <span>íŠ¸ë Œë“œ ìŠ¤ë‚˜ì´í•‘ ì‹œì‘</span>
                `;
                }
            }

            // Visual Dashboard Renderer
            function renderTrendDashboard(data) {
                const genreLabel = { humor: 'ìœ ë¨¸', drama: 'ë“œë¼ë§ˆ', economy: 'ê²½ì œ', health: 'ê±´ê°•', all: 'ì „ì²´' };
                const meta = data.meta || {};
                const conceptsJson = data.conceptsJson;

                // Market Analysis Section (if JSON available)
                let marketAnalysisHtml = '';
                if (conceptsJson && conceptsJson.market_analysis) {
                    const ma = conceptsJson.market_analysis;
                    marketAnalysisHtml = `
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                        <div class="bg-slate-800/70 rounded-xl p-4 text-center border border-slate-700">
                            <div class="text-xs text-slate-500 uppercase mb-1">ê°ì„± ì ìˆ˜</div>
                            <div class="flex items-center justify-center gap-2">
                                <div class="text-2xl font-bold text-brand-400">${ma.sentiment_score || '-'}</div>
                                <div class="w-16 h-2 bg-slate-700 rounded-full overflow-hidden">
                                    <div class="h-full bg-gradient-to-r from-brand-500 to-accent-500" style="width: ${ma.sentiment_score || 0}%"></div>
                                </div>
                            </div>
                        </div>
                        <div class="bg-slate-800/70 rounded-xl p-4 text-center border border-slate-700">
                            <div class="text-xs text-slate-500 uppercase mb-1">ë²„ì¦ˆëŸ‰</div>
                            <div class="flex items-center justify-center gap-2">
                                <div class="text-2xl font-bold text-accent-400">${ma.buzz_volume || '-'}</div>
                                <div class="w-16 h-2 bg-slate-700 rounded-full overflow-hidden">
                                    <div class="h-full bg-gradient-to-r from-accent-500 to-pink-500" style="width: ${ma.buzz_volume || 0}%"></div>
                                </div>
                            </div>
                        </div>
                        <div class="bg-slate-800/70 rounded-xl p-4 text-center border border-slate-700 col-span-2">
                            <div class="text-xs text-slate-500 uppercase mb-1">í•µì‹¬ í…Œë§ˆ (í´ë¦­í•˜ì—¬ ê²€ìƒ‰)</div>
                            <div class="flex flex-wrap gap-2 justify-center">
                                ${(ma.key_themes || []).map(t => `<button onclick="searchKeyword('${t}')" class="bg-brand-900/50 text-brand-300 px-2 py-1 rounded-lg text-xs hover:bg-brand-700 hover:text-white transition-all cursor-pointer border border-transparent hover:border-brand-500">#${t}</button>`).join('')}
                            </div>
                        </div>
                    </div>
                `;
                }

                // Concept Cards Section (if JSON available)
                let conceptCardsHtml = '';
                if (conceptsJson && conceptsJson.concepts && conceptsJson.concepts.length > 0) {
                    conceptCardsHtml = conceptsJson.concepts.map((c, idx) => `
                    <div class="bg-slate-800/50 rounded-xl border border-slate-700 p-5 hover:border-brand-500/50 transition-all">
                        <div class="flex items-start justify-between mb-3">
                            <h5 class="font-bold text-white text-base leading-tight flex-1">${c.title_kr}</h5>
                            <span class="bg-${c.genre === 'Humor' ? 'yellow' : c.genre === 'Drama' ? 'purple' : c.genre === 'Economy' ? 'green' : 'blue'}-600/20 text-${c.genre === 'Humor' ? 'yellow' : c.genre === 'Drama' ? 'purple' : c.genre === 'Economy' ? 'green' : 'blue'}-300 text-xs px-2 py-0.5 rounded-full ml-2">${c.genre}</span>
                        </div>
                        
                        <div class="flex items-center gap-3 mb-4">
                            <div class="text-xs text-slate-500">ë°”ì´ëŸ´ ì ì¬ë ¥</div>
                            <div class="flex-1 h-2 bg-slate-700 rounded-full overflow-hidden">
                                <div class="h-full bg-gradient-to-r from-green-500 to-emerald-400" style="width: ${(c.viral_potential || 0) * 10}%"></div>
                            </div>
                            <div class="text-sm font-bold text-green-400">${c.viral_potential}/10</div>
                        </div>

                        <div class="space-y-2 text-sm">
                            <div class="flex gap-2">
                                <span class="text-brand-400 font-semibold shrink-0">ğŸ¬ Hook:</span>
                                <span class="text-slate-300">${c.hook_visual || '-'}</span>
                            </div>
                            <div class="flex gap-2">
                                <span class="text-brand-400 font-semibold shrink-0">ğŸ“ ì¤„ê±°ë¦¬:</span>
                                <span class="text-slate-300">${c.plot_summary || '-'}</span>
                            </div>
                            <div class="flex gap-2">
                                <span class="text-accent-400 font-semibold shrink-0">ğŸ”„ ì¬ê°€ê³µ:</span>
                                <span class="text-slate-300">${c.reprocessing_strategy || '-'}</span>
                            </div>
                            <div class="flex gap-2">
                                <span class="text-green-400 font-semibold shrink-0">âœ… ì í•©ë„:</span>
                                <span class="text-slate-300">${c.why_fits_channel || '-'}</span>
                            </div>
                        </div>
                    </div>
                `).join('');
                } else {
                    // Fallback to raw markdown if JSON parsing failed
                    conceptCardsHtml = `<div class="prose prose-invert max-w-none">${marked.parse(data.conceptsRaw || 'No concepts generated.')}</div>`;
                }

                return `
                <div class="mb-6 flex items-center gap-3">
                    <span class="bg-brand-600/20 text-brand-300 px-3 py-1 rounded-full text-sm font-medium">${meta.country || 'Unknown'}</span>
                    <span class="bg-accent-600/20 text-accent-300 px-3 py-1 rounded-full text-sm font-medium">${genreLabel[meta.genre] || meta.genre}</span>
                    <span class="text-slate-500 text-xs">ìµœê·¼ 1ì£¼ ~ 2ë‹¬ ë°ì´í„°</span>
                </div>

                ${marketAnalysisHtml}

                <div class="mb-8">
                    <h4 class="text-brand-400 font-bold text-lg mb-4 flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        ì‹¤ì‹œê°„ ê²€ìƒ‰ íŠ¸ë Œë“œ (Perplexity)
                    </h4>
                    <div class="bg-slate-800/50 p-6 rounded-xl border border-slate-700 text-slate-300 text-sm leading-relaxed max-h-60 overflow-y-auto">
                        ${marked.parse(data.trends || 'No trends found.')}
                    </div>
                </div>
                
                <div class="separator h-px bg-gradient-to-r from-transparent via-slate-700 to-transparent my-8"></div>
                
                <div>
                    <h4 class="text-accent-400 font-bold text-lg mb-4 flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" />
                        </svg>
                        ì¶”ì²œ ë¹„ë””ì˜¤ ì»¨ì…‰ (Gemini)
                    </h4>
                    <div class="grid grid-cols-1 gap-4">
                        ${conceptCardsHtml}
                    </div>
                </div>
            `;
            }

            // Store last trend data for mini widget
            let lastTrendData = null;

            function minimizeTrendModal() {
                // Hide full modal
                document.getElementById('trendModal').classList.add('hidden');
                document.body.style.overflow = 'auto';

                // Show mini widget
                const miniWidget = document.getElementById('trendMiniWidget');
                const miniContent = document.getElementById('trendMiniContent');

                // Create mini preview content
                if (lastTrendData && lastTrendData.meta) {
                    const genreLabel = { humor: 'ìœ ë¨¸', drama: 'ë“œë¼ë§ˆ', economy: 'ê²½ì œ', health: 'ê±´ê°•', all: 'ì „ì²´' };
                    miniContent.innerHTML = `
                    <div class="flex items-center gap-2 mb-2">
                        <span class="bg-brand-600/30 text-brand-300 px-2 py-0.5 rounded text-xs">${lastTrendData.meta.country || 'Unknown'}</span>
                        <span class="bg-accent-600/30 text-accent-300 px-2 py-0.5 rounded text-xs">${genreLabel[lastTrendData.meta.genre] || lastTrendData.meta.genre}</span>
                    </div>
                    <p class="text-xs text-slate-400 line-clamp-2">${lastTrendData.conceptsJson?.concepts?.[0]?.title_kr || 'íŠ¸ë Œë“œ ë¶„ì„ ì™„ë£Œ'}</p>
                `;
                }

                miniWidget.classList.remove('hidden');
            }

            function expandTrendModal() {
                // Hide mini widget
                document.getElementById('trendMiniWidget').classList.add('hidden');

                // Show full modal
                document.getElementById('trendModal').classList.remove('hidden');
                document.body.style.overflow = 'hidden';
            }

            function closeTrendModalCompletely() {
                document.getElementById('trendModal').classList.add('hidden');
                document.getElementById('trendMiniWidget').classList.add('hidden');
                document.body.style.overflow = 'auto';
                lastTrendData = null;
            }

            function closeTrendModal() {
                minimizeTrendModal();
            }

            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // Trending Finder Functions
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

            let currentTrendingFilter = 'all';
            let currentTrendingCountry = 'KR';


            function switchTrendingFilter(filter) {
                currentTrendingFilter = filter;
                const country = currentTrendingCountry;

                // Update button styles
                document.querySelectorAll('.trending-filter-btn').forEach(btn => {
                    const btnOnclick = btn.getAttribute('onclick');
                    if (btnOnclick && btnOnclick.includes(`'${filter}'`)) {
                        btn.classList.add('bg-orange-600', 'text-white', 'border-orange-500');
                        btn.classList.remove('text-slate-400');
                        // Update badge color
                        const badge = btn.querySelector('span');
                        if (badge) {
                            badge.classList.remove('bg-slate-800', 'border-slate-700');
                            badge.classList.add('bg-orange-400/20', 'border-orange-400/30');
                        }
                    } else {
                        btn.classList.remove('bg-orange-600', 'text-white', 'border-orange-500');
                        btn.classList.add('text-slate-400');
                        // Reset badge color
                        const badge = btn.querySelector('span');
                        if (badge) {
                            badge.classList.add('bg-slate-800', 'border-slate-700');
                            badge.classList.remove('bg-orange-400/20', 'border-orange-400/30');
                        }
                    }
                });

                loadTrendingVideos(filter, country);
            }

            function switchTrendingCountry(country) {
                currentTrendingCountry = country;

                // Update country buttons
                document.querySelectorAll('.country-btn').forEach(btn => {
                    const btnOnclick = btn.getAttribute('onclick');
                    if (btnOnclick && btnOnclick.includes(`'${country}'`)) {
                        btn.classList.add('bg-slate-800', 'text-orange-400', 'border-orange-500/30');
                        btn.classList.remove('text-slate-500');
                    } else {
                        btn.classList.remove('bg-slate-800', 'text-orange-400', 'border-orange-500/30');
                        btn.classList.add('text-slate-500');
                    }
                });

                loadTrendingVideos(currentTrendingFilter, country);
            }

            async function loadTrendingVideos(filter = 'all', country = 'KR') {
                const tableBody = document.getElementById('trendingVideosTableBody');
                if (!tableBody) return;

                // Show loading
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="7" class="py-20 text-center">
                            <div class="flex flex-col items-center justify-center space-y-4">
                                <div class="loader w-10 h-10 border-4 border-t-orange-500"></div>
                                <p class="text-slate-400 animate-pulse font-bold">ì¸ê¸° ê¸‰ìƒìŠ¹ ì˜ìƒì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
                                <p class="text-xs text-slate-500">${country} êµ­ê°€ì˜ ë°ì´í„°ë¥¼ ìˆ˜ì§‘ ì¤‘ì…ë‹ˆë‹¤.</p>
                            </div>
                        </td>
                    </tr>
                `;

                try {
                    const response = await fetch(`http://localhost:4000/api/trending?filter=${filter}&country=${country}`);
                    if (!response.ok) throw new Error('ì„œë²„ ì—°ê²° ì‹¤íŒ¨');

                    const data = await response.json();
                    if (!data.success) throw new Error(data.error || 'ë°ì´í„° ìˆ˜ì§‘ ì‹¤íŒ¨');

                    // Update counts
                    if (data.counts) {
                        if (document.querySelector('.trending-count-all')) document.querySelector('.trending-count-all').innerText = data.counts.all || 0;
                        if (document.querySelector('.trending-count-long')) document.querySelector('.trending-count-long').innerText = data.counts.long || 0;
                        if (document.querySelector('.trending-count-shorts')) document.querySelector('.trending-count-shorts').innerText = data.counts.shorts || 0;
                        if (document.getElementById('trending-total-count')) document.getElementById('trending-total-count').innerText = data.counts.all || 0;
                    }

                    renderTrendingVideos(data.videos);
                } catch (error) {
                    console.error('Trending fetch error:', error);
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="7" class="py-20 text-center text-red-400">
                                <div class="flex flex-col items-center justify-center space-y-2">
                                    <span class="text-3xl mb-2">âš ï¸</span>
                                    <p class="font-bold">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</p>
                                    <p class="text-sm text-slate-500">${error.message}</p>
                                    <button onclick="loadTrendingVideos('${filter}', '${country}')" class="mt-4 bg-slate-700 hover:bg-slate-600 px-4 py-2 rounded-lg text-xs font-bold transition-all">
                                        ë‹¤ì‹œ ì‹œë„
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                }
            }

            function renderTrendingVideos(videos) {
                const tableBody = document.getElementById('trendingVideosTableBody');
                if (!tableBody) return;

                if (!videos || videos.length === 0) {
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="7" class="py-20 text-center text-slate-400">
                                <p>í•´ë‹¹ ì¹´í…Œê³ ë¦¬ì— ì¸ê¸° ê¸‰ìƒìŠ¹ ì˜ìƒì´ ì—†ìŠµë‹ˆë‹¤.</p>
                            </td>
                        </tr>
                    `;
                    return;
                }

                tableBody.innerHTML = videos.map((v, idx) => `
                    <tr class="border-b border-slate-800/50 hover:bg-slate-800/30 transition-colors group">
                        <td class="px-4 py-4 text-center">
                            <span class="text-lg font-black ${idx < 3 ? 'text-orange-500 italic scale-125' : 'text-slate-600'}">#${v.rank || (idx + 1)}</span>
                        </td>
                        <td class="px-4 py-4">
                            <div class="relative w-32 aspect-video rounded-lg overflow-hidden flex-shrink-0 cursor-pointer shadow-lg group-hover:ring-2 group-hover:ring-orange-500 transition-all" onclick="window.open('https://www.youtube.com/watch?v=${v.videoId}', '_blank')">
                                <img src="${v.thumbnail}" class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-500">
                                <div class="absolute bottom-1 right-1 bg-black/80 text-white text-[10px] font-bold px-1.5 py-0.5 rounded backdrop-blur-sm">
                                    ${v.duration || '0:00'}
                                </div>
                            </div>
                        </td>
                        <td class="px-4 py-4">
                            <div class="max-w-md">
                                <h4 class="text-white font-bold line-clamp-2 hover:text-orange-400 transition-colors cursor-pointer mb-2 leading-tight" onclick="window.open('https://www.youtube.com/watch?v=${v.videoId}', '_blank')">
                                    ${escapeHtml(v.title)}
                                </h4>
                                <div class="flex flex-wrap gap-1 mt-1">
                                    ${(v.tags || []).slice(0, 3).map(tag => `<span class="text-[10px] bg-slate-800/80 text-slate-500 px-2 py-0.5 rounded border border-slate-700">#${escapeHtml(tag)}</span>`).join('')}
                                </div>
                            </div>
                        </td>
                        <td class="px-4 py-4">
                            <div class="text-slate-300 text-sm font-bold hover:text-orange-400 transition-colors cursor-pointer flex flex-col gap-0.5" onclick="openChannelModal('${v.channelId || ''}', '${escapeHtml(v.channelTitle).replace(/'/g, "\\'")}')">
                                <span class="flex items-center gap-1.5">
                                    <div class="w-1.5 h-1.5 rounded-full bg-orange-500"></div>
                                    ${escapeHtml(v.channelTitle)}
                                </span>
                                <span class="text-[10px] text-slate-600 font-medium ml-3">${v.publishedAt ? (typeof v.publishedAt === 'string' ? timeAgo(new Date(v.publishedAt)) : timeAgo(v.publishedAt)) : '-'}</span>
                            </div>
                        </td>
                        <td class="px-4 py-4 text-center">
                            <span class="text-slate-500 text-xs font-black uppercase tracking-tighter">Newest</span>
                        </td>
                        <td class="px-4 py-4 text-right">
                            <div class="text-orange-400 font-black text-lg">${formatCompactNumber(v.viewCount)}</div>
                            <div class="text-[10px] text-slate-600 uppercase font-black tracking-widest">ì¡°íšŒìˆ˜</div>
                        </td>
                        <td class="px-4 py-4">
                            <div class="flex flex-col gap-2">
                                <button onclick="analyzeVideo('${v.videoId}', '${escapeHtml(v.title).replace(/'/g, "\\'")}')"
                                    class="bg-gradient-to-r from-orange-600 to-amber-600 hover:from-orange-500 hover:to-amber-500 text-white text-xs font-black py-2 px-4 rounded-lg transition-all shadow-lg hover:scale-105 active:scale-95 whitespace-nowrap flex items-center justify-center gap-1.5 border border-orange-400/30">
                                    <svg class="w-3 h-3 text-orange-200" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M11.3 1.046A1 1 0 0112 2v5h4a1 1 0 01.82 1.573l-7 10A1 1 0 018 18v-5H4a1 1 0 01-.82-1.573l7-10a1 1 0 011.12-.38z" clip-rule="evenodd" /></svg>
                                    ë¶„ì„
                                </button>
                                <button onclick="window.open('https://www.youtube.com/watch?v=${v.videoId}', '_blank')"
                                    class="bg-slate-700/50 hover:bg-slate-600/50 text-white text-xs font-bold py-2 px-4 rounded-lg transition-all whitespace-nowrap flex items-center justify-center gap-1.5 border border-slate-600">
                                    <svg class="w-3 h-3 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.143 7.623 4 12 4s8.268 3.143 9.542 8c-1.274 4.857-5.165 8-9.542 8s-8.268-3.143-9.542-8z" /></svg>
                                    ì‹œì²­
                                </button>
                            </div>
                        </td>
                    </tr>
                `).join('');
            }

            // Search keyword in Deep Search
            function searchKeyword(keyword) {
                // First, minimize the trend modal
                minimizeTrendModal();

                // Set the keyword in the search input
                const keywordInput = document.getElementById('keyword');
                if (keywordInput) {
                    keywordInput.value = keyword;
                    keywordInput.focus();

                    // Highlight the input briefly
                    keywordInput.classList.add('ring-2', 'ring-brand-500');
                    setTimeout(() => {
                        keywordInput.classList.remove('ring-2', 'ring-brand-500');
                    }, 1500);
                }

                // Scroll to top of page
                window.scrollTo({ top: 0, behavior: 'smooth' });

                // Optional: auto-trigger search
                // startSearch();
            }

            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // Dual Track Viral Analysis Functions
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

            let viralAnalysisData = { hot: null, recycle: null };
            let currentViralTab = 'hot';

            async function startViralAnalysis() {
                const keyword = document.getElementById('viralKeyword').value.trim();
                const viralBtn = document.getElementById('viralBtn');
                const viralModal = document.getElementById('viralModal');
                const viralContent = document.getElementById('viralModalContent');

                if (!keyword) {
                    alert('ê²€ìƒ‰ í‚¤ì›Œë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”. (ì˜ˆ: ì‹œë‹ˆì–´ ìœ ë¨¸ ì‡¼ì¸ )');
                    return;
                }

                if (!YOUTUBE_API_KEY) {
                    alert('YouTube API í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ìƒë‹¨ ì„¤ì •ì—ì„œ API í‚¤ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                    return;
                }

                viralBtn.disabled = true;
                viralBtn.innerHTML = `
                <div class="w-4 h-4 border-2 border-slate-300 border-t-white rounded-full animate-spin"></div>
                <span>ë¶„ì„ ì¤‘...</span>
            `;

                viralModal.classList.remove('hidden');
                document.body.style.overflow = 'hidden';
                viralContent.innerHTML = `
                <div class="flex flex-col items-center justify-center py-20 space-y-4">
                    <div class="relative w-16 h-16">
                        <div class="absolute top-0 left-0 w-full h-full border-4 border-slate-700 rounded-full animate-pulse"></div>
                        <div class="absolute top-0 left-0 w-full h-full border-4 border-t-orange-500 rounded-full animate-spin"></div>
                    </div>
                    <p class="text-orange-400 font-medium">YouTubeì—ì„œ ë°”ì´ëŸ´ ì˜ìƒì„ ê²€ìƒ‰í•˜ê³  ë¶„ì„ ì¤‘...</p>
                    <p class="text-xs text-slate-500">ğŸ”¥ í•« íŠ¸ë™ + â™»ï¸ ë¦¬ì‚¬ì´í´ íŠ¸ë™ ë™ì‹œ ë¶„ì„</p>
                </div>
            `;

                try {
                    // Date calculations
                    const now = new Date();
                    const oneMonthAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
                    const twoMonthsAgo = new Date(now.getTime() - 60 * 24 * 60 * 60 * 1000);
                    const threeMonthsAgo = new Date(now.getTime() - 90 * 24 * 60 * 60 * 1000);

                    // Fetch Hot Track (past 1 month)
                    const hotVideos = await fetchYouTubeShorts(keyword, oneMonthAgo.toISOString(), now.toISOString());

                    // Fetch Recycle Track (2-3 months ago)
                    const recycleVideos = await fetchYouTubeShorts(keyword, threeMonthsAgo.toISOString(), twoMonthsAgo.toISOString());

                    // Calculate Outlier Scores
                    const hotWithScores = await calculateOutlierScores(hotVideos.slice(0, 30));
                    const recycleWithScores = await calculateOutlierScores(recycleVideos.slice(0, 30));

                    // Get Gemini analysis for both tracks
                    const [hotAnalysis, recycleAnalysis] = await Promise.all([
                        fetchViralAnalysis(hotWithScores, 'hot'),
                        fetchViralAnalysis(recycleWithScores, 'recycle')
                    ]);

                    viralAnalysisData = {
                        hot: { videos: hotWithScores, analysis: hotAnalysis },
                        recycle: { videos: recycleWithScores, analysis: recycleAnalysis }
                    };

                    // Render default tab (hot)
                    renderViralTab('hot');

                } catch (error) {
                    console.error('Viral Analysis Error:', error);
                    viralContent.innerHTML = `
                    <div class="text-center py-20">
                        <div class="text-5xl mb-4">âš ï¸</div>
                        <h3 class="text-xl font-bold text-red-400 mb-2">ë¶„ì„ ì¤‘ ì˜¤ë¥˜ ë°œìƒ</h3>
                        <p class="text-slate-400">${error.message}</p>
                    </div>
                `;
                } finally {
                    viralBtn.disabled = false;
                    viralBtn.innerHTML = `
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 18.657A8 8 0 016.343 7.343S7 9 9 10c0-2 .5-5 2.986-7C14 5 16.09 5.777 17.656 7.343A7.975 7.975 0 0120 13a7.975 7.975 0 01-2.343 5.657z" />
                    </svg>
                    <span>ë“€ì–¼ íŠ¸ë™ ë¶„ì„</span>
                `;
                }
            }

            async function fetchYouTubeShorts(keyword, publishedAfter, publishedBefore) {
                const url = `https://www.googleapis.com/youtube/v3/search?part=snippet&q=${encodeURIComponent(keyword)}&type=video&videoDuration=short&order=viewCount&maxResults=50&publishedAfter=${publishedAfter}&publishedBefore=${publishedBefore}&key=${YOUTUBE_API_KEY}`;

                const response = await fetch(url);
                if (!response.ok) throw new Error('YouTube ê²€ìƒ‰ ì‹¤íŒ¨');

                const data = await response.json();
                return data.items || [];
            }

            async function calculateOutlierScores(videos) {
                if (!videos.length) return [];

                const videoIds = videos.map(v => v.id.videoId).join(',');
                const channelIds = [...new Set(videos.map(v => v.snippet.channelId))].join(',');

                // Fetch video stats AND contentDetails for duration
                const videoStatsUrl = `https://www.googleapis.com/youtube/v3/videos?part=statistics,contentDetails&id=${videoIds}&key=${YOUTUBE_API_KEY}`;
                const videoStatsRes = await fetch(videoStatsUrl);
                const videoStats = await videoStatsRes.json();

                // Fetch channel stats
                const channelStatsUrl = `https://www.googleapis.com/youtube/v3/channels?part=statistics&id=${channelIds}&key=${YOUTUBE_API_KEY}`;
                const channelStatsRes = await fetch(channelStatsUrl);
                const channelStats = await channelStatsRes.json();

                const channelMap = {};
                (channelStats.items || []).forEach(ch => {
                    channelMap[ch.id] = parseInt(ch.statistics.subscriberCount) || 1;
                });

                return videos.map((v, idx) => {
                    const stats = videoStats.items?.find(s => s.id === v.id.videoId);
                    const viewCount = parseInt(stats?.statistics?.viewCount) || 0;
                    const subscriberCount = channelMap[v.snippet.channelId] || 1;
                    const outlierScore = Math.round((viewCount / subscriberCount) * 100);
                    const duration = stats?.contentDetails?.duration || '';

                    return {
                        videoId: v.id.videoId,
                        title: v.snippet.title,
                        channelTitle: v.snippet.channelTitle,
                        thumbnail: v.snippet.thumbnails?.medium?.url || v.snippet.thumbnails?.default?.url,
                        publishedAt: v.snippet.publishedAt,
                        viewCount,
                        subscriberCount,
                        outlierScore,
                        duration
                    };
                }).sort((a, b) => b.outlierScore - a.outlierScore);
            }

            async function fetchViralAnalysis(videos, track) {
                if (!videos.length) return null;

                const response = await fetch('http://localhost:4000/api/viral-analysis', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ videos, track })
                });

                if (!response.ok) return null;
                return response.json();
            }

            function switchViralTab(tab) {
                currentViralTab = tab;

                // Update tab styles
                const hotTab = document.getElementById('hotTrackTab');
                const recycleTab = document.getElementById('recycleTrackTab');

                if (tab === 'hot') {
                    hotTab.className = 'flex-1 py-3 px-4 text-center font-bold text-orange-400 border-b-2 border-orange-500 bg-orange-500/10 flex items-center justify-center gap-2';
                    recycleTab.className = 'flex-1 py-3 px-4 text-center font-medium text-slate-400 border-b-2 border-transparent hover:text-green-400 flex items-center justify-center gap-2';
                } else {
                    hotTab.className = 'flex-1 py-3 px-4 text-center font-medium text-slate-400 border-b-2 border-transparent hover:text-orange-400 flex items-center justify-center gap-2';
                    recycleTab.className = 'flex-1 py-3 px-4 text-center font-bold text-green-400 border-b-2 border-green-500 bg-green-500/10 flex items-center justify-center gap-2';
                }

                renderViralTab(tab);
            }

            function renderViralTab(tab) {
                const content = document.getElementById('viralModalContent');
                const data = viralAnalysisData[tab];

                if (!data || !data.videos || data.videos.length === 0) {
                    content.innerHTML = `
                    <div class="text-center py-12 text-slate-400">
                        <p>í•´ë‹¹ ê¸°ê°„ì— ë°”ì´ëŸ´ ì˜ìƒì„ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</p>
                    </div>
                `;
                    return;
                }

                const trackColor = tab === 'hot' ? 'orange' : 'green';
                const trackLabel = tab === 'hot' ? 'ğŸ”¥ ì§€ê¸ˆ í„°ì§€ëŠ” ì¤‘!' : 'â™»ï¸ ê²€ì¦ëœ êµ¬ì¡°, ë‹¤ì‹œ ì¨ë¨¹ê¸°';

                const analyses = data.analysis?.analysisJson?.analyses || [];
                const overallInsight = data.analysis?.analysisJson?.overallInsight || '';

                let html = `
                <div class="mb-4 p-3 bg-${trackColor}-900/20 border border-${trackColor}-500/30 rounded-lg">
                    <p class="text-sm text-${trackColor}-300 font-medium">${trackLabel}</p>
                    ${overallInsight ? `<p class="text-xs text-slate-400 mt-1">${overallInsight}</p>` : ''}
                </div>
                <div class="space-y-4">
            `;

                data.videos.forEach((v, idx) => {
                    const analysis = analyses.find(a => a.videoIndex === idx + 1) || {};
                    const whyViral = tab === 'hot' ? analysis.whyViral : analysis.whyViralThen;
                    const actionGuide = tab === 'hot' ? analysis.recommendedAction : analysis.whyStillWorks;

                    html += `
                    <div class="bg-slate-800/50 rounded-xl border border-slate-700 p-4 hover:border-${trackColor}-500/50 transition-all" id="viral-video-${v.videoId}">
                        <div class="flex gap-4">
                            <a href="https://www.youtube.com/watch?v=${v.videoId}" target="_blank" class="shrink-0 relative">
                                <img src="${v.thumbnail}" alt="${escapeHtml(v.title)}" class="w-40 h-24 object-cover rounded-lg hover:opacity-80 transition-opacity" />
                                <span class="absolute bottom-1 right-1 bg-black/80 text-white text-xs px-1.5 py-0.5 rounded font-medium">${parseDuration(v.duration)}</span>
                            </a>
                            <div class="flex-1 min-w-0">
                                <h4 class="font-bold text-white text-sm mb-1 line-clamp-2 hover:text-${trackColor}-400 cursor-pointer" onclick="window.open('https://www.youtube.com/watch?v=${v.videoId}', '_blank')">${escapeHtml(v.title)}</h4>
                                <p class="text-xs text-slate-500 mb-2">${v.channelTitle} â€¢ ${formatNumber(v.viewCount)}íšŒ â€¢ ${timeAgo(new Date(v.publishedAt))}</p>
                                
                                <div class="flex items-center gap-2 mb-2">
                                    <span class="text-xs text-slate-400">Outlier Score:</span>
                                    <div class="flex-1 h-1.5 bg-slate-700 rounded-full max-w-32">
                                        <div class="h-full bg-gradient-to-r from-${trackColor}-500 to-yellow-400 rounded-full" style="width: ${Math.min(v.outlierScore / 50, 100)}%"></div>
                                    </div>
                                    <span class="text-sm font-bold text-${trackColor}-400">${v.outlierScore}%</span>
                                </div>
                                
                                ${whyViral ? `<p class="text-xs text-slate-300 bg-slate-900/50 p-2 rounded"><span class="text-${trackColor}-400 font-medium">ğŸ’¡ ë¶„ì„:</span> ${whyViral}</p>` : ''}
                            </div>
                        </div>
                        ${analysis.aiReproductionGuide ? `
                            <div class="mt-3 pt-3 border-t border-slate-700">
                                <p class="text-xs text-slate-400"><span class="text-accent-400 font-medium">ğŸ¨ AI ì¬í˜„:</span> ${analysis.aiReproductionGuide}</p>
                            </div>
                        ` : ''}
                        <div class="mt-3 flex gap-2">
                            <button onclick="findSimilarVideosInline('${v.videoId}', '${escapeHtml(v.title).replace(/'/g, "\\\'")}')" class="text-xs bg-slate-700 hover:bg-slate-600 text-white px-3 py-1.5 rounded-lg flex items-center gap-1" id="similar-btn-${v.videoId}">
                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
                                ìœ ì‚¬ ì˜ìƒ ì°¾ê¸°
                            </button>
                            <button onclick="analyzeVideo('${v.videoId}', '${escapeHtml(v.title).replace(/'/g, "\\\'")}')" class="text-xs bg-${trackColor}-600 hover:bg-${trackColor}-500 text-white px-3 py-1.5 rounded-lg flex items-center gap-1">
                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
                                ìë§‰ + ëŒ“ê¸€ ì¶”ì¶œ
                            </button>
                        </div>
                        <div id="similar-results-${v.videoId}" class="hidden mt-3 pt-3 border-t border-slate-600"></div>
                    </div>
                `;
                });

                html += '</div>';
                content.innerHTML = html;
            }

            function closeViralModal() {
                document.getElementById('viralModal').classList.add('hidden');
                document.body.style.overflow = 'auto';
            }

            // Inline Similar Videos Search (within modal)
            async function findSimilarVideosInline(videoId, title) {
                const resultsDiv = document.getElementById(`similar-results-${videoId}`);
                const btn = document.getElementById(`similar-btn-${videoId}`);

                // Toggle: if already showing, just hide
                if (!resultsDiv.classList.contains('hidden')) {
                    resultsDiv.classList.add('hidden');
                    btn.innerHTML = `
                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
                    ìœ ì‚¬ ì˜ìƒ ì°¾ê¸°
                `;
                    return;
                }

                // Show loading state
                resultsDiv.classList.remove('hidden');
                resultsDiv.innerHTML = `
                <div class="flex items-center gap-2 text-slate-400 text-xs py-2">
                    <div class="w-3 h-3 border-2 border-slate-400 border-t-brand-400 rounded-full animate-spin"></div>
                    ìœ ì‚¬ ì˜ìƒ ê²€ìƒ‰ ì¤‘...
                </div>
            `;
                btn.innerHTML = `
                <div class="w-3 h-3 border-2 border-slate-300 border-t-white rounded-full animate-spin"></div>
                ê²€ìƒ‰ ì¤‘...
            `;

                try {
                    // Extract keywords from title (first 4 meaningful words)
                    const keywords = title.replace(/[#@\[\](){}'"!?]/g, '').split(' ').filter(w => w.length > 1).slice(0, 4).join(' ');

                    // Search YouTube for similar videos (past 6 months)
                    const sixMonthsAgo = new Date(Date.now() - 180 * 24 * 60 * 60 * 1000).toISOString();
                    const searchUrl = `https://www.googleapis.com/youtube/v3/search?part=snippet&q=${encodeURIComponent(keywords)}&type=video&videoDuration=short&order=viewCount&maxResults=6&publishedAfter=${sixMonthsAgo}&key=${YOUTUBE_API_KEY}`;

                    const searchRes = await fetch(searchUrl);
                    if (!searchRes.ok) throw new Error('YouTube ê²€ìƒ‰ ì‹¤íŒ¨');
                    const searchData = await searchRes.json();

                    // Exclude the original video
                    const filteredVideos = (searchData.items || []).filter(v => v.id.videoId !== videoId);

                    if (filteredVideos.length === 0) {
                        resultsDiv.innerHTML = `<p class="text-xs text-slate-500 py-2">ìœ ì‚¬ ì˜ìƒì„ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</p>`;
                        btn.innerHTML = `
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                        ê²°ê³¼ ìˆ¨ê¸°ê¸°
                    `;
                        return;
                    }

                    // Get video stats for the similar videos
                    const videoIds = filteredVideos.map(v => v.id.videoId).join(',');
                    const statsUrl = `https://www.googleapis.com/youtube/v3/videos?part=statistics,contentDetails&id=${videoIds}&key=${YOUTUBE_API_KEY}`;
                    const statsRes = await fetch(statsUrl);
                    const statsData = await statsRes.json();

                    // Render similar videos
                    let html = `
                    <p class="text-xs text-brand-400 font-medium mb-2">ğŸ” ìœ ì‚¬ ì˜ìƒ ${filteredVideos.length}ê°œ ë°œê²¬</p>
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-2">
                `;

                    filteredVideos.slice(0, 5).forEach(v => {
                        const stats = statsData.items?.find(s => s.id === v.id.videoId);
                        const viewCount = parseInt(stats?.statistics?.viewCount) || 0;
                        const duration = stats?.contentDetails?.duration || '';

                        html += `
                        <div class="bg-slate-900/50 rounded-lg p-2 hover:bg-slate-800/50 transition-colors">
                            <a href="https://www.youtube.com/watch?v=${v.id.videoId}" target="_blank" class="block relative mb-1.5">
                                <img src="${v.snippet.thumbnails?.default?.url}" alt="" class="w-full aspect-video object-cover rounded" />
                                <span class="absolute bottom-0.5 right-0.5 bg-black/80 text-white text-[10px] px-1 py-0.5 rounded">${parseDuration(duration)}</span>
                            </a>
                            <h6 class="text-[11px] text-slate-300 line-clamp-2 leading-tight mb-1">${escapeHtml(v.snippet.title)}</h6>
                            <div class="flex justify-between items-center">
                                <span class="text-[10px] text-slate-500">${formatCompactNumber(viewCount)}íšŒ</span>
                                <button onclick="event.stopPropagation(); analyzeVideo('${v.id.videoId}', '${escapeHtml(v.snippet.title).replace(/'/g, "\\\\'")}');" 
                                    class="text-[10px] text-brand-400 hover:text-brand-300 font-medium">
                                    ë¶„ì„í•˜ê¸°
                                </button>
                            </div>
                        </div>
                    `;
                    });

                    html += '</div>';
                    resultsDiv.innerHTML = html;
                } catch (error) {
                    console.error('Similar video search error:', error);
                    resultsDiv.innerHTML = `<p class="text-xs text-red-400 py-2">ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}</p>`;
                    btn.innerHTML = `
                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
                    ìœ ì‚¬ ì˜ìƒ ì°¾ê¸°
                `;
                }
            }

            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // Young Forty Webtoon [Nano Banana] Script Generator Functions
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

            let selectedViralPlatform = 'tiktok'; // Default

            function selectViralPlatform(platform) {
                selectedViralPlatform = platform;

                // Update UI
                ['tiktok', 'instagram', 'youtube'].forEach(p => {
                    const btn = document.getElementById(`viralPlatform${p}`);
                    if (!btn) return;
                    if (p === platform) {
                        btn.classList.remove('bg-slate-800', 'border-slate-600');
                        btn.classList.add('bg-brand-600', 'border-brand-400', 'ring-2', 'ring-brand-400/30');
                    } else {
                        btn.classList.add('bg-slate-800', 'border-slate-600');
                        btn.classList.remove('bg-brand-600', 'border-brand-400', 'ring-2', 'ring-brand-400/30');
                    }
                });
            }

            function detectViralPlatform(url) {
                if (url.includes('tiktok.com')) {
                    selectViralPlatform('tiktok');
                } else if (url.includes('instagram.com')) {
                    selectViralPlatform('instagram');
                } else if (url.includes('youtube.com') || url.includes('youtu.be')) {
                    selectViralPlatform('youtube');
                }
            }

            // Initialize default platform
            selectViralPlatform('tiktok');

            // Global state to store Step 1 results
            let currentAnalysisData = null;



            // Function for the "Viral Shorts Generator" input field
            async function analyzeViralInputVideo() {
                const url = document.getElementById('viralVideoUrl').value.trim();
                // ... (rest of the existing logic) ...
                const analyzeBtn = document.getElementById('analyzeBtn');
                const loading = document.getElementById('nanoLoading');
                const manualContainer = document.getElementById('manualInputContainer');
                // ...
                if (!url) {
                    alert('URLì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                    return;
                }

                // Reset UI
                loading.classList.remove('hidden');
                outputContainer.classList.add('hidden');
                analyzeBtn.disabled = true;
                analyzeBtn.classList.add('opacity-50');
                generateBtn.disabled = true;
                generateBtn.classList.add('opacity-50', 'cursor-not-allowed');

                loading.querySelector('p').innerText = 'STEP 1: ì˜ìƒ ë¶„ì„ ë° ëŒ€ë³¸ ì¶”ì¶œ ì¤‘...';

                try {
                    const response = await fetch('/api/analyze-viral-video', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ url, platform: selectedViralPlatform })
                    });

                    const data = await response.json();

                    currentAnalysisData = data;

                    // Render Analysis Result (inline, not modal)
                    renderViralScript(null, currentAnalysisData);
                    outputContainer.classList.remove('hidden');

                    // Enable Step 2
                    generateBtn.disabled = false;
                    generateBtn.classList.remove('opacity-50', 'cursor-not-allowed');

                    // If extraction failed (empty data), show alert
                    if (!data.transcript && (!data.comments || data.comments.length === 0)) {
                        alert('ì˜ìƒ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
                    }

                } catch (error) {
                    console.error('Analysis Error:', error);
                    alert('ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
                    generateBtn.disabled = false;
                    generateBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                } finally {
                    loading.classList.add('hidden');
                    analyzeBtn.disabled = false;
                    analyzeBtn.classList.remove('opacity-50');
                }
            }

            async function generateViralScript() {
                const generateBtn = document.getElementById('generateNanoBtn');
                const loading = document.getElementById('nanoLoading');
                const outputContainer = document.getElementById('nanoOutputContainer');

                if (!currentAnalysisData || !currentAnalysisData.transcript) {
                    alert('ë¨¼ì € 1ë‹¨ê³„ì—ì„œ ì˜ìƒì„ ë¶„ì„í•´ì£¼ì„¸ìš”.');
                    return;
                }

                const useViralPatterns = document.getElementById('useViralPatternsNano')?.checked || false;

                loading.classList.remove('hidden');
                loading.querySelector('p').innerText = 'STEP 2: ë°”ì´ëŸ´ ì‡¼ì¸  ëŒ€ë³¸ ìƒì„± ì¤‘...';
                generateBtn.disabled = true;
                generateBtn.classList.add('opacity-50');

                try {
                    // Use the existing rewrite endpoint with viral_shorts style
                    const response = await fetch('/api/transcript-rewrite', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            videoId: currentAnalysisData.videoUrl || '',
                            videoTitle: currentAnalysisData.metadata?.title || 'ë°”ì´ëŸ´ ì‡¼ì¸ ',
                            comments: currentAnalysisData.comments.join('\n'),
                            transcript: currentAnalysisData.transcript,
                            style: 'viral_shorts', // Default to viral_shorts style
                            aiProvider: 'gemini'
                        })
                    });

                    if (!response.ok) throw new Error('ëŒ€ë³¸ ìƒì„± ì‹¤íŒ¨');

                    const scriptData = await response.json();

                    // Parse the markdown script into sections
                    const parsedScript = parseViralScript(scriptData.scriptMarkdown);

                    // Re-render including the script
                    renderViralScript(parsedScript, currentAnalysisData);

                    outputContainer.classList.remove('hidden');
                    outputContainer.scrollIntoView({ behavior: 'smooth', block: 'center' });

                } catch (error) {
                    console.error('Generation Error:', error);
                    alert(`ëŒ€ë³¸ ìƒì„± ì˜¤ë¥˜: ${error.message}`);
                } finally {
                    loading.classList.add('hidden');
                    generateBtn.disabled = false;
                    generateBtn.classList.remove('opacity-50');
                }
            }

            // Helper function to parse the viral script into sections
            function parseViralScript(markdown) {
                // Simple parser for Hook/ì „ê°œ/ë°˜ì „ structure
                const sections = [];

                // Split by emoji/section markers
                const lines = markdown.split('\n');
                let currentSection = null;

                for (const line of lines) {
                    // Detect section headers
                    if (line.includes('Hook') || line.includes('ğŸ”¥')) {
                        if (currentSection) sections.push(currentSection);
                        currentSection = { type: 'Hook (0~3ì´ˆ)', script: '', visual: '' };
                    } else if (line.includes('ì „ê°œ') || line.includes('â„ï¸')) {
                        if (currentSection) sections.push(currentSection);
                        currentSection = { type: 'ì „ê°œ (3~9ì´ˆ)', script: '', visual: '' };
                    } else if (line.includes('ë°˜ì „') || line.includes('ğŸ¾')) {
                        if (currentSection) sections.push(currentSection);
                        currentSection = { type: 'ë°˜ì „ (9~16ì´ˆ)', script: '', visual: '' };
                    } else if (line.includes('ê°•ì¡°') || line.includes('ğŸ’–')) {
                        if (currentSection) sections.push(currentSection);
                        currentSection = { type: 'ê°•ì¡° (16~23ì´ˆ)', script: '', visual: '' };
                    } else if (line.includes('CTA') || line.includes('âœ¨')) {
                        if (currentSection) sections.push(currentSection);
                        currentSection = { type: 'CTA (23~30ì´ˆ)', script: '', visual: '' };
                    } else if (currentSection && line.trim()) {
                        // Add content to current section
                        currentSection.script += line + '\n';
                    }
                }

                if (currentSection) sections.push(currentSection);

                return {
                    title: 'ë°”ì´ëŸ´ ì‡¼ì¸  ëŒ€ë³¸',
                    concept: 'ì‚¬ê±´í˜• ì‡¼ì¸  ëŒ€ë³¸',
                    sections: sections
                };
            }

            function renderViralScript(data, analysis) {
                const content = document.getElementById('nanoScriptContent');
                let html = '';

                // 0. Analysis Results Section
                if (analysis) {
                    html += `
                    <div class="mb-10 bg-slate-900/60 rounded-3xl border border-slate-700 p-6 shadow-lg">
                        <div class="flex flex-col md:flex-row gap-6 items-start mb-6">
                            ${analysis.metadata.thumbnail ? `
                                <div class="w-full md:w-48 aspect-video rounded-xl overflow-hidden border border-slate-700 shadow-md">
                                    <img src="${analysis.metadata.thumbnail}" alt="Thumbnail" class="w-full h-full object-cover">
                                </div>
                            ` : ''}
                            <div class="flex-1">
                                <h3 class="text-xl font-black text-white mb-2 leading-tight">${analysis.metadata.title}</h3>
                                <div class="flex flex-wrap gap-3 text-xs text-slate-400 mb-4">
                                    <span class="flex items-center gap-1"><span class="text-brand-400">ğŸ‘¤</span> ${analysis.metadata.author}</span>
                                    <span class="flex items-center gap-1"><span class="text-brand-400">ğŸ‘ï¸</span> ${analysis.metadata.views.toLocaleString()}</span>
                                    <span class="flex items-center gap-1"><span class="text-brand-400">â¤ï¸</span> ${analysis.metadata.likes.toLocaleString()}</span>
                                </div>
                                ${analysis.videoUrl ? `
                                    <a href="${analysis.videoUrl}" target="_blank" download 
                                        class="inline-flex items-center gap-2 bg-slate-800 hover:bg-slate-700 text-white text-xs font-bold py-2 px-4 rounded-lg border border-slate-600 transition-all">
                                        ğŸ“¥ ì˜ìƒ ë‹¤ìš´ë¡œë“œ (ì›ë³¸)
                                    </a>
                                ` : ''}
                                <button onclick="saveViralToArchive()" 
                                    class="inline-flex items-center gap-2 bg-green-900/50 hover:bg-green-800/50 text-green-100 text-xs font-bold py-2 px-4 rounded-lg border border-green-700/50 transition-all ml-2">
                                    ğŸ’¾ ë°”ì´ëŸ´ ì‹œíŠ¸ì— ì €ì¥
                                </button>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <!-- Transcription -->
                            <div class="space-y-3">
                                <h4 class="text-xs font-black text-slate-500 uppercase tracking-widest flex items-center gap-2">
                                    ğŸ¤ Whisper ì „ì‚¬ ëŒ€ë³¸ (ì›ë³¸)
                                </h4>
                                <div class="bg-black/40 rounded-xl p-4 border border-slate-800 max-h-48 overflow-y-auto text-sm leading-relaxed text-slate-300 font-mono">
                                    ${analysis.transcript.replace(/\n/g, '<br>')}
                                </div>
                            </div>
                            <!-- Comments -->
                            <div class="space-y-3">
                                <h4 class="text-xs font-black text-slate-500 uppercase tracking-widest flex items-center gap-2">
                                    ğŸ’¬ ìˆ˜ì§‘ëœ ì£¼ìš” ëŒ“ê¸€ ë°˜ì‘
                                </h4>
                                <div class="bg-black/40 rounded-xl p-4 border border-slate-800 max-h-48 overflow-y-auto">
                                    <ul class="space-y-2">
                                        ${analysis.comments.map(c => `
                                            <li class="text-xs text-slate-400 border-l-2 border-brand-500/30 pl-3 py-1 bg-slate-800/20 rounded-r">
                                                ${c}
                                            </li>
                                        `).join('')}
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="relative flex py-5 items-center">
                        <div class="flex-grow border-t border-slate-700"></div>
                        <span class="flex-shrink mx-4 text-slate-500 text-xs font-black uppercase tracking-[0.3em]">Viral Script Generation</span>
                        <div class="flex-grow border-t border-slate-700"></div>
                    </div>
                `;
                }

                // Only show script sections if data exists (Step 2)
                if (data) {
                    // Concept Section
                    html += `
                    <div class="bg-indigo-900/30 rounded-2xl p-6 border border-indigo-500/30 mb-8 mt-6">
                        <h3 class="text-xl font-bold text-indigo-300 mb-3">ğŸ¯ ${data.title || 'ë°”ì´ëŸ´ ì‡¼ì¸  ê¸°íšì•ˆ'}</h3>
                        <p class="text-slate-300 leading-relaxed mb-4">${data.concept ? data.concept.replace(/\n/g, '<br>') : ''}</p>
                        ${data.reasoning ? `
                            <div class="bg-indigo-950/50 rounded-xl p-4 border border-indigo-500/20">
                                <h4 class="text-xs font-bold text-indigo-400 mb-2 uppercase flex items-center gap-1">
                                    ğŸ’¡ ëŒ€ë³¸ ìƒì„± ê·¼ê±° (Reasoning)
                                </h4>
                                <p class="text-slate-300 text-sm leading-relaxed font-light italic">
                                    "${data.reasoning}"
                                </p>
                            </div>
                        ` : ''}
                        
                        <!-- Japanese Translation Button -->
                        <div class="mt-6 flex gap-3">
                            <button onclick="translateToJapanese()" 
                                class="inline-flex items-center gap-2 bg-gradient-to-r from-red-600 to-pink-600 hover:from-red-500 hover:to-pink-500 text-white font-bold py-3 px-6 rounded-xl shadow-lg transition-all transform hover:scale-105">
                                ğŸ‡¯ğŸ‡µ ì¼ë³¸ì–´ë¡œ ë²ˆì—­ + ë°œìŒ ìƒì„±
                            </button>
                        </div>
                    </div>
                    
                    <!-- Japanese Translation Result (Initially Hidden) -->
                    <div id="japaneseTranslationSection" class="hidden mb-8">
                        <div class="bg-pink-900/20 rounded-2xl p-6 border border-pink-500/30">
                            <h3 class="text-xl font-bold text-pink-300 mb-3">ğŸ‡¯ğŸ‡µ ì¼ë³¸ì–´ ë²ˆì—­ ê²°ê³¼</h3>
                            <div id="japaneseTranslationResult" class="text-slate-300 leading-relaxed whitespace-pre-wrap">
                                <!-- Translation will be inserted here -->
                            </div>
                        </div>
                    </div>
                `;

                    // Sections Loop (Hook -> Story -> Twist -> CTA)
                    if (data.sections && data.sections.length > 0) {
                        html += '<div class="space-y-4">';
                        data.sections.forEach((section, index) => {
                            // Determine color based on section type keyword
                            let typeColor = 'text-brand-400';
                            let borderColor = 'border-slate-700';
                            let bgClass = 'bg-slate-800/50';

                            if (section.type.includes('Hook') || section.type.includes('ğŸ”¥')) {
                                typeColor = 'text-orange-400';
                                borderColor = 'border-orange-500/30';
                            } else if (section.type.includes('ë°˜ì „') || section.type.includes('Twist')) {
                                typeColor = 'text-purple-400';
                                borderColor = 'border-purple-500/30';
                                bgClass = 'bg-slate-800/80';
                            } else if (section.type.includes('CTA')) {
                                typeColor = 'text-green-400';
                            }

                            html += `
                            <div class="${bgClass} rounded-2xl p-6 border ${borderColor} hover:border-brand-500/50 transition-all group">
                                <div class="flex flex-col md:flex-row gap-4">
                                    <!-- Type & Header -->
                                    <div class="w-full md:w-32 flex-shrink-0">
                                        <span class="inline-block ${typeColor} font-black text-sm uppercase tracking-wider mb-2 bg-black/30 px-2 py-1 rounded">
                                            ${section.type}
                                        </span>
                                    </div>

                                    <!-- Script & Visual -->
                                    <div class="flex-1 space-y-3">
                                        <div>
                                            <h4 class="text-xs font-bold text-slate-500 mb-1 flex items-center gap-1">
                                                ğŸ—£ï¸ SCRIPT (ë‚˜ë ˆì´ì…˜/ëŒ€ì‚¬)
                                            </h4>
                                            <p class="text-white text-lg font-medium leading-relaxed font-sans">
                                                "${section.script}"
                                            </p>
                                        </div>
                                        
                                        <div class="border-t border-slate-700/50 pt-2">
                                            <h4 class="text-xs font-bold text-slate-500 mb-1 flex items-center gap-1">
                                                ğŸ¥ VISUAL (í™”ë©´ ì—°ì¶œ)
                                            </h4>
                                            <p class="text-slate-400 text-sm">
                                                ${section.visual}
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                        });
                        html += '</div>';
                    } else {
                        html += '<p class="text-slate-500 text-center py-10">ëŒ€ë³¸ ìƒì„± ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                    }
                }

                content.innerHTML = html;
            }

            // Japanese Translation Function
            async function translateToJapanese() {
                const nanoScriptContent = document.getElementById('nanoScriptContent');

                if (!nanoScriptContent) {
                    alert('ë¨¼ì € ëŒ€ë³¸ì„ ìƒì„±í•´ì£¼ì„¸ìš”.');
                    return;
                }

                // Extract Korean script from the rendered sections
                let koreanScript = '';
                const sections = nanoScriptContent.querySelectorAll('.bg-slate-800\\/50, .bg-slate-800\\/80');
                sections.forEach((section) => {
                    const typeLabel = section.querySelector('.uppercase');
                    const scriptText = section.querySelector('.text-white.text-lg');

                    if (typeLabel && scriptText) {
                        koreanScript += `\n${typeLabel.textContent.trim()} \n${scriptText.textContent.trim()} \n`;
                    }
                });

                if (!koreanScript.trim()) {
                    alert('ë²ˆì—­í•  ëŒ€ë³¸ì´ ì—†ìŠµë‹ˆë‹¤.');
                    return;
                }

                const translationSection = document.getElementById('japaneseTranslationSection');
                const translationResult = document.getElementById('japaneseTranslationResult');

                // Show loading state
                translationSection.classList.remove('hidden');
                translationResult.innerHTML = `
                \u003cdiv class="flex flex-col items-center justify-center py-8 space-y-4"\u003e
                \u003cdiv class="loader w-8 h-8 border-4 border-t-pink-500"\u003e\u003c / div\u003e
                \u003cp class="text-pink-400 animate-pulse text-sm"\u003eì¼ë³¸ì–´ë¡œ ë²ˆì—­ ì¤‘... (ì œëª©, ë²ˆì—­, ë°œìŒ, í¸ì§‘ ê°€ì´ë“œ) \u003c / p\u003e
                \u003c / div\u003e
                    `;

                try {
                    const response = await fetch('/api/translate-to-japanese', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ koreanScript })
                    });

                    if (!response.ok) {
                        const error = await response.json();
                        throw new Error(error.error || 'ë²ˆì—­ ì‹¤íŒ¨');
                    }

                    const data = await response.json();

                    // Display translation result
                    translationResult.innerHTML = `
                \u003cpre class="whitespace-pre-wrap font-sans text-slate-300 leading-relaxed"\u003e${data.translation} \u003c / pre\u003e
                \u003cdiv class="mt-4 flex gap-2"\u003e
                \u003cbutton onclick = "copyTranslation()"
                class="bg-pink-800 hover:bg-pink-700 text-white font-bold py-2 px-4 rounded-lg transition-all"\u003e
                            ğŸ“‹ ë²ˆì—­ ë³µì‚¬
                \u003c / button\u003e
                \u003c / div\u003e
                    `;

                } catch (error) {
                    console.error('Translation Error:', error);
                    translationResult.innerHTML = `
                \u003cdiv class="text-red-400 text-center py-4"\u003e
                        ë²ˆì—­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}
                \u003c / div\u003e
                `;
                }
            }

            function copyTranslation() {
                const translationResult = document.getElementById('japaneseTranslationResult');
                const text = translationResult.querySelector('pre')?.textContent || '';

                navigator.clipboard.writeText(text).then(() => {
                    alert('ì¼ë³¸ì–´ ë²ˆì—­ì´ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
                }).catch(err => {
                    console.error('ë³µì‚¬ ì‹¤íŒ¨:', err);
                });
            }

            function copyNanoScript() {
                const content = document.getElementById('nanoScriptContent');
                const text = Array.from(content.querySelectorAll('.bg-slate-800\\/50')).map((scene, idx) => {
                    const prompt = scene.querySelector('.font-mono').innerText;
                    const desc = scene.querySelector('.text-slate-300').innerText;
                    const bubbles = Array.from(scene.querySelectorAll('.flex-1')).map(b => {
                        const speakerLabel = b.previousElementSibling.innerText;
                        const meta = b.querySelector('.text-slate-500').innerText;
                        const txt = b.querySelector('.text-white').innerText;
                        return `${speakerLabel} ${meta}: ${txt} `;
                    }).join('\n');
                    return `[SCENE 0${idx + 1}]\nImage Prompt: ${prompt} \nì¥ë©´ ì„¤ëª…: ${desc} \në§í’ì„ : \n${bubbles} `;
                }).join('\n\n');

                navigator.clipboard.writeText(text).then(() => {
                    alert('ëŒ€ë³¸ì´ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
                }).catch(err => {
                    console.error('ë³µì‚¬ ì‹¤íŒ¨:', err);
                });
            }

            async function saveViralToArchive(isManual = false) {
                let payload = {};

                if (isManual) {
                    // Manual Save Mode
                    const manualInput = document.getElementById('manualComments').value.trim();
                    const url = document.getElementById('viralVideoUrl').value.trim();

                    if (!manualInput) {
                        alert('ì €ì¥í•  ë‚´ìš©(ëŒ€ë³¸/ëŒ“ê¸€)ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                        return;
                    }

                    // Create payload from manual input
                    payload = {
                        videoId: url || 'manual_' + Date.now(),
                        title: 'ìˆ˜ë™ ì…ë ¥ ë°ì´í„°',
                        transcript: manualInput,
                        comments: ['ìˆ˜ë™ ì…ë ¥ë¨'],
                        viewCount: 0,
                        url: url
                    };
                } else {
                    // Auto Analysis Result Save Mode
                    if (!currentAnalysisData) {
                        alert('ë¶„ì„ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                        return;
                    }

                    // Extract videoId logic...
                    let videoId = currentAnalysisData.metadata.id;
                    if (!videoId && currentAnalysisData.videoUrl) {
                        const url = currentAnalysisData.videoUrl;
                        if (url.includes('youtube') || url.includes('youtu.be')) {
                            const match = url.match(/(?:v=|youtu\.be\/)([^&?]+)/);
                            if (match) videoId = match[1];
                        } else {
                            videoId = url;
                        }
                    }

                    payload = {
                        videoId: videoId || 'unknown_id',
                        title: currentAnalysisData.metadata.title || 'Untitled',
                        transcript: currentAnalysisData.transcript || '',
                        comments: currentAnalysisData.comments || [],
                        viewCount: currentAnalysisData.metadata.views || 0,
                        url: currentAnalysisData.videoUrl
                    };
                }

                const btn = event.target;
                const originalText = btn.innerText;
                btn.innerText = 'ğŸ’¾ ì €ì¥ ì¤‘...';
                btn.disabled = true;

                try {
                    const response = await fetch('/api/analyze-and-save', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        throw new Error('ì €ì¥ ì‹¤íŒ¨');
                    }

                    const result = await response.json();
                    alert(`âœ… ì €ì¥ ì™„ë£Œ!\në°”ì´ëŸ´ ì ìˆ˜: ${result.data.viralPoint.score} ì \nHook: ${result.data.viralPoint.hook} `);
                    btn.innerText = 'âœ… ì €ì¥ë¨';

                } catch (error) {
                    console.error('Save error:', error);
                    alert(`ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message} `);
                    btn.innerText = originalText;
                    btn.disabled = false;
                }
            }

            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // ì¬ê°€ê³µ ì˜ìƒ ë°œê²¬ ì‹œìŠ¤í…œ í•¨ìˆ˜ë“¤
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

            // Tab ì „í™˜
            function switchReprocessedTab(tab) {
                const tabs = ['search', 'channel', 'trending'];
                tabs.forEach(t => {
                    const tabBtn = document.getElementById(`tab${t.charAt(0).toUpperCase() + t.slice(1)} `);
                    const tabContent = document.getElementById(`${t} Tab`);
                    if (t === tab) {
                        tabBtn.className = 'reprocessed-tab px-6 py-3 font-bold text-purple-400 border-b-2 border-purple-500 bg-purple-500/10';
                        tabContent.classList.remove('hidden');
                    } else {
                        tabBtn.className = 'reprocessed-tab px-6 py-3 font-medium text-slate-400 border-b-2 border-transparent hover:text-purple-300';
                        tabContent.classList.add('hidden');
                    }
                });
            }

            // ì¬ê°€ê³µ ì˜ìƒ ê²€ìƒ‰
            async function searchReprocessedVideos() {
                const language = document.getElementById('reprocessedLanguage').value;
                const category = document.getElementById('reprocessedCategory').value;
                const minViews = document.getElementById('reprocessedMinViews').value;
                const dateRange = document.getElementById('reprocessedDateRange').value;
                const btn = document.getElementById('searchReprocessedBtn');

                btn.disabled = true;
                btn.innerHTML = `< div class="loader" ></div > <span>ê²€ìƒ‰ ì¤‘...</span>`;

                try {
                    const response = await fetch(`/ api / search - reprocessed ? language = ${language}& category=${category}& minViews=${minViews}& dateRange=${dateRange}& youtubeApiKey=${YOUTUBE_API_KEY} `);
                    const data = await response.json();

                    if (!data.videos || data.videos.length === 0) {
                        alert('ì¬ê°€ê³µ ì˜ìƒì„ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ë‹¤ë¥¸ í•„í„°ë¡œ ì‹œë„í•´ë³´ì„¸ìš”.');
                        return;
                    }

                    // ê²°ê³¼ë¥¼ Results Gridì— í‘œì‹œ
                    renderReprocessedResults(data.videos, `ì¬ê°€ê³µ ì˜ìƒ ê²€ìƒ‰ ê²°ê³¼(${data.language}) - ${data.totalResults} ê°œ`);

                } catch (error) {
                    console.error('ê²€ìƒ‰ ì—ëŸ¬:', error);
                    alert('ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
                } finally {
                    btn.disabled = false;
                    btn.innerHTML = `< svg class="w-5 h-5" fill = "none" stroke = "currentColor" viewBox = "0 0 24 24" > <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg > <span>ì¬ê°€ê³µ ì˜ìƒ ê²€ìƒ‰</span>`;
                }
            }

            // ê²°ê³¼ ë Œë”ë§ (ê¸°ì¡´ ê²°ê³¼ ê·¸ë¦¬ë“œ ì‚¬ìš©)
            function renderReprocessedResults(videos, title) {
                const resultsGrid = document.getElementById('resultsGrid');
                const sortBar = document.getElementById('sortBar');
                const loading = document.getElementById('loading');
                const emptyState = document.getElementById('emptyState');

                loading.classList.add('hidden');
                sortBar.classList.add('hidden'); // ì •ë ¬ ë°” ìˆ¨ê¹€
                emptyState.classList.add('hidden');

                let html = `< div class="col-span-full mb-4" > <h3 class="text-2xl font-bold text-purple-400">${title}</h3></div > `;

                videos.forEach(video => {
                    const badge = video.hasNarration ? `< span class="absolute top-2 right-2 bg-purple-600 text-white text-xs font-bold px-2 py-1 rounded-full" >ğŸ™ï¸ ë‚˜ë ˆì´ì…˜</span > ` : '';
                    const source = video.sourceAttribution ? `< p class="text-xs text-slate-500 mt-1" >ğŸ“„ ${escapeHtml(video.sourceAttribution)}</p > ` : '';

                    html += `
                    < div class="glass-panel p-4 rounded-xl hover:border-purple-500/50 transition-all cursor-pointer transform hover:scale-[1.02]" >
                        <div class="relative mb-3">
                            <a href="https://www.youtube.com/watch?v=${video.videoId}" target="_blank">
                                <img src="${video.thumbnail}" alt="${escapeHtml(video.title)}" class="w-full aspect-video object-cover rounded-lg">
                            </a>
                            ${badge}
                        </div>
                        <h4 class="text-sm font-bold text-white mb-2 line-clamp-2">${escapeHtml(video.title)}</h4>
                        <p class="text-xs text-slate-400 mb-2">${video.channelTitle}</p>
                        <div class="flex justify-between items-center text-xs">
                            <span class="text-brand-400 font-bold">${formatNumber(video.viewCount)}íšŒ</span>
                            <span class="text-slate-500">${formatDate(video.publishedAt)}</span>
                        </div>
                        ${source}
                <button onclick="reprocessVideo('${video.videoId}', '${escapeHtml(video.title).replace(/'/g, "\\'")}') " 
                class="mt-3 w-full bg-purple-600 hover:bg-purple-500 text-white text-xs font-bold py-2 rounded-lg transition" >
                    ì¬ê°€ê³µ
                        </button >
                    </div >
                    `;
                });

                resultsGrid.innerHTML = html;
                resultsGrid.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }

            // ì±„ë„ ë¶„ì„
            async function analyzeChannel() {
                const input = document.getElementById('channelInput').value.trim();
                const resultDiv = document.getElementById('channelResult');
                const btn = document.getElementById('analyzeChannelBtn');

                if (!input) {
                    alert('ì±„ë„ URL ë˜ëŠ” IDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                    return;
                }

                // Extract channel ID from URL or handle
                let channelId = input;
                if (input.includes('@')) {
                    // Handle like @ì¼ë¶„ì¼ì´ˆ - need to resolve to channel ID first
                    alert('ì±„ë„ í•¸ë“¤(@)ì€ ì•„ì§ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ì±„ë„ í˜ì´ì§€ì—ì„œ URLì˜ ì±„ë„ IDë¥¼ ë³µì‚¬í•´ì£¼ì„¸ìš”.');
                    return;
                } else if (input.includes('youtube.com/channel/')) {
                    channelId = input.split('youtube.com/channel/')[1].split('/')[0].split('?')[0];
                } else if (input.startsWith('UC')) {
                    channelId = input;
                } else {
                    alert('ì˜¬ë°”ë¥¸ ì±„ë„ IDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”. (UCë¡œ ì‹œì‘)');
                    return;
                }

                btn.disabled = true;
                btn.textContent = 'ë¶„ì„ ì¤‘...';
                resultDiv.classList.remove('hidden');
                resultDiv.innerHTML = '<div class="flex items-center gap-2"><div class="loader"></div> ì±„ë„ ë¶„ì„ ì¤‘...</div>';

                try {
                    const response = await fetch(`/ api / analyze - channel ? channelId = ${channelId}& youtubeApiKey=${YOUTUBE_API_KEY} `);
                    const data = await response.json();

                    if (data.error) {
                        resultDiv.innerHTML = `< p class="text-red-400" > ${data.error}</p > `;
                        return;
                    }

                    // ì±„ë„ ë¶„ì„ ê²°ê³¼ ë Œë”ë§
                    let html = `
                    < div class="flex items-center gap-4 mb-6" >
                        <img src="${data.thumbnailUrl}" alt="${escapeHtml(data.channelTitle)}" class="w-24 h-24 rounded-full border-2 border-purple-500">
                        <div>
                            <h3 class="text-2xl font-bold text-white">${escapeHtml(data.channelTitle)}</h3>
                            <div class="flex gap-4 mt-2 text-sm text-slate-400">
                                <span>ğŸ‘¥ êµ¬ë…ì: <strong class="text-purple-400">${formatNumber(data.subscriberCount)}</strong></span>
                                <span>ğŸ“¹ ì˜ìƒ: <strong class="text-purple-400">${formatNumber(data.videoCount)}</strong>ê°œ</span>
                                <span>ğŸ“Š í‰ê·  ì¡°íšŒìˆ˜: <strong class="text-purple-400">${formatNumber(data.avgViewCount)}</strong></span>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <h4 class="text-lg font-bold text-purple-400 mb-3">ğŸ”¥ ìµœê·¼ ì¸ê¸° ì˜ìƒ Top 10</h4>
                            <div class="space-y-2">
                                ${data.recentTopVideos.map((video, i) => `
                                    <div class="bg-slate-900/50 p-3 rounded-lg hover:bg-slate-800/50 transition">
                                        <div class="flex items-center gap-2">
                                            <span class="text-purple-400 font-bold text-sm">#${i + 1}</span>
                                            <a href="https://www.youtube.com/watch?v=${video.videoId}" target="_blank" class="flex-1">
                                                <p class="text-sm text-white line-clamp-1 hover:text-purple-300">${escapeHtml(video.title)}</p>
                                                <p class="text-xs text-slate-500">${formatNumber(video.viewCount)}íšŒ â€¢ ${formatDate(video.publishedAt)}</p>
                                            </a>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>

                        <div>
                            <h4 class="text-lg font-bold text-purple-400 mb-3">ğŸ·ï¸ ìì£¼ ì‚¬ìš©í•˜ëŠ” í‚¤ì›Œë“œ</h4>
                            <div class="flex flex-wrap gap-2">
                                ${data.frequentKeywords.map(keyword => `
                                    <span class="bg-purple-600/20 text-purple-300 px-3 py-1 rounded-full text-sm border border-purple-500/30">${escapeHtml(keyword)}</span>
                                `).join('')}
                            </div>
                            <p class="mt-4 text-xs text-slate-500">ğŸ’¡ ì´ í‚¤ì›Œë“œë“¤ì„ ì°¸ê³ í•˜ì—¬ ìœ ì‚¬í•œ ì½˜í…ì¸ ë¥¼ ì œì‘í•´ë³´ì„¸ìš”!</p>
                        </div>
                    </div>
                `;

                    resultDiv.innerHTML = html;

                } catch (error) {
                    console.error('ì±„ë„ ë¶„ì„ ì—ëŸ¬:', error);
                    resultDiv.innerHTML = `< p class="text-red-400" > ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}</p > `;
                } finally {
                    btn.disabled = false;
                    btn.textContent = 'ë¶„ì„ ì‹œì‘';
                }
            }

            // íŠ¸ë Œë“œ ëª¨ë‹ˆí„°ë§
            async function monitorTrending() {
                const region = document.getElementById('trendingRegion').value;
                const category = document.getElementById('trendingCategory').value;
                const resultDiv = document.getElementById('trendingResult');
                const btn = document.getElementById('monitorTrendingBtn');

                btn.disabled = true;
                btn.innerHTML = '<div class="loader"></div> ì¡°íšŒ ì¤‘...';
                resultDiv.classList.remove('hidden');
                resultDiv.innerHTML = '<div class="flex items-center gap-2"><div class="loader"></div> ê¸‰ìƒìŠ¹ ì˜ìƒ ì¡°íšŒ ì¤‘...</div>';

                try {
                    const response = await fetch(`/ api / trending - monitor ? region = ${region}& category=${category}& youtubeApiKey=${YOUTUBE_API_KEY} `);
                    const data = await response.json();

                    if (!data.trending || data.trending.length === 0) {
                        resultDiv.innerHTML = '<p class="text-slate-400">íŠ¸ë Œë”© Shorts ì˜ìƒì„ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</p>';
                        return;
                    }

                    const regionFlag = {
                        JP: 'ğŸ‡¯ğŸ‡µ', KR: 'ğŸ‡°ğŸ‡·', US: 'ğŸ‡ºğŸ‡¸', TW: 'ğŸ‡¹ğŸ‡¼', ES: 'ğŸ‡ªğŸ‡¸', DE: 'ğŸ‡©ğŸ‡ª'
                    }[region] || 'ğŸŒ';

                    // íŠ¸ë Œë”© ê²°ê³¼ ë Œë”ë§
                    let html = `
                    < div class="mb-4" >
                        <h3 class="text-xl font-bold text-orange-400 mb-2">${regionFlag} ${region} ê¸‰ìƒìŠ¹ Shorts - ì´ ${data.totalCount}ê°œ</h3>
                        <div class="flex gap-4 text-sm">
                            <span class="text-green-400">âœ… ì•„ì§ ì¬ê°€ê³µ ì•ˆë¨: <strong>${data.notYetReprocessed.length}ê°œ</strong></span>
                            <span class="text-slate-400">âšª ì´ë¯¸ ì¬ê°€ê³µë¨: <strong>${data.totalCount - data.notYetReprocessed.length}ê°œ</strong></span>
                        </div>
                    </div >

                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        ${data.trending.map(video => {
                        const badge = video.isReprocessed
                            ? '<span class="bg-slate-600 text-slate-300 text-xs px-2 py-1 rounded">âšª ì¬ê°€ê³µë¨</span>'
                            : '<span class="bg-green-600 text-white text-xs px-2 py-1 rounded">âœ… ì›ë³¸</span>';

                        return `
                                <div class="bg-slate-800/50 p-4 rounded-xl border ${video.isReprocessed ? 'border-slate-700' : 'border-green-500/50'} hover:border-orange-500/50 transition">
                                    <div class="relative mb-3">
                                        <a href="https://www.youtube.com/watch?v=${video.videoId}" target="_blank">
                                            <img src="${video.thumbnail}" alt="${escapeHtml(video.title)}" class="w-full aspect-video object-cover rounded-lg">
                                        </a>
                                        <div class="absolute top-2 right-2">${badge}</div>
                                    </div>
                                    <h4 class="text-sm font-bold text-white mb-2 line-clamp-2">${escapeHtml(video.title)}</h4>
                                    <p class="text-xs text-slate-400 mb-2">${video.channelTitle}</p>
                                    <div class="flex justify-between items-center text-xs">
                                        <span class="text-orange-400 font-bold">${formatNumber(video.viewCount)}íšŒ</span>
                                        <span class="text-slate-500">${formatDate(video.publishedAt)}</span>
                                    </div>
                                    ${!video.isReprocessed ? `
                                        <button onclick="analyzeVideo('${video.videoId}', '${escapeHtml(video.title).replace(/'/g, "\\'")}')" 
                                            class="mt-3 w-full bg-green-600 hover:bg-green-500 text-white text-xs font-bold py-2 rounded-lg transition">
                                            ğŸ¯ ì´ ì˜ìƒ ì¬ê°€ê³µí•˜ê¸°
                                        </button>
                                    ` : ''}
                                </div>
                            `;
                    }).join('')}
                    </div>
                `;

                    resultDiv.innerHTML = html;

                } catch (error) {
                    console.error('íŠ¸ë Œë“œ ëª¨ë‹ˆí„°ë§ ì—ëŸ¬:', error);
                    resultDiv.innerHTML = `< p class="text-red-400" > ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}</p > `;
                } finally {
                    btn.disabled = false;
                    btn.innerHTML = 'ê¸‰ìƒìŠ¹ ì˜ìƒ ì¡°íšŒ';
                }
            }
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // ì¶œì²˜ URL ì¶”ì¶œ ë° í”Œë«í¼ë³„ ë°”ì´ëŸ´ ì½˜í…ì¸  ê°€ì ¸ì˜¤ê¸°
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

            let extractedSources = null;
            let viralContent = null;

            async function extractChannelSources() {
                const channelInput = document.getElementById('channelInput').value.trim();
                const btn = document.getElementById('extractSourcesBtn');

                if (!channelInput) {
                    alert('ì±„ë„ URL ë˜ëŠ” IDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                    return;
                }

                btn.disabled = true;
                btn.innerHTML = `< div class="loader" ></div > <span>ì±„ë„ ì •ë³´ í™•ì¸ ì¤‘...</span>`;

                try {
                    // Extract channel ID or handle from various formats
                    let channelIdOrHandle = channelInput;
                    let isHandle = false;

                    if (channelInput.includes('youtube.com')) {
                        const match = channelInput.match(/channel\/([^\/\?]+)|@([^\/\?]+)/);
                        if (match) {
                            channelIdOrHandle = match[1] || match[2];
                            if (match[2]) isHandle = true; // @ í•¸ë“¤ì¸ ê²½ìš°
                        }
                    } else if (channelInput.startsWith('@')) {
                        isHandle = true;
                        channelIdOrHandle = channelInput;
                    }

                    // If it's a handle (@...), convert to channel ID using search API
                    let channelId = channelIdOrHandle;
                    if (isHandle) {
                        btn.innerHTML = `< div class="loader" ></div > <span>ì±„ë„ ID í™•ì¸ ì¤‘...</span>`;

                        // Remove @ if present
                        const handleName = channelIdOrHandle.replace('@', '');

                        // Search for channel by handle
                        const searchResponse = await fetch(
                            `https://www.googleapis.com/youtube/v3/search?part=snippet&type=channel&q=${encodeURIComponent(handleName)}&maxResults=1&key=${YOUTUBE_API_KEY}`
                        );
                        const searchData = await searchResponse.json();

                        if (!searchData.items || searchData.items.length === 0) {
                            throw new Error(`ì±„ë„ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ${channelIdOrHandle}`);
                        }

                        channelId = searchData.items[0].snippet.channelId;
                        console.log(`[Extract Sources] Converted handle ${channelIdOrHandle} to channel ID: ${channelId}`);
                    }

                    btn.innerHTML = `<div class="loader"></div> <span>ì¶œì²˜ ì¶”ì¶œ ì¤‘...</span>`;

                    // Step 1: Extract source URLs
                    const extractResponse = await fetch('/api/extract-sources', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ channelId, youtubeApiKey: YOUTUBE_API_KEY })
                    });

                    if (!extractResponse.ok) {
                        throw new Error(await extractResponse.text());
                    }

                    extractedSources = await extractResponse.json();

                    // Step 2: Fetch viral content metadata
                    btn.innerHTML = `<div class="loader"></div> <span>ì›ë³¸ ì˜ìƒ ê°€ì ¸ì˜¤ëŠ” ì¤‘...</span>`;

                    const fetchResponse = await fetch('/api/fetch-viral-content', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ sources: extractedSources.sources, youtubeApiKey: YOUTUBE_API_KEY })
                    });

                    if (!fetchResponse.ok) {
                        throw new Error(await fetchResponse.text());
                    }

                    viralContent = await fetchResponse.json();

                    // Display results
                    displaySourceResults();

                } catch (error) {
                    console.error('Extract sources error:', error);
                    alert('ì¶œì²˜ ì¶”ì¶œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
                } finally {
                    btn.disabled = false;
                    btn.innerHTML = `
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                    </svg>
                    ì¶œì²˜ ì¶”ì¶œ
                `;
                }
            }

            function displaySourceResults() {
                const resultsDiv = document.getElementById('sourceResults');
                const statsDiv = document.getElementById('sourceStats');

                resultsDiv.classList.remove('hidden');

                // Display statistics
                const stats = {
                    youtube: viralContent.youtube.length,
                    tiktok: viralContent.tiktok.length,
                    instagram: viralContent.instagram.length,
                    facebook: viralContent.facebook.length
                };

                statsDiv.innerHTML = `
                <div class="bg-red-900/20 border border-red-500/30 rounded-lg p-4 text-center">
                    <div class="text-3xl font-bold text-red-400">${stats.youtube}</div>
                    <div class="text-xs text-slate-400 mt-1">YouTube ì›ë³¸</div>
                </div>
                <div class="bg-slate-800/50 border border-slate-600 rounded-lg p-4 text-center">
                    <div class="text-3xl font-bold text-white">${stats.tiktok}</div>
                    <div class="text-xs text-slate-400 mt-1">TikTok ì›ë³¸</div>
                </div>
                <div class="bg-gradient-to-r from-purple-900/20 to-pink-900/20 border border-purple-500/30 rounded-lg p-4 text-center">
                    <div class="text-3xl font-bold text-purple-400">${stats.instagram}</div>
                    <div class="text-xs text-slate-400 mt-1">Instagram ì›ë³¸</div>
                </div>
                <div class="bg-blue-900/20 border border-blue-500/30 rounded-lg p-4 text-center">
                    <div class="text-3xl font-bold text-blue-400">${stats.facebook}</div>
                    <div class="text-xs text-slate-400 mt-1">Facebook ì›ë³¸</div>
                </div>
            `;

                // Show first non-empty platform
                if (stats.youtube > 0) switchPlatformTab('youtube');
                else if (stats.tiktok > 0) switchPlatformTab('tiktok');
                else if (stats.instagram > 0) switchPlatformTab('instagram');
                else if (stats.facebook > 0) switchPlatformTab('facebook');
            }

            function switchPlatformTab(platform) {
                // Update tab styles
                ['youtube', 'tiktok', 'instagram', 'facebook'].forEach(p => {
                    const tab = document.getElementById(`${p}Tab`);
                    if (p === platform) {
                        tab.classList.remove('bg-slate-700', 'text-slate-300');
                        if (p === 'youtube') tab.classList.add('bg-red-600', 'text-white');
                        else if (p === 'tiktok') tab.classList.add('bg-slate-900', 'text-white');
                        else if (p === 'instagram') tab.classList.add('bg-gradient-to-r', 'from-purple-600', 'to-pink-600', 'text-white');
                        else if (p === 'facebook') tab.classList.add('bg-blue-600', 'text-white');
                    } else {
                        tab.className = 'platform-tab-btn flex-1 py-2 px-4 rounded-lg bg-slate-700 text-slate-300 hover:bg-slate-600 transition';
                    }
                });

                // Render content
                renderPlatformContent(platform);
            }

            function renderPlatformContent(platform) {
                const content = document.getElementById('platformContent');
                const videos = viralContent[platform] || [];

                if (videos.length === 0) {
                    content.innerHTML = `
                    <div class="text-center py-12 text-slate-400">
                        <p class="text-lg">ì´ í”Œë«í¼ì—ì„œ ì¶”ì¶œëœ ì›ë³¸ ì˜ìƒì´ ì—†ìŠµë‹ˆë‹¤.</p>
                    </div>
                `;
                    return;
                }

                let html = '<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">';

                videos.forEach(video => {
                    const platformBadge = {
                        youtube: '<span class="bg-red-600 text-white text-xs px-2 py-1 rounded">YouTube</span>',
                        tiktok: '<span class="bg-slate-900 text-white text-xs px-2 py-1 rounded">TikTok</span>',
                        instagram: '<span class="bg-gradient-to-r from-purple-600 to-pink-600 text-white text-xs px-2 py-1 rounded">Instagram</span>',
                        facebook: '<span class="bg-blue-600 text-white text-xs px-2 py-1 rounded">Facebook</span>'
                    };

                    if (video.needsApify) {
                        // Instagram/Facebook - needs Apify
                        html += `
                        <div class="bg-slate-800 rounded-lg p-4 border border-slate-700">
                            <div class="flex items-start justify-between mb-3">
                                ${platformBadge[platform]}
                                <span class="text-xs text-orange-400">âš ï¸ Apify í•„ìš”</span>
                            </div>
                            <a href="${escapeHtml(video.url)}" target="_blank" class="text-sm text-slate-300 hover:text-white line-clamp-2 mb-3">${escapeHtml(video.url)}</a>
                            <p class="text-xs text-slate-500">${video.message}</p>
                            <a href="${escapeHtml(video.url)}" target="_blank" class="mt-3 block w-full bg-slate-700 hover:bg-slate-600 text-white text-sm font-medium py-2 px-4 rounded-lg text-center transition">
                                ì›ë³¸ ë³´ê¸°
                            </a>
                        </div>
                    `;
                    } else {
                        // YouTube / TikTok with metadata
                        const thumbnail = video.thumbnail || 'https://via.placeholder.com/480x270?text=No+Thumbnail';
                        const viewCount = video.viewCount ? `ğŸ‘ï¸ ${formatNumber(video.viewCount)}íšŒ` : '';
                        const likeCount = video.likeCount ? `â¤ï¸ ${formatNumber(video.likeCount)}` : '';

                        html += `
                        <div class="bg-slate-800 rounded-lg overflow-hidden border border-slate-700 hover:border-${platform === 'youtube' ? 'red' : 'slate'}-500 transition">
                            <div class="relative">
                                <img src="${thumbnail}" alt="${escapeHtml(video.title)}" class="w-full aspect-video object-cover">
                                ${platformBadge[platform]}
                            </div>
                            <div class="p-4">
                                <h4 class="text-sm font-bold text-white mb-2 line-clamp-2">${escapeHtml(video.title)}</h4>
                                ${video.authorName ? `<p class="text-xs text-slate-400 mb-2">${escapeHtml(video.authorName)}</p>` : ''}
                                <div class="flex items-center gap-3 text-xs text-slate-500 mb-3">
                                    ${viewCount ? `<span>${viewCount}</span>` : ''}
                                    ${likeCount ? `<span>${likeCount}</span>` : ''}
                                </div>
                                <div class="flex gap-2">
                                    <a href="${escapeHtml(video.url)}" target="_blank" class="flex-1 bg-slate-700 hover:bg-slate-600 text-white text-xs font-medium py-2 px-3 rounded-lg text-center transition">
                                        ì›ë³¸ ë³´ê¸°
                                    </a>
                                    ${platform === 'youtube' ? `
                                        <button onclick="analyzeVideo('${video.id}', '${escapeHtml(video.title).replace(/'/g, "\\'")}')" class="bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-500 hover:to-pink-500 text-white text-xs font-medium py-2 px-3 rounded-lg transition">
                                            ì¬ê°€ê³µ
                                        </button>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    `;
                    }
                });

                html += '</div>';
                content.innerHTML = html;
            }

            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // Image Upload & OCR Source Detection
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

            let uploadedImageBase64 = null;

            // Setup drag & drop
            document.addEventListener('DOMContentLoaded', () => {
                const dropZone = document.getElementById('dropZone');
                const imageUpload = document.getElementById('imageUpload');

                if (dropZone && imageUpload) {
                    dropZone.addEventListener('click', () => imageUpload.click());

                    dropZone.addEventListener('dragover', (e) => {
                        e.preventDefault();
                        dropZone.classList.add('border-purple-500', 'bg-purple-500/10');
                    });

                    dropZone.addEventListener('dragleave', () => {
                        dropZone.classList.remove('border-purple-500', 'bg-purple-500/10');
                    });

                    dropZone.addEventListener('drop', (e) => {
                        e.preventDefault();
                        dropZone.classList.remove('border-purple-500', 'bg-purple-500/10');

                        const files = e.dataTransfer.files;
                        if (files.length > 0 && files[0].type.startsWith('image/')) {
                            handleImageUpload(files[0]);
                        }
                    });

                    imageUpload.addEventListener('change', (e) => {
                        if (e.target.files.length > 0) {
                            handleImageUpload(e.target.files[0]);
                        }
                    });
                }
            });

            function handleImageUpload(file) {
                const reader = new FileReader();

                reader.onload = (e) => {
                    uploadedImageBase64 = e.target.result;

                    // Show preview
                    document.getElementById('previewImg').src = e.target.result;
                    document.getElementById('imagePreview').classList.remove('hidden');
                    document.getElementById('ocrBtn').classList.remove('hidden');

                    // Hide OCR results
                    document.getElementById('ocrResults').classList.add('hidden');
                };

                reader.readAsDataURL(file);
            }

            function clearImage() {
                uploadedImageBase64 = null;
                document.getElementById('imagePreview').classList.add('hidden');
                document.getElementById('ocrBtn').classList.add('hidden');
                document.getElementById('ocrResults').classList.add('hidden');
                document.getElementById('imageUpload').value = '';
            }

            async function extractSourceFromImage() {
                if (!uploadedImageBase64) {
                    alert('ì´ë¯¸ì§€ë¥¼ ë¨¼ì € ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.');
                    return;
                }

                const btn = document.getElementById('ocrBtn');
                btn.disabled = true;
                btn.innerHTML = `<div class="loader"></div> <span>OCR ì²˜ë¦¬ ì¤‘...</span>`;

                try {
                    const response = await fetch('/api/ocr-source', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            image: uploadedImageBase64,
                            youtubeApiKey: YOUTUBE_API_KEY
                        })
                    });

                    if (!response.ok) {
                        throw new Error(await response.text());
                    }

                    const data = await response.json();

                    // Display OCR results
                    displayOCRResults(data);

                } catch (error) {
                    console.error('OCR error:', error);
                    alert('OCR ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
                } finally {
                    btn.disabled = false;
                    btn.innerHTML = `
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                    </svg>
                    <span>OCRë¡œ ì¶œì²˜ ì¶”ì¶œ</span>
                `;
                }
            }

            function displayOCRResults(data) {
                const resultsDiv = document.getElementById('ocrResults');
                const outputDiv = document.getElementById('ocrOutput');

                resultsDiv.classList.remove('hidden');

                if (!data.channelName) {
                    outputDiv.innerHTML = `
                    <div class="text-center py-8">
                        <p class="text-lg text-slate-300 mb-2">âŒ ì¶œì²˜ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</p>
                        <p class="text-sm text-slate-500 mb-4">ì´ë¯¸ì§€ì— "ì¶œì²˜:", "å‡ºì²˜:", "Source:", "@username" ë“±ì˜ í…ìŠ¤íŠ¸ê°€ ìˆëŠ”ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.</p>
                        
                        <!-- Manual Input -->
                        <div class="max-w-md mx-auto mt-6 p-6 bg-slate-800/50 rounded-xl border border-slate-700">
                            <p class="text-sm text-slate-300 mb-3">ğŸ’¡ ì±„ë„ëª…ì„ ì§ì ‘ ì…ë ¥í•˜ì„¸ìš”:</p>
                            <div class="flex gap-2">
                                <input 
                                    type="text" 
                                    id="manualChannelInput" 
                                    placeholder="ì˜ˆ: gigafights, @username" 
                                    class="flex-1 bg-slate-700 text-white px-4 py-2 rounded-lg border border-slate-600 focus:border-purple-500 focus:outline-none"
                                    onkeypress="if(event.key==='Enter') searchManualChannel()"
                                >
                                <button 
                                    onclick="searchManualChannel()" 
                                    class="bg-purple-600 hover:bg-purple-500 text-white px-6 py-2 rounded-lg font-bold transition">
                                    ê²€ìƒ‰
                                </button>
                            </div>
                        </div>
                        
                        ${data.detectedText ? `<div class="mt-4 p-4 bg-slate-700/50 rounded text-left"><p class="text-xs text-slate-400 mb-1">ê°ì§€ëœ í…ìŠ¤íŠ¸:</p><pre class="text-xs text-slate-300 whitespace-pre-wrap">${escapeHtml(data.detectedText)}</pre></div>` : ''}
                    </div>
                `;
                    return;
                }

                const platformBadge = data.platform === 'instagram'
                    ? '<span class="bg-gradient-to-r from-purple-600 to-pink-600 text-white text-xs px-2 py-1 rounded">Instagram</span>'
                    : '<span class="bg-red-600 text-white text-xs px-2 py-1 rounded">YouTube</span>';

                let html = `
                <div class="space-y-4">
                    <div class="p-4 bg-green-900/20 border border-green-500/30 rounded-lg">
                        <div class="flex items-center gap-2 mb-2">
                            <span class="text-green-400 text-lg">âœ“</span>
                            <span class="font-bold text-white">ì±„ë„ëª… ì¶”ì¶œ ì„±ê³µ</span>
                            ${platformBadge}
                        </div>
                        <p class="text-2xl font-bold text-white mb-1">${data.platform === 'instagram' ? '@' : ''}${escapeHtml(data.channelName)}</p>
                        <p class="text-sm text-slate-400">ì‹ ë¢°ë„: ${Math.round(data.confidence * 100)}%</p>
                    </div>
            `;

                if (data.detectedText) {
                    html += `
                    <details class="p-4 bg-slate-700/30 rounded-lg">
                        <summary class="cursor-pointer text-sm text-slate-400 hover:text-white">ì „ì²´ OCR í…ìŠ¤íŠ¸ ë³´ê¸°</summary>
                        <pre class="text-xs text-slate-300 mt-3 whitespace-pre-wrap">${escapeHtml(data.detectedText)}</pre>
                    </details>
                `;
                }

                // Related shorts - always show if available
                if (data.relatedShorts && data.relatedShorts.length > 0) {
                    const shortsTitle = data.platform === 'instagram'
                        ? 'ğŸ“¸ ì´ Instagram ê³„ì •ì„ ì¶œì²˜ë¡œ í‘œê¸°í•œ YouTube Shorts'
                        : 'ğŸ¯ ê´€ë ¨ ì¸ê¸° YouTube Shorts';

                    html += `
                    <div class="p-4 bg-gradient-to-r from-purple-900/20 to-pink-900/20 border border-purple-500/30 rounded-lg">
                        <p class="text-lg font-bold text-white mb-4">${shortsTitle} (${data.relatedShorts.length}ê°œ ë°œê²¬!)</p>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                `;

                    data.relatedShorts.forEach(video => {
                        const viewCount = video.viewCount >= 1000 ? `ğŸ‘ï¸ ${formatNumber(video.viewCount)}` : '';
                        const likeCount = video.likeCount >= 100 ? `â¤ï¸ ${formatNumber(video.likeCount)}` : '';
                        const duration = video.duration ? `${video.duration}ì´ˆ` : '';

                        html += `
                        <div class="bg-slate-800/50 rounded-lg overflow-hidden border border-slate-700 hover:border-purple-500 transition">
                            <div class="relative">
                                <img src="${video.thumbnail}" alt="${escapeHtml(video.title)}" class="w-full aspect-video object-cover">
                                <span class="absolute top-2 right-2 bg-red-600 text-white text-xs px-2 py-1 rounded font-bold">SHORTS</span>
                                ${duration ? `<span class="absolute bottom-2 right-2 bg-black/80 text-white text-xs px-2 py-1 rounded">${duration}</span>` : ''}
                            </div>
                            <div class="p-3">
                                <p class="text-sm text-white line-clamp-2 mb-2">${escapeHtml(video.title)}</p>
                                <div class="flex items-center justify-between text-xs text-slate-400">
                                    <span>${viewCount}</span>
                                    <span>${likeCount}</span>
                                </div>
                                <div class="flex gap-2 mt-2">
                                    <button onclick="window.open('https://www.youtube.com/watch?v=${video.id}', '_blank')" class="flex-1 bg-slate-700 hover:bg-slate-600 text-white text-xs py-1.5 rounded transition">
                                        ì˜ìƒ ë³´ê¸°
                                    </button>
                                    <button onclick="reprocessVideo('${video.id}')" class="bg-purple-600 hover:bg-purple-500 text-white text-xs px-4 py-1.5 rounded font-bold transition">
                                        ì¬ê°€ê³µ
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                    });

                    html += `
                        </div>
                    </div >
                    `;
                }

                // YouTube channels
                if (data.channels && data.channels.length > 0) {
                    html += `
                    < div >
                        <h4 class="font-bold text-white mb-3">ğŸ¯ ì°¾ì€ YouTube ì±„ë„ (${data.channels.length}ê°œ)</h4>
                        <div class="space-y-3">
                `;

                    data.channels.forEach(channel => {
                        html += `
                        <div class="p-4 bg-slate-700/50 rounded-lg hover:bg-slate-700 transition cursor-pointer" onclick="loadChannelVideos('${channel.id}', '${escapeHtml(channel.title).replace(/'/g, "\\'")}')">
                            <div class="flex items-start gap-4">
                                <img src="${channel.thumbnail}" alt="${escapeHtml(channel.title)}" class="w-20 h-20 rounded-full object-cover">
                                <div class="flex-1">
                                    <h5 class="font-bold text-white mb-1">${escapeHtml(channel.title)}</h5>
                                    <p class="text-sm text-slate-400 mb-2">${escapeHtml(channel.description || 'ì„¤ëª… ì—†ìŒ').substring(0, 100)}...</p>
                                    <div class="flex items-center gap-4 text-xs text-slate-500">
                                        <span>ğŸ‘¥ ${formatNumber(channel.subscriberCount)} êµ¬ë…ì</span>
                                        <span>ğŸ“¹ ${formatNumber(channel.videoCount)} ì˜ìƒ</span>
                                    </div>
                                </div>
                                <button class="bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-500 hover:to-pink-500 text-white text-sm font-medium py-2 px-4 rounded-lg transition">
                                    ì˜ìƒ ë³´ê¸°
                                </button>
                            </div>
                        </div>
                    `;
                    });

                    html += `
                        </div>
                    </div >
                    `;
                }

                html += `</div > `;
                outputDiv.innerHTML = html;
            }

            async function loadChannelVideos(channelId, channelTitle) {
                console.log(`Loading videos from channel: ${channelId} (${channelTitle})`);

                // Use existing channel extraction logic
                document.getElementById('channelInput').value = channelId;
                await extractChannelSources();
            }

            // --- Viral Shorts Script Generator Integration ---

            function selectPlatform(platform) {
                scriptGenPlatform = platform;
                document.querySelectorAll('.platform-btn').forEach(btn => {
                    btn.classList.add('bg-slate-700');
                    btn.classList.remove('border-brand-500', 'bg-brand-600', 'bg-pink-600', 'bg-red-600');
                });

                const btn = document.getElementById(`platform-${platform}`);
                if (btn) {
                    btn.classList.remove('bg-slate-700');
                    btn.classList.add('border-brand-500');
                    if (platform === 'TikTok') btn.classList.add('bg-brand-600');
                    else if (platform === 'Instagram') btn.classList.add('bg-pink-600');
                    else if (platform === 'YouTube') btn.classList.add('bg-red-600');
                }
            }

            async function analyzeVideo() {
                const urlInput = document.getElementById('viralVideoUrl');
                const fileInput = document.getElementById('scriptGenVideoFile');
                const resultDiv = document.getElementById('scriptGenResult');
                const step1Btn = document.getElementById('step1Btn');
                const step2Btn = document.getElementById('step2Btn');

                if (!scriptGenPlatform) return alert('í”Œë«í¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');

                const hasUrl = urlInput.value.trim();
                const hasFile = fileInput.files && fileInput.files.length > 0;

                if (!hasUrl && !hasFile) return alert('URLì„ ì…ë ¥í•˜ê±°ë‚˜ íŒŒì¼ì„ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.');

                // Show loading
                resultDiv.classList.remove('hidden');
                resultDiv.innerHTML = `
                <div class="bg-slate-800/50 rounded-xl p-6 border border-brand-500/30">
                    <div class="flex flex-col items-center justify-center py-8 space-y-4">
                        <div class="loader w-12 h-12 border-4 border-t-brand-500"></div>
                        <p class="text-brand-400 animate-pulse font-bold">Whisper AIë¡œ ì˜ìƒ ë¶„ì„ ì¤‘...</p>
                        <p class="text-sm text-slate-400">${scriptGenPlatform} â€¢ ${hasFile ? 'íŒŒì¼ ì—…ë¡œë“œ' : 'URL ë¶„ì„'}</p>
                    </div>
                </div>
            `;
                step1Btn.disabled = true;

                try {
                    let transcript = '';
                    let metadata = {};
                    let responseData = null; // âœ… ê³µí†µ ë³€ìˆ˜ ì„ ì–¸

                    if (hasFile) {
                        const file = fileInput.files[0];
                        if (file.size > 25 * 1024 * 1024) throw new Error('íŒŒì¼ í¬ê¸°ëŠ” 25MB ì´í•˜ì—¬ì•¼ í•©ë‹ˆë‹¤.');

                        const formData = new FormData();
                        formData.append('videoFile', file);
                        formData.append('title', file.name);
                        formData.append('platform', scriptGenPlatform);

                        const response = await fetch('http://localhost:4000/api/upload-viral-video', {
                            method: 'POST',
                            body: formData
                        });
                        const data = await response.json();
                        if (!response.ok) throw new Error(data.error || 'ì—…ë¡œë“œ ì‹¤íŒ¨');

                        transcript = data.data.transcript;
                        metadata = data.data.metadata;
                        responseData = data; // âœ… ì €ì¥
                    } else {
                        // URL ë¶„ì„ êµ¬í˜„ âœ…
                        const response = await fetch('http://localhost:4000/api/analyze-viral-video', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ url: hasUrl })
                        });

                        const data = await response.json();

                        if (!data.success) {
                            throw new Error(data.error || 'URL ë¶„ì„ ì‹¤íŒ¨');
                        }

                        transcript = data.data.transcript || 'ìë§‰ì„ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤';
                        metadata = {
                            title: data.data.metadata?.title || data.data.videoId || 'ì˜ìƒ ì œëª©',
                            platform: data.data.platform || scriptGenPlatform,
                            videoId: data.data.videoId
                        };
                        responseData = data; // âœ… ì €ì¥
                    }

                    // Success - Store data globally
                    window.currentTranscript = transcript;
                    window.currentVideoTitle = metadata.title;
                    window.currentPlatform = metadata.platform;
                    window.currentVideoId = metadata.videoId || 'viral_' + Date.now(); // âœ… ì‹¤ì œ ë¹„ë””ì˜¤ ID ì‚¬ìš©
                    window.currentComments = responseData?.data?.comments?.join('\n- ') || ''; // âœ… ëŒ“ê¸€ë„ ì €ì¥

                    // Show success message briefly
                    resultDiv.innerHTML = `
                    <div class="bg-emerald-900/20 border border-emerald-500/30 rounded-xl p-6 mt-4">
                        <p class="text-emerald-400 font-bold mb-2">âœ… ë¶„ì„ ì™„ë£Œ!</p>
                        <p class="text-white text-sm mb-1">ğŸ“¹ ${escapeHtml(metadata.title)}</p>
                        <p class="text-slate-400 text-xs">ëª¨ë‹¬ì„ ì—¬ëŠ” ì¤‘...</p>
                    </div>
                `;

                    // Open the modal after a brief delay
                    setTimeout(() => {
                        openUnifiedScriptModal();  // âœ… í†µí•© ëª¨ë‹¬ ì‚¬ìš©
                    }, 500);

                } catch (error) {
                    console.error('[Analyze Error]', error);
                    resultDiv.innerHTML = `
                    <div class="bg-red-900/20 border border-red-500/30 rounded-xl p-6 mt-4">
                        <p class="text-red-400 font-bold">âŒ ë¶„ì„ ì‹¤íŒ¨</p>
                        <p class="text-slate-400 text-sm">${error.message}</p>
                    </div>
                `;
                } finally {
                    step1Btn.disabled = false;
                }
            }

            /**
             * í†µí•© ë°”ì´ëŸ´ ìŠ¤í¬ë¦½íŠ¸ ëª¨ë‹¬
             * (Unified Viral Script Modal)
             * 
             * ëª¨ë“  í”Œë«í¼(YouTube, TikTok, Instagram) ê³µí†µ ì‚¬ìš©
             * í”Œë«í¼ë³„ ì°¨ì´ëŠ” ì¡°ê±´ë¬¸ìœ¼ë¡œ ì²˜ë¦¬
             */
            function openUnifiedScriptModal() {
                if (!window.currentTranscript) {
                    alert('ë¨¼ì € 1ë‹¨ê³„ ë¶„ì„ì„ ì™„ë£Œí•´ì£¼ì„¸ìš”.');
                    return;
                }

                // Populate the modal with extracted data
                const modal = document.getElementById('analysisModal');
                const modalContent = document.getElementById('modalContent');
                const modalTitle = document.getElementById('modal-title');

                if (!modal || !modalContent) {
                    console.error('[Modal Error] Modal elements not found');
                    alert('ëª¨ë‹¬ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.');
                    return;
                }

                // Update modal title
                if (modalTitle) {
                    modalTitle.textContent = `${window.currentVideoTitle} - ëŒ€ë³¸ ì¶”ì¶œ ì™„ë£Œ`;
                }

                // Display the full rewrite modal with all features (reprocessVideo ìŠ¤íƒ€ì¼ UI)
                modalContent.innerHTML = `
                <div class="space-y-6">
                    <div class="bg-slate-800/50 rounded-xl p-4 border border-slate-700">
                        <h4 class="text-lg font-bold text-white mb-2">ğŸ“¹ ì˜ìƒ ì œëª©</h4>
                        <p class="text-slate-300">${escapeHtml(window.currentVideoTitle)}</p>
                    </div>
                    
                    <div class="bg-slate-800/50 rounded-xl p-4 border border-slate-700">
                        <h4 class="text-lg font-bold text-white mb-2">ğŸ’¬ ì‹œì²­ì ëŒ“ê¸€ (Top 50)</h4>
                        <div class="max-h-60 overflow-y-auto bg-slate-900/50 rounded-lg p-4">
                            <textarea id="commentsText" class="w-full bg-transparent text-sm text-slate-300 outline-none resize-none whitespace-pre-wrap" rows="8" placeholder="ëŒ“ê¸€ì„ ë¶™ì—¬ë„£ê±°ë‚˜ ìˆ˜ë™ìœ¼ë¡œ ì…ë ¥í•˜ì„¸ìš”...">${window.currentComments ? '- ' + window.currentComments : ''}</textarea>
                        </div>
                    </div>
                    
                    <div class="bg-slate-800/50 rounded-xl p-4 border border-slate-700">
                        <h4 class="text-lg font-bold text-white mb-3">ğŸ“ ì˜ìƒ ìë§‰ (Transcript)</h4>
                        <div class="flex gap-2 mb-3">
                            <select id="aiProvider" class="flex-1 bg-slate-700 border border-slate-600 rounded-lg px-3 py-2 text-white text-sm">
                                <option value="gemini">Gemini 2.5 Flash</option>
                                <option value="claude">Claude Sonnet 4.5</option>
                            </select>
                            <select id="scriptStyle" class="flex-1 bg-slate-700 border border-slate-600 rounded-lg px-3 py-2 text-white text-sm">
                                <option value="viral_shorts">ğŸ”¥ ë°”ì´ëŸ´ Shorts (500-800ì)</option>
                                <option value="viral_shorts_reverse">ğŸ”„ ë°”ì´ëŸ´ Shorts ì—­ìˆœ</option>
                                <option value="viral_shorts_loop">ğŸ” ë°”ì´ëŸ´ Shorts ë¬´í•œ ë£¨í”„</option>
                                <option value="humor">ğŸ˜‚ ìœ ë¨¸ (ë°˜ì „ ì½”ë¯¸ë””)</option>
                                <option value="senior_shorts_drama">ğŸ‘´ ì‹œë‹ˆì–´ ì‚¬ì—° Shorts</option>
                                <option value="senior_shorts_drama_reverse">ğŸ”„ ì‹œë‹ˆì–´ ì‚¬ì—° ì—­ìˆœ</option>
                                <option value="senior_shorts_drama_thirdperson">ğŸ‘ï¸ ì‹œë‹ˆì–´ ì‚¬ì—° 3ì¸ì¹­</option>
                                <option value="senior_shorts_drama_detail">âœ¨ ì‹œë‹ˆì–´ ì‚¬ì—° ë””í…Œì¼</option>
                            </select>
                            <button onclick="generateScriptFromModal('${window.currentVideoId}', '${escapeHtml(window.currentVideoTitle).replace(/'/g, "\\\\'")}')" 
                                class="bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-500 hover:to-pink-500 text-white font-bold px-6 py-2 rounded-lg transition">
                                ëŒ€ë³¸ ì¬ì‘ì„±
                            </button>
                        </div>
                        <!-- Viral Pattern Toggle -->
                        <div class="flex items-center gap-2 mb-3 px-1">
                            <input type="checkbox" id="useViralPatterns" class="w-4 h-4 text-emerald-600 bg-slate-700 border-slate-600 rounded focus:ring-emerald-500 focus:ring-2" checked>
                            <label for="useViralPatterns" class="text-sm text-emerald-400 font-bold cursor-pointer select-none flex items-center gap-2">
                                <span>ğŸ§¬</span> í•™ìŠµëœ ë°”ì´ëŸ´ íŒ¨í„´ ì ìš© (Analyzed Patterns)
                            </label>
                        </div>
                            
                        <button onclick="analyzeAndSaveViral()" class="bg-gradient-to-r from-emerald-600 to-teal-600 hover:from-emerald-500 hover:to-teal-500 text-white font-bold px-6 py-2 rounded-lg transition flex items-center gap-2">
                            <span>ğŸ§¬</span>
                            <span>ë°”ì´ëŸ´ ë¶„ì„ & ì €ì¥</span>
                        </button>
                    </div>
                    <!-- Viral Analysis Result Area -->
                    <div id="viralAnalysisResult" class="hidden mb-4 p-4 bg-emerald-900/20 border border-emerald-500/30 rounded-lg"></div>
                    <div class="max-h-96 overflow-y-auto bg-slate-900/50 rounded-lg p-4">
                        <textarea id="transcriptText" class="w-full bg-transparent text-sm text-slate-300 outline-none resize-none" rows="15">${escapeHtml(window.currentTranscript)}</textarea>
                    </div>
                    
                    <div id="rewriteResult" class="hidden bg-slate-800/50 rounded-xl p-4 border border-slate-700">
                        <h4 class="text-lg font-bold text-white mb-3">âœ¨ ì¬ì‘ì„±ëœ ëŒ€ë³¸</h4>
                        <div id="rewriteContent" class="bg-slate-900/50 rounded-lg p-4"></div>
                    </div>
                </div>
            `;

                // Show the modal
                modal.classList.remove('hidden');
            }

            /**
             * í•˜ìœ„ í˜¸í™˜ì„±ì„ ìœ„í•œ ë³„ì¹­ (Backward Compatibility Alias)
             * ê¸°ì¡´ ì½”ë“œì—ì„œ ì´ í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•˜ëŠ” ê³³ì´ ìˆì„ ìˆ˜ ìˆìŒ
             */
            function openViralAnalysisModal() {
                openUnifiedScriptModal();
            }

            function openStep2Rewrite() {
                openUnifiedScriptModal();
            }

            function closeModal() {
                const modal = document.getElementById('analysisModal');
                if (modal) {
                    modal.classList.add('hidden');
                }
            }

        </script>
    </div> <!-- End of Video Search Tab -->








    <!-- ========================================
     HOT Channel Finder - Advanced Filter Modal
     ======================================== -->
    <div id="advancedFilterModal" class="fixed inset-0 z-50 hidden" aria-labelledby="filter-modal-title" role="dialog"
        aria-modal="true">
        <!-- Backdrop -->
        <div class="fixed inset-0 bg-black/80 backdrop-blur-sm transition-opacity" onclick="closeAdvancedFilterModal()">
        </div>

        <div class="fixed inset-0 z-10 overflow-y-auto">
            <div class="flex min-h-full items-center justify-center p-4">
                <div
                    class="relative transform overflow-hidden rounded-2xl bg-slate-900 border border-slate-700 text-left shadow-2xl transition-all w-full max-w-2xl">

                    <!-- Modal Header -->
                    <div
                        class="bg-gradient-to-r from-slate-800 to-slate-900 px-6 py-4 border-b border-slate-700 flex justify-between items-center">
                        <div class="flex items-center gap-3">
                            <div class="p-2 bg-red-500/10 rounded-lg">
                                <svg class="w-6 h-6 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4">
                                    </path>
                                </svg>
                            </div>
                            <h3 class="text-xl font-bold text-white" id="filter-modal-title">âš™ï¸ ê³ ê¸‰ í•„í„°</h3>
                        </div>
                        <button onclick="closeAdvancedFilterModal()"
                            class="text-slate-400 hover:text-white transition-colors p-1 rounded hover:bg-slate-800">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>

                    <!-- Modal Body -->
                    <div class="px-6 py-6 space-y-6">

                        <!-- 1. ì¼ì¼ ì¡°íšŒìˆ˜ ê¸°ì¤€ -->
                        <div>
                            <label class="block text-sm font-bold text-slate-300 mb-3">ì¼ì¼ ì¡°íšŒìˆ˜ ê¸°ì¤€</label>
                            <div class="flex flex-wrap gap-3">
                                <button onclick="selectGrowthPeriod('none')" id="period-none"
                                    class="growth-period-btn px-6 py-2.5 rounded-lg bg-red-600 text-white font-bold shadow-lg transition-all border-2 border-red-500">
                                    ì—†ìŒ
                                </button>
                                <button onclick="selectGrowthPeriod('1day')" id="period-1day"
                                    class="growth-period-btn px-6 py-2.5 rounded-lg bg-slate-700 text-slate-300 hover:bg-slate-600 font-medium transition-all border-2 border-transparent">
                                    1ì¼
                                </button>
                                <button onclick="selectGrowthPeriod('7days')" id="period-7days"
                                    class="growth-period-btn px-6 py-2.5 rounded-lg bg-slate-700 text-slate-300 hover:bg-slate-600 font-medium transition-all border-2 border-transparent">
                                    7ì¼
                                </button>
                                <button onclick="selectGrowthPeriod('30days')" id="period-30days"
                                    class="growth-period-btn px-6 py-2.5 rounded-lg bg-slate-700 text-slate-300 hover:bg-slate-600 font-medium transition-all border-2 border-transparent">
                                    30ì¼
                                </button>
                            </div>
                        </div>

                        <div class="border-t border-slate-700"></div>

                        <!-- 2. ì„±ì¥ ê¸°ì¤€ -->
                        <div>
                            <label class="block text-sm font-bold text-slate-300 mb-3">ì„±ì¥ ê¸°ì¤€</label>
                            <div class="flex flex-wrap gap-3">
                                <button onclick="selectGrowthMetric('total_views')" id="growth-total_views"
                                    class="growth-metric-btn px-6 py-2.5 rounded-lg bg-red-600 text-white font-bold shadow-lg transition-all border-2 border-red-500">
                                    ì´ ì¡°íšŒìˆ˜
                                </button>
                                <button onclick="selectGrowthMetric('subscribers')" id="growth-subscribers"
                                    class="growth-metric-btn px-6 py-2.5 rounded-lg bg-slate-700 text-slate-300 hover:bg-slate-600 font-medium transition-all border-2 border-transparent">
                                    êµ¬ë…ìˆ˜
                                </button>
                            </div>
                            <p class="text-xs text-slate-500 mt-2">* ì¡°íšŒ ì¦ê° ê¸°ì¤€ í˜¹ì€ êµ¬ë… ì¦ê° ê¸°ì¤€ì—ì„œ ì„ íƒí•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤</p>
                        </div>

                        <div class="border-t border-slate-700"></div>

                        <!-- 3. êµ¬ë…ì ë²”ìœ„ -->
                        <div>
                            <label class="block text-sm font-bold text-slate-300 mb-3">êµ¬ë…ì ë²”ìœ„</label>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="text-xs text-slate-500 mb-1 block">ìµœì†Œ</label>
                                    <input type="number" id="filterSubMin" placeholder="0"
                                        class="w-full bg-slate-800 border border-slate-700 rounded-lg px-4 py-2.5 text-white focus:border-red-500 outline-none transition-all">
                                </div>
                                <div>
                                    <label class="text-xs text-slate-500 mb-1 block">ìµœëŒ€</label>
                                    <input type="number" id="filterSubMax" placeholder="10000000"
                                        class="w-full bg-slate-800 border border-slate-700 rounded-lg px-4 py-2.5 text-white focus:border-red-500 outline-none transition-all">
                                </div>
                            </div>
                        </div>

                        <div class="border-t border-slate-700"></div>

                        <!-- 4. ì˜ìƒ ìˆ˜ ë²”ìœ„ -->
                        <div>
                            <label class="block text-sm font-bold text-slate-300 mb-3">ì˜ìƒ ìˆ˜ ë²”ìœ„</label>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="text-xs text-slate-500 mb-1 block">ìµœì†Œ</label>
                                    <input type="number" id="filterVideoMin" placeholder="0"
                                        class="w-full bg-slate-800 border border-slate-700 rounded-lg px-4 py-2.5 text-white focus:border-red-500 outline-none transition-all">
                                </div>
                                <div>
                                    <label class="text-xs text-slate-500 mb-1 block">ìµœëŒ€</label>
                                    <input type="number" id="filterVideoMax" placeholder="1000"
                                        class="w-full bg-slate-800 border border-slate-700 rounded-lg px-4 py-2.5 text-white focus:border-red-500 outline-none transition-all">
                                </div>
                            </div>
                        </div>

                        <div class="border-t border-slate-700"></div>

                        <!-- 5. êµ­ê°€ -->
                        <div>
                            <label class="block text-sm font-bold text-slate-300 mb-3">êµ­ê°€</label>
                            <div class="flex flex-wrap gap-3">
                                <button onclick="selectFilterCountry('KR')" id="filter-country-KR"
                                    class="filter-country-btn flex items-center gap-2 px-5 py-2.5 rounded-lg bg-red-600 text-white font-bold shadow-lg transition-all border-2 border-red-500">
                                    ğŸ‡°ğŸ‡· ëŒ€í•œë¯¼êµ­
                                </button>
                                <button onclick="selectFilterCountry('US')" id="filter-country-US"
                                    class="filter-country-btn flex items-center gap-2 px-5 py-2.5 rounded-lg bg-slate-700 text-slate-300 hover:bg-slate-600 font-medium transition-all border-2 border-transparent">
                                    ğŸ‡ºğŸ‡¸ ë¯¸êµ­
                                </button>
                                <button onclick="selectFilterCountry('JP')" id="filter-country-JP"
                                    class="filter-country-btn flex items-center gap-2 px-5 py-2.5 rounded-lg bg-slate-700 text-slate-300 hover:bg-slate-600 font-medium transition-all border-2 border-transparent">
                                    ğŸ‡¯ğŸ‡µ ì¼ë³¸
                                </button>
                                <button onclick="selectFilterCountry('OTHER')" id="filter-country-OTHER"
                                    class="filter-country-btn flex items-center gap-2 px-5 py-2.5 rounded-lg bg-slate-700 text-slate-300 hover:bg-slate-600 font-medium transition-all border-2 border-transparent">
                                    ğŸŒ ê·¸ ì™¸
                                </button>
                            </div>
                            <p
                                class="text-xs text-slate-400 mt-2 bg-slate-800/50 p-3 rounded-lg border border-slate-700">
                                ğŸ’¡ <strong>í•œêµ­ìœ¼ë¡œ ë³´ê³ ìš”</strong><br>
                                'í•œêµ­ ì„ íƒ'ì‹œ í•œêµ­ì–´ ì œëª©/ì±„ë„ ì˜ìƒë§Œ ë¶„ì„í•©ë‹ˆë‹¤.
                            </p>
                        </div>
                    </div>

                    <!-- Modal Footer -->
                    <div
                        class="bg-slate-800/50 px-6 py-4 border-t border-slate-700 flex justify-between items-center gap-3">
                        <button onclick="resetAdvancedFilters()"
                            class="px-6 py-2.5 bg-slate-700 hover:bg-slate-600 text-white font-medium rounded-lg transition-all">
                            ì´ˆê¸°í™”
                        </button>
                        <button onclick="applyAdvancedFilters()"
                            class="px-8 py-2.5 bg-gradient-to-r from-red-600 to-pink-600 hover:from-red-500 hover:to-pink-500 text-white font-bold rounded-lg shadow-lg transition-all transform hover:scale-[1.02] active:scale-[0.98]">
                            í•„í„° ì ìš©
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ========================================
     HOT Channel Finder - Category Filter Modal
     ======================================== -->
    <div id="categoryFilterModal" class="fixed inset-0 z-50 hidden" aria-labelledby="category-modal-title" role="dialog"
        aria-modal="true">
        <!-- Backdrop -->
        <div class="fixed inset-0 bg-black/80 backdrop-blur-sm transition-opacity" onclick="closeCategoryFilterModal()">
        </div>

        <div class="fixed inset-0 z-10 overflow-y-auto">
            <div class="flex min-h-full items-center justify-center p-4">
                <div
                    class="relative transform overflow-hidden rounded-2xl bg-slate-900 border border-slate-700 text-left shadow-2xl transition-all w-full max-w-5xl max-h-[90vh]">

                    <!-- Modal Header -->
                    <div
                        class="bg-gradient-to-r from-slate-800 to-slate-900 px-6 py-4 border-b border-slate-700 sticky top-0 z-10">
                        <div class="flex justify-between items-center mb-4">
                            <div class="flex items-center gap-3">
                                <div class="p-2 bg-blue-500/10 rounded-lg">
                                    <svg class="w-6 h-6 text-blue-500" fill="none" stroke="currentColor"
                                        viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M4 6h16M4 12h16M4 18h7"></path>
                                    </svg>
                                </div>
                                <h3 class="text-xl font-bold text-white" id="category-modal-title">ğŸ“‚ ì¹´í…Œê³ ë¦¬ í•„í„° (<span
                                        id="categoryTotalCount">0</span>)</h3>
                                <span class="text-sm text-slate-400 ml-2">(ë³µìˆ˜ ì„ íƒ ê°€ëŠ¥)</span>
                            </div>
                            <button onclick="closeCategoryFilterModal()"
                                class="text-slate-400 hover:text-white transition-colors p-1 rounded hover:bg-slate-800">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>

                        <!-- Country Selector & DB Search Button (Hardcoded) -->
                        <div class="flex items-center justify-between" id="categoryFilterCountrySection">
                            <div class="flex items-center gap-2">
                                <button onclick="selectCategoryFilterCountry('KR')" id="cat-filter-country-KR"
                                    class="filter-country-btn px-4 py-2 rounded-lg bg-red-600 text-white border-red-500 shadow-lg transition-all text-sm font-bold border">ğŸ‡°ğŸ‡·
                                    ëŒ€í•œë¯¼êµ­</button>
                                <button onclick="selectCategoryFilterCountry('US')" id="cat-filter-country-US"
                                    class="filter-country-btn px-4 py-2 rounded-lg bg-slate-700 text-slate-300 border border-slate-600 hover:bg-slate-600 transition-all text-sm font-bold">ğŸ‡ºğŸ‡¸
                                    ë¯¸êµ­</button>
                                <button onclick="selectCategoryFilterCountry('JP')" id="cat-filter-country-JP"
                                    class="filter-country-btn px-4 py-2 rounded-lg bg-slate-700 text-slate-300 border border-slate-600 hover:bg-slate-600 transition-all text-sm font-bold">ğŸ‡¯ğŸ‡µ
                                    ì¼ë³¸</button>
                                <button onclick="selectCategoryFilterCountry('ALL')" id="cat-filter-country-ALL"
                                    class="filter-country-btn px-4 py-2 rounded-lg bg-slate-700 text-slate-300 border border-slate-600 hover:bg-slate-600 transition-all text-sm font-bold">ğŸŒ
                                    ì „ì²´</button>
                            </div>
                            <button onclick="searchCategoryFilterDB()"
                                class="px-6 py-2 bg-blue-600 hover:bg-blue-500 text-white rounded-lg font-bold shadow-lg transition-all flex items-center gap-2">
                                <span>ğŸ” ì±„ë„ ë¶ˆëŸ¬ì˜¤ê¸°</span>
                            </button>
                        </div>
                    </div>

                    <!-- Modal Body -->
                    <div class="px-6 py-6">
                        <!-- Category Grid -->
                        <div id="categoryFilterGrid" class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4">
                            <!-- Categories will be populated here dynamically -->
                        </div>

                        <!-- Selected Category Channels -->
                        <div id="selectedCategorySection" class="hidden mt-6">
                            <div class="border-t border-slate-700 pt-4">
                                <h4 class="text-lg font-bold text-white mb-4" id="selectedCategoryTitle"></h4>
                                <div id="selectedCategoryChannels" class="space-y-3 max-h-[50vh] overflow-y-auto pr-2">
                                    <!-- Channels will be listed here -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Modal Footer -->
                    <div
                        class="bg-slate-800/50 px-6 py-4 border-t border-slate-700 flex justify-end items-center gap-3 sticky bottom-0">
                        <button onclick="closeCategoryFilterModal()"
                            class="px-6 py-2.5 bg-slate-700 hover:bg-slate-600 text-white font-medium rounded-lg transition-all">
                            ë‹«ê¸°
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ========================================
    <script>
        // ========================================
        // HOT Channel Finder - Main Script
        // ========================================

        // Global variable to store current search results
        let currentChannels = [];

        let advancedFilterState = {
            growthPeriod: 'none',
            growthMetric: 'total_views',
            subscriberMin: 0,
            subscriberMax: 10000000,
            videoCountMin: 0,
            videoCountMax: 1000,
            country: 'KR',
            categories: []
        };

        function openAdvancedFilterModal() {
            const modal = document.getElementById('advancedFilterModal');
            if (!modal) return;
            modal.classList.remove('hidden');
            selectGrowthPeriod(advancedFilterState.growthPeriod, false);
            selectGrowthMetric(advancedFilterState.growthMetric, false);
            selectFilterCountry(advancedFilterState.country, false);
            document.getElementById('filterSubMin').value = advancedFilterState.subscriberMin || '';
            document.getElementById('filterSubMax').value = advancedFilterState.subscriberMax || '';
            document.getElementById('filterVideoMin').value = advancedFilterState.videoCountMin || '';
            document.getElementById('filterVideoMax').value = advancedFilterState.videoCountMax || '';
        }

        function closeAdvancedFilterModal() {
            const modal = document.getElementById('advancedFilterModal');
            if (modal) modal.classList.add('hidden');
        }

        function selectGrowthPeriod(period, updateState = true) {
            if (updateState) advancedFilterState.growthPeriod = period;
            document.querySelectorAll('.growth-period-btn').forEach(btn => {
                btn.classList.remove('bg-red-600', 'text-white', 'border-red-500', 'shadow-lg', 'font-bold');
                btn.classList.add('bg-slate-700', 'text-slate-300', 'border-transparent', 'font-medium');
            });
            const selectedBtn = document.getElementById(`period-${period}`);
            if (selectedBtn) {
                selectedBtn.classList.remove('bg-slate-700', 'text-slate-300', 'border-transparent', 'font-medium');
                selectedBtn.classList.add('bg-red-600', 'text-white', 'border-red-500', 'shadow-lg', 'font-bold');
            }
        }

        function selectGrowthMetric(metric, updateState = true) {
            if (updateState) advancedFilterState.growthMetric = metric;
            document.querySelectorAll('.growth-metric-btn').forEach(btn => {
                btn.classList.remove('bg-red-600', 'text-white', 'border-red-500', 'shadow-lg', 'font-bold');
                btn.classList.add('bg-slate-700', 'text-slate-300', 'border-transparent', 'font-medium');
            });
            const selectedBtn = document.getElementById(`growth-${metric}`);
            if (selectedBtn) {
                selectedBtn.classList.remove('bg-slate-700', 'text-slate-300', 'border-transparent', 'font-medium');
                selectedBtn.classList.add('bg-red-600', 'text-white', 'border-red-500', 'shadow-lg', 'font-bold');
            }
        }

        function selectFilterCountry(country, updateState = true) {
            if (updateState) advancedFilterState.country = country;
            document.querySelectorAll('.filter-country-btn').forEach(btn => {
                btn.classList.remove('bg-red-600', 'text-white', 'border-red-500', 'shadow-lg', 'font-bold');
                btn.classList.add('bg-slate-700', 'text-slate-300', 'border-transparent', 'font-medium');
            });
            const selectedBtn = document.getElementById(`filter-country-${country}`);
            if (selectedBtn) {
                selectedBtn.classList.remove('bg-slate-700', 'text-slate-300', 'border-transparent', 'font-medium');
                selectedBtn.classList.add('bg-red-600', 'text-white', 'border-red-500', 'shadow-lg', 'font-bold');
            }
        }

        function resetAdvancedFilters() {
            advancedFilterState = {
                growthPeriod: 'none',
                growthMetric: 'total_views',
                subscriberMin: 0,
                subscriberMax: 10000000,
                videoCountMin: 0,
                videoCountMax: 1000,
                country: 'KR',
                categories: []
            };
            selectGrowthPeriod('none', false);
            selectGrowthMetric('total_views', false);
            selectFilterCountry('KR', false);
            document.getElementById('filterSubMin').value = '';
            document.getElementById('filterSubMax').value = '';
            document.getElementById('filterVideoMin').value = '';
            document.getElementById('filterVideoMax').value = '';
        }

        function applyAdvancedFilters() {
            advancedFilterState.subscriberMin = parseInt(document.getElementById('filterSubMin').value) || 0;
            advancedFilterState.subscriberMax = parseInt(document.getElementById('filterSubMax').value) || 10000000;
            advancedFilterState.videoCountMin = parseInt(document.getElementById('filterVideoMin').value) || 0;
            advancedFilterState.videoCountMax = parseInt(document.getElementById('filterVideoMax').value) || 1000;
            closeAdvancedFilterModal();
            searchHotChannels();
        }

        // Helper to get category icon
        function getCategoryIcon(category) {
            const icons = {
                'ì˜í™”/ì• ë‹ˆë©”ì´ì…˜': 'ğŸ¬', 'ìë™ì°¨': 'ğŸš—', 'ìŒì•…': 'ğŸµ', 'ë°˜ë ¤ë™ë¬¼/ë™ë¬¼': 'ğŸ¾', 'ìŠ¤í¬ì¸ ': 'âš½',
                'ì—¬í–‰/ì´ë²¤íŠ¸': 'âœˆï¸', 'ê²Œì„': 'ğŸ®', 'ì¸ë¬¼/ë¸”ë¡œê·¸': 'ğŸ‘¤', 'ì½”ë¯¸ë””': 'ğŸ˜‚', 'ì—”í„°í…Œì¸ë¨¼íŠ¸': 'ğŸ­',
                'ë‰´ìŠ¤/ì •ì¹˜': 'ğŸ“°', 'ë…¸í•˜ìš°/ìŠ¤íƒ€ì¼': 'ğŸ’„', 'êµìœ¡': 'ğŸ“š', 'ê³¼í•™ê¸°ìˆ ': 'ğŸ”¬', 'ë¹„ì˜ë¦¬/ì‚¬íšŒìš´ë™': 'ğŸ¤'
            };
            return icons[category] || 'ğŸ“';
        }

        async function openCategoryFilterModal() {
            const modal = document.getElementById('categoryFilterModal');
            if (!modal) {
                console.error('[Category Filter] Modal not found');
                return;
            }

            modal.classList.remove('hidden');

            // 15 Fixed Categories
            const ALL_CATEGORIES = [
                'ì˜í™”/ì• ë‹ˆë©”ì´ì…˜', 'ìë™ì°¨', 'ìŒì•…', 'ë°˜ë ¤ë™ë¬¼/ë™ë¬¼', 'ìŠ¤í¬ì¸ ',
                'ì—¬í–‰/ì´ë²¤íŠ¸', 'ê²Œì„', 'ì¸ë¬¼/ë¸”ë¡œê·¸', 'ì½”ë¯¸ë””', 'ì—”í„°í…Œì¸ë¨¼íŠ¸',
                'ë‰´ìŠ¤/ì •ì¹˜', 'ë…¸í•˜ìš°/ìŠ¤íƒ€ì¼', 'êµìœ¡', 'ê³¼í•™ê¸°ìˆ ', 'ë¹„ì˜ë¦¬/ì‚¬íšŒìš´ë™'
            ];

            // Determine source of data: Current Results or DB Stats
            let stats = {};
            let totalCount = 0;
            let source = 'db'; // 'db' or 'current'

            // Check if we have current active results
            // We consider 'currentChannels' valid if it has items. 
            // However, we should only use it if the user hasn't wiped the results manually or something.
            // But generally, if there are cards on screen, currentChannels has them.
            console.log('[Category Filter] currentChannels type:', typeof currentChannels);
            console.log('[Category Filter] currentChannels length:', currentChannels ? currentChannels.length : 'null');
            console.log('[Category Filter] Sample channel:', currentChannels && currentChannels[0]);
            
            if (typeof currentChannels !== 'undefined' && currentChannels && currentChannels.length > 0) {
                // Calculate stats from current results
                source = 'current';
                totalCount = currentChannels.length;
                currentChannels.forEach((ch, idx) => {
                    const cat = ch.category || 'ì¼ë°˜';
                    stats[cat] = (stats[cat] || 0) + 1;
                    if (idx < 5) console.log(`[Category Filter] Channel ${idx}: ${ch.name} -> category: ${cat}`);
                });
                console.log('[Category Filter] Calculated stats from currentChannels:', stats);
            } else {
                // Fallback to DB stats
                try {
                    const response = await fetch('http://localhost:4000/api/hot-channels/stats');
                    const data = await response.json();

                    if (data.success && data.stats) {
                        stats = data.stats;
                        totalCount = data.totalChannels || 0;

                        // Update global total display if using DB stats
                        const totalEl = document.getElementById('discovered-channels-total');
                        if (totalEl) totalEl.innerText = totalCount.toLocaleString(); // Using toLocaleString instead of formatCompactNumber as it's not defined here.
                    }
                } catch (error) {
                    console.error('[Category Filter] Error loading stats:', error);
                }
            }

            const container = document.getElementById('categoryFilterGrid');
            if (container) {
                container.innerHTML = ''; // Clear existing

                // Render ALL 15 Categories
                ALL_CATEGORIES.forEach(catName => {
                    const count = stats[catName] || 0;

                    const btn = document.createElement('button');
                    // Check if selected
                    const isSelected = advancedFilterState.categories && advancedFilterState.categories.includes(catName);

                    btn.className = `p-4 rounded-xl border text-left transition-all ${isSelected
                        ? 'bg-brand-600 border-brand-500 text-white shadow-lg shadow-brand-500/20'
                        : 'bg-slate-800 border-slate-700 text-slate-400 hover:border-slate-500 hover:text-slate-200'
                        }`;

                    btn.innerHTML = `
                        <div class="flex items-center gap-3">
                            <span class="text-2xl">${getCategoryIcon(catName)}</span>
                            <div>
                                <h4 class="font-bold text-sm text-white">${catName}</h4>
                                <p class="text-xs text-slate-400 mt-1">${count.toLocaleString()}ê°œ ì±„ë„</p>
                            </div>
                        </div>
                    `;

                    btn.onclick = () => toggleCategoryFilter(catName, btn);
                    container.appendChild(btn);
                });

                // Update header count
                const headerCount = document.querySelector('#categoryFilterModal h3');
                if (headerCount) {
                    headerCount.innerHTML = `ğŸ“‚ ì¹´í…Œê³ ë¦¬ í•„í„° (<span id="categoryTotalCount">${totalCount.toLocaleString()}</span>)`;
                }
            }

            // Add Footer with Apply Button if not exists
            let footer = modal.querySelector('.modal-footer');
            if (!footer) {
                footer = document.createElement('div');
                footer.className = 'modal-footer bg-slate-800/50 px-6 py-4 border-t border-slate-700 flex justify-end gap-3 rounded-b-2xl';
                // Insert after the modal body (the grid container's parent usually)
                // We need to find where to append. Assuming modal structure: Backdrop -> Modal -> Content -> [Header, Body, Footer]
                const modalContent = container.parentElement.parentElement; // Grid -> BodyWrapper(p-8) -> Content
                // Wait, let's verify structure next time. For now, let's append to the main modal content div.
                // Actually, let's just append to the modal content container if we can find it.
                // The 'container' variable is the Grid. Its parent is commonly the padding wrapper.

                // Let's just create a button container inside the Body for now if footer is tricky without full DOM view.

                // BETTER: Prepend to the container or Append to container?
                // Append a full-width row to the grid?
            }

            // Since we replaced innerHTML of container, let's append the button area AFTER the grid items?
            // No, grid is grid-cols-5.
            // Let's replace the whole modal content body logic if possible, or just add a fixed footer in HTML string.

            // Let's try to find the modal footer in DOM.
            // If not found, we can inject it.

            // Simplified: Just add a big "Apply" button at the end of the grid as a full-width item? No.

            // Let's re-render the Apply button into a specific container if it exists, or create one.
            const applyBtnContainer = document.getElementById('categoryFilterActions');
            if (applyBtnContainer) {
                applyBtnContainer.innerHTML = `
                    <button onclick="applyCategoryFilter()" class="w-full py-4 bg-brand-600 hover:bg-brand-500 text-white font-bold rounded-xl shadow-lg transition-all text-lg">
                        í•„í„° ì ìš©í•˜ê¸°
                    </button>
                `;
            } else {
                // Create if missing (append to parent of grid)
                const actionsDiv = document.createElement('div');
                actionsDiv.id = 'categoryFilterActions';
                actionsDiv.className = 'mt-8 pt-6 border-t border-slate-700';
                actionsDiv.innerHTML = `
                    <button onclick="applyCategoryFilter()" class="w-full py-4 bg-brand-600 hover:bg-brand-500 text-white font-bold rounded-xl shadow-lg transition-all text-lg">
                        âœ… ì„ íƒí•œ ì¹´í…Œê³ ë¦¬ë¡œ í•„í„° ì ìš©
                    </button>
                `;
                container.parentElement.appendChild(actionsDiv);
            }

        }

        function closeCategoryFilterModal() {
            const modal = document.getElementById('categoryFilterModal');
            if (modal) modal.classList.add('hidden');
        }

        function applyCategoryFilter() {
            const modal = document.getElementById('categoryFilterModal');
            if (modal) modal.classList.add('hidden');
            searchHotChannels();
        }

        // Helper: Toggle Category Selection
        function toggleCategoryFilter(categoryName, btnElement) {
            if (!advancedFilterState.categories) advancedFilterState.categories = [];

            const index = advancedFilterState.categories.indexOf(categoryName);
            if (index === -1) {
                // Select
                advancedFilterState.categories.push(categoryName);
                btnElement.className = 'p-4 rounded-xl border text-left transition-all bg-brand-600 border-brand-500 text-white shadow-lg shadow-brand-500/20';
            } else {
                // Deselect
                advancedFilterState.categories.splice(index, 1);
                btnElement.className = 'p-4 rounded-xl border text-left transition-all bg-slate-800 border-slate-700 text-slate-400 hover:border-slate-500 hover:text-slate-200';
            }
        }

        async function selectCategory(category) {
            const selectedSection = document.getElementById('selectedCategorySection');
            const selectedTitle = document.getElementById('selectedCategoryTitle');
            const selectedChannels = document.getElementById('selectedCategoryChannels');

            if (!selectedSection || !selectedTitle || !selectedChannels) return;

            // Load discovered channels again
            try {
                const response = await fetch('/discovered_channels.json');
                const discoveredChannels = await response.json();

                // Filter by category
                const channelsInCategory = Object.values(discoveredChannels).filter(
                    channel => (channel.category || 'ì¼ë°˜') === category
                );

                // Update UI
                selectedTitle.textContent = `${category} (${channelsInCategory.length}ê°œ)`;
                selectedSection.classList.remove('hidden');

                selectedChannels.innerHTML = channelsInCategory.map(channel => `
                    <div class="flex items-center gap-4 bg-slate-800/50 rounded-xl p-4 hover:bg-slate-800 transition-all">
                        <div class="flex-1">
                            <h5 class="text-white font-bold mb-1">${escapeHtml(channel.name)}</h5>
                            <div class="flex items-center gap-3 text-sm">
                                <span class="text-slate-400">${escapeHtml(channel.channelId)}</span>
                                <span class="px-2 py-0.5 bg-slate-700/80 text-slate-300 rounded text-xs">
                                    ${new Date(channel.discoveredAt).toLocaleDateString('ko-KR')}
                                </span>
                            </div>
                        </div>
                        <a href="https://www.youtube.com/channel/${channel.channelId}" target="_blank"
                            class="px-4 py-2 bg-red-600 hover:bg-red-500 text-white font-bold rounded-lg transition-all text-sm">
                            ì±„ë„ ë³´ê¸°
                        </a>
                    </div>
                `).join('');

            } catch (error) {
                console.error('[Category Filter] Error loading category channels:', error);
            }
        }

        async function searchHotChannels() {
            const keyword = document.getElementById('channelSearchKeyword') ? document.getElementById('channelSearchKeyword').value.trim() : '';

            // Show loading
            const grid = document.getElementById('channelResultsGrid');
            if (grid) {
                grid.innerHTML = `
                    <div class="flex flex-col items-center justify-center py-20 col-span-full">
                        <div class="loader w-12 h-12 border-4 border-brand-500 border-t-transparent mx-auto mb-4"
                            style="border-radius: 50%; animation: spin 1s linear infinite;"></div>
                        <p class="text-xl font-bold text-white animate-pulse">HOT ì±„ë„ì„ ë°œêµ´í•˜ê³  ìˆìŠµë‹ˆë‹¤...</p>
                        <p class="text-slate-400 mt-2">ìˆ˜ì‹­ë§Œ ê°œì˜ ë°ì´í„°ì—ì„œ ë³´ì„ ê°™ì€ ì±„ë„ì„ ì°¾ëŠ” ì¤‘ì…ë‹ˆë‹¤.</p>
                        ${(advancedFilterState.categories && advancedFilterState.categories.length > 0) ? `<p class="text-brand-400 mt-1 text-sm font-bold">ğŸ¯ ì¹´í…Œê³ ë¦¬ í•„í„°: ${advancedFilterState.categories.join(', ')}</p>` : ''}
                    </div>
                `;
            }

            try {
                // Prepare payload
                const payload = {
                    keyword: keyword,
                    contentType: 'shorts',
                    growthMetric: advancedFilterState.growthMetric || 'total_views',
                    ...advancedFilterState // Include categories
                };

                const response = await fetch('http://localhost:4000/api/hot-channels', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const data = await response.json();

                if (data.channels) {
                    renderHotChannelCards(data.channels); // Changed from renderHotChannels to renderHotChannelCards

                    // Update total count
                    const totalCountEl = document.getElementById('discovered-channels-total');
                    if (totalCountEl) {
                        totalCountEl.textContent = (data.totalCount || 0).toLocaleString();
                    }
                } else {
                    throw new Error('No channels data');
                }

            } catch (error) {
                console.error('[Search] Error:', error);
                if (grid) {
                    grid.innerHTML = `
                        <div class="col-span-full text-center py-20">
                            <span class="text-6xl block mb-4">ğŸ˜µ</span>
                            <h3 class="text-2xl font-bold text-white mb-2">ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</h3>
                            <p class="text-slate-400">${error.message}</p>
                            <button onclick="searchHotChannels()" class="mt-6 px-6 py-2 bg-brand-600 rounded-lg text-white font-bold hover:bg-brand-500">ë‹¤ì‹œ ì‹œë„</button>
                        </div>
                    `;
                }
            }
        }

            // Duplicate renderHotChannelCards removed. Using function from hot_channel_functions.js


    // Sorting by view ratio (subscriber to view ratio)
    // currentChannels is declared globally at the top of the script
    let sortAscending = false;

    function sortByViewRatio() {
    if (!currentChannels.length) return;

    sortAscending = !sortAscending;
    const sorted = [...currentChannels].sort((a, b) => {
    const ratioA = a.subscribers > 0 ? (a.dailyGrowth / a.subscribers) : 0;
    const ratioB = b.subscribers > 0 ? (b.dailyGrowth / b.subscribers) : 0;
    return sortAscending ? ratioA - ratioB : ratioB - ratioA;
    });

    renderHotChannelCards(sorted);
    }

    // Bookmark functionality
    function toggleBookmark(channelId) {
    const btn = document.getElementById(`bookmark-${channelId}`);
    if (!btn) return;

    const svg = btn.querySelector('svg');
    const isFilled = svg.getAttribute('fill') === 'currentColor';

    if (isFilled) {
    svg.setAttribute('fill', 'none');
    svg.setAttribute('stroke', 'currentColor');
    btn.classList.remove('text-red-500');
    btn.classList.add('text-slate-500');
    } else {
    svg.setAttribute('fill', 'currentColor');
    svg.setAttribute('stroke', 'none');
    btn.classList.remove('text-slate-500');
    btn.classList.add('text-red-500');
    }
    }

    function showQuotaWarning(message) {
    let warningEl = document.getElementById('quota-warning-banner');
    if (!warningEl) {
    warningEl = document.createElement('div');
    warningEl.id = 'quota-warning-banner';
    warningEl.className = 'bg-amber-500/10 border border-amber-500/30 rounded-2xl p-4 mb-6 flex items-center gap-4
    animate-in fade-in slide-in-from-top duration-500';
    const grid = document.getElementById('channelResultsGrid');
    grid.parentNode.insertBefore(warningEl, grid);
    }

    warningEl.innerHTML = `
    <div class="bg-amber-500 p-2 rounded-xl">
        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
        </svg>
    </div>
    <div class="flex-1">
        <p class="text-amber-200 font-bold text-sm">${message}</p>
        <p class="text-amber-500/70 text-xs mt-0.5">.env íŒŒì¼ì— YOUTUBE_API_KEY_3 ë“±ì„ ì¶”ê°€í•˜ì—¬ ê²€ìƒ‰ í•œë„ë¥¼ ëŠ˜ë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
    </div>
    <button onclick="hideQuotaWarning()" class="text-amber-500/50 hover:text-amber-400 transition-colors">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg>
    </button>
    `;
    warningEl.classList.remove('hidden');
    }

    // Script Library Integration
    async function previewAndSaveToLibrary(channelId, channelName) {
    try {
    // 1. Get channel details from current state
    const channel = currentChannels.find(c => c.channelId === channelId);
    if (!channel || !channel.recentVideos || channel.recentVideos.length === 0) {
    alert('ì¶”ì¶œí•  ì˜ìƒì´ ì—†ìŠµë‹ˆë‹¤.');
    return;
    }

    // 2. Use the first recent video
    const video = channel.recentVideos[0];

    if (!confirm(`[${channelName}] ì±„ë„ì˜ ìµœê·¼ ì˜ìƒ ëŒ€ë³¸ì„ ë¼ì´ë¸ŒëŸ¬ë¦¬ì— ì¶”ê°€í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì œëª©: ${video.title}`)) {
    return;
    }

    // 3. Fetch transcript
    // We reuse the existing nano loading UI if available, or just alert
    const loadingOverlay = document.getElementById('nanoLoading');
    if (loadingOverlay) loadingOverlay.classList.remove('hidden');

    const transcriptRes = await fetch('/api/get-transcript', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ videoId: video.videoId })
    });

    const transcriptData = await transcriptRes.json();
    if (loadingOverlay) loadingOverlay.classList.add('hidden');

    if (!transcriptData.transcript) {
    throw new Error('ëŒ€ë³¸ì„ ì¶”ì¶œí•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. (ìë§‰ì´ ì—†ëŠ” ì˜ìƒì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤)');
    }

    // 4. Save to Library
    const saveRes = await fetch('/api/save-to-library', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
    videoId: video.videoId,
    title: video.title,
    channelName: channelName,
    category: channel.category || 'ì¼ë°˜',
    transcript: transcriptData.transcript,
    memo: 'HOT ì±„ë„ ë°œêµ´ê¸°ë¥¼ í†µí•´ ìë™ ì¶”ê°€ë¨',
    views: channel.dailyGrowth
    })
    });

    const saveData = await saveRes.json();
    if (saveData.success) {
    alert(`âœ… [${channelName}] ëŒ€ë³¸ì´ Google Sheets ë¼ì´ë¸ŒëŸ¬ë¦¬ì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!`);
    } else {
    throw new Error(saveData.error || 'ì €ì¥ ì‹¤íŒ¨');
    }

    } catch (error) {
    console.error('[Library Error]', error);
    alert(`ì—ëŸ¬: ${error.message}`);
    const loadingOverlay = document.getElementById('nanoLoading');
    if (loadingOverlay) loadingOverlay.classList.add('hidden');
    }
    }
    </script>
    <script src="hot_channels_v3.js"></script>
</body>
</html>
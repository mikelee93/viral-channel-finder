<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Viral Style Trainer - ë°”ì´ëŸ´ ìŠ¤íƒ€ì¼ ì—°êµ¬ì†Œ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700;900&display=swap"
        rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-color: #0f172a;
            color: #e2e8f0;
        }

        .glass-panel {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .category-card {
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .category-card:hover {
            transform: translateY(-2px);
            background: rgba(59, 130, 246, 0.2);
            border-color: #3b82f6;
        }

        .category-card.active {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            border-color: #60a5fa;
            color: white;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #1e293b;
        }

        ::-webkit-scrollbar-thumb {
            background: #475569;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #64748b;
        }

        .loader {
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            border-top: 3px solid #3b82f6;
            width: 24px;
            height: 24px;
            -webkit-animation: spin 1s linear infinite;
            /* Safari */
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body class="flex h-screen overflow-hidden">

    <!-- Sidebar (Navigation) -->
    <aside
        class="w-20 lg:w-64 flex-shrink-0 border-r border-slate-800 bg-slate-900/50 flex flex-col items-center lg:items-stretch py-6 px-3">
        <div class="mb-8 lg:px-4 text-center lg:text-left">
            <h1
                class="text-2xl font-black bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-purple-500 hidden lg:block">
                Viral Lab
            </h1>
            <span class="text-2xl lg:hidden">ğŸ§¬</span>
            <p class="text-xs text-slate-500 mt-1 hidden lg:block">ìŠ¤íƒ€ì¼ ì—°êµ¬ì†Œ</p>
        </div>

        <nav class="space-y-2 flex-1 w-full">
            <a href="youtube_guidelines.html"
                class="flex items-center gap-3 p-3 rounded-xl text-slate-400 hover:bg-slate-800 hover:text-white transition-colors">
                <span class="text-xl">ğŸ“‹</span>
                <span class="hidden lg:block">ê°€ì´ë“œë¼ì¸ ì²´í¬</span>
            </a>
            <a href="#"
                class="flex items-center gap-3 p-3 rounded-xl bg-blue-600/20 text-blue-400 border border-blue-500/30 font-bold">
                <span class="text-xl">ğŸ§ª</span>
                <span class="hidden lg:block">ìŠ¤íƒ€ì¼ ì—°êµ¬ì†Œ</span>
            </a>
        </nav>

        <div class="mt-auto lg:px-4">
            <div class="glass-panel p-4 rounded-xl hidden lg:block">
                <p class="text-xs text-slate-400 mb-1">Total Personas</p>
                <p class="text-2xl font-bold text-white" id="totalPersonasCount">0</p>
            </div>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 overflow-y-auto bg-[#0f172a] relative">
        <!-- Header Zone -->
        <header
            class="sticky top-0 z-30 bg-[#0f172a]/90 backdrop-blur-md border-b border-slate-800 px-8 py-4 flex items-center justify-between">
            <div>
                <h2 class="text-xl font-bold text-white">ì±„ë„ ìŠ¤íƒ€ì¼ íŠ¸ë ˆì´ë„ˆ</h2>
                <p class="text-sm text-slate-400">ìœ íŠœë¸Œ ì±„ë„ì˜ 'Viral DNA'ë¥¼ ë¶„ì„í•˜ê³  í•™ìŠµí•©ë‹ˆë‹¤</p>
            </div>
            <button id="addChannelBtn"
                class="bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-500 hover:to-indigo-500 text-white px-6 py-2.5 rounded-lg font-bold shadow-lg shadow-blue-500/20 flex items-center gap-2 transition-all">
                <span>â• ìƒˆ ì±„ë„ ë¶„ì„</span>
            </button>
        </header>

        <div class="p-8 max-w-7xl mx-auto">

            <!-- Category Filter (15 items) -->
            <section class="mb-10">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-bold text-slate-300">ğŸ“‚ ì¹´í…Œê³ ë¦¬ í•„í„°</h3>
                    <div class="text-xs text-slate-500">15ê°œ ì¹´í…Œê³ ë¦¬</div>
                </div>

                <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-3" id="categoryGrid">
                    <!-- Javascript will populate this -->
                </div>
            </section>

            <!-- Channel List -->
            <section>
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-lg font-bold text-white flex items-center gap-2">
                        <span id="selectedCategoryTitle">ì „ì²´</span>
                        <span class="text-sm font-normal text-slate-500" id="channelCountBadge">(0)</span>
                    </h3>

                    <!-- Search -->
                    <div class="relative w-64">
                        <input type="text" placeholder="ì±„ë„ëª… ê²€ìƒ‰..."
                            class="w-full bg-slate-800 border border-slate-700 rounded-lg pl-10 pr-4 py-2 text-sm text-white focus:outline-none focus:border-blue-500">
                        <span class="absolute left-3 top-2.5 text-slate-500">ğŸ”</span>
                    </div>
                </div>

                <!-- Channel Grid -->
                <div id="personaGrid" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
                    <!-- Cards will be inserted here -->

                    <!-- Empty State -->
                    <div
                        class="col-span-full py-20 text-center glass-panel rounded-2xl border-dashed border-2 border-slate-700">
                        <div class="text-6xl mb-4 grayscale opacity-50">ğŸ§ª</div>
                        <h3 class="text-xl font-bold text-slate-300 mb-2">ì•„ì§ ë¶„ì„ëœ ì±„ë„ì´ ì—†ìŠµë‹ˆë‹¤</h3>
                        <p class="text-slate-500 mb-6">ì›í•˜ëŠ” ìœ íŠœë²„ì˜ ìŠ¤íƒ€ì¼ì„ ë¶„ì„í•´ì„œ ë‚˜ë§Œì˜ ë°ì´í„°ë¥¼ ë§Œë“œì„¸ìš”</p>
                        <button onclick="window.openModal()" class="text-blue-400 hover:text-blue-300 font-bold">
                            + ì²« ë²ˆì§¸ ì±„ë„ ë¶„ì„í•˜ê¸°
                        </button>
                    </div>
                </div>
            </section>
        </div>
    </main>

    <!-- Analyze Modal -->
    <div id="analyzeModal"
        class="fixed inset-0 z-50 bg-black/80 backdrop-blur-sm hidden flex items-center justify-center p-4">
        <div class="bg-slate-900 border border-slate-700 rounded-2xl w-full max-w-2xl shadow-2xl transform transition-all scale-95 opacity-0"
            id="modalContent">

            <div class="p-6 border-b border-slate-800 flex justify-between items-center">
                <h3 class="text-xl font-bold text-white">ğŸ§ª ìƒˆ ì±„ë„ ë¶„ì„</h3>
                <button id="closeModalBtn" class="text-slate-400 hover:text-white text-2xl">&times;</button>
            </div>

            <div class="p-6">
                <!-- Input Step -->
                <div id="stepInput" class="space-y-6">
                    <div>
                        <label class="block text-slate-300 font-bold mb-2">ìœ íŠœë¸Œ ì±„ë„ URL (ë˜ëŠ” í•¸ë“¤)</label>
                        <div class="flex gap-2">
                            <input type="text" id="channelUrlInput" placeholder="ì˜ˆ: https://www.youtube.com/@MrBeast"
                                class="flex-1 bg-slate-800 border border-slate-700 rounded-xl px-4 py-3 text-white focus:border-blue-500 focus:outline-none">
                            <button id="fetchChannelInfoBtn"
                                class="bg-blue-600 hover:bg-blue-500 text-white font-bold px-6 rounded-xl transition-colors">
                                ì¡°íšŒ
                            </button>
                        </div>
                        <p class="text-xs text-slate-500 mt-2">ì…ë ¥í•œ ì±„ë„ì˜ ìµœê·¼ ì˜ìƒì„ ë¶„ì„í•˜ì—¬ ìŠ¤íƒ€ì¼ì„ í•™ìŠµí•©ë‹ˆë‹¤.</p>
                    </div>

                    <!-- Channel Info Preview (Hidden initially) -->
                    <div id="channelPreview" class="hidden glass-panel rounded-xl p-4 flex gap-4 items-center">
                        <div id="previewThumbnail"
                            class="w-16 h-16 rounded-full bg-slate-700 flex items-center justify-center text-2xl font-bold text-white">
                            ?</div>
                        <div>
                            <h4 id="previewName" class="font-bold text-white text-lg">--</h4>
                            <p id="previewSubscribers" class="text-sm text-slate-400">êµ¬ë…ì --ëª…</p>
                        </div>
                    </div>

                    <!-- Category Selection -->
                    <div id="categorySelectSection" class="hidden">
                        <label class="block text-slate-300 font-bold mb-2">ì¹´í…Œê³ ë¦¬ ì„ íƒ</label>
                        <select id="categorySelect"
                            class="w-full bg-slate-800 border border-slate-700 rounded-xl px-4 py-3 text-white focus:border-blue-500 outline-none">
                            <option value="">ì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
                            <!-- JS populated -->
                        </select>
                    </div>

                    <!-- Limit Selection (New, Hidden initially) -->
                    <div id="limitSelectSection" class="hidden">
                        <label class="block text-slate-300 font-bold mb-2">ë¶„ì„í•  ì˜ìƒ ê°œìˆ˜</label>
                        <div class="flex gap-3 mb-2 flex-wrap">
                            <button type="button" onclick="selectLimit(3)" id="btn-limit-3"
                                class="limit-btn flex-1 bg-slate-800 border border-slate-700 hover:bg-slate-700 text-slate-400 py-2 rounded-lg font-medium transition-all">3ê°œ</button>
                            <button type="button" onclick="selectLimit(5)" id="btn-limit-5"
                                class="limit-btn flex-1 bg-slate-800 border border-slate-700 hover:bg-slate-700 text-slate-400 py-2 rounded-lg font-medium transition-all">5ê°œ</button>
                            <button type="button" onclick="selectLimit(10)" id="btn-limit-10"
                                class="limit-btn flex-1 bg-slate-800 border border-slate-700 hover:bg-slate-700 text-slate-400 py-2 rounded-lg font-medium transition-all">10ê°œ</button>
                            <button type="button" onclick="selectLimit(15)" id="btn-limit-15"
                                class="limit-btn flex-1 bg-slate-800 border border-slate-700 hover:bg-slate-700 text-slate-400 py-2 rounded-lg font-medium transition-all">15ê°œ</button>
                            <button type="button" onclick="selectLimit('all')" id="btn-limit-all"
                                class="limit-btn flex-[1.5] bg-slate-800 border border-slate-700 hover:bg-slate-700 text-purple-400 py-2 rounded-lg font-bold transition-all border-purple-500/30">
                                ì „ì²´(ì €ì¥ëœ ëŒ€ë³¸)
                            </button>
                        </div>
                        <p class="text-xs text-slate-500" id="limitHint">ìµœê·¼ ì¸ê¸° ìˆœ ì˜ìƒ 5ê°œë¥¼ ë¶„ì„í•©ë‹ˆë‹¤.</p>

                        <!-- Custom Folder Input (Hidden by default) -->
                        <div id="customFolderSection" class="mt-3 hidden transition-all">
                            <label class="block text-xs font-bold text-slate-400 mb-1">ğŸ“‚ ëŒ€ë³¸ í´ë” ì§ì ‘ ì§€ì • (ì„ íƒì‚¬í•­)</label>
                            <div class="flex gap-2">
                                <input type="text" id="customFolderInput"
                                    placeholder="ì˜ˆ: f:/Google Antigravity/.../ì¼ë¶„ì¼ì´ˆ"
                                    class="flex-1 bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-xs text-slate-300 focus:ring-2 focus:ring-purple-500 outline-none">
                                <button type="button" onclick="pickFolder()"
                                    class="px-3 py-2 bg-slate-700 hover:bg-slate-600 text-white text-xs rounded-lg font-bold transition-colors whitespace-nowrap">
                                    ğŸ“‚ ì°¾ê¸°
                                </button>
                            </div>
                            <p class="text-[10px] text-slate-500 mt-1">* ì±„ë„ëª…ê³¼ í´ë”ëª…ì´ ë‹¤ë¥¼ ê²½ìš°, í´ë” ê²½ë¡œë¥¼ ì§ì ‘ ì…ë ¥í•˜ì„¸ìš”.</p>
                        </div>
                    </div>

                    <!-- Transcript Source Selection (New) -->
                    <div id="transcriptSourceSection" class="hidden">
                        <label class="block text-slate-300 font-bold mb-2">ìë§‰ ì¶”ì¶œ ë°©ì‹</label>
                        <div class="grid grid-cols-2 gap-3">
                            <label class="cursor-pointer relative group">
                                <input type="radio" name="transcriptSource" value="apify" class="peer sr-only">
                                <div
                                    class="p-4 rounded-xl bg-slate-800 border-2 border-slate-700 peer-checked:border-blue-500 peer-checked:bg-blue-600/10 transition-all hover:bg-slate-700 h-full">
                                    <div class="font-bold text-white mb-1">Apify (ê¸°ë³¸)</div>
                                    <div class="text-xs text-slate-400">Youtube ìë§‰ ì¶”ì¶œ (ë¬´ë£Œ/ë¹ ë¦„)</div>
                                </div>
                            </label>
                            <label class="cursor-pointer relative group">
                                <input type="radio" name="transcriptSource" value="whisper" class="peer sr-only"
                                    checked>
                                <div
                                    class="p-4 rounded-xl bg-slate-800 border-2 border-slate-700 peer-checked:border-green-500 peer-checked:bg-green-600/10 transition-all hover:bg-slate-700 h-full">
                                    <div class="flex justify-between items-center mb-1">
                                        <span class="font-bold text-white">Whisper AI</span>
                                        <span
                                            class="bg-green-500 text-black text-[10px] px-1.5 py-0.5 rounded font-bold">ìœ ë£Œ</span>
                                    </div>
                                    <div class="text-xs text-slate-400">ì˜¤ë””ì˜¤ ë¶„ì„ ë° ì •í™•í•œ ìë§‰ (ë‚˜ë ˆì´ì…˜ í¬í•¨)</div>
                                </div>
                            </label>
                        </div>
                    </div>

                    <!-- Loading Step -->
                    <div id="stepLoading" class="hidden py-10 text-center">
                        <div class="loader w-12 h-12 mx-auto mb-4 border-t-purple-500"></div>
                        <h3 class="text-xl font-bold text-white mb-2" id="loadingStatus">ì˜ìƒ ë°ì´í„° ìˆ˜ì§‘ ì¤‘...</h3>
                        <p class="text-slate-400 text-sm" id="loadingDetail">ì±„ë„ì˜ ìµœê·¼ ì˜ìƒì„ ë¶ˆëŸ¬ì˜¤ê³  ìˆìŠµë‹ˆë‹¤</p>

                        <!-- Progress Bar -->
                        <div class="w-full bg-slate-800 rounded-full h-2 mt-6 overflow-hidden">
                            <div id="progressBar"
                                class="bg-gradient-to-r from-blue-500 to-purple-500 h-full w-0 transition-all duration-300">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="p-6 border-t border-slate-800 flex justify-end gap-3 bg-slate-900/50 rounded-b-2xl">
                    <button id="cancelBtn" class="px-5 py-2 text-slate-400 hover:text-white font-medium">ì·¨ì†Œ</button>
                    <button id="startAnalysisBtn" disabled
                        class="px-6 py-2 bg-slate-700 text-slate-400 rounded-xl font-bold cursor-not-allowed transition-all">
                        ë¶„ì„ ì‹œì‘
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // 15 YouTube Categories
        const CATEGORIES = [
            { id: 'film', name: 'ì˜í™”/ì• ë‹ˆë©”ì´ì…˜', icon: 'ğŸ¬' },
            { id: 'autos', name: 'ìë™ì°¨', icon: 'ğŸš—' },
            { id: 'music', name: 'ìŒì•…', icon: 'ğŸµ' },
            { id: 'pets', name: 'ë°˜ë ¤ë™ë¬¼/ë™ë¬¼', icon: 'ğŸ¾' },
            { id: 'sports', name: 'ìŠ¤í¬ì¸ ', icon: 'âš½' },
            { id: 'travel', name: 'ì—¬í–‰/ì´ë²¤íŠ¸', icon: 'âœˆï¸' },
            { id: 'gaming', name: 'ê²Œì„', icon: 'ğŸ®' },
            { id: 'people', name: 'ì¸ë¬¼/ë¸”ë¡œê·¸', icon: 'ğŸ‘¤' },
            { id: 'comedy', name: 'ì½”ë¯¸ë””', icon: 'ğŸ˜‚' },
            { id: 'entertainment', name: 'ì—”í„°í…Œì¸ë¨¼íŠ¸', icon: 'ğŸ­' },
            { id: 'news', name: 'ë‰´ìŠ¤/ì •ì¹˜', icon: 'ğŸ“°' },
            { id: 'howto', name: 'ë…¸í•˜ìš°/ìŠ¤íƒ€ì¼', icon: 'ğŸ’„' },
            { id: 'education', name: 'êµìœ¡', icon: 'ğŸ“š' },
            { id: 'tech', name: 'ê³¼í•™ê¸°ìˆ ', icon: 'ğŸ”¬' },
            { id: 'nonprofit', name: 'ë¹„ì˜ë¦¬/ì‚¬íšŒìš´ë™', icon: 'ğŸ¤' },
            { id: 'general', name: 'ì¼ë°˜', icon: 'ğŸ“' }
        ];

        // --- State ---
        let fetchedChannelInfo = null;
        let activeFilter = 'all';
        window.allPersonas = []; // Made global for access by modals
        let analysisLimit = 5; // Default

        // --- Limit Selection Logic ---
        window.selectLimit = (n) => {
            analysisLimit = n;
            document.querySelectorAll('.limit-btn').forEach(b => {
                b.classList.remove('bg-blue-600', 'text-white', 'border-blue-500');
                b.classList.add('bg-slate-800', 'text-slate-400', 'border-slate-700');
            });
            const btn = document.getElementById(`btn-limit-${n}`);
            if (btn) {
                btn.classList.add('bg-blue-600', 'text-white', 'border-blue-500');
                btn.classList.remove('bg-slate-800', 'text-slate-400', 'border-slate-700');
            }
            const hint = document.getElementById('limitHint');
            const folderSection = document.getElementById('customFolderSection');

            const sourceSection = document.getElementById('transcriptSourceSection');
            if (n === 'all') {
                if (hint) hint.textContent = `ì €ì¥ëœ ëª¨ë“  ëŒ€ë³¸ íŒŒì¼(.txt)ì„ ë¶„ì„í•©ë‹ˆë‹¤.`;
                if (folderSection) folderSection.classList.remove('hidden');
                if (sourceSection) sourceSection.classList.add('hidden'); // Hide when using local files
            } else {
                if (hint) hint.textContent = `ìµœê·¼ ì¸ê¸° ìˆœ ì˜ìƒ ${n}ê°œë¥¼ ë¶„ì„í•©ë‹ˆë‹¤.`;
                if (folderSection) folderSection.classList.add('hidden');
                if (sourceSection) sourceSection.classList.remove('hidden');
            }
        }

        // Init default selection visually
        setTimeout(() => { if (window.selectLimit) window.selectLimit(5); }, 50);

        // --- DOM Elements ---
        const grid = document.getElementById('categoryGrid');
        const select = document.getElementById('categorySelect');
        const personaGrid = document.getElementById('personaGrid');

        // --- Init Function ---
        async function init() {
            initCategories();
            await loadPersonas();
            setupEventListeners();
        }

        function initCategories() {
            grid.innerHTML = ''; // Clear
            select.innerHTML = '<option value="">ì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒí•˜ì„¸ìš”</option>';

            CATEGORIES.forEach(cat => {
                // Filter Grid Item
                const card = document.createElement('div');
                card.className = "category-card glass-panel rounded-xl p-3 flex items-center gap-3 active:scale-95 select-none";
                card.onclick = () => selectFilterCategory(cat.id);
                card.dataset.id = cat.id;
                card.innerHTML = `
                    <span class="text-xl">${cat.icon}</span>
                    <div class="flex-1 min-w-0">
                        <p class="font-bold text-sm text-slate-200 truncate">${cat.name}</p>
                        <p class="text-[10px] text-slate-500" id="count-${cat.id}">0ê°œ ì±„ë„</p>
                    </div>
                `;
                grid.appendChild(card);

                // Option in Modal
                const option = document.createElement('option');
                option.value = cat.id;
                option.textContent = `${cat.icon} ${cat.name}`;
                select.appendChild(option);
            });
        }

        async function loadPersonas() {
            try {
                const res = await fetch('/api/channels/list');
                const json = await res.json();
                if (json.success) {
                    window.allPersonas = json.data;
                    document.getElementById('totalPersonasCount').innerText = window.allPersonas.length;
                    renderPersonas();
                    updateCategoryCounts();
                }
            } catch (e) {
                console.error("Failed to load personas", e);
            }
        }

        function updateCategoryCounts() {
            CATEGORIES.forEach(cat => {
                const count = allPersonas.filter(p => p.category === cat.id).length;
                const el = document.getElementById(`count-${cat.id}`);
                if (el) el.innerText = `${count}ê°œ ì±„ë„`;
            });
        }

        function selectFilterCategory(id) {
            activeFilter = (activeFilter === id) ? 'all' : id; // Toggle

            // UI Update
            document.querySelectorAll('.category-card').forEach(c => {
                if (activeFilter !== 'all' && c.dataset.id === activeFilter) {
                    c.classList.add('active');
                } else {
                    c.classList.remove('active');
                }
            });

            const catName = CATEGORIES.find(c => c.id === activeFilter)?.name || 'ì „ì²´';
            document.getElementById('selectedCategoryTitle').innerText = catName;

            renderPersonas();
        }

        function renderPersonas() {
            const filtered = activeFilter === 'all'
                ? allPersonas
                : allPersonas.filter(p => p.category === activeFilter);

            document.getElementById('channelCountBadge').innerText = `(${filtered.length})`; // update badge

            personaGrid.innerHTML = '';

            if (filtered.length === 0) {
                personaGrid.innerHTML = `
                    <div class="col-span-full py-20 text-center glass-panel rounded-2xl border-dashed border-2 border-slate-700">
                        <div class="text-6xl mb-4 grayscale opacity-50">ğŸ§ª</div>
                        <h3 class="text-xl font-bold text-slate-300 mb-2">
                            ${activeFilter === 'all' ? 'ì•„ì§ ë¶„ì„ëœ ì±„ë„ì´ ì—†ìŠµë‹ˆë‹¤' : 'ì´ ì¹´í…Œê³ ë¦¬ì—ëŠ” ì±„ë„ì´ ì—†ìŠµë‹ˆë‹¤'}
                        </h3>
                        <p class="text-slate-500 mb-6">ì›í•˜ëŠ” ìœ íŠœë²„ì˜ ìŠ¤íƒ€ì¼ì„ ë¶„ì„í•´ì„œ ë‚˜ë§Œì˜ ë°ì´í„°ë¥¼ ë§Œë“œì„¸ìš”</p>
                        <button onclick="window.openModal()" class="text-blue-400 hover:text-blue-300 font-bold">
                            + ì²« ë²ˆì§¸ ì±„ë„ ë¶„ì„í•˜ê¸°
                        </button>
                    </div>
                `;
                return;
            }

            filtered.forEach(p => {
                // Determine style tags from analysis
                const tags = [p.analysis.pacing, p.analysis.tone].filter(Boolean).slice(0, 2);

                const card = document.createElement('div');
                card.className = "glass-panel p-5 rounded-2xl hover:bg-slate-800 transition-colors relative group";
                card.innerHTML = `
                    <div class="flex items-start justify-between mb-4">
                        <div class="flex items-center gap-3">
                            <div class="w-12 h-12 rounded-full bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center text-xl font-bold text-white">
                                ${p.name.charAt(0)}
                            </div>
                            <div>
                                <h4 class="font-bold text-white leading-tight">${p.name}</h4>
                                <a href="${p.url}" target="_blank" class="text-xs text-blue-400 hover:underline">YouTube â†—</a>
                            </div>
                        </div>
                        <div class="flex items-center gap-2">
                            ${p.sourceCount ? `<span class="bg-slate-700/50 text-slate-400 text-xs px-2 py-1 rounded-md font-mono border border-slate-600/50" title="í•™ìŠµëœ ì˜ìƒ ìˆ˜">${p.sourceCount}</span>` : ''}
                            <span class="text-2xl opacity-50">${CATEGORIES.find(c => c.id === p.category)?.icon || 'ğŸ“'}</span>
                        </div>
                    </div>
                    
                    <div class="mb-4 space-y-2">
                        <div class="bg-black/30 p-3 rounded-lg text-sm text-slate-300 border border-white/5">
                            <span class="text-purple-400 font-bold text-xs block mb-1">AI ìš”ì•½</span>
                            "${p.analysis.summary || 'ìš”ì•½ ì—†ìŒ'}"
                        </div>
                    </div>

                    <div class="flex flex-wrap gap-2 mb-4">
                        ${tags.map(t => `<span class="px-2 py-1 bg-slate-700 rounded text-xs text-slate-300">${t}</span>`).join('')}
                    </div>

                    <div class="grid grid-cols-2 gap-2 mt-auto">
                        <button onclick="window.viewDNA('${p.id}')" class="px-3 py-2 rounded-lg bg-purple-600 hover:bg-purple-500 text-xs text-center text-white transition-colors shadow-lg shadow-purple-500/20 font-bold border border-purple-400/30">
                            ğŸ§¬ DNA ë¶„ì„
                        </button>
                        <button onclick="window.openDirectorWrite('${p.id}')" class="px-3 py-2 rounded-lg bg-blue-600 hover:bg-blue-500 text-xs text-center text-white font-bold transition-colors">
                            ğŸ¬ Director Write
                        </button>
                    </div>
                    
                    <div class="absolute top-2 right-2 z-50 opacity-70 hover:opacity-100 transition-all">
                         <button onclick="event.stopPropagation(); deletePersona('${p.id}')" class="bg-red-500/20 text-red-200 p-2 rounded-lg hover:bg-red-600 hover:text-white transition-all backdrop-blur-sm" title="ì‚­ì œ">
                            ğŸ—‘ï¸
                         </button>
                    </div>
                `;
                personaGrid.appendChild(card);
            });
        }

        // Expose openModal globally
        window.openModal = () => {
            const modal = document.getElementById('analyzeModal');
            const modalContent = document.getElementById('modalContent');

            modal.classList.remove('hidden');
            setTimeout(() => {
                modalContent.classList.remove('opacity-0', 'scale-95');
                modalContent.classList.add('opacity-100', 'scale-100');
            }, 10);

            // Reset state
            document.getElementById('stepInput').classList.remove('hidden');
            document.getElementById('stepLoading').classList.add('hidden');
            document.getElementById('startAnalysisBtn').classList.remove('hidden');
            document.getElementById('cancelBtn').classList.remove('hidden');

            // Hide result sections
            document.getElementById('channelPreview').classList.add('hidden');
            document.getElementById('categorySelectSection').classList.add('hidden');
            document.getElementById('limitSelectSection').classList.add('hidden');
            document.getElementById('transcriptSourceSection').classList.add('hidden'); // Added

            // Reset Button State
            document.getElementById('startAnalysisBtn').disabled = true;
            document.getElementById('startAnalysisBtn').classList.add('cursor-not-allowed', 'text-slate-400', 'bg-slate-700');
            document.getElementById('startAnalysisBtn').classList.remove('bg-blue-600', 'text-white', 'hover:bg-blue-500');

            // Reset inputs
            document.getElementById('channelUrlInput').value = '';
            fetchedChannelInfo = null;
        };

        // Expose delete function global
        window.deletePersona = async (id) => {
            if (!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            try {
                await fetch('/api/channels/delete', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id })
                });
                await loadPersonas();
            } catch (e) {
                alert('ì‚­ì œ ì‹¤íŒ¨');
            }
        };

        // Folder Picker
        window.pickFolder = async () => {
            const btn = document.querySelector('button[onclick="pickFolder()"]');
            const originalText = btn.innerText;
            btn.innerText = 'â³';
            btn.disabled = true;

            try {
                const res = await fetch('/api/channels/util/pick-folder', { method: 'POST' });
                // Wait, did I add it to /api/channels/util/pick-folder?
                // Server route was router.post('/util/pick-folder') inside channel_analysis.routes.js
                // And server.js likely mounts channel_analysis at /api/channels?
                // Let's assume standard mounting.
                // I need to double check if route is /api/channels/util/pick-folder
                // In server.js line 193: app.use('/api/channels', channelAnalysisRoutes);
                // So yes, it is /api/channels/util/pick-folder.

                const json = await res.json();
                if (json.success && json.path) {
                    document.getElementById('customFolderInput').value = json.path;
                }
            } catch (e) {
                console.error(e);
                alert('í´ë” ì„ íƒ ì°½ì„ ì—¬ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            } finally {
                btn.innerText = originalText;
                btn.disabled = false;
            }
        };

        function setupEventListeners() {
            // Header Button
            document.getElementById('addChannelBtn').onclick = window.openModal;

            // Fetch Info Handler
            document.getElementById('fetchChannelInfoBtn').onclick = async () => {
                const url = document.getElementById('channelUrlInput').value.trim();
                const btn = document.getElementById('fetchChannelInfoBtn');

                if (!url) return alert('URLì„ ì…ë ¥í•´ì£¼ì„¸ìš”');

                btn.innerText = 'ì¡°íšŒ ì¤‘...';
                btn.disabled = true;

                try {
                    const res = await fetch('/api/channels/info', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ url })
                    });
                    const json = await res.json();

                    if (json.success) {
                        fetchedChannelInfo = json.data;

                        // Show Preview
                        document.getElementById('channelPreview').classList.remove('hidden');
                        document.getElementById('previewName').innerText = json.data.name;
                        document.getElementById('previewSubscribers').innerText = `êµ¬ë…ì ${json.data.subscribers}`;
                        document.getElementById('previewThumbnail').innerText = json.data.name.charAt(0); // Fallback avatar

                        // Show Category Select
                        document.getElementById('categorySelectSection').classList.remove('hidden');
                        document.getElementById('limitSelectSection').classList.remove('hidden');
                        document.getElementById('transcriptSourceSection').classList.remove('hidden'); // Show Source Select
                        document.getElementById('startAnalysisBtn').disabled = false;
                        document.getElementById('startAnalysisBtn').classList.remove('cursor-not-allowed', 'text-slate-400', 'bg-slate-700');
                        document.getElementById('startAnalysisBtn').classList.add('bg-blue-600', 'text-white', 'hover:bg-blue-500');

                        // --- Auto Select Category Logic ---
                        if (json.data.originalCategory) {
                            const map = {
                                'Film & Animation': 'film', 'Autos & Vehicles': 'autos', 'Music': 'music',
                                'Pets & Animals': 'pets', 'Sports': 'sports', 'Travel & Events': 'travel',
                                'Gaming': 'gaming', 'People & Blogs': 'people', 'Comedy': 'comedy',
                                'Entertainment': 'entertainment', 'News & Politics': 'news', 'Howto & Style': 'howto',
                                'Education': 'education', 'Science & Technology': 'tech', 'Nonprofits & Activism': 'nonprofit'
                            };
                            const mappedId = map[json.data.originalCategory];
                            if (mappedId) {
                                document.getElementById('categorySelect').value = mappedId;
                            } else {
                                // Try lowercase match
                                const lowerCat = json.data.originalCategory.toLowerCase();
                                const exists = CATEGORIES.find(c => c.id === lowerCat);
                                if (exists) {
                                    document.getElementById('categorySelect').value = exists.id;
                                } else {
                                    // Default to general if not found
                                    document.getElementById('categorySelect').value = 'general';
                                }
                            }
                        }

                    } else {
                        alert('ì±„ë„ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + (json.error || 'Unknown error'));
                    }
                } catch (e) {
                    console.error(e);
                    alert('ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                } finally {
                    btn.innerText = 'ì¡°íšŒ';
                    btn.disabled = false;
                }
            };

            // Start Analysis Handler
            document.getElementById('startAnalysisBtn').onclick = async () => {
                const category = document.getElementById('categorySelect').value;
                // Get selected transcript source
                const transcriptSource = document.querySelector('input[name="transcriptSource"]:checked')?.value || 'apify';
                const customFolderPath = document.getElementById('customFolderInput')?.value?.trim() || '';

                if (!fetchedChannelInfo) return;
                if (!category) return alert('ì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”');

                // UI Switch to Loading
                document.getElementById('stepInput').classList.add('hidden');
                document.getElementById('stepLoading').classList.remove('hidden');
                document.getElementById('startAnalysisBtn').classList.add('hidden');
                document.getElementById('cancelBtn').classList.add('hidden'); // Cannot cancel easily mid-request

                // Fake Progress Bar Animation
                let progress = 10;
                const progressBar = document.getElementById('progressBar');
                const interval = setInterval(() => {
                    progress += (Math.random() * 5);
                    if (progress > 90) progress = 90;
                    progressBar.style.width = `${progress}%`;
                }, 1000);

                try {
                    const res = await fetch('/api/channels/analyze', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            url: fetchedChannelInfo.url,
                            category: category,
                            limit: analysisLimit,
                            transcriptSource: transcriptSource, // Pass to API
                            customFolderPath: customFolderPath // Pass Custom Path
                        })
                    });
                    const json = await res.json();

                    clearInterval(interval);
                    progressBar.style.width = '100%';

                    if (json.success) {
                        // Auto Save (Simplify workflow)
                        await fetch('/api/channels/save', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                name: fetchedChannelInfo.name,
                                url: fetchedChannelInfo.url,
                                category: category,
                                analysis: json.analysis,
                                sourceCount: analysisLimit // Added sourceCount
                            })
                        });

                        // Success Feedback
                        alert(`âœ… '${fetchedChannelInfo.name}' ì±„ë„ì˜ ìŠ¤íƒ€ì¼ì´ í•™ìŠµë˜ì—ˆìŠµë‹ˆë‹¤!`);

                        closeModal(); // Use local close first

                        // Internal close function for consistency
                        const clsModal = () => {
                            const modal = document.getElementById('analyzeModal');
                            const modalContent = document.getElementById('modalContent');
                            modalContent.classList.remove('opacity-100', 'scale-100');
                            modalContent.classList.add('opacity-0', 'scale-95');
                            setTimeout(() => {
                                modal.classList.add('hidden');
                            }, 200);
                        }
                        clsModal();

                        await loadPersonas(); // Refresh Grid

                    } else {
                        alert('ë¶„ì„ ì‹¤íŒ¨: ' + (json.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
                        document.getElementById('stepInput').classList.remove('hidden');
                        document.getElementById('stepLoading').classList.add('hidden');
                        document.getElementById('startAnalysisBtn').classList.remove('hidden');
                        document.getElementById('cancelBtn').classList.remove('hidden');
                    }
                } catch (e) {
                    console.error(e);
                    alert('ì„œë²„ í†µì‹  ì˜¤ë¥˜');
                    document.getElementById('stepInput').classList.remove('hidden');
                    document.getElementById('stepLoading').classList.add('hidden');
                    document.getElementById('startAnalysisBtn').classList.remove('hidden');
                    document.getElementById('cancelBtn').classList.remove('hidden');
                }
            };
        }

        // Modal Logic Helper (Internal)
        function closeModal() {
            const modal = document.getElementById('analyzeModal');
            const modalContent = document.getElementById('modalContent');
            modalContent.classList.remove('opacity-100', 'scale-100');
            modalContent.classList.add('opacity-0', 'scale-95');
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 200);
        }

        document.getElementById('closeModalBtn').onclick = closeModal;
        document.getElementById('cancelBtn').onclick = closeModal;

        // Start
        init();

    </script>
    <!-- DNA Analysis Modal -->
    <div id="dnaModal" class="fixed inset-0 bg-black/80 backdrop-blur-sm hidden z-50 flex items-center justify-center">
        <div id="dnaModalContent"
            class="bg-slate-900 border border-slate-700 rounded-3xl w-full max-w-3xl p-6 transform scale-95 opacity-0 transition-all duration-300 shadow-2xl relative max-h-[85vh] overflow-y-auto">
            <button onclick="closeDnaModal()" class="absolute top-4 right-4 text-slate-400 hover:text-white">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12">
                    </path>
                </svg>
            </button>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <!-- Left: Profile -->
                <div>
                    <div class="flex items-center gap-4 mb-6">
                        <div id="dnaAvatar"
                            class="w-16 h-16 rounded-full bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center text-3xl font-bold text-white">
                            A
                        </div>
                        <div>
                            <h2 id="dnaName" class="text-2xl font-bold text-white">Channel Name</h2>
                            <p id="dnaSummary" class="text-slate-400 text-sm mt-1">Summary...</p>
                        </div>
                    </div>

                    <div class="bg-slate-800/50 p-4 rounded-xl border border-white/5 mb-4">
                        <h4 class="text-xs font-bold text-purple-400 uppercase tracking-wider mb-2">Director's Rules
                        </h4>
                        <ul id="dnaRules" class="text-sm text-slate-300 space-y-2 list-disc list-inside">
                            <li>Loading...</li>
                        </ul>
                    </div>

                    <div class="space-y-4">
                        <div class="bg-slate-800/50 p-4 rounded-xl border border-white/5">
                            <h4 class="text-xs font-bold text-blue-400 uppercase tracking-wider mb-2">Vocabulary
                                Patterns</h4>
                            <div id="dnaVocabulary" class="flex flex-wrap gap-2">
                                <!-- Tag cloud -->
                            </div>
                        </div>

                        <div class="bg-slate-800/50 p-4 rounded-xl border border-white/5">
                            <h4 class="text-xs font-bold text-green-400 uppercase tracking-wider mb-2">Transition
                                Phrases</h4>
                            <div id="dnaTransitions" class="flex flex-wrap gap-2 text-xs text-slate-300">
                                <!-- List -->
                            </div>
                        </div>

                        <div class="bg-slate-800/50 p-4 rounded-xl border border-white/5">
                            <h4 class="text-xs font-bold text-orange-400 uppercase tracking-wider mb-2">Sentence
                                Structure</h4>
                            <p id="dnaSentenceStructure" class="text-xs text-slate-400 leading-relaxed italic">
                                <!-- Text -->
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Right: Structure Graph -->
                <div>
                    <h3 class="text-lg font-bold text-white mb-4 flex items-center gap-2">
                        <span>ğŸ“Š</span> Viral Structure DNA
                    </h3>
                    <p class="text-xs text-slate-400 mb-4">Timestamps & Narrative Flow</p>

                    <div id="dnaTimeline" class="space-y-3">
                        <!-- Bars will be injected here -->
                    </div>
                </div>
            </div>

            <div class="mt-8 pt-6 border-t border-slate-700 flex justify-end">
                <button onclick="startDirectorWriteFromModal()"
                    class="px-6 py-3 bg-blue-600 hover:bg-blue-500 text-white rounded-xl font-bold text-lg shadow-lg hover:shadow-blue-500/20 transition-all">
                    ğŸ¬ ì´ DNAë¡œ ëŒ€ë³¸ ì“°ê¸° (Director Mode)
                </button>
            </div>
        </div>
    </div>

    <script>
        // Ensure access to global variable if it exists, or define it for safety (though it should be defined in valid flow)
        // If 'allPersonas' is defined in the previous script block, it should be accessible.
        // However, if the previous script block was inside a module or function, it might not be.
        // Let's assume it's global.

        // DNA Modal Logic
        let currentDnaId = null;

        window.viewDNA = function (id) {
            console.log('[viewDNA] Clicked with ID:', id);

            // Check if allPersonas is available
            if (typeof allPersonas === 'undefined' || !Array.isArray(allPersonas)) {
                console.error("allPersonas is undefined. Loading from server...");
                // Emergency load
                fetch('/api/channels/list').then(r => r.json()).then(d => {
                    if (d.success) {
                        window.allPersonas = d.data; // Force global
                        window.viewDNA(id); // Retry
                    } else {
                        alert('ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨');
                    }
                });
                return;
            }

            currentDnaId = id;
            const persona = allPersonas.find(p => p.id == id);

            if (!persona) {
                console.error('Persona not found inside allPersonas:', allPersonas);
                // Try refreshing data once
                fetch('/api/channels/list').then(r => r.json()).then(d => {
                    if (d.success) {
                        window.allPersonas = d.data;
                        const retryPersona = window.allPersonas.find(p => p.id == id);
                        if (retryPersona) {
                            window.viewDNA(id);
                        } else {
                            alert('ì±„ë„ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (ID ë¶ˆì¼ì¹˜)');
                        }
                    }
                });
                return;
            }

            // Populate Info
            document.getElementById('dnaName').innerText = persona.name;
            document.getElementById('dnaAvatar').innerText = persona.name.charAt(0);
            document.getElementById('dnaSummary').innerText = persona.analysis.summary || 'ìš”ì•½ ì •ë³´ ì—†ìŒ';

            // Populate Rules
            const rulesList = document.getElementById('dnaRules');
            rulesList.innerHTML = '';
            if (persona.analysis.director_rules && persona.analysis.director_rules.length > 0) {
                persona.analysis.director_rules.forEach(r => {
                    rulesList.innerHTML += `<li>${r}</li>`;
                });
            } else {
                rulesList.innerHTML = `<li class="text-slate-500 italic">No specific rules found.</li>`;
            }

            // Populate Vocabulary
            const vocab = document.getElementById('dnaVocabulary');
            vocab.innerHTML = '';
            if (persona.analysis.vocabulary_patterns) {
                const patterns = persona.analysis.vocabulary_patterns;
                const allWords = [
                    ...(patterns.adjectives || []),
                    ...(patterns.verbs || []),
                    ...(patterns.signature_expressions || [])
                ];
                allWords.forEach(word => {
                    const span = document.createElement('span');
                    span.className = "px-2 py-1 bg-blue-500/10 text-blue-300 border border-blue-500/20 rounded text-[10px]";
                    span.textContent = word;
                    vocab.appendChild(span);
                });
            } else {
                vocab.innerHTML = '<span class="text-slate-500 italic text-xs">No pattern found</span>';
            }

            // Populate Transitions
            const trans = document.getElementById('dnaTransitions');
            trans.innerHTML = '';
            if (persona.analysis.transition_phrases && persona.analysis.transition_phrases.length > 0) {
                persona.analysis.transition_phrases.forEach(p => {
                    const span = document.createElement('span');
                    span.className = "px-2 py-0.5 bg-green-500/10 text-green-300 border border-green-500/20 rounded-full";
                    span.textContent = p;
                    trans.appendChild(span);
                });
            } else {
                trans.innerHTML = '<span class="text-slate-500 italic text-xs">No transitions found</span>';
            }

            // Populate Sentence Structure
            document.getElementById('dnaSentenceStructure').innerText = persona.analysis.sentence_structure || 'No structure analysis available.';

            // Populate Timeline
            const timeline = document.getElementById('dnaTimeline');
            timeline.innerHTML = '';

            if (persona.analysis.structure_template) {
                persona.analysis.structure_template.forEach(block => {
                    // Parse "0-5s"
                    const timeMatch = block.time.match(/(\d+)-(\d+)s/);
                    let duration = 5;
                    if (timeMatch) duration = parseInt(timeMatch[2]) - parseInt(timeMatch[1]);

                    // Color mapping
                    let bgClass = "bg-slate-600";
                    if (block.type.includes('Hook')) bgClass = "bg-red-500";
                    if (block.type.includes('Body')) bgClass = "bg-blue-500";
                    if (block.type.includes('Climax')) bgClass = "bg-purple-500";
                    if (block.type.includes('CTA')) bgClass = "bg-green-500";

                    timeline.innerHTML += `
                        <div class="relative pl-16 py-2 border-l-2 border-slate-700 hover:border-blue-500 transition-colors group">
                            <span class="absolute left-0 top-3 text-xs font-mono text-slate-500 w-12 text-right group-hover:text-blue-400">${block.time}</span>
                            <div class="bg-slate-800 p-3 rounded-lg border border-white/5 relative overflow-hidden">
                                <div class="absolute left-0 top-0 bottom-0 w-1 ${bgClass}"></div>
                                <h5 class="text-sm font-bold text-white mb-1 flex justify-between">
                                    <span>${block.type}</span>
                                    <span class="text-xs font-normal opacity-50 text-white gap-2 px-1.5 py-0.5 rounded bg-white/10">â± ${duration}s</span>
                                </h5>
                                <p class="text-xs text-slate-400">${block.description}</p>
                            </div>
                        </div>
                    `;
                });
            } else {
                timeline.innerHTML = `<div class="p-4 text-center text-slate-500 bg-slate-800 rounded-lg">No DNA structure available.<br>Please re-analyze this channel.</div>`;
            }

            // Show Modal
            const modal = document.getElementById('dnaModal');
            const content = document.getElementById('dnaModalContent');
            modal.classList.remove('hidden');
            setTimeout(() => {
                content.classList.remove('opacity-0', 'scale-95');
                content.classList.add('opacity-100', 'scale-100');
            }, 10);
        };

        window.closeDnaModal = function () {
            const modal = document.getElementById('dnaModal');
            const content = document.getElementById('dnaModalContent');
            content.classList.remove('opacity-100', 'scale-100');
            content.classList.add('opacity-0', 'scale-95');
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 300);
        };

        window.openDirectorWrite = function (id) {
            currentDnaId = id;
            // Close DNA modal if open
            closeDnaModal();

            // Open Input Modal
            const modal = document.getElementById('directorInputModal');
            modal.classList.remove('hidden');
            document.getElementById('directorTopicInput').value = '';
            setTimeout(() => document.getElementById('directorTopicInput').focus(), 100);
        };

        window.closeDirectorInputHelper = function () {
            document.getElementById('directorInputModal').classList.add('hidden');
        };

        window.generateDirectorScript = async function () {
            const topic = document.getElementById('directorTopicInput').value.trim();
            const tone = document.getElementById('directorToneSelect').value;
            if (!topic) return alert('ì£¼ì œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!');

            // Loading State
            const btn = document.getElementById('generateDirectorBtn');
            const originalText = btn.innerHTML;
            btn.innerHTML = 'ğŸ¬ ê°ë…ì´ ëŒ€ë³¸ì„ ì“°ëŠ” ì¤‘... (ì•½ 15ì´ˆ)';
            btn.disabled = true;

            try {
                const persona = allPersonas.find(p => p.id === currentDnaId);
                if (!persona) throw new Error('Persona not found');

                const res = await fetch('/api/channels/director/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        topic: topic,
                        tone: tone,
                        structure_template: persona.analysis.structure_template,
                        director_rules: persona.analysis.director_rules
                    })
                });

                const json = await res.json();
                if (json.success) {
                    window.closeDirectorInputHelper();
                    showDirectorResult(json.script, persona.name);
                } else {
                    alert('Error: ' + json.error);
                }

            } catch (e) {
                console.error(e);
                alert('ëŒ€ë³¸ ìƒì„± ì‹¤íŒ¨');
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        };

        function showDirectorResult(script, personaName) {
            const modal = document.getElementById('directorResultModal');
            document.getElementById('resultPersonaName').innerText = personaName + " Style";

            const container = document.getElementById('scriptTimelineContainer');
            container.innerHTML = '';

            script.forEach(block => {
                // Color mapping
                let bgClass = "border-slate-600";
                let textClass = "text-slate-300";
                if (block.type.includes('Hook')) { bgClass = "border-red-500"; textClass = "text-red-300"; }
                if (block.type.includes('Body')) { bgClass = "border-blue-500"; textClass = "text-blue-300"; }
                if (block.type.includes('Climax') || block.type.includes('Twist')) { bgClass = "border-purple-500"; textClass = "text-purple-300"; }
                if (block.type.includes('CTA')) { bgClass = "border-green-500"; textClass = "text-green-300"; }

                container.innerHTML += `
                    <div class="flex gap-4 relative">
                        <div class="w-20 pt-2 text-right text-xs font-mono text-slate-500 shrink-0 select-none">
                            ${block.time}
                        </div>
                        <div class="absolute left-[5.25rem] top-0 bottom-0 w-px bg-slate-700"></div>
                        <div class="absolute left-[5.10rem] top-3 w-3 h-3 rounded-full bg-slate-800 border-2 ${bgClass} z-10"></div>
                        
                        <div class="flex-1 pb-8">
                             <div class="bg-slate-800/80 p-5 rounded-xl border border-white/5 hover:border-white/10 transition-colors">
                                <div class="flex justify-between items-center mb-2">
                                    <span class="text-xs font-bold px-2 py-1 rounded bg-white/5 ${textClass}">${block.type}</span>
                                    <div class="flex gap-2">
                                        ${block.visual_cue ? `<span class="text-[10px] px-1.5 py-0.5 rounded bg-blue-900/30 text-blue-300 border border-blue-500/20">ğŸ‘ ${block.visual_cue}</span>` : ''}
                                        ${block.audio_cue ? `<span class="text-[10px] px-1.5 py-0.5 rounded bg-pink-900/30 text-pink-300 border border-pink-500/20">ğŸ”Š ${block.audio_cue}</span>` : ''}
                                    </div>
                                </div>
                                <p class="text-lg text-white font-medium leading-relaxed">
                                    "${block.content}"
                                </p>
                             </div>
                        </div>
                    </div>
                `;
            });

            modal.classList.remove('hidden');
        }

        window.closeDirectorResult = function () {
            document.getElementById('directorResultModal').classList.add('hidden');
        };

        window.startDirectorWriteFromModal = function () {
            if (currentDnaId) window.openDirectorWrite(currentDnaId);
        };

        // --- AI Recommendation Logic ---
        window.recommendTopics = async function () {
            const btn = document.getElementById('btnRecommend');
            const list = document.getElementById('aiRecommendationList');

            if (btn.disabled) return; // Prevent double click

            // UI Loading
            btn.innerHTML = `<span class="animate-spin">ğŸŒ€</span> ì±„ë„ DNA ë¶„ì„ ì¤‘...`;
            btn.disabled = true;
            list.classList.remove('hidden');
            list.innerHTML = `<div class="p-3 text-center text-xs text-slate-500">AIê°€ ì´ ì±„ë„ì— ë”± ë§ëŠ” ì£¼ì œë¥¼ ì°¾ê³  ìˆìŠµë‹ˆë‹¤...</div>`;

            try {
                const persona = allPersonas.find(p => p.id === currentDnaId);
                if (!persona) throw new Error('Persona not found');

                const res = await fetch('/api/channels/director/recommend', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        channelName: persona.name,
                        summary: persona.analysis.summary,
                        category: persona.category,
                        tone: persona.analysis.tone,
                        rules: persona.analysis.director_rules
                    })
                });

                const json = await res.json();
                if (json.success && json.recommendations) {
                    list.innerHTML = ''; // Clear loading
                    json.recommendations.forEach(rec => {
                        const el = document.createElement('div');
                        el.className = "bg-slate-800 p-3 rounded-lg border border-slate-700 hover:border-purple-500 cursor-pointer transition-colors group";
                        el.onclick = () => applyRecommendation(rec.topic, rec.tone);
                        el.innerHTML = `
                            <div class="flex justify-between items-start mb-1">
                                <span class="text-[10px] font-bold text-purple-400 bg-purple-900/30 px-1.5 py-0.5 rounded">${rec.type}</span>
                                <span class="text-[10px] text-slate-500 group-hover:text-purple-300">Tone: ${rec.tone}</span>
                            </div>
                            <h5 class="text-sm font-bold text-white mb-1 group-hover:text-purple-200">"${rec.topic}"</h5>
                            <p class="text-xs text-slate-400 leading-tight">${rec.reason}</p>
                         `;
                        list.appendChild(el);
                    });
                    btn.innerHTML = `<span>ğŸ¤–</span> ë‹¤ë¥¸ ì£¼ì œ ë‹¤ì‹œ ì¶”ì²œë°›ê¸°`;
                } else {
                    list.innerHTML = `<div class="text-red-400 text-xs p-2">ì¶”ì²œ ì‹¤íŒ¨: ${json.error || 'Unknown'}</div>`;
                    btn.innerHTML = `<span>ğŸ¤–</span> AI ì£¼ì œ ì¶”ì²œë°›ê¸° (Retry)`;
                }

            } catch (e) {
                console.error(e);
                list.innerHTML = `<div class="text-red-400 text-xs p-2">ì„œë²„ ì˜¤ë¥˜</div>`;
                btn.innerHTML = `<span>ğŸ¤–</span> AI ì£¼ì œ ì¶”ì²œë°›ê¸° (Retry)`;
            } finally {
                btn.disabled = false;
            }
        };

        window.applyRecommendation = function (topic, tone) {
            document.getElementById('directorTopicInput').value = topic;
            // Try to match tone if exists in select, else add it or ignore
            const toneSelect = document.getElementById('directorToneSelect');
            // Simple check: if tone is somewhat matching standard ones, select it.
            // For now, let's just keep the tone separate or default.
            // Actually, let's try to set it if it matches value, or default to Engaging
            // We won't force the select change unless it matches perfectly.

            // Visual feedback
            const input = document.getElementById('directorTopicInput');
            input.classList.add('ring-2', 'ring-purple-500');
            setTimeout(() => input.classList.remove('ring-2', 'ring-purple-500'), 500);
        };

    </script>
    <!-- Director Input Modal -->
    <div id="directorInputModal"
        class="fixed inset-0 bg-black/90 backdrop-blur-sm hidden z-[60] flex items-center justify-center">
        <div
            class="bg-slate-900 border border-slate-700 rounded-2xl w-full max-w-4xl p-8 shadow-2xl overflow-y-auto max-h-[90vh]">
            <h3 class="text-xl font-bold text-white mb-4">ğŸ¬ Director Mode</h3>
            <p class="text-sm text-slate-400 mb-6">This persona's pacing & editing rules will be applied to your
                topic.
            </p>

            <label class="block text-xs font-bold text-slate-500 mb-1">TOPIC</label>
            <input id="directorTopicInput" type="text" placeholder="e.g., Why cats sleep so much"
                class="w-full bg-slate-800 border border-slate-700 rounded-lg px-4 py-3 text-white mb-2 focus:ring-2 focus:ring-blue-500 outline-none">

            <!-- AI Suggestion Area -->
            <div class="mb-4">
                <button id="btnRecommend" type="button" onclick="recommendTopics()"
                    class="text-xs flex items-center gap-1 text-purple-400 hover:text-purple-300 transition-colors font-bold mb-2">
                    <span>ğŸ¤–</span> AI ì£¼ì œ ì¶”ì²œë°›ê¸° (Click!)
                </button>
                <div id="aiRecommendationList" class="mt-2 grid grid-cols-1 md:grid-cols-3 gap-3 hidden">
                    <!-- Items injected here -->
                </div>
            </div>

            <label class="block text-xs font-bold text-slate-500 mb-1">TONE</label>
            <select id="directorToneSelect"
                class="w-full bg-slate-800 border border-slate-700 rounded-lg px-4 py-3 text-white mb-6 outline-none">
                <option value="Engaging">Engaging (Standard)</option>
                <option value="High-Tension">High-Tension (Fast)</option>
                <option value="Scientific">Calm & Scientific</option>
                <option value="Funny">Humorous</option>
            </select>

            <div class="flex justify-end gap-2">
                <button onclick="window.closeDirectorInputHelper()"
                    class="px-4 py-2 text-slate-400 hover:text-white">Cancel</button>
                <button id="generateDirectorBtn" onclick="generateDirectorScript()"
                    class="px-6 py-2 bg-blue-600 hover:bg-blue-500 text-white rounded-lg font-bold">Action!</button>
            </div>
        </div>
    </div>

    <!-- Director Result Modal -->
    <div id="directorResultModal" class="fixed inset-0 bg-black/95 hidden z-[70] overflow-y-auto">
        <div class="min-h-screen p-8 max-w-4xl mx-auto">
            <div
                class="flex justify-between items-center mb-10 sticky top-0 bg-black/95 py-4 z-10 border-b border-white/10 backdrop-blur">
                <div>
                    <h2
                        class="text-3xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-purple-400">
                        Director's Cut</h2>
                    <p id="resultPersonaName" class="text-slate-400">Persona Style</p>
                </div>
                <button onclick="window.closeDirectorResult()"
                    class="px-4 py-2 bg-slate-800 hover:bg-slate-700 text-white rounded-lg">Close</button>
            </div>

            <div id="scriptTimelineContainer" class="pl-4">
                <!-- Timeline items injected here -->
            </div>
        </div>
    </div>

</body>

</html>
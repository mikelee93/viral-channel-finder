<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reddit Viral Finder | Viral Shorts Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
        body {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            min-height: 100vh;
        }

        .glass-panel {
            background: rgba(30, 41, 59, 0.5);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .video-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px -10px rgba(0, 0, 0, 0.5);
            border-color: #f97316;
            /* orange-500 */
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #1e293b;
        }

        ::-webkit-scrollbar-thumb {
            background: #475569;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #64748b;
        }

        .loader {
            border-radius: 50%;
            border-top-color: currentColor;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body class="p-8 text-slate-300">

    <div class="max-w-7xl mx-auto">
        <!-- Navigation -->
        <div class="flex justify-between items-center mb-8">
            <h1 class="text-3xl font-black text-white flex items-center gap-3">
                <span class="text-orange-500 text-4xl">ğŸ”¥</span> Reddit Viral Finder
            </h1>
            <a href="youtube_guidelines.html"
                class="bg-slate-800 hover:bg-slate-700 text-white px-5 py-2.5 rounded-lg border border-slate-700 transition-colors font-bold flex items-center gap-2">
                <span>ğŸ </span> ë©”ì¸ìœ¼ë¡œ ëŒì•„ê°€ê¸°
            </a>
        </div>

        <!-- Toolbar -->
        <div class="glass-panel p-6 rounded-2xl mb-8 sticky top-4 z-50 shadow-xl">
            <div class="flex flex-wrap gap-4 items-center">
                <!-- Subreddit Select -->
                <div class="relative">
                    <span class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-500">r/</span>
                    <input type="text" id="subredditInput" value="PublicFreakout"
                        class="bg-slate-900 border border-slate-700 text-white pl-8 pr-4 py-3 rounded-xl focus:outline-none focus:border-orange-500 w-48 font-bold"
                        placeholder="Subreddit">
                </div>

                <!-- Presets -->
                <div class="flex gap-2 overflow-x-auto pb-1 max-w-xl custom-scrollbar">
                    <button onclick="setSubreddit('PublicFreakout')"
                        class="px-3 py-1.5 bg-slate-800 hover:bg-orange-600/20 hover:text-orange-400 rounded-lg text-sm transition-colors border border-slate-700 whitespace-nowrap">ğŸ¤¬
                        PublicFreakout</button>
                    <button onclick="setSubreddit('BodyCam')"
                        class="px-3 py-1.5 bg-slate-800 hover:bg-blue-600/20 hover:text-blue-400 rounded-lg text-sm transition-colors border border-slate-700 whitespace-nowrap">ğŸ‘®
                        BodyCam</button>
                    <button onclick="setSubreddit('NextFuckingLevel')"
                        class="px-3 py-1.5 bg-slate-800 hover:bg-purple-600/20 hover:text-purple-400 rounded-lg text-sm transition-colors border border-slate-700 whitespace-nowrap">ğŸš€
                        NextLevel</button>
                    <button onclick="setSubreddit('Damnthatsinteresting')"
                        class="px-3 py-1.5 bg-slate-800 hover:bg-yellow-600/20 hover:text-yellow-400 rounded-lg text-sm transition-colors border border-slate-700 whitespace-nowrap">ğŸ¤”
                        Interesting</button>
                    <button onclick="setSubreddit('Unexpected')"
                        class="px-3 py-1.5 bg-slate-800 hover:bg-pink-600/20 hover:text-pink-400 rounded-lg text-sm transition-colors border border-slate-700 whitespace-nowrap">ğŸ‘»
                        Unexpected</button>
                    <button onclick="setSubreddit('MadeMeSmile')"
                        class="px-3 py-1.5 bg-slate-800 hover:bg-green-600/20 hover:text-green-400 rounded-lg text-sm transition-colors border border-slate-700 whitespace-nowrap">ğŸ˜Š
                        Smile</button>
                </div>

                <div class="h-8 w-[1px] bg-slate-700 mx-2"></div>

                <!-- Filters -->
                <select id="sortSelect"
                    class="bg-slate-900 border border-slate-700 text-white px-4 py-3 rounded-xl focus:outline-none focus:border-orange-500">
                    <option value="hot">ğŸ”¥ Hot</option>
                    <option value="top">ğŸ† Top</option>
                    <option value="new">ğŸ†• New</option>
                </select>

                <select id="timeSelect"
                    class="bg-slate-900 border border-slate-700 text-white px-4 py-3 rounded-xl focus:outline-none focus:border-orange-500 hidden">
                    <option value="day">ì˜¤ëŠ˜ (Day)</option>
                    <option value="week">ì´ë²ˆ ì£¼ (Week)</option>
                    <option value="month">ì´ë²ˆ ë‹¬ (Month)</option>
                    <option value="all">ì „ì²´ (All Time)</option>
                </select>

                <button id="searchBtn"
                    class="ml-auto bg-orange-600 hover:bg-orange-500 text-white px-8 py-3 rounded-xl font-bold transition-transform active:scale-95 shadow-lg shadow-orange-600/20 flex items-center gap-2">
                    <span>ğŸ”</span> ìˆ˜ì§‘í•˜ê¸° (Collect)
                </button>
            </div>
        </div>

        <!-- Results Grid -->
        <div id="resultsGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
            <!-- Items -> JS Injected -->
            <div class="col-span-full text-center py-20 opacity-50">
                <div class="text-6xl mb-4">ğŸ›¸</div>
                <p class="text-xl">ì„œë¸Œë ˆë”§ì„ ì„ íƒí•˜ê³  'ìˆ˜ì§‘í•˜ê¸°'ë¥¼ ëˆŒëŸ¬ì£¼ì„¸ìš”.</p>
            </div>
        </div>

    </div>

    <script>
        // Preset Handler
        function setSubreddit(name) {
            document.getElementById('subredditInput').value = name;
            fetchPosts();
        }

        // Toggle Time Select based on Sort
        document.getElementById('sortSelect').addEventListener('change', (e) => {
            const timeSelect = document.getElementById('timeSelect');
            if (e.target.value === 'top') {
                timeSelect.classList.remove('hidden');
            } else {
                timeSelect.classList.add('hidden');
            }
        });

        document.getElementById('searchBtn').addEventListener('click', fetchPosts);
        document.getElementById('subredditInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') fetchPosts();
        });

        async function fetchPosts() {
            const subreddit = document.getElementById('subredditInput').value;
            const sort = document.getElementById('sortSelect').value;
            const time = document.getElementById('timeSelect').value;
            const grid = document.getElementById('resultsGrid');
            const btn = document.getElementById('searchBtn');

            if (!subreddit) return alert('ì„œë¸Œë ˆë”§ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”');

            // Loading UI
            btn.disabled = true;
            btn.innerHTML = '<div class="loader w-5 h-5 border-2 border-t-white mr-2"></div> ë¡œë”© ì¤‘...';
            grid.innerHTML = Array(8).fill(0).map(() => `
                <div class="glass-panel h-80 rounded-2xl animate-pulse"></div>
            `).join('');

            try {
                const response = await fetch(`http://localhost:4000/api/reddit/viral?subreddit=${subreddit}&sort=${sort}&time=${time}&limit=50`);
                const data = await response.json();

                if (!data.success) throw new Error(data.error);

                renderPosts(data.posts);

            } catch (error) {
                grid.innerHTML = `<div class="col-span-full text-center text-red-500 py-10">âŒ ì˜¤ë¥˜ ë°œìƒ: ${error.message}</div>`;
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<span>ğŸ”</span> ìˆ˜ì§‘í•˜ê¸° (Collect)';
            }
        }

        function renderPosts(posts) {
            const grid = document.getElementById('resultsGrid');
            grid.innerHTML = '';

            if (posts.length === 0) {
                grid.innerHTML = '<div class="col-span-full text-center text-slate-500 py-20">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
                return;
            }

            posts.forEach(post => {
                const isVideo = post.is_video || (post.video_url && post.video_url.includes('.mp4')) || post.url.includes('youtu');
                const score = post.score > 1000 ? (post.score / 1000).toFixed(1) + 'k' : post.score;

                const card = document.createElement('div');
                card.className = 'glass-panel rounded-xl overflow-hidden video-card transition-all duration-300 border border-slate-700/50 flex flex-col h-full group';

                // Media Container
                let mediaHtml = '';
                if (post.is_video && post.video_url) {
                    // Reddit Video
                    mediaHtml = `
                        <div class="aspect-video bg-black relative">
                            ${post.hls_url ? `
                                <!-- HLS Player -->
                                <video id="video-${post.id}" class="w-full h-full object-contain" controls preload="none" poster="${post.thumbnail !== 'default' ? post.thumbnail : ''}"></video>
                                <script>
                                    (function() {
                                        const video = document.getElementById('video-${post.id}');
                                        const hlsUrl = "${post.hls_url}";
                                        if (Hls.isSupported()) {
                                            const hls = new Hls();
                                            hls.loadSource(hlsUrl);
                                            hls.attachMedia(video);
                                        } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                                            video.src = hlsUrl;
                                        } else {
                                            // Fallback to MP4 (No Audio potentially)
                                            video.src = "${post.video_url}";
                                        }
                                    })();
                                <\/script>
                            ` : `
                                <!-- Standard MP4 Fallback -->
                                <video src="${post.video_url}" class="w-full h-full object-contain" controls preload="none" poster="${post.thumbnail !== 'default' ? post.thumbnail : ''}"></video>
                            `}
    <div class="absolute top-2 right-2 bg-black/70 text-white text-xs px-2 py-1 rounded flex items-center gap-1 z-10">
        <span>${post.hls_url ? 'ğŸ”Š Audio' : 'ğŸ”‡ No Audio'}</span>
    </div>
    </div>
    `;
                } else if (post.thumbnail && post.thumbnail.startsWith('http')) {
                    // Thumbnail / Link
                    mediaHtml = `
    <div class="aspect-video bg-slate-800 relative group cursor-pointer" onclick="window.open('${post.url}', '_blank')">
        <img src="${post.thumbnail}"
            class="w-full h-full object-cover opacity-80 group-hover:opacity-100 transition-opacity">
        <div
            class="absolute inset-0 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
            <span class="bg-black/50 p-3 rounded-full text-2xl">ğŸ”—</span>
        </div>
    </div>
    `;
                } else {
                    // Text/No Image
                    mediaHtml = `
    <div class="aspect-video bg-slate-800 flex items-center justify-center text-slate-500">
        ğŸ“ No Preview
    </div>
    `;
                }

                card.innerHTML = `
    ${mediaHtml}

    <div class="p-4 flex flex-col flex-1">
        <div class="flex items-start justify-between gap-2 mb-2">
            <h3 class="font-bold text-white leading-tight line-clamp-2 hover:line-clamp-none transition-all cursor-pointer"
                title="${post.title}" onclick="window.open('${post.permalink}', '_blank')">
                ${post.title}
            </h3>
        </div>

        <div class="text-xs text-slate-500 mb-4 flex items-center gap-2">
            <span class="text-orange-400 font-bold">â¬†ï¸ ${score}</span>
            <span>ğŸ’¬ ${post.comments}</span>
            <span>ğŸ‘¤ ${post.author}</span>
        </div>

        <div class="mt-auto grid grid-cols-2 gap-2">
            <button onclick="copyUrl('${post.url}')"
                class="bg-slate-700 hover:bg-slate-600 text-slate-300 py-2 rounded-lg text-sm font-bold transition-colors">
                ğŸ”— URL ë³µì‚¬
            </button>
            <button onclick="analyzeVideo('${post.url}')"
                class="bg-indigo-600 hover:bg-indigo-500 text-white py-2 rounded-lg text-sm font-bold transition-colors shadow-lg shadow-indigo-500/20">
                ğŸš€ ë¶„ì„í•˜ê¸°
            </button>
        </div>
    </div>
    `;

                grid.appendChild(card);
            });
        }

        function copyUrl(url) {
            navigator.clipboard.writeText(url);
            alert('URLì´ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤: ' + url);
        }

        function analyzeVideo(url) {
            // Copy URL and alert user to go to main page
            const confirmMove = confirm('ë¶„ì„ì„ ìœ„í•´ ë©”ì¸ í˜ì´ì§€ë¡œ ì´ë™í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (URLì€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë©ë‹ˆë‹¤)');
            if (confirmMove) {
                copyUrl(url); // Auto copy
                window.location.href = 'youtube_guidelines.html';
            }
        }
    </script>
</body>

</html>